\documentclass[runningheads,a4paper]{llncs}
\pdfoutput=1

\bibliographystyle{plainurl}

\usepackage{amssymb}
\setcounter{tocdepth}{3}
\usepackage{enumerate}
\usepackage[colorlinks=true]{hyperref}
\usepackage{tikz}
\usepackage{xcolor,latexsym,amsmath,extarrows,alltt}
\usepackage{xspace}
\usepackage{booktabs}
\usepackage{mathtools}
\usepackage{enumitem}
\usepackage{stmaryrd}
\usepackage{microtype}
\usepackage{bussproofs}
\usepackage{multirow}
\usepackage{proof}
\usepackage[T1]{fontenc}

\newcommand{\Iterms}{\mathcal{I}}
\newcommand{\World}{\mathcal{W}}
\newcommand{\Rules}{\mathcal{R}}
\newcommand{\Typevars}{\mathcal{A}}
\newcommand{\Vars}{\mathcal{V}}
\newcommand{\ITypes}{\mathcal{Y}}
\newcommand{\Types}{\mathcal{T}}
\newcommand{\Terms}{\mathcal{T}\!\mathit{erms}}
\newcommand{\TypeConstructors}{\mathcal{C}}
\newcommand{\TypeQuantifiers}{\mathcal{Q}}
\newcommand{\Typemap}{\mathcal{T\!M}}
\newcommand{\Termmap}{\mathcal{J}}

\newcommand{\quant}[2]{\forall #1[#2]}
\newcommand{\qquant}[3]{#1 #2[#3]}
\newcommand{\typeinterpret}[1]{\text{\guillemotleft} #1\! \text{\guillemotright}}
\newcommand{\interpret}[1]{\llparenthesis #1 \rrparenthesis}
\newcommand{\fullinterpret}[1]{\Phi(#1)}
\newcommand{\arr}[1]{\to_{#1}}
\newcommand{\arrtype}{\Rightarrow}
\newcommand{\abs}[2]{\lambda #1.#2}
\newcommand{\tabs}[2]{\Lambda #1.#2}
\newcommand{\abstraction}[2]{\backslash #1.#2}
\newcommand{\app}[2]{#1 \cdot #2}
\newcommand{\apps}[3]{#1 \cdot #2 \cdots #3}
\newcommand{\tapp}[2]{#1 * #2}
\newcommand{\pair}[2]{\langle #1,#2 \rangle}
\newcommand{\subst}[2]{#1:=#2}
\newcommand{\meta}[2]{#1\langle#2\rangle}

\newcommand{\FTV}{\mathit{FTV}}
\newcommand{\FV}{\mathit{FV}}

\newcommand{\nat}{\mathtt{nat}}
\newcommand{\proj}{\pi}
\newcommand{\flatten}{\mathtt{flatten}}
\newcommand{\lift}{\mathtt{lift}}
\newcommand{\con}{\mathtt{c}}
\newcommand{\afun}{\mathtt{f}}

\newcommand{\ur}{\upharpoonright}
\newcommand{\da}{\downarrow}
\newcommand{\SN}{\mathrm{SN}}
\newcommand{\Cb}{\mathbb{C}}
\newcommand{\Nbb}{\mathbb{N}}
\newcommand{\val}[3]{\ensuremath{\llbracket#1\rrbracket_{#2}^{#3}}}
\newcommand{\proves}{\vdash}

\newcommand{\CK}[1]{\textcolor{blue}{CK: #1}}
\newcommand{\LC}[1]{\textcolor{purple}{LC: #1}}

\begin{document}

\mainmatter

\title{TODO list
  \thanks{The authors are supported by lots of people.}}
\subtitle{What we need to do to get where we want to be}

\author{{\L}ukasz Czajka and Cynthia Kop}
\authorrunning{{\L}. Czajka and C. Kop}
\institute{
Faculty of Informatics, TU Dortmund
\\
Institute of Computer Science, Radboud University Nijmegen (RU)
\\
\email{lukaszcz@mimuw.edu.pl}
\quad\quad\quad
\email{C.Kop@cs.ru.nl}
}

\maketitle

\begin{abstract}
The introduction of this paper is a TODO list.
The remainder is meant for filling in the TODOs with what we already have.
The hope is that the end result is something useful. :)
\end{abstract}

\section*{THE LIST}

\renewcommand{\theenumii}{\arabic{enumi}.\arabic{enumii}}

Here's what we need to do:
\begin{enumerate}
\item Define a world $\World$ and a well-founded ordering $\succ$ on
  $\World$:
  \begin{enumerate}
  \item Define a set of terms $\World$ typed under some variation of
    System F-$\omega$.
  \item Define relations $\succ$ and $\succeq$ on the elements of $\World$.
  \item Prove that $\succ$ is a well-founded ordering relation and that
    $\succeq$ is a compatible quasi-ordering.
  \end{enumerate}
\item Specify what systems we are interested in analysing, and prove
  standard results which will make their analysis doable.
  \begin{enumerate}
  \item Specify a form of system which includes all the systems of interest.
  \item Specify a default way of interpreting terms in these systems.
  \item Prove that in all such systems, using our way of interpreting
    terms: if $\interpret{\ell} \succ \interpret{r}$ (resp.\ $\interpret{
    \ell} \succeq \interpret{r}$) for a rule  $\ell \to r$, then
    $\interpret{s} \succ \interpret{t}$ whenever $s \arr{\Rules} t$ by
    this rule (resp.\ $\interpret{s} \succeq \interpret{t}$).
  \end{enumerate}
\item Obtain useful lemmas regarding these defaults.
  \begin{enumerate}
  \item $\interpret{s[x:=t]} = \interpret{s}[x:=\interpret{t}]$.
  \item $\interpret{s\sigma} = \interpret{s}\sigma$.
  \item \dots?
  \end{enumerate}
\item For some system of interest, prove its termination:
  \begin{enumerate}
  \item Present the system and give interpretations (following the
    default scheme) for all ways of constructing terms.
  \item Show that $\ell \succ r$ or $\ell \succeq r$ for all rules.
    Remove the rules which are oriented using $\succ$ and repeat,
    until all rules have been removed.
  \end{enumerate}
\end{enumerate}

\renewcommand{\theenumii}{\alph{enumii}}

We use \emph{rule removal}:

\begin{theorem}\label{thm:ruleremove}
Let $\Rules = \Rules_1 \cup \Rules_2$, and suppose that $\arr{\Rules_1}\:
\subseteq\:\succ$ and $\arr{\Rules_2}\:\subseteq\:\succeq$ for a
well-founded ordering $\succ$ and a compatible quasi-ordering $\succeq$.
Then $\arr{\Rules}$ is terminating if and only if $\arr{\Rules_2}$ is
(which is certainly the case if $\Rules_2 = \emptyset$).
\end{theorem}

\begin{proof}
By well-foundedness of $\succ$, every infinite decreasing $\arr{\Rules}$
sequence can only use finitely many steps using $\arr{\Rules_1}$.
\qed
\end{proof}

This gives rise to the following algorithm:
\begin{enumerate}
\item While $\Rules$ is non-empty:
  \begin{enumerate}
  \item Orient all rules in $\Rules$ using $\succeq$ or $\succ$; at least
    one of them must be oriented using $\succ$.
  \item Remove all rules ordered by $\succ$ from $\Rules$.
  \end{enumerate}
\end{enumerate}
If this algorithm succeeds, we have proven termination.

\section{Defining a world}

\subsection{Defining the set $\World$}

\subsubsection{Interpretation terms}
We define the set of types for interpretation terms.

\begin{definition}\label{def:itypes}
We assume given an infinite set $\Typevars$ of \emph{type variables}.
The set $\ITypes$ of \emph{interpretation types} is given by:
\begin{itemize}
\item $\alpha \in \ITypes$ for all $\alpha \in \Typevars$, and
  $\FTV(\alpha) = \{ \alpha \}$.
\item $\nat \in \ITypes$, and $\FTV(\nat) = \emptyset$.
\item $\sigma \arrtype \tau \in \ITypes$ if both $\sigma \in \ITypes$
  and $\tau \in \ITypes$, and $\FTV(\sigma \arrtype \tau) = \FTV(\sigma)
  \cup \FTV(\tau)$.
\item $\sigma \times \tau \in \ITypes$ if both $\sigma \in \ITypes$
  and $\tau \in \ITypes$, and $\FTV(\sigma \times \tau) = \FTV(\sigma)
  \cup \FTV(\tau)$.
\item $\quant{\alpha}{\sigma} \in \ITypes$ if $\alpha \in \Typevars$ and
  $\sigma \in \ITypes$, and $\FTV(\quant{\alpha}{\sigma}) =
  \FTV(\sigma) \setminus \{ \alpha \}$.
\end{itemize}
\end{definition}

\begin{definition}\label{def:typesubst}
A \emph{type substitution} is a partial function $[\alpha_1:=\sigma_1,
\dots,\alpha_n:=\sigma_n]$ mapping a finite set of type variables to
types.  We let $\tau[\alpha_1:=\sigma_1,\dots,\alpha_n:=\sigma_n]$
denote $\tau$ with all occurrences of some $\alpha_i$ replaced by the
corresponding $\sigma_i$.  We use alpha-conversion to guarantee that
substitution does not capture variables in any of the $\sigma_i$.
\end{definition}

The set $\Iterms$ of interpretation terms is now defined as follows.

\begin{definition}\label{def_typing}
We assume given an infinite set $\Vars$ of variables, and let $\Gamma$
refer to a mapping from a finite subset of $\Vars$ to the set of
interpretation types.  The set $\Iterms$ of interpretation terms consists
of all expressions $s$ such that $\Gamma \vdash s : \sigma$ can be
inferred for some interpretation type $\sigma$ and mapping $\Gamma$ by
the following clauses:
\begin{itemize}
\item $\Gamma \vdash n : \nat$ for every natural number $n$.
\item $\Gamma \vdash x : \sigma$ for every $(x : \sigma) \in \Gamma$.
\item $\Gamma \vdash \mathtt{f} : \sigma$ for all $(\mathtt{f} :
  \sigma)$ in the following set: $\{ \oplus_\sigma : \sigma \arrtype
  \sigma \arrtype \sigma,\ \otimes_\sigma : \sigma \arrtype \sigma \arrtype
  \sigma,\ \proj^1_{\sigma,\tau} : (\sigma \times \tau) \arrtype
  \sigma,\ \proj^2_{\sigma,\tau} : (\sigma \times \tau) \arrtype \tau,\
  \flatten_{\sigma} : \sigma \arrtype \nat,\
  \lift_{\sigma} : \nat \arrtype \sigma
  \mid \sigma \in \ITypes \}$.
\item $\Gamma \vdash \pair{s}{t} : \sigma \times \tau$ if $\Gamma \vdash
  s : \sigma$ and $\Gamma \vdash t : \tau$.
\item $\Gamma \vdash \abs{x:\sigma}{s} : \sigma \arrtype \tau$ if $x
  \in \Vars$ and $\Gamma \uplus \{ x : \sigma \} \vdash s : \tau$.
\item $\Gamma \vdash \tabs{\alpha}{s} : \quant{\alpha}{\sigma}$ if
  $\alpha \in \Typevars$ and $\Gamma \vdash s : \sigma$ and for all
  $(x : \tau) \in \Gamma$: $\alpha \notin \FTV(\tau)$
\item $\Gamma \vdash \app{s}{t} : \tau$ if $\Gamma \vdash s :
  \sigma \arrtype \tau$ and $\Gamma \vdash t : \sigma$
\item $\Gamma \vdash \tapp{s}{\tau} : \sigma[\subst{\alpha}{\tau}]$ if
  $\Gamma \vdash s : \quant{\alpha}{\sigma}$
\end{itemize}
We say that $s$ is \emph{closed} if $\emptyset \vdash s : \sigma$.
\end{definition}

Note that for a given $\Gamma$, if $s$ is typable under $\Gamma$, then
there is only one choice for the type (this is easily proved by
induction on the form of $s$). Thus, all closed terms have a unique
type.

\subsubsection{Normalising interpretation terms}
Term equality is considered modulo $\alpha$-conversion. To define the
world of \emph{final interpretation terms}, we will normalise certain
elements of $\Iterms$ using the relation $\leadsto$.

\begin{definition}
We define the relation $\leadsto$ on interpretation terms as the
smallest relation for which the following properties are satisfied:
\begin{enumerate}
\item\label{leadsto:mono:abs}
  if $s \leadsto t$ then both $\abs{x}{s} \leadsto \abs{x}{t}$ and
  $\tabs{\alpha}{s} \leadsto \tabs{\alpha}{t}$
\item\label{leadsto:mono:right}
  if $s \leadsto t$ then $\app{u}{s} \leadsto \app{u}{t}$
\item\label{leadsto:mono:left}
  if $s \leadsto t$ then both $\app{s}{u} \leadsto \app{t}{u}$ and
  $\tapp{s}{\sigma} \leadsto \tapp{t}{\sigma}$
\item\label{leadsto:plus:base}
  $\app{\app{\oplus_{\nat}}{n}}{m} \leadsto (n+m)$
\item\label{leadsto:times:base}
  $\app{\app{\otimes_{\nat}}{n}}{m} \leadsto (n \cdot m)$
\item\label{leadsto:circ:arrow}
  $\app{\app{\circ_{\sigma \arrtype \tau}}{s}}{t} \leadsto \abs{x:
  \sigma}{\app{\app{\circ_\tau}{(\app{s}{x})}}{(\app{t}{x})}}$ for
  $\circ \in \{ \oplus, \otimes \}$
\item\label{leadsto:circ:forall}
  $\app{\app{\circ_{\quant{\alpha}{\sigma}}}{s}}{t} \leadsto
  \tabs{\alpha}{\app{\app{\circ_\sigma}{(\tapp{s}{\alpha})}}{(
  \tapp{t}{\alpha})}}$ for $\circ \in \{ \oplus, \otimes \}$
\item $\app{\proj^1_{\sigma,\tau}}{(s,t)} \leadsto s$
\item $\app{\proj^2_{\sigma,\tau}}{(s,t)} \leadsto t$
\item $\app{\flatten_\nat}{s} \leadsto s$
\item $\app{\flatten_{\sigma \arrtype \tau}}{s} \leadsto
  \app{s}{(\app{\lift_\sigma}{0})}$
\item $\app{\flatten_{\quant{\alpha}{\sigma}}}{s} \leadsto
  \app{\flatten_{\sigma[\subst{\alpha}{\nat}]}}{(\tapp{s}{\nat})}$
\item $\app{\lift_\nat}{s} \leadsto s$
\item $\app{\lift_{\sigma \arrtype \tau}}{s} \leadsto
  \abs{x:\sigma}{\app{\lift_{\tau}}{s}}$
\item $\app{\lift_{\quant{\alpha}{\sigma}}}{s} \leadsto
  \tabs{\alpha}{\app{\lift_{\sigma}}{s}}$
\item\label{leadsto:beta:abs}
  $\app{(\abs{x:\sigma}{s})}{t} \leadsto s[\subst{x}{t}]$
\item\label{leadsto:beta:tabs}
  $\tapp{(\tabs{\alpha}{s})}{\sigma} \leadsto
  s[\subst{\alpha}{\sigma}]$.
\end{enumerate}
We say that $s$ is a \emph{redex} if $s$ reduces by one of the rules
(\ref{leadsto:plus:base})--(\ref{leadsto:beta:tabs}), and that $s$
\emph{reduces at the head} to $t$ if the derivation of $s \leadsto t$
does not use (\ref{leadsto:mono:abs}) or (\ref{leadsto:mono:right}).

A \emph{final interpretation term} is a term $s \in \Iterms$ such that
(a) $\FV(s) = \FTV(s) = \emptyset$, and (b) $s$ is in normal form with
respect to $\leadsto$.  We let $\World$ be the set of all final
interpretation terms. By~$\World_\tau$ we denote the set of all final
interpretation terms of type~$\tau$.
\end{definition}

NOTE: in the remainder of this section, we shall often speak simply of
``terms'' when referring to interpretation terms.

\subsubsection{Key properties of $\leadsto$}
In the remainder of this section, we will often abuse notation to omit
$\cdot$ and $*$.  Thus, $s t$ can refer to both $\app{s}{t}$ and
$\tapp{s}{t}$.  Due to typing, this notation is not ambiguous.  We will
also denote $\abstraction{a}{s}$ for either $\abs{a}{s}$ or
$\tabs{a}{s}$, depending on typing. Thus, we have:

\begin{lemma}\label{lem_abusive_notation}
Every interpretation term has the form $s t_1 \dots t_n$ with
$s$ a variable, function symbol or abstraction $\abstraction{a}{s'}$
(for $n \geq 0$).
\end{lemma}

\begin{proof}
By induction on the size of interpretation terms (and a simple case
analysis).
\qed
\end{proof}

\begin{lemma}[Subject reduction]
  If $\Gamma \vdash t : \tau$ and $t \leadsto t'$ then
  $\Gamma \vdash t' : \tau$.
\end{lemma}

\begin{proof}
  TODO
\end{proof}

By~$\SN$ we denote the set of all terminating interpretation
terms. For $t \in \SN$ by~$\nu(t)$ we denote the length of the longest
reduction starting at~$t$.

The following lemma is obvious, but worth stating explicitly.

\begin{lemma}\label{lem_reduce_abs}
If $\abstraction{a}{s} \leadsto^* t$, then $t = \abstraction{a}{
t}$ and $s \leadsto^* t'$.
If $s \in \SN$ then both $\abs{x}{s}$ and $\tabs{\alpha}{s}$ are also
in $\SN$.
\end{lemma}

\begin{proof}
We observe that every reduct of $\abstraction{x}{s}$ has the form
$\abstraction{x}{s'}$ with $s \leadsto s'$, and analogously for
$\tabs{\alpha}{s}$.  Thus, the first statement follows by induction on
the length of the reduction $\abstraction{a}{s} \leadsto^* t$, and the
second statement by induction on $\nu(s)$.  \qed
\end{proof}

\begin{lemma}\label{lem_circ_sn_base}
  If $t_1,t_2 \in \SN$ then $\circ_\nat t_1 t_2 \in \SN$ for $\circ
  \in \{\oplus,\otimes\}$.
\end{lemma}

\begin{proof}
  By induction on $\nu(t_1) + \nu(t_2)$. Assume $t_1,t_2 \in \SN$. To
  prove $\circ_\nat t_1 t_2 \in \SN$ it suffices to show $s \in \SN$
  for all~$s$ such that $\circ_\nat t_1 t_2 \leadsto s$. If $s =
  \circ_\nat t_1' t_2$ or $s = \circ_\nat t_1 t_2'$ with $t_i \leadsto
  t_i'$ then we complete by the induction hypothesis. Otherwise $s \in
  \mathbb{N}$ is obviously in $\SN$.
\end{proof}

\subsubsection{Computability}

In the rest of this section we adapt the Tait-Girard computability
method to prove termination of~$\leadsto$. The proof is an adaptation
of chapters~6 and~14 from the book ``Proofs and Types'' by Girard, and
chapters~10 and~11 from the book ``Lectures on the Curry-Howard
Isomorphism'' by Sorensen and Urzyczyn.

NOTE: For now the proof does not take product types into account. I'm
not sure if explicit products are necessary in the definition, because
in contrast to the simply-typed lambda-calculus they may be encoded in
the polymorphic lambda-calculus.

NOTE: Currently, $\flatten$ and $\lift$ are not accounted for either,
but adding them should be similar to~$\oplus$ and~$\otimes$.

\begin{definition}\label{def_candidate}
  A term~$t$ is \emph{neutral} if there does not exists a sequence of
  terms or types~$u_1,\ldots,u_n$ with $n \ge 1$ such that
  $t u_1 \ldots u_n$ is a redex (by~$\leadsto$).

  A set~$X$ of interpretation terms of type~$\tau$ in context~$\Gamma$
  is a \emph{candidate of type~$\tau$} when:
  \begin{enumerate}
  \item $X \subseteq \SN$;
  \item if $t \in X$ and $t \leadsto t'$ then $t' \in X$;
  \item if $t$ is neutral and for every~$t'$ with $t \leadsto t'$ we
    have $t' \in X$, then $t \in X$;
  \item if $t_1,t_2 \in X$ then $\circ_\tau t_1 t_2 \in X$ for $\circ
    \in \{\oplus,\otimes\}$;
  \item conditions analogous to the previous one for $\flatten$ and
    $\lift$ \ldots
  \end{enumerate}
  Note that item~3 above implies:
  \begin{itemize}
  \item if $t$ is neutral and in normal form then $t \in X$.
  \end{itemize}
  The set of all candidates of type~$\tau$ in context~$\Gamma$ is
  denoted by~$\Cb_\tau^\Gamma$.
\end{definition}

\begin{definition}\label{def_reducibility_valuation}
  Let $\omega$ be a mapping from type variables to types. A
  \emph{$\Gamma,\omega$-valuation} is a mapping~$\xi$ from type
  variables to candidates such that $\xi(\alpha)$ is a candidate of
  type~$\omega(\alpha)$ (in context~$\Gamma$).

  For each type~$\sigma$, context~$\Gamma$, mapping~$\omega$
  and each $\Gamma,\omega$-valuation~$\xi$, the set $\val{\sigma}{\omega,\xi}{\Gamma}$ is
  defined by induction on~$\sigma$:
  \begin{itemize}
  \item $\val{\alpha}{\omega,\xi}{\Gamma} = \xi(\alpha)$ for a type
    variable~$\alpha$,
  \item $\val{\nat}{\omega,\xi}{\Gamma}$ is the set of all
    terms~$t \in \SN$ such that $\Gamma \proves t : \nat$,
  \item $\val{\sigma \to \tau}{\omega,\xi}{\Gamma}$ is the set of all
    terms~$t$ such that $\Gamma \proves t : \omega(\sigma \to \tau)$,
    and for every~$s \in \val{\sigma}{\omega,\xi}{\Gamma}$ we have
    $\app{t}{s} \in \val{\tau}{\omega,\xi}{\Gamma}$,
  \item $\val{\forall\alpha[\sigma]}{\omega,\xi}{\Gamma}$ is the set
    of all terms~$t$ such that
    $\Gamma \proves t : \omega(\forall\alpha[\sigma])$ and for every
    type~$\tau$ and every $X \in \Cb_\tau^\Gamma$ we have
    $\tapp{t}{\alpha} \in
    \val{\sigma}{\omega[\subst{\alpha}{\tau}],\xi[\subst{\alpha}{X}]}{\Gamma}$.
  \end{itemize}
\end{definition}

\begin{lemma}\label{lem_val_typable}
  If $t \in \val{\sigma}{\omega,\xi}{\Gamma}$ then
  $\Gamma \proves t : \omega(\sigma)$.
\end{lemma}

\begin{proof}
  Follows from definitions.
\end{proof}

\begin{lemma}\label{lem_nat_reducible}
  $\val{\nat}{\omega,\xi}{\Gamma} \in \Cb_{\nat}^\Gamma$.
\end{lemma}

\begin{proof}
  We check the conditions in Definition~\ref{def_candidate}.
  \begin{enumerate}
  \item $\val{\nat}{\omega,\xi}{\Gamma} \subseteq \SN$ follows
    directly from Definition~\ref{def_reducibility_valuation}.
  \item Let $t \in \val{\nat}{\omega,\xi}{\Gamma}$ and
    $t \leadsto t'$. Then $\Gamma \proves t : \nat$ and $t \in
    \SN$. Hence $t' \in \SN$, and $\Gamma \proves t' : \nat$ by the
    subject reduction lemma. Thus
    $t' \in \val{\nat}{\omega,\xi}{\Gamma}$.
  \item Let $t$ be neutral and $\Gamma \proves t : \nat$. Assume that
    for all~$t'$ with $t \leadsto t'$ we have
    $t' \in \val{\nat}{\omega,\xi}{\Gamma}$, so in particular
    $t' \in \SN$. But then $t \in \SN$. Hence
    $t \in \val{\nat}{\omega,\xi}{\Gamma}$.
  \item Let $t_1,t_2 \in \SN$ be such that
    $\Gamma \proves t_i : \nat$. Obviously,
    $\Gamma \proves \circ_\nat t_1 t_2 : \nat$. Also
    $\circ_\nat t_1 t_2 \in \SN$ follows by Lemma~\ref{lem_circ_sn_base}.
    So $\circ_\nat t_1 t_2 \in \val{\nat}{\omega,\xi}{\Gamma}$.
  \end{enumerate}
\end{proof}

\LC{The following lemma is essentially just the two lemmas you
  commented out, plus using property 2 of candidates for the other
  direction. I corrected the statement (the statements of the
  commented-out lemmas were also incomplete -- I forgot about the
  typing).}
\CK{Yeah, I realised that afterwards -- I needed them \emph{before}
  the main proof, and hadn't realised that they were given later
  as well.}
\begin{lemma}\label{lem_abstraction_computable}
  Suppose it is given that $\val{\sigma}{\omega',\xi'}{\Gamma}$ and
  $\val{\tau}{\omega,\xi}{\Gamma}$ are candidates for all suitable
  $\omega',\xi'$.  Then
  \begin{itemize}
  \item
    $\abs{x:\omega(\tau)}{s} \in \val{\tau \arrtype
      \sigma}{\omega,\xi}{ \Gamma}$ if and only if
    $\Gamma \proves \abs{x:\omega(\tau)}{s} : \omega(\tau \arrtype
    \sigma)$ and $s[x:=t] \in \val{\sigma}{\omega,\xi}{\Gamma}$ for
    all $t \in \val{ \tau}{\omega,\xi}{\Gamma}$;
  \item
    $\tabs{\alpha}{s} \in \val{\quant{\alpha}{\sigma}}{\omega,\xi}{
      \Gamma}$ if and only if
    $\Gamma \proves \tabs{\alpha}{s} : \omega(\quant{\alpha}{\sigma})$
    and for every type~$\tau$ and all $X \in \Cb_\tau^\Gamma$ we have
    $s[\alpha:=\tau] \in
    \val{\sigma}{\omega[\subst{\alpha}{\tau}],\xi[\subst{\alpha}{X}]}{\Gamma}$.
  \end{itemize}
\end{lemma}

\begin{proof}
  First suppose $\abs{x:\sigma}{s} \in \val{\sigma \arrtype \tau}{\omega,
  \xi}{\Gamma}$.  Then for all $t \in \val{\sigma}{\omega,\xi}{\Gamma}$ we
  have $\app{(\abs{x:\sigma}{s})}{t} \in \val{\tau}{\omega,\xi}{\Gamma}$.
  As this set is a candidate, it is closed under $\leadsto$, so also
  $s[x:=t] \in \val{\tau}{\omega,\xi}{\Gamma}$.
  Similarly, if $\tabs{\alpha}{s} \in \quant{\alpha}{\sigma}$, then
  $\tapp{(\tabs{\alpha}{s})}{\tau} \in \val{\sigma}{
  \omega[\subst{\alpha}{\tau}],\xi[\subst{\alpha}{X}]}{\Gamma}$, and we are
  done because $\tapp{(\tabs{\alpha}{s})}{\tau} \leadsto s[\alpha:=\tau]$.

  Now suppose (**): $s[x:=t] \in \val{\sigma}{\omega,\xi}{\Gamma}$ for all
  $t \in \val{\tau}{\omega,\xi}{\Gamma}$.  Let $t \in \val{\tau}{\omega,
  \xi}{\Gamma}$.  Then:
  \begin{itemize}
  \item $t \in \SN$ because $\val{\tau}{\omega,\xi}{\Gamma}$ is a candidate;
  \item $s \in \SN$ because every infinite reduction in $s$ induces an
    infinite reduction in $s[x:=t]$ ($\leadsto$ is stable);
  \item if $s \leadsto^* s'$ and $t \leadsto^* t'$, then:
    \begin{itemize}
    \item $s[x:=t] \leadsto^* s'[x:=t']$ by monotonicity and stability of
      $\leadsto$;
    \item therefore $s'[x:=t'] \in \val{\sigma}{\omega,\xi}{\Gamma}$, because
      $\val{\sigma}{\omega,\xi}{\Gamma}$ is a candidate and therefore closed
      under $\leadsto$;
    \item $\app{(\abs{x}{s'})}{t'}$ is neutral, so in
      $\val{\sigma}{\omega,\xi}{\Gamma}$ if all its reducts are;
    \item by induction on $s',t'$ oriented with $\leadsto$ therefore
      $\app{(\abs{x}{s'})}{t'} \in \val{\sigma}{\omega,\xi}{\Gamma}$.
    \end{itemize}
  \end{itemize}
  A similar reasoning applies to $s[\alpha:=\tau]$.
\end{proof}

\begin{lemma}\label{lem_val_computable}
  $\val{\sigma}{\omega,\xi}{\Gamma} \in \Cb_{\omega(\sigma)}^\Gamma$.
\end{lemma}

\begin{proof}
  Induction on~$\sigma$. First, if $\sigma = \alpha$ for a type
  variable~$\alpha$ then
  $\val{\sigma}{\omega,\xi}{\Gamma} = \xi(\alpha) \in
  \Cb_{\omega(\sigma)}^\Gamma$ by definition. If $\sigma = \nat$ then
  $\val{\nat}{\omega,\xi}{\Gamma} \in \Cb_{\nat}^\Gamma$ by
  Lemma~\ref{lem_nat_reducible}.

  Assume $\sigma = \tau_1 \to \tau_2$. We check the conditions in
  Definition~\ref{def_candidate}.
  \begin{enumerate}
  \item Let $t \in \val{\tau_1\to\tau_2}{\omega,\xi}{\Gamma}$ and
    assume there is an infinite reduction
    $t \leadsto t_1 \leadsto t_2 \leadsto t_3 \leadsto \ldots$. By the
    inductive hypothesis $\val{\tau_1}{\omega,\xi}{\Gamma}$ and
    $\val{\tau_2}{\omega,\xi}{\Gamma}$ are candidates. So
    $x \in \val{\tau_1}{\omega,\xi}{\Gamma}$ because it is neutral and
    normal. Then $t x \in \val{\tau_2}{\omega,\xi}{\Gamma}$. Thus
    $t x$~is strongly normalising. But
    $t x \leadsto t_1 x \leadsto t_2 x \leadsto t_3 x \leadsto
    \ldots$. Contradiction.
  \item Let $t \in \val{\tau_1\to\tau_2}{\omega,\xi}{\Gamma}$ and
    $t \leadsto t'$. Let $u \in
    \val{\tau_1}{\omega,\xi}{\Gamma}$. Then
    $t u \in \val{\tau_2}{\omega,\xi}{\Gamma}$. By the inductive
    hypothesis $\val{\tau_2}{\omega,\xi}{\Gamma}$ is a candidate, so
    $t' u \in \val{\tau_2}{\omega,\xi}{\Gamma}$. Also note that
    $\Gamma \proves t' : \omega(\tau_1 \to \tau_2)$ by the subject
    reduction lemma. Hence
    $t' \in \val{\tau_1\to\tau_2}{\omega,\xi}{\Gamma}$.
  \item Let $t$ be neutral and
    $\Gamma \proves t : \omega(\tau_1 \to \tau_2)$ and assume for
    every~$t'$ with $t \leadsto t'$ we have
    $t' \in \val{\tau_1\to\tau_2}{\omega,\xi}{\Gamma}$. Let
    $u \in \val{\tau_1}{\omega,\xi}{\Gamma}$. By the inductive
    hypothesis $\val{\tau_1}{\omega,\xi}{\Gamma}$ is a candidate, so
    $u \in \SN$. By induction on~$\nu(u)$ we show that
    $t u \in \val{\tau_2}{\omega,\xi}{\Gamma}$. Assume
    $t u \leadsto t''$. We show
    $t'' \in \val{\tau_2}{\omega,\xi}{\Gamma}$. Because~$t$ is
    neutral, $t u$ cannot be a redex. So there are two cases.
    \begin{itemize}
    \item $t'' = t u'$ with $u \leadsto u'$. Then
      $t u' \in \val{\tau_2}{\omega,\xi}{\Gamma}$ by the inductive
      hypothesis for~$u$.
    \item $t'' = t' u$ with $t \leadsto t'$. Then
      $t' \in \val{\tau_1\to\tau_2}{\omega,\xi}{\Gamma}$, so
      $t' u \in \val{\tau_2}{\omega,\xi}{\Gamma}$.
    \end{itemize}
    We have thus shown that if $t u \leadsto t''$ then
    $t'' \in \val{\tau_2}{\omega,\xi}{\Gamma}$. By the (main)
    inductive hypothesis $\val{\tau_2}{\omega,\xi}{\Gamma}$ is a
    candidate, and $t u$ is neutral, so also
    $t u \in \val{\tau_2}{\omega,\xi}{\Gamma}$. Since
    $u \in \val{\tau_1}{\omega,\xi}{\Gamma}$ was arbitrary, we have
    shown $t \in \val{\tau_1\to\tau_2}{\omega,\xi}{\Gamma}$.
  \item Assume $t_1,t_2 \in \val{\tau_1\to\tau_2}{\omega,\xi}{\Gamma}$.
    We have already shown that this implies $t_1,t_2 \in \SN$.
    Since $s := \circ_{\omega(\tau_1\to\tau_2)} t_1 t_2$ is neutral,
    we have also already seen that $s \in \val{\tau_1\to\tau_2}{\omega,
    \xi}{\Gamma}$ if $s' \in \val{\tau_1\to\tau_2}{\omega,\xi}{\Gamma}$
    whenever $s \leadsto s'$.
    This we show by induction on $t_1,t_2$ (oriented with $\leadsto$).
    If $s' = \circ_{\omega(\tau_1\to\tau_2)} t_1' t_2$, then note that
    $t_1' \in \val{\tau_1\to\tau_2}{\omega,\xi}{\Gamma}$ because we
    have already shown that $\val{\tau_1\to\tau_2}{\omega,\xi}{\Gamma}$
    is closed under $\leadsto$; thus, we can complete by the induction
    hypothesis.
    If $s' = \circ_{\omega(\tau_1\to\tau_2)} t_1 t_2'$, we complete in
    the same way.
    The only alternative is that $s' = \abs{x:\omega(\tau_1)}{\circ_{
    \omega(\tau_2)} (t_1 x) (t_2 x)}$.
    Let $u \in \val{\tau_1}{\omega,\xi}{\Gamma}$.  Since $t_1,t_2 \in
    \val{\tau_1\to\tau_2}{\omega,\xi}{\Gamma}$, we have that $t_1 u$
    and $t_2 u$ are in $\val{\tau_2}{\omega,\xi}{\Gamma}$ by
    definition.  Since, $\val{\tau_2}{\omega,\xi}{\Gamma}$ is a
    candidate, this means that $\circ_{\omega(\tau_2)} (t_1 u) (t_2 u) =
    (\circ_{\omega(\tau_2)} (t_1 x) (t_2 x))[x:=u]$ is in
    $\val{\tau_2}{\omega,\xi}{\Gamma}$ as well.  By
    Lemma~\ref{lem_abstraction_computable}, we conclude that $s' \in
    \val{\tau_1\to\tau_2}{\omega,\xi}{\Gamma}$.
  \end{enumerate}

  Assume $\sigma = \forall\alpha[\tau]$. We check the conditions in
  Definition~\ref{def_candidate}.
  \begin{enumerate}
  \item Let $t \in \val{\forall\alpha[\tau]}{\omega,\xi}{\Gamma}$ and
    assume there is an infinite reduction
    $t \leadsto t_1 \leadsto t_2 \leadsto t_3 \leadsto
    \ldots$. Let~$\tau'$ be an arbitrary type and let
    $S \in \Cb_{\tau'}^\Gamma$ (e.g.~take~$S$ to be the set of
    terminating terms of type~$\tau'$ in context~$\Gamma$).
    \CK{It is not guaranteed that this will work! For that we really
    do need that $\circ s t$ is SN if $s$ and $t$ are.  However, can't
    we just take $\tau' := \nat$?} \LC{I think $\tau' := \nat$ indeed works here.}
    Then
    $t \tau' \in
    \val{\tau}{\omega[\subst{\alpha}{\tau'}],\xi[\subst{\alpha}{S}]}{\Gamma}$. By
    the inductive hypothesis
    $\val{\tau}{\omega[\subst{\alpha}{\tau'}],\xi[\subst{\alpha}{S}]}{\Gamma}$
    is a candidate, so $t \tau' \in \SN$. But
    $t \tau' \leadsto t_1 \tau' \leadsto t_2 \tau' \leadsto t_3 \tau'
    \leadsto \ldots$. Contradiction.
  \item Let $t \in \val{\forall\alpha[\tau]}{\omega,\xi}{\Gamma}$ and
    $t \leadsto t'$. By the subject reduction lemma
    $\Gamma \proves t' : \omega(\forall\alpha[\tau])$. Let~$\tau'$ be
    a type and~$X \in \Cb_{\tau'}^\Gamma$. Then
    $t \tau' \in
    \val{\tau}{\omega[\subst{\alpha}{\tau'}],\xi[\subst{\alpha}{X}]}{\Gamma}$. By
    the inductive hypothesis
    $\val{\tau}{\omega[\subst{\alpha}{\tau'}],\xi[\subst{\alpha}{X}]}{\Gamma}$
    is a candidate, so
    $t' \tau' \in
    \val{\tau}{\omega[\subst{\alpha}{\tau'}],\xi[\subst{\alpha}{X}]}{\Gamma}$. Therefore
    $t' \in \val{\forall\alpha[\tau]}{\omega,\xi}{\Gamma}$.
  \item Let $t$ be neutral and
    $\Gamma \proves t : \omega(\forall\alpha[\tau])$ and assume for
    every~$t'$ with $t \leadsto t'$ we have
    $t' \in
    \val{\forall\alpha[\tau]}{\omega,\xi}{\Gamma}$. Let~$\tau'$ be a
    type and~$X \in \Cb_{\tau'}^\Gamma$. Assume
    $t \tau' \leadsto t''$. Then $t'' = t' \tau'$ with
    $t \leadsto t'$, because~$t$ is neutral. Hence
    $t \tau' \leadsto t' \tau' \in
    \val{\tau}{\omega[\subst{\alpha}{\tau'}],\xi[\subst{\alpha}{X}]}{\Gamma}$. By
    the inductive
    hypothesis~$\val{\tau}{\omega[\subst{\alpha}{\tau'}],\xi[\subst{\alpha}{X}]}{\Gamma}$
    is a candidate, and also $t \tau'$ is neutral, so
    $t \tau' \in
    \val{\tau}{\omega[\subst{\alpha}{\tau'}],\xi[\subst{\alpha}{X}]}{\Gamma}$. This
    implies that
    $t \in \val{\forall\alpha[\tau]}{\omega,\xi}{\Gamma}$.
  \item Assume
    $t_1,t_2 \in \val{\forall\alpha[\tau]}{\omega,\xi}{\Gamma}$. We
    have already shown that this implies $t_1,t_2 \in \SN$, and since
    $s := \circ_{\omega(\forall\alpha[\tau])} t_1 t_2$ is neutral, that
    $s \in \val{\forall\alpha[\tau]}{\omega,\xi}{\Gamma}$ if $s' \in
    \val{\forall\alpha[\tau]}{\omega,\xi}{\Gamma}$ whenever $s \leadsto
    s'$.  This we show by induction on $t_1,t_2$.
    The cases when $t_1$ or $t_2$ are reduced are immediate with the
    induction hypotheses; the only remaining case is when $s' =
    \tabs{\alpha}{\circ_{\omega(\tau)} (t_1 \alpha) (t_2 \alpha)}$.
    For all types $\sigma$ and $X \in \Cb_{\sigma}^\Gamma$ we have both
    $t_1 \sigma$ and $t_2 \sigma$ in $\val{\tau}{\omega[\subst{\alpha}{
    \sigma}],\xi[\subst{\alpha}{X}]}{\Gamma}$ (by definition of
    $t_1,t_2 \in \val{\forall\alpha[\tau]}{\omega,\xi}{\Gamma}$).
    But then, because $\val{\tau}{\omega[\subst{\alpha}{\sigma}],
    \xi[\subst{\alpha}{X}]}{\Gamma}$ is a candidate by the inductive
    hypothesis, we have $\circ_{\omega(\tau[\subst{\alpha}{\sigma})}
    (t_1 \sigma) (t_2\sigma) = (\circ_{\omega(\tau)} (t_1 \alpha) (t_2
    \alpha))[\subst{\alpha}{\sigma}] \in \val{\tau}{\omega[\subst{
    \alpha}{\sigma}],\xi[\subst{\alpha}{X}]}{\Gamma}$ for all types
    $\sigma$, so $s' \in \val{\forall\alpha[\tau]}{\omega,\xi}{\Gamma}$
    by Lemma~\ref{lem_abstraction_computable}.
  \end{enumerate}
\end{proof}

\begin{lemma}\label{lem_val_subst}
  $\val{\sigma[\subst{\alpha}{\tau}]}{\omega,\xi}{\Gamma} =
  \val{\sigma}{\omega[\subst{\alpha}{\tau}],\xi[\subst{\alpha}{\val{\tau}{\omega,\xi}{\Gamma}}]}{\Gamma}$.
\end{lemma}

\begin{proof}
  TODO
\end{proof}

\begin{lemma}
  $\circ_{\omega(\sigma)} \in \val{\sigma \to \sigma \to
    \sigma}{\omega,\xi}{\Gamma}$ for
  $\circ \in \{ \oplus, \otimes \}$.
\end{lemma}

\begin{proof}
  Follows from Definition~\ref{def_typing} and
  Lemma~\ref{lem_val_computable}.
\end{proof}

\begin{lemma}
  $\flatten_{\omega(\sigma)} \in
  \val{\sigma\to\nat}{\omega,\xi}{\Gamma}$.
\end{lemma}

\begin{proof}
  TODO
\end{proof}

\begin{lemma}
  $\lift_{\omega(\sigma)} \in
  \val{\nat\to\sigma}{\omega,\xi}{\Gamma}$.
\end{lemma}

\begin{proof}
  TODO
\end{proof}

\begin{lemma}
  If $t \in \val{\forall\alpha[\sigma]}{\omega,\xi}{\Gamma}$ then
  $t \tau \in \val{\sigma[\subst{\alpha}{\tau}]}{\omega,\xi}{\Gamma}$
  for any type~$\tau$.
\end{lemma}

\begin{proof}
  By Lemma~\ref{lem_val_computable} the
  set~$\val{\tau}{\omega,\xi}{\Gamma}$ is a candidate of
  type~$\tau$. By hypothesis
  $t \tau \in
  \val{\sigma}{\omega[\subst{\alpha}{\tau}],\xi[\subst{\alpha}{\val{\tau}{\omega,\xi}{\Gamma}}]}{\Gamma}$. Hence
  $t \tau \in \val{\sigma[\subst{\alpha}{\tau}]}{\omega,\xi}{\Gamma}$
  by Lemma~\ref{lem_val_subst}.
\end{proof}

\begin{lemma}\label{lem_typable_computable}
  If $\Gamma \proves t : \sigma$ then
  $\omega(t) \in \val{\sigma}{\omega,\xi}{\Gamma}$.
\end{lemma}

\begin{proof}
  Idea: by induction on~$t$, using the previous lemmas. One
  generalizes the inductive hypothesis to: if
  $x_1 : \tau_1,\ldots,x_n:\tau_n \proves t : \sigma$ then for all
  $u_1\in\val{\tau_1}{\omega,\xi}{\Gamma},\ldots,u_n\in\val{\tau_n}{\omega,\xi}{\Gamma}$
  we have
  $\omega(t[\subst{x_1}{u_1},\ldots,\subst{x_n}{u_n}]) \in
  \val{\sigma}{\omega,\xi}{\Gamma}$.
\end{proof}

\begin{corollary}
  If $\Gamma \proves t : \sigma$ then $t \in \SN$.
\end{corollary}

\begin{proof}
  Follows from Lemma~\ref{lem_typable_computable},
  Lemma~\ref{lem_val_computable} and Definition~\ref{def_candidate}.
\end{proof}

\begin{lemma}
Every term $s \in \Iterms$ with $\FV(s) = \FTV(s) = \emptyset$ reduces
to a unique final interpretation term $s\downarrow$.
\end{lemma}

\begin{proof}
By proving termination and local confluence of $\leadsto$ (although it
actually suffices to only prove local confluence for fully closed terms).

TODO.
\qed
\end{proof}

\begin{lemma}\label{lem_final_nat}
The only final interpretation terms of type $\nat$ are the natural
numbers.
\end{lemma}

\begin{proof}
  This is~NOT~TRUE. Consider
  $\oplus_{\nat\to\nat} \lift_\nat \lift_\nat n$. Need to add more
  rewrite rules?
  \CK{Better now?} \LC{Yes, I think it works now.}
\end{proof}

\subsection{Defining $\succ$ and $\succeq$}

We will define $\succ$ and $\succeq$ on elements of $\World$, using
coinduction: $s \succ t$ (resp.\ $s \succeq t$) if $s \succ_\sigma t$
(resp.\ $s \succeq_\sigma t$) can be obtained for $\sigma$ the type of
$s,t$, following Definition~\ref{def:succ}.

\begin{definition}\label{def:succ}
  Let $R \in \{ \succ,\succeq \}$. For~$s,t \in \World_\sigma$, the
  relation $s\ R_{\sigma}\ t$ is defined coinductively by the
  following rules.
  \[
    \begin{array}{c}
    \infer={s\ R_\nat\ t}{s\ R\ t \text{ in natural
        numbers}}\quad\quad
    \infer={s\ R_{\sigma\to\tau}\ t}{\app{s}{q}\da\ R_{\tau}\ \app{t}{q}\da
      \text{ for every } q \in \World_\sigma} \\ \\
    \infer={s\ R_{\forall\alpha[\sigma]}\ t}{\tapp{s}{\tau}\da\ R_{\sigma[\subst{\alpha}{\tau}]}\ \tapp{t}{\tau}\da
      \text{ for every closed type } \tau}
    \end{array}
  \]
\end{definition}

Note that in the case for~$\nat$ the terms~$t,s$ are natural numbers
by Lemma~\ref{lem_final_nat}.

\LC{This definition was incorrect before, because e.g.~$\app{s}{q}$
  need not be in normal form.}

\subsection{Properties of $\succ$ and $\succeq$}

We're going to at least need to see that $\succ$ is a well-founded ordering:

\begin{lemma}
$\succ$ is well-founded.
\end{lemma}

\begin{proof}
  By induction on the size of the type~$\tau$ one shows that there
  does not exist an infinite sequence $t_1 \succ_\tau t_2 \succ_\tau
  t_3 \succ_\tau \ldots$ For instance, if $t_1
  \succ_{\forall\alpha[\tau]} t_2 \succ_{\forall\alpha[\tau]} t_3
  \succ_{\forall\alpha[\tau]} \ldots$ then $\tapp{t_1}{\nat}\da
  \succ_{\tau[\subst{\alpha}{\nat}]} \tapp{t_2}{\nat}\da
  \succ_{\tau[\subst{\alpha}{\nat}]} \tapp{t_3}{\nat}\da
  \succ_{\tau[\subst{\alpha}{\nat}]} \ldots$, which is impossible by
  the inductive hypothesis.
\end{proof}

\begin{lemma}
Both $\succ$ and $\succeq$ are transitive.
\end{lemma}

\begin{proof}
  We show this for~$\succeq$, the proof for~$\succ$ being
  analogous. We proceed by coinduction.

  If $t_1 \succeq_\nat t_2 \succeq_\nat t_3$ then
  $t_1\da \ge t_2\da \ge t_3\da$, so $t_1\da \ge t_3\da$. Thus
  $t_1 \succeq_\nat t_3$.

  If $t_1 \succeq_{\sigma\to\tau}t_2\succeq_{\sigma\to\tau}t_3$ then
  $\app{t_1}{q}\da\succeq_{\tau}\app{t_2}{q}\da\succeq_\tau\app{t_3}{q}\da$
  for $q \in \World_\sigma$. Hence
  $\app{t_1}{q}\da\succeq_\tau\app{t_3}{q}\da$ for $q \in
  \World_\sigma$ by the coinductive hypothesis. Thus
  $t_1\succeq_{\sigma\to\tau} t_3$.

  If $t_1
  \succeq_{\forall\alpha[\sigma]}t_2\succeq_{\forall\alpha[\sigma]}t_3$
  then
  $\tapp{t_1}{\tau}\da\succeq_{\sigma[\subst{\alpha}{\tau}]}\tapp{t_2}{\tau}\da\succeq_{\sigma[\subst{\alpha}{\tau}]}\tapp{t_3}{\tau}\da$
  for any closed type~$\tau$. Hence
  $\tapp{t_1}{\tau}\da\succeq_{\sigma[\subst{\alpha}{\tau}]}\tapp{t_3}{\tau}\da$
  by the coinductive hypothesis. Thus
  $t_1\succeq_{\forall\alpha[\sigma]} t_3$.\qed
\end{proof}

And that $\succeq$ is a quasi-ordering:

\begin{lemma}
$\succeq$ is reflexive.
\end{lemma}

\begin{proof}
  By coinduction.\qed
\end{proof}

Finally, they must be compatible:

\begin{lemma}\label{lem:compatibility}
We have $\succ \cdot \succeq\ \subseteq\ \succ$
\end{lemma}

\begin{proof}
By coinduction, analogous to the transitivity proof.\qed
\end{proof}

\CK{Do we also have $\succeq \cdot \succ\ \subseteq\ \succ$? I'd like
to use that.\medskip}

\CK{I think that's all that absolutely \emph{has} to be proven to make
the argument work.  However, to work with these things we will need a
little more\dots}

In the following, we extend $\succ$ and $\succeq$ to non-final
interpretation terms, by defining $s \succ t$ (resp. $s \succeq t$) if
$s\downarrow \succ t$ (resp. $s\downarrow \succeq t\downarrow$).
\CK{Note that for this we do need to prove that $\leadsto$ has unique
normal forms, but if we don't define this, then the following lemma is
meaningless, I think.}

\begin{lemma}\label{lem:plusparts}
For all interpretation types $\sigma$, interpretation terms $s,t$ of
type $\sigma$ and $n > 0$ we have:
\begin{enumerate}
\item $\oplus_{\sigma}(s,t) \succeq s$ and
      $\oplus_{\sigma}(s,t) \succeq t$;
\item $\oplus_{\sigma}(s,\lift_{\sigma}(n)) \succ s$ and
      $\oplus_{\sigma}(\lift_{\sigma}(n),t) \succ t$.
\end{enumerate}
\end{lemma}

\begin{proof}
TODO

\LC{I think these also hold by coinduction because they hold for
type~$\nat$. But one needs to generalize the coinductive hypothesis to
$\app{\app{\oplus}{s}}{t} \cdot t_1 \cdot \ldots \cdot t_n
\succeq_\sigma s \cdot t_1 \cdot \ldots \cdot t_n$ (and with some
additional type arguments also).}

\end{proof}

\begin{lemma}\label{lem:liftgreater}
If $n \geq m$ then $\lift_\sigma(n) \succeq \lift_\sigma(m)$ for all
types $\sigma$.
\end{lemma}

\begin{proof}
TODO
\end{proof}

\begin{lemma}\label{lem:plustimesmonotonic}
If $s,t,u$ are terms of type $\sigma$ and $s \succeq t$, then
$s \oplus_\sigma u \succeq t \oplus_\sigma u$ and $s \otimes_\sigma u
\succeq t \otimes_\sigma u$.  Moreover, if even $s \succ t$ then we
have $s \oplus_\sigma u \succ t$, and if $u \succeq \lift_\sigma(1)$
then also $s \otimes_\sigma u \succ t \otimes_\sigma u$.
\end{lemma}

\begin{proof}
TODO
\end{proof}

In the following, we denote $s \approx t$ if both $s \succeq t$ and
$t \succeq s$.  We observe that standard equality properties of
addition and multiplication extend to interpretation terms of extended
types:

\begin{lemma}\label{lem:approxproperties}
For all interpretation types $\sigma$ and interpretation terms $s,t,u$
of type $\sigma$, we have:
\begin{enumerate}
\item\label{lem:approx:symmetry}
  $\oplus_\sigma(s,t) \approx \oplus_\sigma(t,s)$ and
  $\otimes_\sigma(s,t) \approx \otimes_\sigma(t,s)$;
\item\label{lem:approx:assoc}
  $\oplus_\sigma(s,\oplus_\sigma(t,u)) \approx \oplus_\sigma(
    \oplus_\sigma(s,t),u)$ and
  $\otimes_\sigma(s,\otimes_\sigma(t,u)) \approx \otimes_\sigma(
    \otimes_\sigma(s,t),u)$;
\item\label{lem:approx:distribution}
  $\otimes_\sigma(s,\oplus(t,u)) \approx \oplus_\sigma(\otimes_\sigma(
  s,t),\otimes_\sigma(s,u))$;
\item\label{lem:approx:neutral}
  $\oplus_\sigma(\lift_\sigma(0), s) \approx s$ and
  $\otimes_\sigma(\lift_\sigma(1), s) \approx s$.
\end{enumerate}
\end{lemma}

\begin{proof}
TODO
\end{proof}

\section{Systems of interest and their properties}\label{sec:systems}

The systems of interest are sets of terms with a rewriting relation on
them.  Interestingly, $\Iterms$ can be seen as an instance of this general
scheme.

\subsection*{\ref{sec:systems}.0\quad Type context variables}

In the following, we will use \emph{type contexts}.  A type context
is an expression $\meta{\alpha}{\rho_1,\dots,\rho_n}$ where $\alpha$
is a type variable and $\rho_1,\dots,\rho_n$ are types.  An
\emph{interpretation type scheme} is generated by the clauses of
Definition~\ref{def:itypes} and in addition:
\[
\meta{\alpha}{\rho_1,\dots,\rho_n} \in \ITypes'\ \text{if}\
  \alpha \in \Typevars\ \text{and}\ \rho_1,\dots,\rho_n \in \ITypes'
\]
A type substitution $\gamma$ can only be applied to an interpretation
type scheme $\sigma$ if for every occurrence $\meta{\alpha}{\rho_1,
\dots,\rho_n}$ in $\sigma$, the type variable $\alpha$ is in the domain
of $\gamma$ and $\gamma(\alpha)$ has the form $\tabs{\beta_1 \dots
\beta_n}{\tau}$.  The type substitution $\sigma\gamma$ is obtained as
follows:
\begin{itemize}
\item $\alpha\gamma = \gamma(\alpha)$ if $\alpha$ is in the domain of
  $\gamma$;
\item $\alpha\gamma = \alpha$ if $\alpha \in \Typevars$ and $\alpha$
  is not in the domain of $\gamma$;
\item $\meta{\alpha}{\rho_1,\dots,\rho_n}\gamma = \subst{\tau}{[
  \beta_1:=\rho_1\gamma,\dots,\beta_n:=\rho_n\gamma]}$ if $\gamma(\alpha) =
  \tabs{\beta_1\dots \beta_n}{\tau}$;
\item $(\tabs{\alpha}{\tau})\gamma = \tabs{\alpha}{(\tau\gamma)}$ if
  $\alpha$ is not in the domain of $\gamma$;
  if $\alpha$ is in this domain, then $\alpha$-conversion can be used
  to rename it to a fresh variable first;
\item $(\sigma \arrtype \tau)\gamma = (\sigma\gamma) \arrtype (\tau
  \gamma)$
\item $(\sigma \times \tau)\gamma = (\sigma\gamma) \times (\tau\gamma)$
\end{itemize}

In this way, a type variable context $\meta{\alpha}{\rho_1,\dots,
\rho_n}$ is essentially instantiated by a type in which $\rho_1,\dots,
\rho_n$ may (but don't have to) occur.  This is important when the
$\rho_i$ contain bound type variables.  For example, the
interpretation type scheme $\tabs{\alpha}{\beta}$ can only be
instantiated by interpretation types of the form $\tabs{\alpha}{\tau}$
where the bound variable $\alpha$ does not occur in $\tau$, while the
interpretation type scheme $\tabs{\alpha}{\beta[\alpha]}$ is
instantiated by all interpretation types of the form
$\tabs{\alpha}{\sigma}$.

\subsection{Systems of interest}

Types are built from two sets of type constructors (first-order and
second-order respectively) which must include the type constructors
$\arrtype$ and $\forall$ respectively.

\begin{definition}
We assume given a fixed set $\TypeConstructors$ of \emph{type
constructors}, each paired with an integer \emph{arity}, and a set
$\TypeQuantifiers$ of \emph{type quantifiers}, each quantifier also
paired with an integer arity; $\TypeConstructors$ must contain
$\arrtype : 2$ and $\TypeQuantifiers$ must include $\forall : 1$.
The set $\Types$ of \emph{type schemes} is given by:
\begin{itemize}
\item $\alpha \in \Types$ for all $\alpha \in \Typevars$
\item $\con(\sigma_1,\dots,\sigma_n) \in \Types$ if $\con : n \in
  \TypeConstructors$ and $\sigma_1,\dots,\sigma_n \in \Types$
  (but we denote $\arrtype$ infix)
\item $\qquant{?}{\alpha_1 \dots \alpha_n}{\sigma} \in \Types$ if
  $? : n \in \TypeQuantifiers$, each $\alpha_i \in \Typevars$ and
  $\sigma \in \Types$
\item $\meta{\alpha}{\sigma_1,\dots,\sigma_n} \in \Types$ for all
  $\alpha \in \Typevars$ and $\sigma_1,\dots,\sigma_n \in \Types$.
\end{itemize}
\emph{Types} are type schemes without occurrences of type variable
contexts $\meta{\alpha}{\sigma_1,\dots,\sigma_n}$.
We will not consider type schemes where type variable occurrences
use a \emph{bound} type variable $\alpha$.
We let $\FTV(\sigma)$ be defined in the obvious way (much like
Definition~\ref{def:itypes}, and also including type variables at
the head of a type variable context).
\end{definition}

Terms are built from a set of (possibly type-indexed) function symbols,
using abstraction and application as for interpretation terms.

\begin{definition}
We assume given a fixed set $\Sigma$ of \emph{function symbols}, each
indexed with $0$ or more type variables and paired with an arity $k$
as well as $k$ input types and one output types, denoted
$\mathtt{f}_{\alpha_1,\dots,\alpha_n} : [\sigma_1 \times \dots \times
\sigma_k] \arrtype \tau$; we require that $\FTV(\sigma_1) \cup \dots
\cup \FTV(\sigma_k) \cup \FTV(\tau) \subseteq \{ \alpha_1,\dots,
\alpha_n\}$.
Every function symbol $\mathtt{f}$ occurs only with one type
declaration.

The set $\Terms$ of terms consists of those expressions $s$ such that
$\Gamma \vdash s : \sigma$ can be derived for some type $\sigma$ and
environment $\Gamma$ using the following clauses:
\begin{itemize}
\item $\Gamma \vdash x : \sigma$ for every $(x : \sigma) \in \Gamma$.
\item $\Gamma \vdash \mathtt{f}_{\vec{\rho}}(s_1,\dots,s_k) :
  \tau\gamma$ if $\mathtt{f}_{\alpha_1,\dots,\alpha_n} : [\sigma_1
  \times \dots \times \sigma_k] \arrtype \tau \in \Sigma$ and
  $\gamma$ is a type substitution and $\vec{\rho} =
  [\alpha_1\gamma,\dots,\alpha_n\gamma]$ and $\Gamma \vdash s_i :
  \sigma_i\gamma$ for $1 \leq i \leq k$
\item $\Gamma \vdash \abs{x:\sigma}{s} : \sigma \arrtype \tau$ if $x
  \in \Vars$ and $\Gamma \uplus \{ x : \sigma \} \vdash s : \tau$.
\item $\Gamma \vdash \tabs{\alpha}{s} : \quant{\alpha}{\sigma}$ if
  $\alpha \in \Typevars$ and $\Gamma \vdash s : \sigma$ and for all
  $(x : \tau) \in \Gamma$: $\alpha \notin \FTV(\tau)$
%\item $\Gamma \vdash \tapp{s}{\tau} : \sigma[\subst{\alpha}{\tau}]$ if
%  $\Gamma \vdash s : \quant{\alpha}{\sigma}$
\end{itemize}
%Rather than using a pair $(k,\sigma_1 \arrtype \dots \arrtype \sigma_k
%\arrtype \tau)$, we will denote the type declaration of a function
%symbol as $[\sigma_1 \times \dots \times \sigma_k] \arrtype \tau$.
\end{definition}

Note that there is no explicit application; application can be modelled
by including symbol $@_{\alpha,\beta} : [\alpha \arrtype \beta \times
\alpha] \arrtype \beta$ in $\Sigma$.
Similarly, type application is modelled through a symbol
$\mathtt{A}_{\alpha,\beta} : [\quant{\xi}{\meta{\alpha}{\xi}} \arrtype
\meta{\alpha}{\beta}$.

The rules are simply an infinite set of term pairs, whose monotonic
closure generates the rewrite relation.

\begin{definition}
We fix an infinite variable environment $\Gamma$,
and assume given a set $\Rules$ of term pairs $(\ell,r)$, such that:
\begin{itemize}
\item $\FV(r) \subseteq \FV(\ell) \subseteq \mathit{keys}(\Gamma)$;
\item $\ell$ and $r$ have the same type under $\Gamma$;
\item $\FTV(\ell) = \FTV(r) = \emptyset$;
  %, and all type variables in
  %the range of $\Gamma$ are bound;
\item $\Rules$ is stable: if $(\ell,r) \in \Rules$ and $\gamma$ is a
  substitution, then $(\ell\gamma,r\gamma) \in \Rules$.
\end{itemize}
The reduction relation $\arr{\Rules}$ is the smallest monotonic
relation that contains $\Rules$.
\end{definition}

\subsubsection{An example system.}

For the system of urzy\_emb, we have the following type constructors
and quantifiers:
\[
\begin{array}{c}
\TypeConstructors = \{\quad
  \bot : 0,\quad
  \mathtt{or} : 2,\quad
  \mathtt{and} : 2,\quad
  \Rightarrow : 2\quad
  \}\quad \cup\quad
  \{\quad \mathtt{prop}_i : 0 \mid i \in \mathbb{N}\quad \} \\
\TypeQuantifiers = \{\quad
  \forall : 1,\quad
  \exists : 1\quad
  \} \\
\end{array}
\]

We have the following function symbols:
\[
\begin{array}{rclrcl}
\epsilon_\alpha & : & [\bot] \arrtype \alpha &
\pi^1_{\alpha,\beta} & : & [\mathtt{and}(\alpha,\beta)] \arrtype \alpha \\
@_{\alpha,\beta} & : & [\alpha \arrtype \beta \times \alpha] \arrtype \beta &
\pi^2_{\alpha,\beta} & : & [\mathtt{and}(\alpha,\beta)] \arrtype \beta \\
\mathtt{in}^1_{\alpha,\beta} & : & [\alpha] \arrtype
  \mathtt{or}(\alpha,\beta) &
\mathtt{pair}_{\alpha,\beta} & : & [\alpha \times \beta] \arrtype
  \mathtt{and}(\alpha,\beta) \\
\mathtt{in}^2_{\alpha,\beta} & : & [\beta] \arrtype
  \mathtt{or}(\alpha,\beta) &
\mathtt{tapp}_{\alpha,\beta} & : &
  [\quant{\xi}{\meta{\alpha}{\xi}}] \arrtype \meta{\alpha}{\beta} \\
\mathtt{case}_{\alpha,\beta,\xi} & : & [\mathtt{or}(\alpha,\beta) \times
  \alpha \arrtype \xi \times \beta \arrtype \xi] \arrtype \xi\ \ \ &
\mathtt{let}_{\alpha,\beta} & : &
  \qquant{\exists}{\xi}{\meta{\alpha}{\xi}} \times
  \quant{\xi}{\alpha\langle\xi\rangle \arrtype \beta}] \arrtype \beta \\
\mathtt{ext}_{\alpha,\beta} & : & [\meta{\alpha}{\beta}] \arrtype
  \qquant{\exists}{\xi}{\meta{\alpha}{\xi}} \\
\end{array}
\]
(Note that in the $\mathtt{let}$ symbol, the definition of type
substitution implies that in all instances $\mathtt{let}_{\sigma,\tau}$
the type $\tau$ cannot contain the bound type variable $\xi$.)

And finally the rules.  These are represented as \emph{rule schemes},
representing infinitely many rules at once.  Type substitution is also
done on indexes of function symbols (thus giving essentially
different symbols, but with correct types).
\[
\begin{array}{rcl}
@_{\sigma,\tau}(\abs{x}{s},t) & \to & s[x:=t] \\
\mathtt{tapp}_{\quant{\alpha}{\sigma},\tau}(\tabs{\alpha}{s}) & \to &
  s[\alpha:=\tau] \\
\pi^1_{\sigma,\tau}(\mathtt{pair}_{\sigma,\tau}(s,t)) & \to & s \\
\pi^2_{\sigma,\tau}(\mathtt{pair}_{\sigma,\tau}(s,t)) & \to & s \\
\mathtt{case}_{\sigma,\tau,\rho}(\mathtt{in}^1_{\sigma,\tau}(u),
  \abs{x}{s},\abs{y}{t}) & \to & s[x:=u] \\
\mathtt{case}_{\sigma,\tau,\rho}(\mathtt{in}^2_{\sigma,\tau}(u),
  \abs{x}{s},\abs{y}{t}) & \to & t[x:=u] \\
\mathtt{let}_{\qquant{\forall}{\alpha}{\sigma},\rho}(
  \mathtt{ext}_{\qquant{\forall}{\alpha}{\sigma},\tau}(s),\tabs{\alpha}{
    \abs{x}{t}}) & \to & t[\alpha:=\tau][x:=s] \\
\end{array}
\]
\[
\begin{array}{rcl}
\epsilon_\tau(\epsilon_\bot(s)) & \to & \epsilon_\tau(s) \\
@_{\sigma,\tau}(\epsilon_{\sigma \arrtype \tau}(s),t) & \to &
  \epsilon_\tau(s) \\
\mathtt{tapp}_{\quant{\alpha}{\sigma},\tau}(
  \epsilon_{\quant{\alpha}{\sigma}}(s)) & \to &
  \epsilon_{\sigma[\alpha:=\tau]}(s) \\
\pi^1_{\sigma,\tau}(\epsilon_{\mathtt{and}(\sigma,\tau)}(s)) & \to &
  \epsilon_\sigma(s) \\
\pi^2_{\sigma,\tau}(\epsilon_{\mathtt{and}(\sigma,\tau)}(s)) & \to &
  \epsilon_\tau(s) \\
\mathtt{case}_{\sigma,\tau,\rho}(\epsilon_{\mathtt{or}(\sigma,\tau)}(
  u),\abs{x}{s},\abs{y}{t}) & \to & \epsilon_\rho(s) \\
\mathtt{let}_{\qquant{\forall}{\alpha}{\sigma},\rho}(\epsilon_{\qquant{
  \forall}{\alpha}{\sigma}}(s),\tabs{\alpha}{\abs{x}{t}}) & \to &
  \epsilon_\rho(s) \\
\end{array}
\]
\begin{itemize}
%\[
%\begin{array}{rcl}
\item $
\epsilon_\rho(\mathtt{case}_{\sigma,\tau,\bot}(u,\abs{x}{s},\abs{y}{t}))
  %& \to &
  \to
  \mathtt{case}_{\sigma,\tau,\rho}(u,\abs{x}{\epsilon_\rho(s)},
  \abs{y}{\epsilon_\rho(t)}) $%\\
\item $
@_{\rho,\pi}(\mathtt{case}_{\sigma,\tau,\rho \arrtype \pi}(u,
  \abs{x}{s},\abs{y}{t}),v) %& \to &
  \to
  \mathtt{case}_{\sigma,\tau,\pi}(u,
  \abs{x}{@_{\rho,\pi}(s,v)},\abs{y}{@_{\rho,\pi}(t,v)}) $%\\
\item $
\mathtt{tapp}_{\quant{\alpha}{\rho},\pi}(\mathtt{case}_{\sigma,\tau,
  \quant{\alpha}{\rho}}(u,\abs{x}{s},\abs{y}{t})) %& \to &
  \to
  \mathtt{case}_{\sigma,\tau,\rho[\alpha:=\pi]}(u,
  \abs{x}{\mathtt{tapp}_{\quant{\alpha}{\rho},\pi}(s)},\\
  \abs{y}{\mathtt{tapp}_{\quant{\alpha}{\rho},\pi}(t)}) $%\\
\item $
\pi^1_{\rho,\pi}(\mathtt{case}_{\sigma,\tau,\mathtt{and}(\rho,\pi)}(u,
  \abs{x}{s},\abs{y}{t})) %& \to &
  \to
  \mathtt{case}_{\sigma,\tau,\rho}(u,\abs{x}{\pi^1_{\rho,\pi}(s)},
  \abs{y}{\pi^1_{\rho,\pi}(t)}) $%\\
\item $
\pi^2_{\rho,\pi}(\mathtt{case}_{\sigma,\tau,\mathtt{and}(\rho,\pi)}(u,
  \abs{x}{s},\abs{y}{t})) %& \to &
  \to
  \mathtt{case}_{\sigma,\tau,\pi}(u,\abs{x}{\pi^2_{\rho,\pi}(s)},
  \abs{y}{\pi^2_{\rho,\pi}(t)}) $%\\
\item $
\mathtt{case}_{\rho,\pi,\xi}(\mathtt{case}_{\sigma,\tau,\mathtt{or}(
  \rho,\pi)}(u,\abs{x}{s},\abs{y}{t}),\abs{z}{v},\abs{a}{w}) %& \to &
  \to\\
  \mathtt{case}_{\sigma,\tau,\xi}(u,
    \abs{x}{\mathtt{case}_{\rho,\pi,\xi}(s,\abs{z}{v},\abs{a}{w})},
    \abs{y}{\mathtt{case}_{\rho,\pi,\xi}(t,\abs{z}{v},\abs{a}{w})}) $%\\
\item $
\mathtt{let}_{\qquant{\forall}{\alpha}{\rho}}(
  \mathtt{case}_{\sigma,\tau,\qquant{\forall}{\alpha}{\rho}}(
  u,\abs{x}{s},\abs{y}{t}),v) %& \to &
  \to\\
  \mathtt{case}_{\sigma,\tau,\rho}(u,
  \abs{x}{\mathtt{let}_{\qquant{\forall}{\alpha}{\rho}}(s,v)},
  \abs{y}{\mathtt{let}_{\qquant{\forall}{\alpha}{\rho}}(t,v)})
  $%\\
%\end{array}
%\]
\end{itemize}
\begin{itemize}
\item $\epsilon_\tau(\mathtt{let}_{\qquant{\forall}{\alpha}{\sigma},
  \bot}(s,t)) \to
  \mathtt{let}_{\qquant{\forall}{\alpha}{\sigma},\tau}(s,\epsilon_\tau(t))$
\item $@_{\tau,\rho}(\mathtt{let}_{\qquant{\forall}{\alpha}{\sigma},
  \tau \arrtype \rho}(s,t),u) \to
  \mathtt{let}_{\qquant{\forall}{\alpha}{\sigma},\rho}(s,@_{\tau,\rho}(t,
  u))$
\item $\mathtt{tapp}_{\quant{\alpha}{\tau},\rho}(
\mathtt{let}_{\qquant{\forall}{\alpha}{\sigma},\quant{\alpha}{\tau}}(s,t))
  \to
  \mathtt{let}_{\qquant{\forall}{\alpha}{\sigma},\tau[\alpha:=\rho]}(s,
  \mathtt{tapp}_{\quant{\alpha}{\tau},\rho}(t))$
\item $\pi^1_{\tau,\rho}(\mathtt{let}_{\qquant{\forall}{\alpha}{\sigma},
  \mathtt{and}(\tau,\rho)}(s,t)) \to
  \mathtt{let}_{\qquant{\forall}{\alpha}{\sigma},\tau}(s,\pi^1_{\tau,
  \rho}(t))$
\item $\pi^2_{\tau,\rho}(\mathtt{let}_{\qquant{\forall}{\alpha}{\sigma},
  \mathtt{and}(\tau,\rho)}(s,t)) \to
  \mathtt{let}_{\qquant{\forall}{\alpha}{\sigma},\rho}(s,\pi^2_{\tau,
  \rho}(t))$
\item $\mathtt{case}_{\tau,\rho,\pi}(
  \mathtt{let}_{\qquant{\forall}{\alpha}{\sigma},\mathtt{or}(\tau,
  \rho)}(s,t),\abs{x}{u},\abs{y}{v}) \to
  \mathtt{let}_{\qquant{\forall}{\alpha}{\sigma},\pi}(s,\mathtt{case}_{
  \tau,\rho,\pi}(t,\abs{x}{u},\abs{y}{v}))$
\item $\mathtt{let}_{\qquant{\forall}{\beta}{\tau},\rho}(\mathtt{let}_{\qquant{\forall}{\alpha}{\sigma},\qquant{\forall}{\beta}{\tau}}(s,t),u) \to
  \mathtt{let}_{\qquant{\forall}{\alpha}{\sigma},\rho}(s,\mathtt{let}_{\qquant{\forall}{\beta}{\tau},\rho}(t,u))$
\end{itemize}

%\subsection*{General proposal}
%
%The following is a generalised alternative, that I think could also work.
%However, if we don't actually get any additional systems out of it, then
%that is probably not worth the effort of exploring.
%
%\begin{definition}
%We assume given the following sets of type constructors:
%\begin{itemize}
%\item $\TypeConstructors_{\mathsf{func}}$: a set of \emph{function
%  type constructors} (possibly indexed with a number of types) along
%  with an integer arity;
%\item $\TypeConstructors_{\mathsf{abs}}$: a set of \emph{abstraction
%  type constructors}
%\end{itemize}
%\end{definition}

\subsection{Interpreting interesting terms}

All terms will be mapped to interpretation terms, which are compared
using $\succ$ to hopefully obtain a decrease that can be used with
rule removal.

To start, all types must be mapped to the types of interpretation
terms.  This we do using a \emph{type constructor mapping}:

\begin{definition}
A \emph{type constructor mapping} is a function $\Typemap$ whose domain
is the set of type constructors and quantifiers, such that:
\begin{itemize}
\item for $\con : k \in \TypeConstructors$:
  $\Typemap(\con)$ is a type $\sigma$ with $\FTV(\sigma)
  \subseteq \{\alpha_1,\dots,\alpha_k\}$;
\item for $\mathtt{Q} : k \in \TypeQuantifiers \setminus \{\forall:1\}$:
  $\Typemap(\mathtt{Q})$ is a type scheme $\sigma$ with $\FTV(\sigma)
  \subseteq \{ \alpha \}$, and where $\alpha$ may occur only in the
  form $\alpha\langle\sigma_1,\dots,\sigma_k\rangle$;
\item $\Typemap(\arrtype) = \alpha_1 \arrtype \alpha_2$ and
  $\Typemap(\forall) = \quant{\beta}{\alpha\langle\beta\rangle}$
\end{itemize}
For a fixed type mapping $\Typemap$, we define $\typeinterpret{\sigma}$
as follows:
\[
\begin{array}{rcl}
\typeinterpret{\alpha} & = & \alpha \\
\typeinterpret{\con(\tau_1,\dots,\tau_n)} & = &
  \Typemap(\con)[\alpha_1:=\typeinterpret{\tau_1},\dots,\alpha_n:=
  \typeinterpret{\tau_n}] \\
\typeinterpret{\qquant{\mathtt{Q}}{\alpha_1 \dots \alpha_n}{\tau}} & =
  & \Typemap(\mathtt{Q})[\alpha:=\quant{\beta_1 \dots \beta_k}{\tau}] \\
\end{array}
\]
\end{definition}

Thus, for example $\typeinterpret{\quant{\alpha}{\sigma}} =
\quant{\alpha}{\typeinterpret{\sigma}}$ and $\typeinterpret{\sigma
\arrtype \tau} = \typeinterpret{\sigma} \arrtype \typeinterpret{\tau}$.

Similarly, we employ a \emph{symbol mapping} as an aid to interpret
\emph{terms}.

\begin{definition}
A \emph{symbol mapping} is a function $\Termmap$ which assigns to each
indexed function symbol $\mathtt{f}_{\alpha_1,\dots,\alpha_n} :
[\sigma_1 \times \dots \times \sigma_k] \arrtype \tau \in \Sigma$ an
interpretation term $\Termmap(\mathtt{f}_{\alpha_1,\dots,\alpha_n})$
of the form $\abs{x_1 : \interpret{\sigma_1} \dots x_k : \interpret{
\sigma_k}}{t}$ where $\{ x_1 : \interpret{\sigma_1}, \dots, x_k :
\interpret{\sigma_k} \} \vdash t : \interpret{\tau}$.  Here, the only
type variables that may occur in $\Termmap(\mathtt{f}_{\alpha_1,\dots,
\alpha_n})$ are the elements of $\{\alpha_1,\dots,\alpha_n\}$.
For a fixed symbol mapping $\Termmap$, we define $\interpret{s}$ as
follows:
\[
\begin{array}{rcl}
\interpret{x} & = & x \\
\interpret{\tabs{\alpha}{s}} & = & \tabs{\alpha}{\interpret{s}} \\
\interpret{\abs{x:\sigma}{s}} & = & \abs{x:\typeinterpret{\sigma}}{
  \interpret{s}} \\
\interpret{\afun_{\rho_1,\dots,\rho_n}(s_1,\dots,s_k)} & = &
  t[x_1:=\interpret{s_1},\dots,x_k:=\interpret{s_k}] \\
  & & \text{if}\ \Termmap(\afun_{\alpha_1,\dots,\alpha_n})[\alpha_1:=
  \typeinterpret{\rho_1},\dots,\alpha_n:=\typeinterpret{\rho_n}] =
  \abs{x_1 \dots x_k}{t} \\
\end{array}
\]
\end{definition}

Interpretation mapping preserves typing, in a sense:

\begin{lemma}
Suppose $\Gamma \vdash s : \sigma$, and let $\Delta := \{ (x :
\typeinterpret{\tau}) \mid (x : \tau) \in \Gamma \}$.  Then
$\Delta \vdash \interpret{s} : \typeinterpret{\sigma}$.
\end{lemma}

\begin{proof}
By induction on the form of $s$.
The variable case is obvious.
The case where $s$ is an abstraction $\abs{x:\tau}{s'}$ or a type
abstraction $\tabs{\alpha}{s'}$ are both immediate with the induction
hypothesis and the definition of type interpretation.
So consider the case where $s = \afun_{\rho_1,\dots,\rho_n}(s_1,\dots,
s_k)$.  We have:
\begin{itemize}
\item $\afun_{\alpha_1,\dots,\alpha_n} : [\tau_1' \times \dots \times
  \tau_k'] \arrtype \sigma' \in \Sigma$ for some $\vec{\tau'},\sigma'$;
\item $\sigma = \sigma'[\alpha_1:=\rho_1,\dots,\alpha_n:=\rho_n]$ ;
\item writing $\tau_i := \tau_i'[\alpha_1:=\rho_1,\dots,\alpha_n:=
  \rho_n]$ for $1 \leq i \leq k$, we have $\Gamma \vdash s_i : \tau_i$;
\item by the induction hypothesis, $\Delta \vdash \interpret{s_i} :
  \interpret{\tau_i}$;
\item we have $\Termmap(\afun_{\alpha_1,\dots,\alpha_n}) =
  \abs{x_1 \dots x_k}{t} : \tau_1' \arrtype \dots \arrtype \tau_k'
  \arrtype \sigma'$;
\item therefore $\Termmap(\afun_{\alpha_1,\dots,\alpha_n})[\alpha_1:=
  \typeinterpret{\rho_1},\dots,\alpha_n:=\typeinterpret{\rho_n}] =
  \abs{x_1: \typeinterpret{\tau_1} \dots x_k : \typeinterpret{\tau_k}}{
  t}$ with $\{ x_1: \typeinterpret{\tau_1} \dots x_k :
  \typeinterpret{\tau_k} \} t : \typeinterpret{\sigma}$;
\item hence, $\Delta \vdash t[x_1:=\interpret{s_1},\dots,x_k:=
  \interpret{s_k}] : \sigma$ as well.
\qed
\end{itemize}

TODO: I'm pretty sure that this proof is incomplete, because it assumes
that type substitution does not do anything funny; however, a symbol
mapping does not truly map to ``terms'': it maps to terms where some
type denotations are instead \emph{type schemes}.  This means that a
type scheme $\alpha\langle\beta\rangle$ might be ``instantiated'' to
$\typeinterpret{\sigma[\alpha:=\tau]}$.  At a minimum, we will probably
have to prove that $\typeinterpret{\sigma}[\alpha:=\typeinterpret{\tau}
] = \typeinterpret{\sigma[\alpha:=\tau]}$.  I don't foresee any
difficulties in this, just noting that we \emph{should} still fix this
proof.
\end{proof}

\subsection{Monotonicity}

By imposing certain monotonicity requirements on the choices for
$\Termmap$, we obtain a pair $(\succ,\succeq)$ that can be used with
rule removal (Theorem \ref{thm:ruleremove}).

\CK{%
The idea is that if $s \arr{\Rules} t$ then $\interpret{s}\downarrow\:
\succ\:\interpret{t}\downarrow$ must hold (or $\interpret{s}\downarrow\:
\succeq\:\interpret{t}\downarrow$, but in that case the rule cannot be
removed).  This will likely require that every component of a function
symbol is represented; for instance a requirement such as: if
$\Termmap(\mathtt{f}) = \abs{x_1 \dots x_n}{s}$, then $s = s_1 \oplus
\dots \oplus s_n + t$ where for $i$: if $x_i$ increases strictly,
then also $s_i$ increases.
(This would perhaps be simpler with interpretations to $\mathbb{N}
\setminus \{ 0 \}$, as then a component $\lift(\flatten(x_1)) \otimes
x_2$ would be strict in both $x_1$ and $x_2$, rather than in neither.)
Note that the restrictions should at least allow for the current
definition of $\Termmap(\mathtt{ext})$.}

\CK{In addition, we might need stability: if I can prove that
$\interpret{\ell} \downarrow \succ \interpret{r}\downarrow$ we should
also have $\interpret{\ell\gamma}\downarrow \succ
\interpret{r\gamma}\downarrow$ for all substitutions and type
substitutions $\gamma$.  (Not sure
about this one, as the rules already occur in instantiated form.)}

%\begin{lemma}
%TODO
%\end{lemma}
%
%Thus, if $\interpret{\ell} \succ \interpret{r}$ for some rule, then
%$\interpret{s}\downarrow \succ \interpret{t}\downarrow$ whenever
%$s \arr{\Rules} t$ by that rule, and similar for $\succeq$.  This
%provides a strategy for termination analysis using rule removal.

\section{Some useful lemmas}

Some things I will need:

\begin{lemma}\label{lem:substitutioninterpret}
We have:
\begin{enumerate}
\item\label{lem:substitutioninterpret:types}
  $\typeinterpret{\sigma}[\alpha:=\typeinterpret{\tau}] =
  \typeinterpret{\sigma[\alpha:=\tau]}$
\item\label{lem:substitutioninterpret:mixed}
  $\interpret{s}[\alpha:=\typeinterpret{\tau}] =
  \interpret{s[\alpha:=\tau]}$
\item\label{lem:substitutioninterpret:terms}
  $\interpret{s}[x:=\interpret{t}] = \interpret{s[x:=t]}$
\end{enumerate}
\end{lemma}

\begin{proof}
TODO
\end{proof}

\subsection{Orienting $\beta$-reduction}

\subsection{Orienting type instantiation}

\subsection{Other}

\section{Some systems of interest -- urzy\_emb?}

For easier presentation, we will denote $\oplus$ and $\otimes$ in
\emph{infix, left-associative} notation, and omit the type denotation
where it is clear from context.  Thus, $s \oplus t \oplus u$ should be
read as $\oplus_\sigma(s,\oplus_\sigma(t,u))$ if $s$ has type $\sigma$.
Similarly, we will sometimes omit the type denotation from $\flatten$
and $\lift$ when it can easily be derived from context.

\subsection{Interpretations}

We use the following type constructor mapping:
\[
\begin{array}{rcl}
\Typemap(\bot) & = & \nat \\
\Typemap(\mathtt{or}) & = & \alpha_1 \times \alpha_2 \\
\Typemap(\mathtt{and}) & = & \alpha_1 \times \alpha_2 \\
\Typemap(\mathtt{prop}_i) & = & \nat \\
\Typemap(\arrtype) & = & \alpha_1 \arrtype \alpha_2 \\
\Typemap(\forall) & = & \quant{\beta}{\alpha\langle\beta\rangle} \\
\Typemap(\exists) & = & \quant{\beta}{\quant{\chi}{\alpha\langle\chi
  \rangle \arrtype \beta} \arrtype \beta}
\end{array}
\]
And the following function symbol mapping:
\[
\begin{array}{rcll}
\Termmap(\epsilon_\alpha) & = & \lambda x:\nat. &
  \mathtt{lift}_\alpha(x) \\
\Termmap(@_{\alpha,\beta}) & = & \lambda x: \alpha \arrtype \beta,y :
  \alpha. \quad & x \cdot y \oplus \lift_\beta(\flatten_\alpha(
  y) \oplus 1) \\
\Termmap(\mathtt{tapp}_{\alpha,\beta}) & = & \lambda x : \quant{\xi}{
  \alpha\langle\xi\rangle}.\quad & x * \beta \oplus
  \lift_{\alpha\langle\beta\rangle}(1) \\
\Termmap(\mathtt{ext}_{\alpha,\beta}) & = & \lambda x:\alpha\langle\beta
  \rangle. &
  \tabs{\xi}{\abs{y:\quant{\chi}{\alpha\langle\chi\rangle
  \arrtype \xi}}{y * \beta \cdot x}} \\
\Termmap(\mathtt{in}^1_{\alpha,\beta}) & = & \lambda x : \alpha.\quad &
  (x, \mathtt{lift}_\beta(1)) \\
\Termmap(\mathtt{in}^2_{\alpha,\beta}) & = & \lambda x : \beta.\quad &
  (\mathtt{lift}_\alpha(1), x) \\
\Termmap(\pi^1_{\alpha,\beta}) & = & \lambda x : \alpha \times \beta.
  \quad & \pi^1_{\alpha,\beta}(x) \oplus \lift_{\alpha}(1) \\
\Termmap(\pi^2_{\alpha,\beta}) & = & \lambda x : \alpha \times \beta.
  \quad & \pi^2_{\alpha,\beta}(x) \oplus \lift_{\beta}(1) \\
\Termmap(\mathtt{pair}_{\alpha,\beta}) & = & \lambda x : \alpha, y :
  \beta.\quad & (x, y) \\
\end{array}
\]
\[
\begin{array}{rcl}
\Termmap(\mathtt{let}_{\alpha,\beta}) & = & \lambda x : \quant{\chi}{
  \quant{\xi}{\alpha\langle\xi\rangle \arrtype \chi} \arrtype \chi},
  y : \quant{\xi}{\alpha\langle\chi\rangle \arrtype \beta}. \\
  & & \hfill x * \beta \cdot y \oplus \lift_{\beta}(\flatten(y) \oplus
  1) \\
\Termmap(\mathtt{case}_{\alpha,\beta,\xi}) & = & \lambda x : (\alpha
  \times \beta), y : (\alpha \arrtype \xi), z : (\beta \arrtype \xi). \\
  & & \quad
  \lift_\xi(37) \oplus (\ \lift_\xi(\flatten_{\alpha \times\beta}(
  x) \oplus 1) \otimes \\
  & & \phantom{\quad\lift_\xi(37) \oplus a}\
  ((y \cdot \proj^1_{\alpha,\beta}(x)) \oplus
   (z \cdot \proj^2_{\alpha,\beta}(x)) \oplus \lift_\xi(1))
  \ ) \\
\end{array}
\]

\subsection{Rule orientation}

\begin{itemize}
\item $@_{\sigma,\tau}(\abs{x}{s},t) \to s[x:=t]$ \\
  We have $\interpret{@(\abs{x:\sigma}{s},t)} = (\abs{x:\typeinterpret{
  \sigma}}{\interpret{s}}) \cdot \interpret{t} \oplus \lift(\flatten(
  \interpret{t}) \oplus 1) \leadsto \interpret{s}[x:=\interpret{t}]
  \oplus \lift(\flatten(\interpret{t}) \oplus 1)$.  Since, by Lemma
  \ref{lem:liftgreater} we have $\lift(\flatten(\interpret{t}) \oplus
  1) \succeq \lift(1)$, by Lemma \ref{lem:plustimesmonotonic} this term
  $\succ \interpret{s}[x:=\interpret{t}]$, which equals
  $\interpret{s[x:=t]}$ by Lemma \ref{lem:substitutioninterpret}.
  Thus, we can remove this rule.
\item $\mathtt{tapp}_{\quant{\alpha}{\sigma},\tau}(\tabs{\alpha}{s}) \to
  s[\alpha:=\tau]$ \\
  We have $\interpret{\mathtt{tapp}_{\quant{\alpha}{\sigma},
  \tau}(\tabs{\alpha}{s})} = (\tabs{\alpha}{\interpret{s}}) *
  \typeinterpret{\tau} \oplus \lift(1) \leadsto \interpret{s}[\alpha:=
  \typeinterpret{\tau}] \oplus \lift(1) \succ
  \interpret{s}[\alpha:=\typeinterpret{\tau}] =
  \interpret{s[\alpha:=\tau]}$.
  Thus, we can remove this rule.
\item $\mathtt{let}_{\qquant{\forall}{\alpha}{\sigma},\rho}(
  \mathtt{ext}_{\qquant{\forall}{\alpha}{\sigma},\tau}(s),\tabs{\alpha}{
    \abs{x:\sigma}{t}}) \to t[\alpha:=\tau][x:=s]$ \\
  Let $u := \mathtt{ext}_{\quant{\alpha}{\sigma},\tau}(s)$ and
  $w := \tabs{\alpha}{\abs{x}{t}}$.  Then we have:
  \begin{itemize}
  \item $\interpret{u} =
    \tabs{\xi}{\abs{y:\quant{\alpha}{\sigma \arrtype \xi}}{
    y * \typeinterpret{\tau} \cdot \interpret{s}}}$ (which has type
    $\quant{\xi}{\quant{\alpha}{\sigma \arrtype \xi} \arrtype \xi}$);
  \item $\interpret{w} = \tabs{\alpha}{\abs{x:\typeinterpret{\sigma}}{
    \interpret{t}}}$ (which has type $\quant{\alpha}{\sigma \arrtype
    \rho}$ with $\alpha \notin \FTV(\rho)$);
  \item $\interpret{\mathtt{let}_{\quant{\alpha}{\sigma},\rho}(u,w)} =
    \interpret{u} * \rho \cdot \interpret{w} \oplus
    \lift(\flatten(\interpret{w})\oplus 1) \succeq
    \interpret{u} * \rho \cdot \interpret{w} \oplus \lift(1)$ by
    Lemmas \ref{lem:liftgreater} and \ref{lem:plustimesmonotonic} as
    before; by Lemma \ref{lem:plustimesmonotonic} again this term
    $\succ \interpret{u} * \rho \cdot \interpret{w}
    \leadsto (\abs{y}{y * \typeinterpret{\tau} \cdot \interpret{s}})
    \cdot \interpret{w} \leadsto \interpret{w} * \typeinterpret{\tau}
    \cdot \interpret{s} \leadsto (\abs{x:\typeinterpret{\sigma}[\alpha:=
    \typeinterpret{\tau}]}{\interpret{t}[\alpha:=\typeinterpret{\tau}]})
    \cdot \interpret{s} \leadsto \interpret{t}[\alpha:=\typeinterpret{
    \tau}][x:=\interpret{s}]$.  By Lemma
    \ref{lem:substitutioninterpret} this is equal to
    $\interpret{t[\alpha:=\tau][x:=s]}$.
  \end{itemize}
\item $\pi^1_{\sigma,\tau}(\mathtt{pair}_{\sigma,\tau}(s,t)) \leadsto
  s$ \\
  We have $\interpret{\pi^1_{\sigma,\tau}(\mathtt{pair}_{\sigma,\tau}(
  s,t))} = \pi^1_{\typeinterpret{\sigma,\tau}}(\interpret{s},
  \interpret{t}) \oplus \lift(1) \leadsto \interpret{s} \oplus
  \lift(1) \succ \interpret{s}$.
\item $\pi^2_{\sigma,\tau}(\mathtt{pair}_{\sigma,\tau}(s,t)) \to t$ \\
  We have $\interpret{\pi^2_{\sigma,\tau}(\mathtt{pair}_{\sigma,\tau}(
 s,t))} = \pi^2_{\typeinterpret{\sigma,\tau}}(\interpret{s},
  \interpret{t}) \oplus \lift(1) \leadsto \cdot \succ \interpret{t}$.
\item $\mathtt{case}_{\sigma,\tau,\rho}(\mathtt{in}^1_{\sigma,\tau}(u),
  \abs{x}{s},\abs{y}{t}) \to s[x:=u]$ \\
  For brevity, let $uu := \interpret{\mathtt{in}^1_{\sigma,\tau}(u)} =
  (\interpret{u}, \lift_\tau(1))$.
  Also denote $\varphi := \lift_\rho(\flatten_{\sigma \times \tau}(
  uu) \oplus_{\nat} 1)$. \\
  We have $\interpret{\mathtt{case}_{\sigma,\tau,\rho}(\dots)} =
  \lift_\rho(37) \oplus (\varphi\,\otimes (\ (\abs{x:
  \typeinterpret{\sigma}}{\interpret{s}}) \cdot \proj^1_{\sigma,\tau}(
  uu) \oplus
  (\abs{y:\typeinterpret{\tau}}{\interpret{t}}) \cdot \proj^2_{\sigma,
  \tau}(uu)\ \oplus \lift(1)))$.
  Note that $\varphi \succeq \lift_\rho(1)$ by
  Lemma \ref{lem:liftgreater}.  Therefore, by monotonicity of $\oplus$
  and $\otimes$, the distribution property (Lemmas
  \ref{lem:plustimesmonotonic} and
  \ref{lem:approxproperties}(\ref{lem:approx:distribution})), this
  term $\succeq \lift(37) \oplus (\abs{x}{\interpret{s}}) \cdot
  \proj^1_{\sigma,\tau}(uu) \oplus (\abs{y}{\interpret{t}}) \cdot
  \proj^2_{\sigma,\tau}(uu) \oplus \lift(1) \leadsto^* \lift(37) \oplus
  \interpret{s}[x:=\interpret{u}] \oplus
  \interpret{t}[y:=\interpret{u}] \oplus \lift(1)$.  By Lemma
  \ref{lem:plusparts}\footnote{\CK{Since Lemma
  \ref{lem:plusparts} only gives that $s \oplus \lift(n) \succ s$ and
  not $\lift(n) \oplus s \succ s$, I use Lemma
  \ref{lem:approxproperties}(\ref{lem:approx:symmetry}) to obtain
  $\lift(n) \oplus s \succeq s \oplus \lift(n) \succ s$.  We will
  then also need an \emph{extended version} of Lemma
  \ref{lem:compatibility}, since as is, it does not state that
  $\succeq \cdot \succ$ is included in $\succ$.}}, this term
  $\succ \interpret{s}[x:=\interpret{u}] = \interpret{s[x:=u]}$ by
  Lemma \ref{lem:substitutioninterpret}.
\item $\mathtt{case}_{\sigma,\tau,\rho}(\mathtt{in}^2_{\sigma,\tau}(u),
  \abs{x}{s},\abs{y}{t}) \to t[x:=u]$ \\
  Symmetric to the case above.
\item $
\mathtt{case}_{\rho,\pi,\xi}(\mathtt{case}_{\sigma,\tau,\mathtt{or}(
  \rho,\pi)}(u,\abs{x}{s},\abs{y}{t}),\abs{z}{v},\abs{a}{w}) %& \to &
  \to\\
  \mathtt{case}_{\sigma,\tau,\xi}(u,
    \abs{x}{\mathtt{case}_{\rho,\pi,\xi}(s,\abs{z}{v},\abs{a}{w})},
    \abs{y}{\mathtt{case}_{\rho,\pi,\xi}(t,\abs{z}{v},\abs{a}{w})}) $\\
  We have:
  \begin{itemize}
  \item $aa := \interpret{\mathtt{case}_{\sigma,\tau,\mathtt{or}(\rho,
    \pi)}(u,\abs{x}{s},\abs{y}{t})} =$\\$
    \lift_{\typeinterpret{\rho} \times \typeinterpret{\pi}}(37) \oplus
    (\ \lift_{\typeinterpret{\rho} \times \typeinterpret{\pi}}(
      \flatten_{\typeinterpret{\sigma} \times \typeinterpret{\tau}}(
        \interpret{u}) \oplus 1) \otimes$ \\
    \phantom{x} \hfill
    $(\ ((\abs{x}{\interpret{s}}) \cdot \proj^1(\interpret{u})) \oplus
    ((\abs{y}{\interpret{t}}) \cdot \proj^2(\interpret{u})) \oplus
    \lift(1)\ )\ )$
  \end{itemize}
\end{itemize}

==========================

\[
\begin{array}{rcl}
\epsilon_\tau(\epsilon_\bot(s)) & \to & \epsilon_\tau(s) \\
@_{\sigma,\tau}(\epsilon_{\sigma \arrtype \tau}(s),t) & \to &
  \epsilon_\tau(s) \\
\mathtt{tapp}_{\quant{\alpha}{\sigma},\tau}(
  \epsilon_{\quant{\alpha}{\sigma}}(s)) & \to &
  \epsilon_{\sigma[\alpha:=\tau]}(s) \\
\pi^1_{\sigma,\tau}(\epsilon_{\mathtt{and}(\sigma,\tau)}(s)) & \to &
  \epsilon_\sigma(s) \\
\pi^2_{\sigma,\tau}(\epsilon_{\mathtt{and}(\sigma,\tau)}(s)) & \to &
  \epsilon_\tau(s) \\
\mathtt{case}_{\sigma,\tau,\rho}(\epsilon_{\mathtt{or}(\sigma,\tau)}(
  u),\abs{x}{s},\abs{y}{t}) & \to & \epsilon_\rho(s) \\
\mathtt{let}_{\qquant{\forall}{\alpha}{\sigma},\rho}(\epsilon_{\qquant{
  \forall}{\alpha}{\sigma}}(s),\tabs{\alpha}{\abs{x}{t}}) & \to &
  \epsilon_\rho(s) \\
\end{array}
\]

\begin{itemize}
%\[
%\begin{array}{rcl}
\item $
\epsilon_\rho(\mathtt{case}_{\sigma,\tau,\bot}(u,\abs{x}{s},\abs{y}{t}))
  %& \to &
  \to
  \mathtt{case}_{\sigma,\tau,\rho}(u,\abs{x}{\epsilon_\rho(s)},
  \abs{y}{\epsilon_\rho(t)}) $%\\
\item $
@_{\rho,\pi}(\mathtt{case}_{\sigma,\tau,\rho \arrtype \pi}(u,
  \abs{x}{s},\abs{y}{t}),v) %& \to &
  \to
  \mathtt{case}_{\sigma,\tau,\pi}(u,
  \abs{x}{@_{\rho,\pi}(s,v)},\abs{y}{@_{\rho,\pi}(t,v)}) $%\\
\item $
\mathtt{tapp}_{\quant{\alpha}{\rho},\pi}(\mathtt{case}_{\sigma,\tau,
  \quant{\alpha}{\rho}}(u,\abs{x}{s},\abs{y}{t})) %& \to &
  \to
  \mathtt{case}_{\sigma,\tau,\rho[\alpha:=\pi]}(u,
  \abs{x}{\mathtt{tapp}_{\quant{\alpha}{\rho},\pi}(s)},\\
  \abs{y}{\mathtt{tapp}_{\quant{\alpha}{\rho},\pi}(t)}) $%\\
\item $
\pi^1_{\rho,\pi}(\mathtt{case}_{\sigma,\tau,\mathtt{and}(\rho,\pi)}(u,
  \abs{x}{s},\abs{y}{t})) %& \to &
  \to
  \mathtt{case}_{\sigma,\tau,\rho}(u,\abs{x}{\pi^1_{\rho,\pi}(s)},
  \abs{y}{\pi^1_{\rho,\pi}(t)}) $%\\
\item $
\pi^2_{\rho,\pi}(\mathtt{case}_{\sigma,\tau,\mathtt{and}(\rho,\pi)}(u,
  \abs{x}{s},\abs{y}{t})) %& \to &
  \to
  \mathtt{case}_{\sigma,\tau,\pi}(u,\abs{x}{\pi^2_{\rho,\pi}(s)},
  \abs{y}{\pi^2_{\rho,\pi}(t)}) $%\\
\item $
\mathtt{let}_{\qquant{\forall}{\alpha}{\rho}}(
  \mathtt{case}_{\sigma,\tau,\qquant{\forall}{\alpha}{\rho}}(
  u,\abs{x}{s},\abs{y}{t}),v) %& \to &
  \to\\
  \mathtt{case}_{\sigma,\tau,\rho}(u,
  \abs{x}{\mathtt{let}_{\qquant{\forall}{\alpha}{\rho}}(s,v)},
  \abs{y}{\mathtt{let}_{\qquant{\forall}{\alpha}{\rho}}(t,v)})
  $%\\
%\end{array}
%\]
\end{itemize}
\begin{itemize}
\item $\epsilon_\tau(\mathtt{let}_{\qquant{\forall}{\alpha}{\sigma},
  \bot}(s,t)) \to
  \mathtt{let}_{\qquant{\forall}{\alpha}{\sigma},\tau}(s,\epsilon_\tau(t))$
\item $@_{\tau,\rho}(\mathtt{let}_{\qquant{\forall}{\alpha}{\sigma},
  \tau \arrtype \rho}(s,t),u) \to
  \mathtt{let}_{\qquant{\forall}{\alpha}{\sigma},\rho}(s,@_{\tau,\rho}(t,
  u))$
\item $\mathtt{tapp}_{\quant{\alpha}{\tau},\rho}(
\mathtt{let}_{\qquant{\forall}{\alpha}{\sigma},\quant{\alpha}{\tau}}(s,t))
  \to
  \mathtt{let}_{\qquant{\forall}{\alpha}{\sigma},\tau[\alpha:=\rho]}(s,
  \mathtt{tapp}_{\quant{\alpha}{\tau},\rho}(t))$
\item $\pi^1_{\tau,\rho}(\mathtt{let}_{\qquant{\forall}{\alpha}{\sigma},
  \mathtt{and}(\tau,\rho)}(s,t)) \to
  \mathtt{let}_{\qquant{\forall}{\alpha}{\sigma},\tau}(s,\pi^1_{\tau,
  \rho}(t))$
\item $\pi^2_{\tau,\rho}(\mathtt{let}_{\qquant{\forall}{\alpha}{\sigma},
  \mathtt{and}(\tau,\rho)}(s,t)) \to
  \mathtt{let}_{\qquant{\forall}{\alpha}{\sigma},\rho}(s,\pi^2_{\tau,
  \rho}(t))$
\item $\mathtt{case}_{\tau,\rho,\pi}(
  \mathtt{let}_{\qquant{\forall}{\alpha}{\sigma},\mathtt{or}(\tau,
  \rho)}(s,t),\abs{x}{u},\abs{y}{v}) \to
  \mathtt{let}_{\qquant{\forall}{\alpha}{\sigma},\pi}(s,\mathtt{case}_{
  \tau,\rho,\pi}(t,\abs{x}{u},\abs{y}{v}))$
\item $\mathtt{let}_{\qquant{\forall}{\beta}{\tau},\rho}(\mathtt{let}_{\qquant{\forall}{\alpha}{\sigma},\qquant{\forall}{\beta}{\tau}}(s,t),u) \to
  \mathtt{let}_{\qquant{\forall}{\alpha}{\sigma},\rho}(s,\mathtt{let}_{\qquant{\forall}{\beta}{\tau},\rho}(t,u))$
\end{itemize}
\end{document}
