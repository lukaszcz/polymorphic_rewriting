\documentclass[runningheads,a4paper]{llncs}
\pdfoutput=1

\bibliographystyle{plainurl}

\usepackage{amssymb}
\setcounter{tocdepth}{3}
\usepackage{enumerate}
\usepackage[colorlinks=true]{hyperref}
\usepackage{tikz}
\usepackage{xcolor,latexsym,amsmath,extarrows,alltt}
\usepackage{xspace}
\usepackage{booktabs}
\usepackage{mathtools}
\usepackage{stmaryrd}
\usepackage{microtype}
\usepackage{enumitem}
\usepackage{multirow}
\usepackage{proof}
\usepackage[T1]{fontenc}

\newcommand{\Fomega}{\mathtt{F}_\omega}

\newcommand{\Iterms}{\mathcal{I}}
\newcommand{\World}{\mathcal{W}}
\newcommand{\Rules}{\mathcal{R}}
\newcommand{\Typevars}{\mathcal{A}}
\newcommand{\Vars}{\mathcal{V}}
\newcommand{\ITypes}{\mathcal{Y}}
\newcommand{\Types}{\mathcal{T}}
\newcommand{\Terms}{\mathcal{T}\!\mathit{erms}}
\newcommand{\TypeConstructors}{\mathcal{C}}
\newcommand{\TypeQuantifiers}{\mathcal{Q}}
\newcommand{\Typemap}{\mathcal{T\!M}}
\newcommand{\Termmap}{\mathcal{J}}
\newcommand{\succinterpret}{\succ^{\llbracket\rrbracket}}
\newcommand{\succeqinterpret}{\succeq^{\llbracket\rrbracket}}

\newcommand{\cl}{\mathcal{C}}
\newcommand{\dom}{\mathrm{dom}}
\newcommand{\nf}{\mathrm{nf}}

\newcommand{\quant}[2]{\forall #1[#2]}
\newcommand{\qquant}[3]{#1 #2[#3]}
\newcommand{\typeinterpret}[1]{\llbracket #1 \rrbracket}
\newcommand{\interpret}[1]{\llbracket #1 \rrbracket}
\newcommand{\itp}[1]{\llbracket #1 \rrbracket}
\newcommand{\arr}[1]{\longrightarrow_{#1}}
\newcommand{\arrrbeta}{\leadsto_\beta^*}
\newcommand{\red}{\longrightarrow}
\newcommand{\arrtype}{\rightarrow}
\newcommand{\arrkind}{\Rightarrow}
\newcommand{\abs}[2]{\lambda #1.#2}
\newcommand{\tabs}[2]{\Lambda #1.#2}
\newcommand{\abstraction}[2]{\backslash #1.#2}
\newcommand{\app}[2]{#1 \cdot #2}
\newcommand{\apps}[3]{#1 \cdot #2 \cdots #3}
\newcommand{\tapp}[2]{#1 * #2}
\newcommand{\pair}[2]{\langle #1,#2 \rangle}
\newcommand{\expair}[2]{[#1,#2]}
\newcommand{\subst}[2]{#1:=#2}
\newcommand{\meta}[2]{#1\langle#2\rangle}

\newcommand{\FTV}{\mathrm{FTV}}
\newcommand{\FV}{\mathrm{FV}}
\newcommand{\Tc}{\mathcal{T}}
\newcommand{\Vc}{\mathcal{V}}

\newcommand{\nat}{\mathtt{nat}}
\newcommand{\proj}{\pi}
\newcommand{\flatten}{\mathtt{flatten}}
\newcommand{\lift}{\mathtt{lift}}
\newcommand{\con}{\mathtt{c}}
\newcommand{\afun}{\mathtt{f}}

\newcommand{\List}{\mathtt{List}}
\newcommand{\nil}{\mathtt{nil}}
\newcommand{\cons}{\mathtt{cons}}
\newcommand{\fold}{\mathtt{fold}}

\newcommand{\ur}{\upharpoonright}
\newcommand{\da}{\mathord{\downarrow}}
\newcommand{\SN}{\mathrm{SN}}
\newcommand{\Cb}{\mathbb{C}}
\newcommand{\Nbb}{\mathbb{N}}
\newcommand{\val}[3]{\ensuremath{\llbracket#1\rrbracket_{#2}^{#3}}}
\newcommand{\gteq}[3]{\ensuremath{\ge_{#1}^{#2,#3}}}
\newcommand{\rval}[3]{\ensuremath{{\mathcal R}_{#1}^{#2,#3}}}
\newcommand{\rel}[1]{\ensuremath{{\mathcal R}_{#1}}}
\newcommand{\proves}{\vdash}
\newcommand{\Rel}{\mathtt{Rel}}

\newcommand{\xcase}[4]{\mathtt{case}_{#1}\,#2\,\mathtt{of}\,#3\,\mathtt{or}\,#4}
\newcommand{\xlet}[4]{\mathtt{let}_{#1}\,#2\,\mathtt{be}\,[#3]\,\mathtt{in}\,#4}

\newcommand{\CK}[1]{\textcolor{blue}{CK: #1}}
\newcommand{\CKchange}[1]{\textcolor{blue}{#1}}
\newcommand{\LC}[1]{\textcolor{purple}{LC: #1}}

\begin{document}

\mainmatter

\title{Polymorphic Higher-Order Termination}

\author{{\L}ukasz Czajka and Cynthia Kop}
\authorrunning{{\L}. Czajka and C. Kop}
\institute{
Faculty of Informatics, TU Dortmund
\\
Institute of Computer Science, Radboud University Nijmegen (RU)
\\
\email{lukaszcz@mimuw.edu.pl}
\quad\quad\quad
\email{C.Kop@cs.ru.nl}
}

\maketitle

\begin{abstract}
  We generalise the termination method of higher-order polynomial
  interpretations to a setting with impredicative
  polymorphism. Instead of using weakly monotonic functionals, we
  interpret terms in a suitable extension of System~$\Fomega$. In
  addition to enabling an interpretation of rewrite rules which make
  essential use of impredicative polymorphism, thanks to the
  possibility of encoding inductive data types in the polymorphic
  lambda-calculus, this generalisation increases the power of the
  method also in the non-polymorphic setting. As an illustration of
  the potential of our method, we prove termination of a substantial
  fragment of full intuitionistic second-order propositional logic
  with permutative conversions.
\end{abstract}

\section{Introduction}

\section{Preliminaries}\label{sec_preliminaries}

In this section we introduce the System~$\Fomega$ (see e.g.,
Sorensen, Urzyczyn, ``Lectures on the Curry-Howard Isomorphism'',
Section~11.7.), which will form a basis both of our interpretations
and of a general syntax for the investigated systems.

First, we define the set of types.

\begin{definition}\label{def_types}\normalfont
  \emph{Kinds} are defined inductively:
  \begin{itemize}
  \item $*$ is a kind,
  \item if $\kappa_1,\kappa_2$ are kinds then so is $\kappa_1 \arrkind
    \kappa_2$.
  \end{itemize}

  We assume infinitely many \emph{type constructor variables} of each
  kind. Variables of kind~$*$ are \emph{type variables}.

  We assume a fixed set~$\Sigma_T$ of \emph{type constructor symbols}
  paired with a kind, denoted $c : \kappa$. Every type constructor
  symbol~$c$ occurs with only one kind declaration.

  We define \emph{type constructors} of kind~$\kappa$ by induction.
  Type constructors of kind~$*$ are called \emph{types}.
  \begin{itemize}
  \item A type constructor variable of kind~$\kappa$ is a type
    constructor of kind~$\kappa$.
  \item A type constructor symbol of kind~$\kappa$ is a type
    constructor of kind~$\kappa$.
  \item If $\varphi$ is a type constructor of kind $\kappa_1 \arrkind
    \kappa_2$ and $\psi$ is a type constructor of kind~$\kappa_1$ then
    $\varphi \psi$ is a type constructor of kind~$\kappa_2$.
  \item If $\alpha$ is a type constructor variable of kind~$\kappa_1$
    and $\varphi$ is a type constructor of kind~$\kappa_2$, then
    $\lambda\alpha . \varphi$ is a type constructor of kind $\kappa_1
    \arrkind \kappa_2$.
  \item If $\alpha$ is a type constructor variable of kind~$\kappa$
    and~$\tau$ is a type, then $\forall \alpha[\tau]$ is a type.
  \item If $\tau_1,\tau_2$ are types, then $\tau_1 \arrtype \tau_2$ is
    a type.
  \end{itemize}
  The set of type constructors of kind~$\kappa$ is denoted
  by~$\Tc_\kappa$.

  We use the notation $\forall \alpha . \tau$. When $\alpha$ is of
  kind $\kappa$ then we use the notations
  $\forall \alpha : \kappa . \tau$ and
  $\forall (\alpha : \kappa)[\tau]$. These are all just different
  notations used for convenience.

  We treat type constructors up to $\alpha$-conversion. Note
  that~$\forall$ binds variables.

  Beta-reduction on type constructors is defined as the compatible
  closure of the rule
  \[
  (\lambda\alpha.\varphi)\psi \to \varphi[\alpha := \psi]
  \]
  Note that type constructors are essentially simply-typed
  lambda-terms, so beta-reduction on type constructors terminates and
  is confluent, hence every type constructor~$\tau$ has a unique
  beta-normal form~$\nf_\beta(\tau)$. A \emph{type atom} is a type in
  $\beta$-normal form which is not an arrow $\tau_1\arrtype\tau_2$ or
  a quantification $\forall\alpha\tau$.

  We define $\FV(\varphi)$ -- the set of free type constructor
  variables of the type constructor~$\varphi$ -- in an obvious way by
  induction on the structure of~$\varphi$. A type
  constructor~$\varphi$ is \emph{closed} if
  $\FV(\varphi) = \emptyset$.
\end{definition}

Terms are built from a set of function symbols, using abstraction and
application.

\begin{definition}\label{def_preterms}\normalfont
  We assume given an infinite set $\Vars$ of variables, and let
  $\Gamma$ refer to a mapping from a finite subset of $\Vars$ to the
  set of types.

  We assume given a fixed set $\Sigma$ of \emph{function symbols},
  each paired with a type, denoted $\mathtt{f} : \tau$.  Every
  function symbol $\mathtt{f}$ occurs only with one type declaration.

  The set of preterms consists of all expressions $s$ such that
  $\Gamma \vdash s : \sigma$ can be inferred for some type $\sigma$
  and mapping $\Gamma$ by the following clauses:
  \begin{itemize}
  \item $\Gamma \vdash n : \nat$ for every natural number $n$.
  \item $\Gamma \vdash x : \sigma$ for every $(x : \sigma) \in \Gamma$.
  \item $\Gamma \vdash \mathtt{f} : \sigma$ for all
    $(\mathtt{f} : \sigma) \in \Sigma$.
  \item $\Gamma \vdash \abs{x:\sigma}{s} : \sigma \arrtype \tau$ if $x
    \in \Vars$ and $\Gamma \uplus \{ x : \sigma \} \vdash s : \tau$.
  \item $\Gamma \vdash \tabs{\alpha}{s} : \quant{\alpha}{\sigma}$ if
    $\alpha$ is a type constructor variable and $\Gamma \vdash s :
    \sigma$ and for all $(x : \tau) \in \Gamma$: $\alpha \notin
    \FV(\tau)$
  \item $\Gamma \vdash \app{s}{t} : \tau$ if $\Gamma \vdash s : \sigma
    \arrtype \tau$ and $\Gamma \vdash t : \sigma$
  \item $\Gamma \vdash \tapp{s}{\tau} : \sigma[\subst{\alpha}{\tau}]$
    if $\Gamma \vdash s : \quant{(\alpha:\kappa)}{\sigma}$ and~$\tau$
    is a type constructor of kind~$\kappa$,
  \item $\Gamma \vdash s : \tau$ if $\Gamma \vdash s : \tau'$ and
    $\tau =_\beta \tau'$.
  \end{itemize}
  The set of free variables of a preterm~$t$, denoted $\FV(t)$, is
  defined in the expected way. Analogously, we define the
  set~$\FTV(t)$ of type constructor variables occurring free
  in~$t$. We say that $t$ is \emph{closed} if $\FV(t) = \emptyset$ and
  $\FTV(t) = \emptyset$.
\end{definition}

If $\alpha$ is a type constructor variable of kind~$\kappa$ then we
use the notation $\tabs{\alpha:\kappa}{t}$.

Note that for a given $\Gamma$, if $s$ is typable under $\Gamma$, then
there is only one choice for the type modulo $\beta$-conversion (this
is easily proved by induction on the form of $s$). Thus, all closed
preterms have a unique type modulo $\beta$-conversion.

\begin{definition}\label{def_type_equiv}
  We define the type equivalence relation~$\equiv$ on preterms by
  induction on preterm structure.
  \begin{itemize}
  \item $x \equiv x$, $n \equiv n$,
  \item if $\sigma =_\beta \tau$ then $f_\sigma \equiv f_\tau$ for
    $f \in \Sigma$,
  \item if $\sigma =_\beta \tau$ and $s \equiv t$ then
    $\abs{x:\sigma}{s} \equiv \abs{x:\tau}{t}$,
  \item if $s \equiv t$ then $\tabs{\alpha}{s} \equiv
    \tabs{\alpha}{t}$,
  \item if $s \equiv s'$ and $t \equiv t'$ then $s \cdot t \equiv s'
    \cdot t'$,
  \item if $s \equiv t$ and $\sigma =_\beta \tau$ then
    $\tapp{s}{\sigma} \equiv \tapp{t}{\tau}$.
  \end{itemize}
  In other words, $s \equiv t$ iff $s$ and $t$ are identical modulo
  $\beta$-conversion in types.
\end{definition}

Note that~$\equiv$ is an equivalence relation.

\begin{lemma}
  If $\Gamma \vdash s : \tau$ and $s \equiv t$ then $\Gamma \vdash t :
  \tau$.
\end{lemma}

\begin{proof}
  Induction on~$s$.
\end{proof}

The set of terms is now defined as follows.

\begin{definition}\label{def_terms}\normalfont
  The set of \emph{terms} is the set of the equivalence classes
  of~$\equiv$.
\end{definition}

Because $\beta$-reduction on types is confluent and terminating, every
term has a canonical preterm representative -- the one with all types
occurring in it $\beta$-normalized. We say that a term is
\emph{closed} if its canonical representative is. We define $\FTV(t)$
as the value of~$\FTV$ on the canonical representative of~$t$.

Because typing and term formation operations (abstraction,
application, \ldots) are invariant under~$\equiv$, we may denote terms
by their (canonical) representatives and informally treat them
interchangeably.

We will often abuse notation to omit $\cdot$ and $*$. Thus, $s t$ can
refer to both $\app{s}{t}$ and $\tapp{s}{t}$. This is not ambiguous
due to typing. We will also use $\abstraction{a}{s}$ for either
$\abs{a}{s}$ or $\tabs{a}{s}$, depending on typing.

\begin{definition}\label{def_chi_kappa}\normalfont
  By induction on the kind~$\kappa$ we define a closed type
  constructor~$\chi_\kappa$. For $\kappa=*$ we take $\chi_\kappa =
  \nat$. For $\kappa=\kappa_1\arrkind\kappa_2$ we take $\chi_\kappa =
  \lambda \alpha:\kappa_1 . \chi_{\kappa_2}$.
\end{definition}

\begin{lemma}[Substitution lemma]
  \begin{enumerate}
  \item If $\Gamma \uplus \{ x : \sigma \} \vdash s : \tau$ and
    $\Gamma \proves t : \sigma$ then
    $\Gamma \proves s[\subst{x}{t}] : \tau$.
  \item If $\Gamma \proves t : \sigma$ and~$\tau$ is a type
    constructor of the same kind as the variable~$\alpha$ then
    $\Gamma[\subst{\alpha}{\tau}] \proves t[\subst{\alpha}{\tau}] :
    \sigma[\subst{\alpha}{\tau}]$.
  \end{enumerate}
\end{lemma}

\begin{proof}
  Induction on the typing derivation.
\end{proof}

\begin{lemma}[Generation lemma]
  Assume $\Gamma \proves t : \sigma$ and let
  $\Vc = \FV(\sigma) \cup \FTV(t) \cup \FTV(\Gamma)$. Then there is a
  type~$\sigma'$ such that $\sigma' =_\beta \sigma$ and
  $\FV(\sigma') \subseteq \Vc$ and one of the following holds.
  \begin{itemize}
  \item $t$ is a natural number and $\sigma' = \nat$.
  \item $t \equiv x$ is a variable and $(x : \tau) \in \Gamma$ and $\tau
    =_\beta \sigma'$.
  \item $t \equiv \mathtt{f}$ is a function symbol with $\mathtt{f} :
    \sigma'$ the following set: $\{ \oplus_{\tau} : \tau \arrtype \tau
    \arrtype \tau,\ \otimes_{\tau} : \tau \arrtype \tau \arrtype
    \tau,\ \flatten_{\tau} : \tau \arrtype \nat,\ \lift_{\tau} : \nat
    \arrtype \tau \}$ for some type~$\tau$.
  \item $t \equiv \abs{x:\tau_1}{s}$ and
    $\sigma'=\tau_1\arrtype\tau_2$ and $\Gamma \uplus \{ x : \tau_1 \}
    \vdash s : \tau_2$.
  \item $t \equiv \tabs{\alpha}{s}$ and
    $\sigma' = \quant{\alpha}{\tau}$ and $\Gamma \vdash s : \tau$ and
    for all $(x : \rho) \in \Gamma$: $\alpha \notin \FV(\rho)$.
  \item $t \equiv \app{t_1}{t_2}$ and
    $\Gamma \vdash t_1 : \tau \arrtype \sigma'$ and
    $\Gamma \vdash t_2 : \tau$ and $\FV(\tau) \subseteq \Vc$.
  \item $t \equiv \tapp{s}{\tau}$ and
    $\sigma' = \rho[\subst{\alpha}{\tau}]$ and
    $\Gamma \vdash s : \quant{(\alpha:\kappa)}{\rho}$ and~$\tau$ is a
    type constructor of kind~$\kappa$.
  \end{itemize}
\end{lemma}

\begin{proof}
  By induction on the derivation $\Gamma \proves t : \sigma$, using
  the substitution lemma. Note that if $\alpha \notin \Vc$ is of
  kind~$\kappa$ and e.g.~$\Gamma \proves s : \sigma'$ with~$s$ a
  subterm of~$t$, then
  $\Gamma \proves s : \sigma'[\subst{\alpha}{\chi_\kappa}]$ by the
  substitution lemma (see Definition~\ref{def_chi_kappa}).
\end{proof}

For convenience, we sometimes assume without loss of generality that
the terms are given in orthodox Church-style, i.e., instead of using
contexts we assume that each variable occurrence is annotated with a
type (where two occurrences of the same variable must be annotated
with the same type). Note that given a context~$\Gamma$ under which
all considered terms are typable, there is a natural isomorphism
between typed terms as defined above and terms given in orthodox
Church-style.

We denote an occurrence of a variable~$x$ annotated with a type~$\tau$
by~$x^\tau$. So now e.g.~$\lambda x : \tau\arrtype\sigma
. x^{\tau\arrtype\sigma}y^\tau$ is an orthodox Church-style typed
term. When clear or irrelevant, we omit the type annotations for
readability, denoting the above term by~$\lambda x :
\tau\arrtype\sigma . x y$ or even~$\lambda x . x y$. Note that now
type substitution also needs to change the type annotations. Also,
each term has a unique type modulo $\beta$-conversion. We write $t :
\tau$ if $t$ has type~$\tau$. The generation and subject reduction
lemmas still holds for orthodox Church-style typed terms.

\section{Interpretations}

In this section we define the set~$\Iterms$ of interpretation terms,
and the relations~$\succ$ and~$\succeq$ on~$\Iterms$. We also define
the set~$\World$ of final interpretation terms as the set of all closed
interpretation terms normalized with a certain reduction relation.

\subsection{Defining the sets~$\Iterms$ and~$\World$}\label{sec_world}

\subsubsection{Interpretation terms}

\begin{definition}\label{def_iterms}\normalfont
  The set~$\ITypes$ of \emph{interpretation types} is the set of types
  as in Definition~\ref{def_types} with $\Sigma_T = \{ \nat : * \}$,
  i.e., there is a single type constant~$\nat$.

  The set~$\Iterms$ of \emph{interpretation terms} is the set of terms
  from Definition~\ref{def_terms} (see also
  Definition~\ref{def_preterms}) where as types we take the
  interpretation types and as the set~$\Sigma$ of function symbols we
  take:
  \[
    \begin{array}{rcl}
      \Sigma &=& \{ \oplus_\sigma : \sigma \arrtype
                 \sigma \arrtype \sigma,\\ & & \otimes_\sigma : \sigma \arrtype \sigma
                 \arrtype \sigma,\\ & & \flatten_{\sigma} : \sigma \arrtype
                 \nat,\\ & & \lift_{\sigma} : \nat \arrtype \sigma \mid \sigma \in \ITypes
                 \}
    \end{array}
  \]
\end{definition}

To define the world of \emph{final interpretation terms}, we will
normalise certain elements of $\Iterms$ using the relation $\leadsto$.

\begin{definition}
  We define the relation $\leadsto$ on interpretation terms as the
  smallest relation for which the following properties are satisfied:
  \begin{enumerate}
  \item\label{leadsto:mono:abs}
    if $s \leadsto t$ then both $\abs{x}{s} \leadsto \abs{x}{t}$ and
    $\tabs{\alpha}{s} \leadsto \tabs{\alpha}{t}$
  \item\label{leadsto:mono:right}
    if $s \leadsto t$ then $\app{u}{s} \leadsto \app{u}{t}$
  \item\label{leadsto:mono:left}
    if $s \leadsto t$ then both $\app{s}{u} \leadsto \app{t}{u}$ and
    $\tapp{s}{\sigma} \leadsto \tapp{t}{\sigma}$
  \item\label{leadsto:beta:abs} $\app{(\abs{x:\sigma}{s})}{t} \leadsto
    s[\subst{x}{t}]$
  \item\label{leadsto:beta:tabs} $\tapp{(\tabs{\alpha}{s})}{\sigma}
    \leadsto s[\subst{\alpha}{\sigma}]$.
  \item\label{leadsto:plus:base}
    $\app{\app{\oplus_{\nat}}{n}}{m} \leadsto (n+m)$
  \item\label{leadsto:times:base} $\app{\app{\otimes_{\nat}}{n}}{m}
    \leadsto (n \cdot m)$
  \item\label{leadsto:circ:arrow} $\app{\app{\circ_{\sigma \arrtype
        \tau}}{s}}{t} \leadsto
    \abs{x:\sigma}{\app{\app{\circ_\tau}{(\app{s}{x})}}{(\app{t}{x})}}$
    for $\circ \in \{ \oplus, \otimes \}$
  \item\label{leadsto:circ:forall}
    $\app{\app{\circ_{\quant{\alpha}{\sigma}}}{s}}{t} \leadsto
    \tabs{\alpha}{\app{\app{\circ_\sigma}{(\tapp{s}{\alpha})}}{(
        \tapp{t}{\alpha})}}$ for $\circ \in \{ \oplus, \otimes \}$
  \item $\app{\flatten_\nat}{s} \leadsto s$
  \item $\app{\flatten_{\sigma \arrtype \tau}}{s} \leadsto
    \app{\flatten_\tau}{(\app{s}{(\app{\lift_\sigma}{0})})}$
  \item $\app{\flatten_{\quant{\alpha:\kappa}{\sigma}}}{s} \leadsto
    \app{\flatten_{\sigma[\subst{\alpha}{\chi_\kappa}]}}{(\tapp{s}{\chi_\kappa})}$
  \item $\app{\lift_\nat}{s} \leadsto s$
  \item $\app{\lift_{\sigma \arrtype \tau}}{s} \leadsto
    \abs{x:\sigma}{\app{\lift_{\tau}}{s}}$
  \item $\app{\lift_{\quant{\alpha}{\sigma}}}{s} \leadsto
    \tabs{\alpha}{\app{\lift_{\sigma}}{s}}$
  \end{enumerate}
  Note that the above rules are invariant under~$\equiv$ (by
  confluence of $\beta$-reduction on types), so they correctly define
  a relation on interpretation terms -- the equivalence classes
  of~$\equiv$.

  We say that $s$ is a \emph{redex} if $s$ reduces by one of the rules
  (\ref{leadsto:plus:base}).

  A \emph{final interpretation term} is an interpretation term
  $s \in \Iterms$ such that (a) $s$ is closed, and (b) $s$ is in
  normal form with respect to $\leadsto$.  We let $\World$ be the set
  of all final interpretation terms. By~$\World_\tau$ we denote the
  set of all final interpretation terms of interpretation type~$\tau$.
\end{definition}

In the remainder of this section, we shall often speak simply of
``terms'' and ``types'' when referring to interpretation terms and
interpretation types.

\subsubsection{Key properties of $\leadsto$}

\begin{lemma}[Subject reduction]
  If $\Gamma \vdash t : \tau$ and $t \leadsto t'$ then
  $\Gamma \vdash t' : \tau$.
\end{lemma}

\begin{proof}
  By induction on the definition of $t \leadsto t'$, using the
  generation and substitution lemmas.
\end{proof}

By~$\SN$ we denote the set of all terminating interpretation
terms. For $t \in \SN$ by~$\nu(t)$ we denote the length of the longest
reduction starting at~$t$.

The following lemma is obvious, but worth stating explicitly.

\begin{lemma}\label{lem_reduce_abs}
  If $\abstraction{a}{s} \leadsto^* t$, then $t = \abstraction{a}{t'}$
  and $s \leadsto^* t'$.  If $s \in \SN$ then both $\abs{x}{s}$ and
  $\tabs{\alpha}{s}$ are also in $\SN$.
\end{lemma}

\begin{proof}
  We observe that every reduct of $\abstraction{x}{s}$ has the form
  $\abstraction{x}{s'}$ with $s \leadsto s'$, and analogously for
  $\tabs{\alpha}{s}$.  Thus, the first statement follows by induction
  on the length of the reduction $\abstraction{a}{s} \leadsto^* t$,
  and the second statement by induction on $\nu(s)$.  \qed
\end{proof}

\begin{lemma}\label{lem_circ_sn_base}
  If $t_1,t_2 \in \SN$ then $\circ_\nat t_1 t_2 \in \SN$ for $\circ
  \in \{\oplus,\otimes\}$.
\end{lemma}

\begin{proof}
  By induction on $\nu(t_1) + \nu(t_2)$. Assume $t_1,t_2 \in \SN$. To
  prove $\circ_\nat t_1 t_2 \in \SN$ it suffices to show $s \in \SN$
  for all~$s$ such that $\circ_\nat t_1 t_2 \leadsto s$. If $s =
  \circ_\nat t_1' t_2$ or $s = \circ_\nat t_1 t_2'$ with $t_i \leadsto
  t_i'$ then we complete by the induction hypothesis. Otherwise $s \in
  \mathbb{N}$ is obviously in $\SN$.  \qed
\end{proof}

\subsubsection{Computability}

In the rest of this section we adapt Girard's method of candidates
(which itself is based on Tait's computability method) to prove
termination of~$\leadsto$. The proof is an adaptation of chapters~6
and~14 from the book ``Proofs and Types'' by Girard, and chapters~10
and~11 from the book ``Lectures on the Curry-Howard Isomorphism'' by
Sorensen and Urzyczyn. An important difference with system~$\Fomega$
and related ones is that the rules for $\oplus_\tau$, $\otimes_\tau$,
$\flatten_\tau$ and $\lift_\tau$ depend on the type~$\tau$. In
particular, type substitution in terms may create redexes. For
instance, if $\alpha$ is a type variable then $\oplus_\alpha t_1 t_2$
is not a redex, but $\oplus_{\sigma\arrtype\tau} t_1 t_2$ is. This
makes adapting the computability method a bit more difficult.

\begin{definition}\label{def_candidate}\normalfont
  A term~$t$ is \emph{neutral} if there does not exist a sequence of
  terms and types~$u_1,\ldots,u_n$ with $n \ge 1$ such that $t u_1
  \ldots u_n$ is a redex (by~$\leadsto$).

  By induction on the kind~$\kappa$ of a type constructor~$\tau$ we
  define the set~$\Cb_\tau$ of all candidates of type
  constructor~$\tau$.

  First assume $\kappa=*$, i.e., $\tau$ is a type. A set~$X$ of
  interpretation terms of type~$\tau$ is a \emph{candidate of
    type~$\tau$} when:
  \begin{enumerate}
  \item $X \subseteq \SN$;
  \item if $t \in X$ and $t \leadsto t'$ then $t' \in X$;
  \item if $t$ is neutral and for every~$t'$ with $t \leadsto t'$ we
    have $t' \in X$, then $t \in X$;
  \item if $t_1,t_2 \in X$ then $\circ_\tau t_1 t_2 \in X$ for
    $\circ \in \{\oplus,\otimes\}$;
  \item if $t \in \SN$ and $t : \nat$ then $\lift_\tau t \in X$;
  \item if $t \in X$ then $\flatten_\tau t \in \SN$.
  \end{enumerate}
  Note that item~3 above implies:
  \begin{itemize}
  \item if $t$ is neutral and in normal form then $t \in X$.
  \end{itemize}

  Now assume $\kappa = \kappa_1\arrkind\kappa_2$. A function $f :
  \Tc_{\kappa_1} \times \bigcup_{\xi\in\Tc_{\kappa_1}}\Cb_\xi \to
  \bigcup_{\xi\in\Tc_{\kappa_2}}\Cb_\xi$ is a \emph{candidate of type
    constructor~$\tau$} if for every closed type constructor~$\sigma$
  of kind~$\kappa_1$ and a candidate $X \in \Cb_\sigma$ we have
  $f(\sigma,X) \in \Cb_{\tau\sigma}$.
\end{definition}

Note that the elements of a candidate of type~$\tau$ are required to
have type~$\tau$.

\begin{lemma}\label{lem_beta_candidate}
  If $\sigma =_\beta \sigma'$ then $\Cb_\sigma = \Cb_{\sigma'}$.
\end{lemma}

\begin{proof}
  Induction on the kind of~$\sigma$.
\end{proof}

\begin{definition}\label{def_computability_valuation}\normalfont
  Let $\omega$ be a mapping from type constructor variables to type
  constructors (respecting kinds). The mapping~$\omega$ extends in an
  obvious way to a mapping from type constructors to type
  constructors. A mapping~$\omega$ is \emph{closed for~$\sigma$} if
  $\omega(\alpha)$ is closed for $\alpha \in \FV(\sigma)$ (then
  $\omega(\sigma)$ is closed).

  An \emph{$\omega$-valuation} is a mapping~$\xi$ from type
  constructor variables to candidates such that $\xi(\alpha) \in
  \Cb_{\omega(\alpha)}$.

  For each type constructor~$\sigma$, each mapping~$\omega$ closed
  for~$\sigma$, and each $\omega$-valuation~$\xi$, the set
  $\val{\sigma}{\xi}{\omega}$ is defined by induction on~$\sigma$:
  \begin{itemize}
  \item $\val{\alpha}{\xi}{\omega} = \xi(\alpha)$ for a type
    constructor variable~$\alpha$,
  \item $\val{\nat}{\xi}{\omega}$ is the set of all terms~$t \in \SN$
    such that $t : \nat$,
  \item $\val{\sigma \arrtype \tau}{\xi}{\omega}$ is the set of all
    terms~$t$ such that $t : \omega(\sigma\arrtype\tau)$ and for
    every~$s \in \val{\sigma}{\xi}{\omega}$ with $s : \omega(\sigma)$
    we have $\app{t}{s} \in \val{\tau}{\xi}{\omega}$,
  \item $\val{\forall(\alpha:\kappa)[\sigma]}{\xi}{\omega}$ is the set
    of all terms~$t$ such that $t : \omega(\forall\alpha[\sigma])$ and
    for every closed type constructor~$\varphi$ of kind~$\kappa$ and
    every $X \in \Cb_\varphi$ we have $\tapp{t}{\varphi} \in
    \val{\sigma}{\xi[\subst{\alpha}{X}]}{\omega[\subst{\alpha}{\varphi}]}$,
  \item
    $\val{\varphi \psi}{\xi}{\omega} =
    \val{\varphi}{\xi}{\omega}(\omega(\psi),\val{\psi}{\xi}{\omega})$,
  \item
    $\val{\lambda(\alpha:\kappa)\varphi}{\xi}{\omega}(\psi,X) =
    \val{\varphi}{\xi[\subst{\alpha}{X}]}{\omega[\subst{\alpha}{\psi}]}$
    for closed $\psi \in \Tc_\kappa$ and $X \in \Cb_\psi$.
  \end{itemize}
  In the above, if e.g.~$\val{\psi}{\xi}{\omega} \notin
  \Cb_{\omega(\psi)}$ then $\val{\varphi \psi}{\xi}{\omega}$ is
  undefined.
\end{definition}

If~$\varphi$ is closed then $\omega,\xi$ do not affect the value
of~$\val{\varphi}{\xi}{\omega}$, so then we simply
write~$\val{\varphi}{}{}$.

\begin{lemma}\label{lem_nat_computable}
  $\val{\nat}{}{} \in \Cb_{\nat}$.
\end{lemma}

\begin{proof}
  We check the conditions in Definition~\ref{def_candidate}.
  \begin{enumerate}
  \item $\val{\nat}{}{} \subseteq \SN$ follows
    directly from Definition~\ref{def_computability_valuation}.
  \item Let $t \in \val{\nat}{}{}$ and $t \leadsto t'$. Then $t :
    \nat$ and $t \in \SN$. Hence $t' \in \SN$, and $t' : \nat$ by the
    subject reduction lemma. Thus $t' \in \val{\nat}{}{}$.
  \item Let $t$ be neutral and $t : \nat$. Assume that for all~$t'$
    with $t \leadsto t'$ we have $t' \in \val{\nat}{}{}$, so in
    particular $t' \in \SN$. But then $t \in \SN$. Hence $t \in
    \val{\nat}{}{}$.
  \item Let $t_1,t_2 \in \SN$ be such that $t_i : \nat$. Obviously,
    $\circ_\nat t_1 t_2 : \nat$. Also $\circ_\nat t_1 t_2 \in \SN$
    follows by Lemma~\ref{lem_circ_sn_base}. So $\circ_\nat t_1 t_2
    \in \val{\nat}{}{}$.
  \item Let $t \in \SN$ be such that $t : \nat$. Then $\lift_\nat t :
    \nat$. It remains to show $\lift_\nat t \in \SN$. Any infinite
    reduction from~$\lift_\nat t$ has the form $\lift_\nat t
    \leadsto^* \lift_\nat t_0 \leadsto t_1 \leadsto t_2 \leadsto
    \ldots$ or $\lift_\nat t \leadsto \lift_\nat t_0 \leadsto
    \lift_\nat t_1 \leadsto \lift_\nat t_2 \leadsto \ldots$, where $t
    \leadsto^* t_0$ and $t_i \leadsto t_{i+1}$. This contradicts $t
    \in \SN$.
  \item Let $t \in \SN$ be such that $t : \nat$. The proof of
    $\flatten_\nat t \in \SN$ is analogous to the proof of $\lift_\nat
    t \in \SN$ above.
  \end{enumerate}
\end{proof}

\begin{lemma}\label{lem_chi_kappa_computable}
  $\val{\chi_\kappa}{}{} \in \Cb_{\chi_\kappa}$.
\end{lemma}

\begin{proof}
  Induction on~$\kappa$. If $\kappa = *$ then this follows from
  Lemma~\ref{lem_nat_computable}. If $\kappa=\kappa_1\arrkind\kappa_2$
  then $\chi_\kappa = \lambda \alpha : \kappa_1
  . \chi_{\kappa_2}$. Let~$\psi$ be a closed type constructor of
  kind~$\kappa_1$ and let $X \in \Cb_{\chi_{\kappa_1}}$. We have
  $\val{\chi_\kappa}{}{}(\psi,X) = \val{\chi_{\kappa_2}}{}{}$ because
  $\chi_{\kappa_2}$ is closed. By the inductive hypothesis
  $\val{\chi_\kappa}{}{}(\psi,X) = \val{\chi_{\kappa_2}}{}{} \in
  \Cb_{\chi_{\kappa_2}}$. This implies $\val{\chi_\kappa}{}{} \in
  \Cb_{\chi_\kappa}$.\qed
\end{proof}

\begin{lemma}\label{lem_abstraction_computable}
  Let $\sigma,\tau$ be types. Suppose $\val{\tau}{\xi'}{\omega'} \in
  \Cb_{\omega'(\tau)}$ and $\val{\sigma}{\xi'}{\omega'} \in
  \Cb_{\omega'(\sigma)}$ for all suitable $\omega',\xi'$. Then
  \begin{itemize}
  \item
    $\abs{x}{s} \in \val{\tau \arrtype \sigma}{\xi}{\omega}$ if and
    only if $\abs{x}{s} : \omega(\tau \arrtype \sigma)$ and $s[x:=t]
    \in \val{\sigma}{\xi}{\omega}$ for all $t \in
    \val{\tau}{\xi}{\omega}$;
  \item
    $\tabs{\alpha}{s} \in
    \val{\quant{(\alpha:\kappa)}{\sigma}}{\xi}{\omega}$ if and only if
    $\tabs{\alpha}{s} : \omega(\quant{(\alpha:\kappa)}{\sigma})$ and
    for every closed type constructor~$\varphi$ of kind~$\kappa$ and
    all $X \in \Cb_\varphi$ we have $s[\alpha:=\varphi] \in
    \val{\sigma}{\xi[\subst{\alpha}{X}]}{\omega[\subst{\alpha}{\varphi}]}$.
  \end{itemize}
\end{lemma}

\begin{proof}
  First suppose
  $\abs{x:\omega(\tau)}{s} \in \val{\tau \arrtype
    \sigma}{\xi}{\omega}$. Then
  $\abs{x:\omega(\tau)}{s} : \omega(\tau\arrtype\sigma)$ and for all
  $t \in \val{\tau}{\xi}{\omega}$ we have
  $\app{(\abs{x:\omega(\tau)}{s})}{t} \in \val{\sigma}{\xi}{\omega}$.
  As this set is a candidate, it is closed under $\leadsto$, so also
  $s[x:=t] \in \val{\sigma}{\xi}{\omega}$. Similarly, if
  $\tabs{\alpha}{s} \in \val{\quant{\alpha}{\sigma}}{\xi}{\omega}$,
  then $\tabs{\alpha}{s} : \quant{\alpha}{\sigma}$ and
  $\tapp{(\tabs{\alpha}{s})}{\varphi} \in
  \val{\sigma}{\xi[\subst{\alpha}{X}]}{\omega[\subst{\alpha}{\varphi}]}$,
  and we are done because
  $\tapp{(\tabs{\alpha}{s})}{\tau} \leadsto s[\alpha:=\varphi]$ and
  $\val{\sigma}{\xi[\subst{\alpha}{X}]}{\omega[\subst{\alpha}{\varphi}]}$
  is a candidate, so it is closed under~$\leadsto$.

  Now suppose $s[x:=t] \in \val{\sigma}{\xi}{\omega}$ for all
  $t \in \val{\tau}{\xi}{\omega}$. Let
  $t \in \val{\tau}{\xi}{\omega}$. Then $t \in \SN$ because
  $\val{\tau}{\xi}{\omega}$ is a candidate. Also $s \in \SN$ because
  every infinite reduction in $s$ induces an infinite reduction in
  $s[x:=t]$ ($\leadsto$ is stable) and
  $\val{\sigma}{\xi}{\omega} \subseteq \SN$ is a candidate. For all
  $s',t'$ with $s \leadsto^* s'$ and $t \leadsto^* t'$, we show by
  induction on~$\nu(s') + \nu(t')$ that
  $\app{(\abs{x}{s'})} t' \in \val{\sigma}{\xi}{\omega}$. We have
  $\app{(\abs{x}{s'})} t' : \omega(\sigma)$ by definition and the
  subject reduction theorem (note that $t : \omega(\tau)$ because
  $\val{\tau}{\xi}{\omega} \in \Cb_{\omega(\tau)}$). The set
  $\val{\sigma}{\xi}{\omega}$ is a candidate, and
  $\app{(\abs{x}{s'})}{t'}$ is neutral, so in
  $\val{\sigma}{\xi}{\omega}$ if all its reducts are. Thus assume
  $\app{(\abs{x}{s'})}{t'} \leadsto u$. If
  $u = \app{(\abs{x}{s'})}{t''}$ with $t' \leadsto t''$ or
  $u = \app{(\abs{x}{s''})}{t'}$ with $s' \leadsto s''$, then
  $u \in \val{\sigma}{\xi}{\omega}$ by the inductive hypothesis. So
  assume $u = s'[x:=t']$. We have $s[x:=t] \leadsto^* s'[x:=t']$ by
  monotonicity and stability of $\leadsto$. Therefore
  $u = s'[x:=t'] \in \val{\sigma}{\xi}{\omega}$, because
  $s[x:=t] \in \val{\sigma}{\xi}{\omega}$ and
  $\val{\sigma}{\xi}{\omega}$ is a candidate and hence closed under
  $\leadsto$.

  A similar reasoning applies to $s[\alpha:=\varphi]$.\qed
\end{proof}

\begin{lemma}\label{lem_val_computable}
  If $\sigma$ is a type constructor, $\omega$ is closed for~$\sigma$,
  and $\xi$ is an $\omega$-valuation, then $\val{\sigma}{\xi}{\omega}
  \in \Cb_{\omega(\sigma)}$.
\end{lemma}

\begin{proof}
  By induction on the structure of~$\sigma$ we show that
  $\val{\sigma}{\xi}{\omega} \in \Cb_{\omega(\sigma)}$ for all
  suitable $\omega,\xi$. First, if $\sigma = \alpha$ is a type
  constructor variable~$\alpha$ then $\val{\sigma}{\xi}{\omega} =
  \xi(\alpha) \in \Cb_{\omega(\sigma)}$ by definition. If $\sigma =
  \nat$ then $\val{\nat}{\xi}{\omega} \in \Cb_{\nat}$ by
  Lemma~\ref{lem_nat_computable}.

  Assume $\sigma = \tau_1 \arrtype \tau_2$. We check the conditions in
  Definition~\ref{def_candidate}.
  \begin{enumerate}
  \item Let $t \in \val{\tau_1\arrtype\tau_2}{\xi}{\omega}$ and assume
    there is an infinite reduction $t \leadsto t_1 \leadsto t_2
    \leadsto t_3 \leadsto \ldots$. By the inductive hypothesis
    $\val{\tau_1}{\xi}{\omega}$ and $\val{\tau_2}{\xi}{\omega}$ are
    candidates. Let~$x$ be a fresh variable. Then $x^{\omega(\tau_1)}
    : \omega(\tau_1)$ and $x^{\omega(\tau_1)} \in
    \val{\tau_1}{\xi}{\omega}$ because it is neutral and normal. Thus
    $t x \in \val{\tau_2}{\xi}{\omega} \subseteq \SN$. But $t x
    \leadsto t_1 x \leadsto t_2 x \leadsto t_3 x \leadsto
    \ldots$. Contradiction.
  \item Let $t \in \val{\tau_1\arrtype\tau_2}{\xi}{\omega}$ and $t
    \leadsto t'$. Let $u \in \val{\tau_1}{\xi}{\omega}$ be such that
    $u : \omega(\tau_1)$. Then $t u \in \val{\tau_2}{\xi}{\omega}$. By
    the inductive hypothesis $\val{\tau_2}{\xi}{\omega}$ is a
    candidate, so $t' u \in \val{\tau_2}{\xi}{\omega}$. Also note that
    $t' : \omega(\tau_1 \arrtype \tau_2)$ by the subject reduction
    lemma. Hence $t' \in \val{\tau_1\arrtype\tau_2}{\xi}{\omega}$.
  \item Let $t$ be neutral such that $t : \omega(\tau_1 \arrtype
    \tau_2)$. Assume for every~$t'$ with $t \leadsto t'$ we have $t'
    \in \val{\tau_1\arrtype\tau_2}{\xi}{\omega}$. Let $u \in
    \val{\tau_1}{\xi}{\omega}$ be such that $u : \omega(\tau_1)$. By
    the inductive hypothesis $\val{\tau_1}{\xi}{\omega}$ is a
    candidate, so $u \in \SN$. By induction on~$\nu(u)$ we show that
    $t u \in \val{\tau_2}{\xi}{\omega}$. Assume $t u \leadsto t''$. We
    show $t'' \in \val{\tau_2}{\xi}{\omega}$. Because~$t$ is neutral,
    $t u$ cannot be a redex. So there are two cases.
    \begin{itemize}
    \item $t'' = t u'$ with $u \leadsto u'$. Then $u' \in
      \val{\tau_1}{\xi}{\omega}$ because~$\val{\tau_1}{\xi}{\omega}$
      is a candidate, and~$u' : \omega(\tau_1)$ by the subject
      reduction lemma. So $t u' \in \val{\tau_2}{\xi}{\omega}$ by the
      inductive hypothesis for~$u$.
    \item $t'' = t' u$ with $t \leadsto t'$. Then $t' \in
      \val{\tau_1\arrtype\tau_2}{\xi}{\omega}$ by point~2 above. So
      $t' u \in \val{\tau_2}{\xi}{\omega}$.
    \end{itemize}
    We have thus shown that if $t u \leadsto t''$ then $t'' \in
    \val{\tau_2}{\xi}{\omega}$. By the (main) inductive hypothesis
    $\val{\tau_2}{\omega,\xi}{\Gamma}$ is a candidate. Because $t u$
    is neutral, the above implies $t u \in
    \val{\tau_2}{\xi}{\omega}$. Since $u \in
    \val{\tau_1}{\xi}{\omega}$ was arbitrary with $u :
    \omega(\tau_1)$, we have shown $t \in
    \val{\tau_1\arrtype\tau_2}{\xi}{\omega}$.
  \item Assume $t_1,t_2 \in \val{\tau_1\arrtype\tau_2}{\xi}{\omega}$.
    We have already shown that this implies $t_1,t_2 \in \SN$. Let $s
    = \circ_{\omega(\tau_1\arrtype\tau_2)} t_1 t_2$. We show $s \in
    \val{\tau_1\arrtype\tau_2}{\xi}{\omega}$ by induction on $\nu(t_1)
    + \nu(t_2)$. Note that $s : \omega(\tau_1\arrtype\tau_2)$ because
    $t_i : \omega(\tau_1\arrtype\tau_2)$. Since $s$ is neutral, we
    have already seen in point~3 above that to prove $s \in
    \val{\tau_1\arrtype\tau_2}{\xi}{\omega}$ it suffices to show that
    $s' \in \val{\tau_1\arrtype\tau_2}{\xi}{\omega}$ whenever $s
    \leadsto s'$. If $s' = \circ_{\omega(\tau_1\arrtype\tau_2)} t_1'
    t_2$ with $t_1 \leadsto t_1'$, then note that $t_1' \in
    \val{\tau_1\arrtype\tau_2}{\xi}{\omega}$ because we have already
    shown that $\val{\tau_1\arrtype\tau_2}{\xi}{\omega}$ is closed
    under $\leadsto$; thus, we can complete by the induction
    hypothesis. If $s' = \circ_{\omega(\tau_1\arrtype\tau_2)} t_1
    t_2'$, we complete in the same way.  The only alternative is that
    $s' = \abs{x:\omega(\tau_1)}{\circ_{\omega(\tau_2)}(t_1x)(t_2x)}$.
    Let $u \in \val{\tau_1}{\xi}{\omega}$. Then $u : \omega(\tau_1)$
    because $\val{\tau_1}{\xi}{\omega} \in \Cb_{\omega(\tau_1)}$ by
    the inductive hypothesis. Since $t_1,t_2 \in
    \val{\tau_1\arrtype\tau_2}{\xi}{\omega}$, we have that $t_1 u$ and
    $t_2 u$ are in $\val{\tau_2}{\xi}{\omega}$ by definition. Since
    $\val{\tau_2}{\xi}{\omega}$ is a candidate, this means that
    $\circ_{\omega(\tau_2)} (t_1 u) (t_2 u) = (\circ_{\omega(\tau_2)}
    (t_1 x) (t_2 x))[x:=u]$ is in $\val{\tau_2}{\xi}{\omega}$ as well.
    By Lemma~\ref{lem_abstraction_computable}, we conclude that $s'
    \in \val{\tau_1\arrtype\tau_2}{\xi}{\omega}$.
  \item Let $t \in \SN$ satisfy $t : \nat$, and let $s =
    \lift_{\omega(\tau_1\arrtype\tau_2)}(t)$. We show $s \in
    \val{\tau_1\arrtype\tau_2}{\xi}{\omega}$ by induction
    on~$\nu(t)$. We have $s : \omega(\tau_1\arrtype\tau_2)$ because $t
    : \nat$. Since~$s$ is neutral, we have already proved above in
    point~3 that it suffices to show that $s' \in
    \val{\tau_1\arrtype\tau_2}{\xi}{\omega}$ whenever $s \leadsto
    s'$. If $s' = \lift_{\omega(\tau_1\arrtype\tau_2)}(t')$ with $t
    \leadsto t'$ then still $t' \in \SN$ and $t' : \nat$, so $s' \in
    \val{\tau_1\arrtype\tau_2}{\xi}{\omega}$ by the inductive
    hypothesis. The only alternative is that $s' = \lambda x :
    \omega(\tau_1) . \lift_{\omega(\tau_2)}(t)$. Let $u \in
    \val{\tau_1}{\xi}{\omega}$ be such that $u :
    \omega(\tau_1)$. Because $\val{\tau_2}{\xi}{\omega} \in
    \Cb_{\omega(\tau_2)}$ by the (main) inductive hypothesis
    for~$\sigma$, we have $\lift_{\omega(\tau_2)}(t) \in
    \val{\tau_2}{\xi}{\omega}$. Since $\lift_{\omega(\tau_2)}(t) =
    (\lift_{\omega(\tau_2)}x)[\subst{x}{t}]$ we obtain $s' \in
    \val{\tau_1\arrtype\tau_2}{\xi}{\omega}$ by
    Lemma~\ref{lem_abstraction_computable}.
  \item Let $t \in \val{\tau_1\arrtype\tau_2}{\xi}{\omega}$.  We show
    $s := \flatten_{\omega(\tau_1\arrtype\tau_2)}t \in \SN$. We have
    already shown $t \in \SN$ in point~1 above. Thus any infinite
    reduction starting from~$s$ must have the form $s \leadsto^*
    \flatten_{\omega(\tau_1\arrtype\tau_2)}t' \leadsto
    \flatten_{\omega(\tau_2)}(t' (\lift_{\omega(\tau_1)}0)) \leadsto
    \ldots$ with $t \leadsto^* t'$. We have already shown in point~2
    above that $\val{\tau_1\arrtype\tau_2}{\xi}{\omega}$ is closed
    under~$\leadsto$, so $t' \in
    \val{\tau_1\arrtype\tau_2}{\xi}{\omega}$. By the inductive
    hypothesis $\val{\tau_1}{\xi}{\omega} \in\Cb_{\omega(\tau_1)}$, so
    $\lift_{\omega(\tau_1)}0 \in \val{\tau_1}{\xi}{\omega}$ by
    property~5 of candidates. Hence $t' (\lift_{\omega(\tau_1)}0) \in
    \val{\tau_2}{\xi}{\omega}$ by definition. But by the inductive
    hypothesis~$\val{\tau_2}{\xi}{\omega}$ is a candidate, so
    $\flatten_{\omega(\tau_2)}(t'(\lift_{\omega(\tau_1)}0))\in\SN$. Contradiction.
  \end{enumerate}

  Assume $\sigma = \forall(\alpha:\kappa)[\tau]$. We check the
  conditions in Definition~\ref{def_candidate}.
  \begin{enumerate}
  \item Let $t \in \val{\forall(\alpha:\kappa)[\tau]}{\xi}{\omega}$
    and assume there is an infinite reduction $t \leadsto t_1 \leadsto
    t_2 \leadsto t_3 \leadsto \ldots$. Recall that~$\chi_\kappa$ from
    Definition~\ref{def_chi_kappa} is a closed type constructor of
    kind~$\kappa$. By Lemma~\ref{lem_chi_kappa_computable} we have
    $\val{\chi_{\kappa}}{}{} \in \Cb_{\chi_\kappa}$. Then $t
    \chi_\kappa \in
    \val{\tau}{\xi[\subst{\alpha}{\val{\chi_\kappa}{}{}}]}{\omega[\subst{\alpha}{\chi_\kappa}]}$. By
    the inductive hypothesis
    $\val{\tau}{\xi[\subst{\alpha}{\val{\chi_\kappa}{}{}}]}{\omega[\subst{\alpha}{\chi_\kappa}]}$
    is a candidate, so $t \chi_\kappa \in \SN$. But $t \chi_\kappa
    \leadsto t_1 \chi_\kappa \leadsto t_2 \chi_\kappa \leadsto t_3
    \chi_\kappa \leadsto \ldots$. Contradiction.
  \item Let $t \in \val{\forall\alpha[\tau]}{\xi}{\omega}$ and $t
    \leadsto t'$. By the subject reduction lemma $t' :
    \omega(\forall\alpha[\tau])$. Let~$\varphi$ be a closed type
    constructor of kind~$\kappa$ and~$X \in \Cb_{\varphi}$. Then $t
    \varphi \in
    \val{\tau}{\xi[\subst{\alpha}{X}]}{\omega[\subst{\alpha}{\varphi}]}$. By
    the inductive hypothesis
    $\val{\tau}{\xi[\subst{\alpha}{X}]}{\omega[\subst{\alpha}{\varphi}]}$
    is a candidate, so $t' \varphi \in
    \val{\tau}{\xi[\subst{\alpha}{X}]}{\omega[\subst{\alpha}{\varphi}]}$. Therefore
    $t' \in \val{\forall\alpha[\tau]}{\xi}{\omega}$.
  \item Let $t$ be neutral such that $t :
    \omega(\forall\alpha[\tau])$, and assume that for every~$t'$ with
    $t \leadsto t'$ we have $t' \in
    \val{\forall\alpha[\tau]}{\xi}{\omega}$. Let~$\varphi$ be a closed
    type constructor of kind~$\kappa$ and~$X \in
    \Cb_{\varphi}$. Assume $t \varphi \leadsto t''$. Then $t'' = t'
    \varphi$ with $t \leadsto t'$, because~$t$ is neutral. Hence $t
    \varphi \leadsto t' \varphi \in
    \val{\tau}{\xi[\subst{\alpha}{X}]}{\omega[\subst{\alpha}{\varphi}]}$. By
    the inductive
    hypothesis~$\val{\tau}{\xi[\subst{\alpha}{X}]}{\omega[\subst{\alpha}{\varphi}]}$
    is a candidate. Also $t \varphi$ is neutral, so $t \varphi \in
    \val{\tau}{\xi[\subst{\alpha}{X}]}{\omega[\subst{\alpha}{\varphi}]}$
    because~$t''$ was arbitrary with $t \varphi \leadsto t''$. This
    implies that $t \in \val{\forall\alpha[\tau]}{\xi}{\omega}$.
  \item Assume $t_1,t_2 \in
    \val{\forall\alpha[\tau]}{\xi}{\omega}$. We have already shown
    that this implies $t_1,t_2 \in \SN$. We prove
    $\circ_{\omega(\forall\alpha[\tau])} t_1 t_2 \in
    \val{\forall\alpha['tau]}{\xi}{\omega}$ by induction on $\nu(t_1)
    + \nu(t_2)$. Since $s := \circ_{\omega(\forall\alpha[\tau])} t_1
    t_2$ is neutral, we have already proven that it suffices to show
    that $s' \in \val{\forall\alpha[\tau]}{\xi}{\omega}$ whenever $s
    \leadsto s'$. The cases when $t_1$ or $t_2$ are reduced are
    immediate with the induction hypotheses. The only remaining case
    is when $s'=\tabs{\alpha}{\circ_{\omega(\tau)} (t_1 \alpha) (t_2
      \alpha)}$.  For all closed type constructors $\varphi$ of
    kind~$\kappa$ and all $X \in \Cb_{\varphi}^\Gamma$ we have both
    $t_1 \varphi$ and $t_2 \varphi$ in
    $\val{\tau}{\xi[\subst{\alpha}{X}]}{\omega[\subst{\alpha}{\varphi}]}$
    (by definition of $t_1,t_2 \in
    \val{\forall\alpha[\tau]}{\xi}{\omega}$). Let $\omega' =
    \omega[\subst{\alpha}{\varphi}]$. By bound variable renaming, we
    may assume $\omega(\alpha) = \alpha$ and $\alpha$ does not occur
    in~$t_1,t_2$. Because
    $\val{\tau}{\xi[\subst{\alpha}{X}]}{\omega[\subst{\alpha}{\varphi}]}$
    is a candidate by the inductive hypothesis for~$\sigma$, we have
    \[
    \circ_{\omega'(\tau)} (t_1 \varphi)
    (t_2\varphi) = (\circ_{\omega(\tau)} (t_1 \alpha) (t_2
    \alpha))[\subst{\alpha}{\varphi}] \in
    \val{\tau}{\xi[\subst{\alpha}{X}]}{\omega[\subst{\alpha}{\varphi}]}.
    \]
    Hence $s' \in \val{\forall\alpha[\tau]}{\xi}{\omega}$ by
    Lemma~\ref{lem_abstraction_computable}.
  \item Let $t \in \SN$ be such that $t : \nat$. By induction
    on~$\nu(t)$ we show $s := \lift_{\omega(\forall\alpha[\tau])}(t)
    \in \val{\forall\alpha[\tau]}{\xi}{\omega}$. First note that $s :
    \omega(\forall\alpha[\tau])$. Since~$s$ is neutral, by the already
    proven point~3 above, it suffices to show that $s' \in
    \val{\forall\alpha[\tau]}{\xi}{\omega}$ whenever $s \leadsto
    s'$. The case when~$t$ is reduced is immediate by the inductive
    hypothesis. The only remaining case is when $s' =
    \tabs{\alpha}{\lift_{\omega(\tau)}(t)}$ (without loss of
    generality assuming $\omega(\alpha) = \alpha$). Let $\varphi$ be a
    closed type constructor of kind~$\kappa$ and let $X \in
    \Cb_\varphi$. Because
    $\val{\tau}{\xi[\subst{\alpha}{X}]}{\omega[\subst{\alpha}{\varphi}]}$
    is a candidate, we have
    \[
    \lift_{\omega[\subst{\alpha}{\varphi}](\tau)}(t) =
    (\lift_{\omega(\tau)}(t))[\subst{\alpha}{\varphi}] \in
    \val{\tau}{\xi[\subst{\alpha}{X}]}{\omega[\subst{\alpha}{\varphi}]}.
    \]
    This implies $s' \in \val{\forall\alpha[\tau]}{\xi}{\omega}$.
  \item Let $t \in \val{\forall\alpha[\tau]}{\xi}{\omega}$. We show $s
    := \flatten_{\omega(\forall\alpha[\tau])}t \in \SN$. We have
    already shown $t \in \SN$ in point~1 above. Thus any infinite
    reduction starting from~$s$ must have the form $s \leadsto^*
    \flatten_{\omega(\forall\alpha[\tau])}t' \leadsto
    \flatten_{\omega(\tau)[\subst{\alpha}{\chi_\kappa}]}(t'
    \chi_\kappa) \leadsto \ldots$ with $t \leadsto^* t'$ (assuming
    $\omega(\alpha) = \alpha$ without loss of generality). We have
    already shown in point~2 above that
    $\val{\forall\alpha[\tau]}{\xi}{\omega}$ is closed
    under~$\leadsto$, so $t' \in
    \val{\forall\alpha[\tau]}{\xi}{\omega}$. We have
    $\val{\chi_\kappa}{}{} \in \Cb_{\chi_\kappa}$ by
    Lemma~\ref{lem_chi_kappa_computable}. Since~$\chi_\kappa$ is also
    closed, we have $t' \chi_\kappa \in
    \val{\tau}{\xi[\subst{\alpha}{\val{\chi_\kappa}{}{}}]}{\omega[\subst{\alpha}{\chi_\kappa}]}$
    by definition of $\val{\forall\alpha[\tau]}{\xi}{\omega}$. By the
    inductive hypothesis
    $\val{\tau}{\xi[\subst{\alpha}{\val{\chi_\kappa}{}{}}]}{\omega[\subst{\alpha}{\chi_\kappa}]}
    \in \Cb_{\omega[\subst{\alpha}{\chi_\kappa}](\tau)}$. Hence
    $\flatten_{\omega[\subst{\alpha}{\chi_\kappa}](\tau)}(t'\chi_\kappa)\in\SN$. But
    $\omega[\subst{\alpha}{\chi_\kappa}](\tau) =
    \omega(\tau)[\subst{\alpha}{\chi_\kappa}]$ because~$\chi_\kappa$
    is closed and $\omega(\alpha) = \alpha$. Contradiction.
  \end{enumerate}

  Assume $\sigma = \varphi\psi$, with $\psi$ of kind~$\kappa_1$ and
  $\varphi$ of kind~$\kappa_1\arrkind\kappa_2$. By the inductive
  hypothesis $\val{\psi}{\xi}{\omega} \in \Cb_{\omega(\psi)}$ and
  $\val{\varphi}{\xi}{\omega} \in \Cb_{\omega(\varphi)}$. Because
  applying~$\omega$ does not change kinds, we have
  $\val{\varphi\psi}{\xi}{\omega} =
  \val{\varphi}{\xi}{\omega}(\omega(\psi), \val{\psi}{\xi}{\omega})
  \in \Cb_{\omega(\varphi\psi)}$, by the definition of candidates of a
  type constructor with kind~$\kappa_1\arrkind\kappa_2$ (note that
  $\omega(\psi)$ is closed, because $\omega$ is closed for~$\sigma$).

  Finally, assume $\sigma = \lambda(\alpha:\kappa)\varphi$. Let $\psi$
  be a closed type constructor of kind~$\kappa$ and $X \in
  \Cb_{\psi}$. By the inductive hypothesis
  $\val{\lambda(\alpha:\kappa)\varphi}{\xi}{\omega}(\psi,X) =
  \val{\varphi}{\xi[\subst{\alpha}{X}]}{\omega[\subst{\alpha}{\psi}]}
  \in \Cb_{\omega[\subst{\alpha}{\psi}](\varphi)}$. Because $\psi$ is
  closed we have $\omega[\subst{\alpha}{\psi}](\varphi) =
  \omega(\varphi[\subst{\alpha}{\psi}]) =_\beta
  \omega((\lambda\alpha.\varphi)\psi) = \omega(\sigma\psi) =
  \omega(\sigma)\psi$. By Lemma~\ref{lem_beta_candidate} this implies
  that $\val{\sigma}{\xi}{\omega} \in \Cb_{\omega(\sigma)}$.
\end{proof}

\begin{lemma}\label{lem_circ}
  If $\omega$ is closed for~$\sigma$ then $\circ_{\omega(\sigma)} \in
  \val{\sigma \arrtype \sigma \arrtype \sigma}{\xi}{\omega}$ for
  $\circ \in \{ \oplus, \otimes \}$.
\end{lemma}

\begin{proof}
  Follows from definitions, Lemma~\ref{lem_val_computable} and
  property~4 of candidates.
\end{proof}

\begin{lemma}\label{lem_lift}
  If $\omega$ is closed for~$\sigma$ then $\lift_{\omega(\sigma)} \in
  \val{\nat\arrtype\sigma}{\xi}{\omega}$.
\end{lemma}

\begin{proof}
  Follows from definitions, Lemma~\ref{lem_val_computable} and
  property~5 of candidates.
\end{proof}

\begin{lemma}\label{lem_flatten}
  If $\omega$ is closed for~$\sigma$ then $\flatten_{\omega(\sigma)}
  \in \val{\sigma\arrtype\nat}{\xi}{\omega}$.
\end{lemma}

\begin{proof}
  Follows from definitions, Lemma~\ref{lem_val_computable} and
  property~6 of candidates.
\end{proof}

\begin{lemma}\label{lem_val_subst}
  For any type constructors~$\sigma,\tau$ with $\alpha \notin
  \FV(\tau)$, a mapping~$\omega$ closed for~$\sigma$ and for~$\tau$,
  and an $\omega$-valuation~$\xi$, we have:
  \[
  \val{\sigma[\subst{\alpha}{\tau}]}{\xi}{\omega} =
  \val{\sigma}{\xi[\subst{\alpha}{\val{\tau}{\xi}{\omega}}]}{\omega[\subst{\alpha}{\omega(\tau)}]}.
  \]
\end{lemma}

\begin{proof}
  Let~$\omega' = \omega[\subst{\alpha}{\omega(\tau)}]$ and $\xi' =
  \xi[\subst{\alpha}{\val{\tau}{\xi}{\omega}}]$. First note
  that~$\omega$ is closed for~$\sigma[\subst{\alpha}{\tau}]$
  and~$\omega'$ is closed for~$\sigma$. We proceed by induction
  on~$\sigma$. If $\alpha \notin \FV(\sigma)$ then the claim is
  obvious. If $\sigma = \alpha$ then
  $\val{\sigma[\subst{\alpha}{\tau}]}{\xi}{\omega} =
  \val{\tau}{\xi}{\omega} = \val{\sigma}{\xi'}{\omega'}$.

  Assume $\sigma = \sigma_1\arrtype\sigma_2$. We show
  $\val{\sigma[\subst{\alpha}{\tau}]}{\xi}{\omega} \subseteq
  \val{\sigma}{\xi'}{\omega'}$. Let $t \in
  \val{\sigma[\subst{\alpha}{\tau}]}{\xi}{\omega}$. We have $t :
  \omega(\sigma[\subst{\alpha}{\tau}])$, so $t : \omega'(\sigma)$. Let
  $u \in \val{\sigma_1}{\xi'}{\omega'}$. By the inductive hypothesis
  $u \in \val{\sigma_1[\subst{\alpha}{\tau}]}{\xi}{\omega}$. Hence $t
  u \in \val{\sigma_2[\subst{\alpha}{\tau}]}{\xi}{\omega} =
  \val{\sigma_2}{\xi'}{\omega'}$, where the last equality follows from
  the inductive hypothesis. Thus $t \in
  \val{\sigma}{\xi'}{\omega'}$. The other direction is analogous. The
  case $\sigma = \forall\alpha[\sigma']$ is also analogous.

  Assume $\sigma = \varphi\psi$. We have
  $\val{\sigma[\subst{\alpha}{\tau}]}{\xi}{\omega} =
  \val{\varphi[\subst{\alpha}{\tau}]}{\xi}{\omega}(\omega(\psi[\subst{\alpha}{\tau}]),
  \val{\psi[\subst{\alpha}{\tau}]}{\xi}{\omega}) =
  \val{\varphi[\subst{\alpha}{\tau}]}{\xi}{\omega}(\omega'(\psi),
  \val{\psi[\subst{\alpha}{\tau}]}{\xi}{\omega}) =
  \val{\varphi}{\xi'}{\omega'}(\omega'(\psi),
  \val{\psi}{\xi'}{\omega'})$ where the last equality follows from the
  inductive hypothesis.

  Finally, assume $\sigma = \lambda(\beta:\kappa)\varphi$. Let $\psi
  \in \Tc_\kappa$ be closed and let $X \in \Cb_\psi$. We have
  $\val{\sigma[\subst{\alpha}{\tau}]}{\xi}{\omega}(\psi,X) =
  \val{\varphi[\subst{\alpha}{\tau}]}{\xi[\subst{\beta}{X}]}{\omega[\subst{\beta}{\tau}]}
  =
  \val{\varphi}{\xi'[\subst{\beta}{X}]}{\omega'[\subst{\beta}{\tau}]}
  = \val{\sigma}{\xi'}{\omega'}(\psi,X)$ where we use the inductive
  hypothesis in the penultimate equality.
\end{proof}

\begin{lemma}\label{lem_forall}
  Let $\tau$ be a type constructor of kind~$\kappa$. Assume $\omega$
  is closed for $\forall\alpha[\sigma]$ and for~$\tau$. If $t \in
  \val{\forall(\alpha:\kappa)[\sigma]}{\xi}{\omega}$ then $t
  (\omega(\tau)) \in \val{\sigma[\subst{\alpha}{\tau}]}{\xi}{\omega}$.
\end{lemma}

\begin{proof}
  By Lemma~\ref{lem_val_computable} we have~$\val{\tau}{\xi}{\omega}
  \in \Cb_{\omega(\tau)}$. So $t (\omega(\tau)) \in
  \val{\sigma}{\xi[\subst{\alpha}{\val{\tau}{\xi}{\omega}}]}{\omega[\subst{\alpha}{\omega(\tau)}]}$
  by $t \in \val{\forall(\alpha:\kappa)[\sigma]}{\xi}{\omega}$. Hence
  $t (\omega(\tau)) \in
  \val{\sigma[\subst{\alpha}{\tau}]}{\xi}{\omega}$ by
  Lemma~\ref{lem_val_subst}.
\end{proof}

\begin{lemma}\label{lem_beta_val}
  If $\omega$ is closed for~$\sigma,\sigma'$ and $\sigma =_\beta
  \sigma'$ then $\val{\sigma}{\xi}{\omega} =
  \val{\sigma'}{\xi}{\omega}$.
\end{lemma}

\begin{proof}
  It suffices to show the lemma for the case when~$\sigma$ is a
  $\beta$-redex. Then the general case follows by induction
  on~$\sigma$ and the length of reduction to a common reduct.

  So assume $(\lambda\alpha\tau)\sigma \to_\beta
  \tau[\subst{\alpha}{\sigma}]$. We have
  $\val{(\lambda\alpha\tau)\sigma}{\xi}{\omega} =
  \val{\lambda\alpha\tau}{\xi}{\omega}(\omega(\sigma),
  \val{\sigma}{\xi}{\omega}) =
  \val{\tau}{\xi[\subst{\alpha}{\val{\sigma}{\xi}{\omega}}]}{\omega[\subst{\alpha}{\omega(\sigma)}]}
  = \val{\tau[\subst{\alpha}{\sigma}]}{\xi}{\omega}$ where the last
  equality follows from Lemma~\ref{lem_val_subst}.
\end{proof}

A mapping~$\omega$ on type constructors is extended in the obvious way
to a mapping on terms. Note that $\omega$ also acts on the type
annotations of variable occurrences, e.g.~$\omega(\lambda x : \alpha
. x^\alpha) = \lambda x : \omega(\alpha) . x^{\omega(\alpha)}$.

\begin{lemma}\label{lem_typable_computable}
  If $t : \sigma$ and $\omega$ is closed for~$\sigma$ and
  $\FTV(\omega(t)) = \emptyset$ then $\omega(t) \in
  \val{\sigma}{\xi}{\omega}$.
\end{lemma}

\begin{proof}
  We prove by induction on the structure of~$t$ that if $t : \sigma$
  and $\omega$ is closed for~$\sigma$ and $\FTV(\omega(t)) =
  \emptyset$ and $x_1^{\tau_1},\ldots,x_n^{\tau_n}$ are all free
  variable occurrences in the canonical representative of~$t$ (so
  each~$\tau_i$ is $\beta$-normal), then for all
  $u_1\in\val{\tau_1}{\xi}{\omega},\ldots,u_n\in\val{\tau_n}{\xi}{\omega}$
  we have $\omega(t)[\subst{x_1}{u_1},\ldots,\subst{x_n}{u_n}] \in
  \val{\sigma}{\xi}{\omega}$. This suffices because
  $\omega(x_i^{\tau_i}) \in \val{\tau_i}{\xi}{\omega}$. Note that
  $\omega$ is closed for each~$\tau_i$ because $\FTV(\omega(t)) =
  \emptyset$ and~$t$ is typed, so no type constructor variable
  occurring free in~$\tau_i$ can be bound in~$t$ by a~$\Lambda$;
  e.g.~$\Lambda \alpha . x^\alpha$ is not a valid typed term (we
  assume~$\tau_i$ to be in $\beta$-normal form). For brevity, we use
  the notation $\omega^*(t) =
  \omega(t)[\subst{x_1}{u_1},\ldots,\subst{x_n}{u_n}]$. Note that
  $\omega^*(t) : \omega(\sigma)$.

  By the generation lemma for $t : \sigma$ there is a type~$\sigma'$
  such that $\sigma' =_\beta \sigma$ and $\FV(\sigma') \subseteq
  \FV(\sigma) \cup \FTV(t)$ and one of the cases below holds. Note
  that~$\omega$ is closed for~$\sigma'$ because it is closed
  for~$\sigma$ and $\FTV(\omega(t)) = \emptyset$. By
  Lemma~\ref{lem_beta_val} it suffices to show $\omega^*(t) \in
  \val{\sigma'}{\xi}{\omega}$.
  \begin{itemize}
  \item If $t = x_1^{\tau_1}$ and $\tau_1 =_\beta \sigma'$ then
    $\omega(t)[\subst{x_1}{u_1}] =
    (x_1^{\omega(\tau_1)})[\subst{x_1}{u_1}] = u_1 \in
    \val{\tau_1}{\xi}{\omega} = \val{\sigma'}{\xi}{\omega}$ by
    assumption and Lemma~\ref{lem_beta_val}.
  \item If $t = n$ is a natural number and $\sigma' = \nat$ then $t
    \in \val{\nat}{}{}$ by definition.
  \item If $t$ is a function symbol then the claim follows from
    Lemma~\ref{lem_circ}, Lemma~\ref{lem_lift} or
    Lemma~\ref{lem_flatten}.
  \item If $t = \abs{x:\sigma_1}{s}$ then
    $\sigma' = \sigma_1\arrtype\sigma_2$ and $s : \sigma_2$. Hence
    $\omega$ is closed for~$\sigma_2$. Let
    $u \in \val{\sigma_1}{\xi}{\omega}$. By the inductive hypothesis
    $\omega^*(s)[\subst{x}{u}] \in \val{\sigma_2}{\xi}{\omega}$. Hence
    $\omega^*(t) \in \val{\sigma'}{\xi}{\omega}$ by
    Lemma~\ref{lem_abstraction_computable}.
  \item If $t = \tabs{\alpha:\kappa}{s}$ then $\sigma' =
    \forall\alpha[\tau]$ and $s : \tau$. Let $\psi$ be a closed type
    constructor of kind~$\kappa$ and let $X \in \Cb_\psi$. Let
    $\omega_1 = \omega[\subst{\alpha}{\psi}]$ and
    $\xi_1=\xi[\subst{\alpha}{X}]$. Then $\omega_1$ is closed
    for~$\tau$ and $\FTV(\omega_1(s)) = \emptyset$. By the inductive
    hypothesis $\omega_1^*(s) \in \val{\tau}{\xi_1}{\omega_1}$. We
    have $\omega_1^*(s) = \omega^*(s)[\subst{\alpha}{\psi}]$ (assuming
    $\alpha$ chosen fresh such that $\omega(\alpha) = \alpha$). Hence
    $\omega^*(t) \in \val{\tau}{\xi}{\omega}$ by
    Lemma~\ref{lem_abstraction_computable}.
  \item If $t = t_1 t_2$ then $t_1 : \tau\arrtype\sigma'$ and
    $t_2 : \tau$ and $\FV(\tau) \subseteq \FV(\sigma) \cup
    \FTV(t)$. Hence~$\omega$ is closed for~$\tau$ and
    for~$\tau\arrtype\sigma'$. By the inductive hypothesis
    $\omega^*(t_1) \in \val{\tau\arrtype\sigma'}{\xi}{\omega}$ and
    $\omega^*(t_2) \in \val{\tau}{\xi}{\omega}$. We have
    $\omega^*(t_2) : \omega(\tau)$. Then by definition
    $\omega^*(t) = (\omega^*(t_1))(\omega^*(t_2)) \in
    \val{\sigma'}{\xi}{\omega}$.
  \item If $t = s \psi$ then $s : \forall\alpha[\tau]$ and $\sigma' =
    \tau[\subst{\alpha}{\psi}]$. By the inductive hypothesis
    $\omega^*(s) \in \val{\forall\alpha[\tau]}{\xi}{\omega}$. Because
    $\FTV(\omega(t)) = \emptyset$, the mapping $\omega$ is closed
    for~$\psi$. So by Lemma~\ref{lem_forall} we have $\omega^*(t) =
    \omega^*(s) \omega(\psi) \in
    \val{\tau[\subst{\alpha}{\psi}]}{\xi}{\omega}$.\qed
  \end{itemize}
\end{proof}

\begin{theorem}\label{thm_sn}
  If $\Gamma \proves t : \sigma$ then $t \in \SN$.
\end{theorem}

\begin{proof}
  For closed terms~$t$ and closed types~$\sigma$ this follows from
  Lemma~\ref{lem_typable_computable}, Lemma~\ref{lem_val_computable}
  and property~1 of candidates (Definition~\ref{def_candidate}). For
  arbitrary terms and types, this follows by closing the terms with an
  appropriate number of abstractions, and the types with corresponding
  $\forall$-quantifiers.\qed
\end{proof}

\begin{lemma}\label{lem_unique_final}
  Every term $s \in \Iterms$ has a unique normal form~$s\da$. If~$s$
  is closed then so is~$s\da$.
\end{lemma}

\begin{proof}
  One checks that~$\leadsto$ is locally confluent. Since it is
  terminating by Theorem~\ref{thm_sn}, it is confluent by Newman's
  lemma.\qed
\end{proof}

\begin{lemma}\label{lem_final_nat}
  The only final interpretation terms of type $\nat$ are the natural
  numbers.
\end{lemma}

\begin{proof}
  We show by induction on~$t$ that if $t$ is a final interpretation
  term of type~$\nat$ then $t$ is a natural number. Because~$t$ is
  closed and in normal form, if it is not a natural number then it
  must have the form $\mathtt{f}_\sigma t_1 \ldots t_n$ for a function
  symbol $\mathtt{f}$. For concreteness assume $\mathtt{f} =
  \oplus$. Then $n \ge 2$. Because~$t$ is closed, $\sigma$ cannot be a
  type variable. It also cannot be an arrow or a $\forall$-type,
  because then $t$ would contain a redex. So $\sigma=\nat$. Then
  $t_1,t_2$ are final interpretation terms of type~$\nat$, hence
  natural numbers by the inductive hypothesis. But then $t$ contains a
  redex. Contradiction.\qed
\end{proof}

\subsection{Defining $\succ$ and $\succeq$}

In what follows we work with orthodox Church-style typed terms.

\begin{definition}\label{def_closure}\normalfont
  A \emph{replacement} is a function $\delta = \gamma \circ \omega$
  satisfying:
  \begin{enumerate}
  \item $\omega$ is a type constructor substitution,
  \item $\gamma$ is a term substitution such that $\gamma(x^\tau) :
    \omega(\tau)$ for every variable~$x$.
  \end{enumerate}
  A \emph{closure}~$\cl = \gamma \circ \omega$ is a replacement such
  that $\omega(\alpha)$ is closed for each type constructor
  variable~$\alpha$, and $\gamma(x)$ is closed for each term
  variable~$x$.

  For~$\tau$ a type constructor, we use $\cl(\tau)$ to denote
  $\omega(\tau)$. We use the notation $\cl[\subst{x}{t}] =
  \gamma[\subst{x}{t}] \circ \omega$. Analogously with~$\delta$.
\end{definition}

Note that if $t \in \Iterms$ and $t : \tau$ then $\cl(t)$ and
$\cl(\tau)$ are closed and $\cl(t) : \cl(\tau)$.

\begin{definition}\label{def:succ}\normalfont
  Let $R \in \{ \succ,\succeq \}$. For closed~$s,t\in\Iterms_\sigma$
  and closed~$\sigma$ in $\beta$-normal form, the relation
  $s\ R_{\sigma}\ t$ is defined coinductively by the following rules.
  \[
  \begin{array}{cc}
    \infer={s\ R_\nat\ t}{s\da\ R\ t\da \text{ in natural numbers}} \quad&\quad
    \infer={s\ R_{\sigma\arrtype\tau}\ t}{\app{s}{q}\ R_{\tau}\ \app{t}{q} \text{ for all } q \in \World_\sigma} \\ \\
    \multicolumn{2}{c}{
    \infer={s\ R_{\forall(\alpha:\kappa)[\sigma]}\ t}{\tapp{s}{\tau}\ R_{\nf_\beta(\sigma[\subst{\alpha}{\tau}])}\ \tapp{t}{\tau} \text{ for all closed } \tau \in \Tc_{\kappa}}}
  \end{array}
  \]
  We define $s \approx_\sigma t$ if both $s \succeq_\sigma t$ and $t
  \succeq_\sigma s$.

  For arbitrary types~$\sigma$ and arbitrary terms $s,t \in \Iterms$
  we define $s \succ_\sigma t$ if for every closure~$\cl$ we can
  obtain $\cl(s) \succ_{\nf_\beta(\cl(\sigma))} \cl(t)$ coinductively
  with the above rules. The relations $\succeq_\sigma$ and
  $\approx_\sigma$ are extended analogously. We drop the type
  subscripts when clear or irrelevant.
\end{definition}

Note that in the case for~$\nat$ the terms~$s\da$, $t\da$ are natural
numbers by Lemma~\ref{lem_final_nat} ($s\da,t\da$ are closed and in
normal form, so they are final interpretation terms).

Intuitively, the above definition means that e.g. $s \succ t$ iff
there exists a possibly infinite derivation tree using the above
rules. In such a derivation tree all leaves must witness $s\da > t\da$
in natural numbers. However, this also allows for infinite branches,
which solves the problem of repeating types due to impredicative
polymorphism. If e.g.~$s \succ_{\forall \alpha . \alpha} t$ then
$\tapp{s}{\forall\alpha.\alpha} \succ_{\forall \alpha . \alpha}
\tapp{t}{\forall\alpha.\alpha}$, which forces an infinite branch in
the derivation tree. According to our definition any infinite branch
may essentially be ignored.

The coinductive definition of~$\succ$ and~$\succeq$ can be
reformulated as follows.

\begin{lemma}
  $t \succeq s$ if and only if for every closure~$\cl$ and every
  sequence $u_1,\ldots,u_n$ of closed terms and type constructors such
  that $\cl(t) u_1 \ldots u_n : \nat$ we have $(\cl(t) u_1 \ldots
  u_n)\da \ge (\cl(s) u_1 \ldots u_n)\da$ in natural numbers. An
  analogous result holds with $\succ$ or $\approx$ instead
  of~$\succeq$.
\end{lemma}

\begin{proof}
  The direction from left to right follows by induction on~$n$. The
  other direction follows by coinduction.
\end{proof}

In what follows, all proofs by coinduction could be reformulated to
instead use the characterisation of $\succ$, $\succeq$ and~$\approx$
from the above lemma. However, this would arguably make the proofs
less perspicuous.

\subsection{Properties of $\succ$ and $\succeq$}

First we state a simple lemma that will be used implicitly in what
follows.

\begin{lemma}
  If~$\tau$ is a closed interpretation type in $\beta$-normal form
  then $\tau = \nat$ or $\tau = \tau_1\arrtype\tau_2$ or $\tau =
  \forall\alpha\sigma$.
\end{lemma}

We're going to at least need to see that $\succ$ is a well-founded
ordering.

\begin{lemma}
  $\succ$ is well-founded.
\end{lemma}

\begin{proof}
  It suffices to show this for closed terms and closed types in
  $\beta$-normal form, because any infinite sequence $t_1 \succ_\tau
  t_2 \succ_\tau t_3 \succ_\tau \ldots$ induces an infinite sequence
  $\cl(t_1) \succ_{\nf_\beta(\cl(\tau))} \cl(t_2)
  \succ_{\nf_\beta(\cl(\tau))} \cl(t_3) \succ_{\nf_\beta(\cl(\tau))}
  \ldots$ for any closure~$\cl$. By induction on the size of a
  $\beta$-normal type~$\tau$ (with size measured as the number of the
  occurrences of~$\forall$ and~$\arrtype$) one proves that there does
  not exist an infinite sequence $t_1 \succ_\tau t_2 \succ_\tau t_3
  \succ_\tau \ldots$ For instance, if $\alpha$ has kind~$\kappa$ and
  $t_1 \succ_{\forall\alpha[\tau]} t_2 \succ_{\forall\alpha[\tau]} t_3
  \succ_{\forall\alpha[\tau]} \ldots$ then $\tapp{t_1}{\chi_\kappa}
  \succ_{\tau'} \tapp{t_2}{\chi_\kappa} \succ_{\tau'}
  \tapp{t_3}{\chi_\kappa} \succ_{\tau'} \ldots$, where
  $\tau'=\nf_\beta(\tau[\subst{\alpha}{\chi_\kappa}])$. Because $\tau$
  is in $\beta$-normal form, all redexes in
  $\tau[\subst{\alpha}{\chi_\kappa}]$ are created by the substitution
  and must have the form $\chi_\kappa u$. Hence, by the definition
  of~$\chi_\kappa$ (see Definition~\ref{def_chi_kappa}) the
  type~$\tau'$ is smaller than~$\tau$. This is impossible by the
  inductive hypothesis.
\end{proof}

\begin{lemma}
  Both $\succ$ and $\succeq$ are transitive.
\end{lemma}

\begin{proof}
  We show this for~$\succ$, the proof for~$\succeq$ being
  analogous. Again, it suffices to prove this for closed terms and
  closed types in $\beta$-normal form. We proceed by coinduction.

  If $t_1 \succ_\nat t_2 \succ_\nat t_3$ then $t_1\da > t_2\da >
  t_3\da$, so $t_1\da > t_3\da$. Thus $t_1 \succ_\nat t_3$.

  If $t_1 \succ_{\sigma\arrtype\tau}t_2\succ_{\sigma\arrtype\tau}t_3$
  then $\app{t_1}{q}\succ_{\tau}\app{t_2}{q}\succ_\tau\app{t_3}{q}$
  for $q \in \World_\sigma$. Hence
  $\app{t_1}{q}\succ_\tau\app{t_3}{q}$ for $q \in \World_\sigma$ by
  the coinductive hypothesis. Thus $t_1\succ_{\sigma\arrtype\tau}
  t_3$.

  If $t_1
  \succeq_{\forall(\alpha:\kappa)[\sigma]}t_2\succ_{\forall(\alpha:\kappa)[\sigma]}t_3$
  then
  $\tapp{t_1}{\tau}\succ_{\sigma'}\tapp{t_2}{\tau}\succ_{\sigma'}\tapp{t_3}{\tau}$
  for any closed type constructor~$\tau$ of kind~$\kappa$, where
  $\sigma' = \nf_\beta(\sigma[\subst{\alpha}{\tau}])$. Hence
  $\tapp{t_1}{\tau}\succ_{\sigma'}\tapp{t_3}{\tau}$ by the coinductive
  hypothesis. Thus $t_1\succeq_{\forall\alpha[\sigma]} t_3$.\qed
\end{proof}

And that $\succeq$ is a quasi-ordering:

\begin{lemma}
  $\succeq$ is reflexive.
\end{lemma}

\begin{proof}
  By coinduction one shows that $\succeq_\sigma$ is reflexive on
  closed terms for closed $\beta$-normal~$\sigma$. The general case is
  then immediate from definitions.\qed
\end{proof}

Finally, they must be compatible:

\begin{lemma}\label{lem:compatibility}
  We have $\succ \cdot \succeq\ \subseteq\ \succ$ and $\succeq \cdot
  \succ\ \subseteq\ \succ$.
\end{lemma}

\begin{proof}
  By coinduction, analogous to the transitivity proof.\qed
\end{proof}

\begin{lemma}\label{lem_succ_to_succeq}
  If $t \succ s$ then $t \succeq s$.
\end{lemma}

\begin{proof}
  By coinduction.
\end{proof}

\begin{lemma}\label{lem_succ_red}
  Assume $t \succ s$ (resp.~$t \succeq s$).
  \begin{enumerate}
  \item If $t \leadsto t'$ or $t' \leadsto t$ then $t' \succ s$ (resp.~$t' \succeq s$).
  \item If $s \leadsto s'$ or $s' \leadsto s$ then $t \succ s'$
    (resp.~$t \succeq s'$).
  \end{enumerate}
\end{lemma}

\begin{proof}
  We show the first point assuming $t \leadsto t'$, other cases being
  analogous. It suffices to show this for closed $t,t',s$ and the type
  closed and in $\beta$-normal form, because $t \leadsto t'$ implies
  $\cl(t) \leadsto \cl(t')$ for any closure~$\cl$.

  We proceed by coinduction. If $t \succ_\nat s$ then $t\da = t'\da$
  and the claim holds.

  If $t \succ_{\sigma\arrtype\tau} s$ then for every $q \in
  \World_\sigma$ we have $\app{t}{q} \succ_\tau \app{s}{q}$. We have
  $\app{t}{q} \leadsto \app{t'}{q}$. Hence $\app{t'}{q} \succ_\tau
  \app{s}{q}$ by the coinductive hypothesis. Thus $t'
  \succ_{\sigma\arrtype\tau} s$.

  If $t \succ_{\forall(\alpha:\kappa)\sigma} s$ then for every closed
  type constructor~$\tau$ of kind~$\kappa$ we have $\tapp{t}{\tau}
  \succ_{\sigma'} \tapp{s}{\tau}$ where $\sigma' =
  \nf_\beta(\sigma[\subst{\alpha}{\tau}])$. We have $\tapp{t}{\tau}
  \leadsto \tapp{t'}{\tau}$. Hence $\tapp{t'}{\tau} \succ_{\sigma'}
  \tapp{s}{\tau}$ by the coinductive hypothesis. Thus $t'
  \succ_{\forall(\alpha:\kappa)\sigma} s$.
\end{proof}

\begin{corollary}\label{cor_succ_da}
  For $R \in \{\succ,\succeq,\approx\}$: $s\ R\ t$ if and only if
  $s\downarrow\ R\ t\downarrow$.
\end{corollary}

For easier presentation, we will denote $\oplus$ and $\otimes$ in
\emph{infix, left-associative} notation, and omit the type denotation
where it is clear from context. Thus, $s \oplus t \oplus u$ should be
read as $\oplus_\sigma\,s\,(\oplus_\sigma\,t\,u)$ if $s$ has type
$\sigma$. Similarly, we will sometimes omit the type denotation from
$\flatten$ and $\lift$ when clear or irrelevant.

\begin{lemma}\label{lem:plusparts}
For all types $\sigma$, terms $s,t$ of type $\sigma$ and natural
numbers $n > 0$:
\begin{enumerate}
\item $s \oplus_{\sigma} t \succeq s$ and $s \oplus_{\sigma} t \succeq
  t$;
\item $s \oplus_{\sigma} (\lift_{\sigma} n) \succ s$ and
  $(\lift_{\sigma} n) \oplus_{\sigma} t \succ t$.
\end{enumerate}
\end{lemma}

\begin{proof}
  It suffices to prove this for closed $s,t$ and closed $\sigma$ in
  $\beta$-normal form.
  \begin{enumerate}
  \item By coinduction we show $(s \oplus t) u_1 \ldots u_m
    \succeq_\sigma s u_1 \ldots u_m$ for closed $u_1,\ldots,u_m$. The
    second case is similar.

    First note that $(s \oplus t) u_1 \ldots u_m \leadsto^* s u_1
    \ldots u_m \oplus t u_1 \ldots u_m$.

    If $\sigma = \nat$ then $((s \oplus t) u_1 \ldots u_m)\da = (s u_1
    \ldots u_m)\da + (t u_1 \ldots u_m)\da \ge (s u_1 \ldots
    u_m)\da$. Hence $(s \oplus t) u_1 \ldots u_m) \succeq_\nat s u_1
    \ldots u_m$.

    If $\sigma = \tau_1\arrtype\tau_2$ then by the coinductive
    hypothesis $(s \oplus t) u_1 \ldots u_m q \succeq_{\tau_2} s u_1
    \ldots u_m q$ for any $q \in \World_{\tau_1}$. Hence $(s \oplus t)
    u_1 \ldots u_m \succeq_\sigma s u_1 \ldots u_m$.

    If $\sigma = \forall(\alpha:\kappa)[\tau]$ then by the coinductive
    hypothesis $(s \oplus t) u_1 \ldots u_m \xi \succeq_{\sigma'} s
    u_1 \ldots u_m \xi$ for any closed $\xi \in \Tc_\kappa$, where
    $\sigma' = \tau[\subst{\alpha}{\xi}]$. Hence $(s \oplus t) u_1
    \ldots u_m \succeq_\sigma s u_1 \ldots u_m$.
  \item By coinduction we show $(s \oplus (\lift n)) u_1 \ldots u_m
    \succeq_\sigma s u_1 \ldots u_m$ for closed $u_1,\ldots,u_m$. The
    second case is similar.

    Note that $(s \oplus (\lift n)) u_1 \ldots u_m \leadsto^* s u_1
    \ldots u_m \oplus n$. From this the case $\sigma=\nat$
    follows. The other cases follow from the coinductive hypothesis,
    like in the first point above.
  \end{enumerate}
\end{proof}

\begin{lemma}\label{lem:liftgreater}
  If $n \geq m$ (resp.~$n > m$) then $\lift_\sigma n \succeq
  \lift_\sigma m$ (resp.~$\lift_\sigma n \succ \lift_\sigma m$) for
  all types $\sigma$.
\end{lemma}

\begin{proof}
  Without loss of generality we may assume $\sigma$ closed and in
  $\beta$-normal form. By coinduction one shows $\lift(n) u_1 \ldots
  u_k \succeq \lift(m) u_1 \ldots u_k$ for closed
  $u_1,\ldots,u_k$. This is similar to the proof of
  Lemma~\ref{lem:plusparts}.
\end{proof}

\begin{lemma}\label{lem_flatten_succ}
  If $t \succ_\sigma s$ then $\flatten_\sigma t \succ_\nat
  \flatten_\sigma s$ for all types $\sigma$. The same holds
  with~$\succeq$ instead of~$\succ$.
\end{lemma}

\begin{proof}
  Without loss of generality we may assume~$\sigma$ is closed and in
  $\beta$-normal form. Using Lemma~\ref{lem_succ_red}, one shows by
  induction on~$\sigma$ that if $t \succ_\sigma s$ then
  $\flatten_\sigma t \succ_\nat \flatten_\sigma s$ (the proof
  for~$\succeq$ is analogous). The same holds with~$\succeq$ instead
  of~$\succ$.
\end{proof}

\begin{lemma}\label{lem_abs_succ}
  If $t \succ s$ then $\abs{x}{t} \succ \abs{x}{s}$ and
  $\tabs{\alpha}{t} \succ \tabs{\alpha}{s}$. The same holds
  with~$\succeq$ instead of~$\succ$.
\end{lemma}

\begin{proof}
  Assume $t \succ_\tau s$ and $\Gamma \proves x : \sigma$. Let~$\cl$
  be a closure. We need to show $\cl(\abs{x}{t})
  \succ_{\cl(\sigma\arrtype\tau)} \cl(\abs{x}{s})$. Let $u \in
  \World_{\cl(\sigma)}$. Then $\cl' = \cl[\subst{x}{u}]$ is a closure
  and $\cl'(t) \succ_{\cl(\tau)} \cl'(s)$. Hence $\cl(t)[\subst{x}{u}]
  \succ_{\cl(\tau)} \cl(s)[\subst{x}{u}]$. By Lemma~\ref{lem_succ_red}
  this implies $\cl(\abs{x}{t}) u \succ_{\cl(\tau)} \cl(\abs{x}{s})
  u$. Therefore $\cl(\abs{x}{t}) \succ_{\cl(\sigma\arrtype\tau)}
  \cl(\abs{x}{s})$. The proof for the second part is analogous.
\end{proof}

\begin{lemma}\label{lem:plustimesmonotonic}
  Let $s,t,u$ be terms of type $\sigma$.
  \begin{enumerate}
  \item If $s \succeq t$ then $s \oplus_\sigma u \succeq t
    \oplus_\sigma u$, $u \oplus_\sigma s \succeq u \oplus_\sigma t$,
    and $s \otimes_\sigma u \succeq t \otimes_\sigma u$, $u
    \otimes_\sigma s \succeq u \otimes_\sigma t$.
  \item If $s \succ t$ then $s \oplus_\sigma u \succ t \oplus_\sigma
    u$ and $u \oplus_\sigma s \succ u \oplus_\sigma t$. Moreover, if
    additionally $u \succeq \lift_\sigma(1)$ then also $s
    \otimes_\sigma u \succ t \otimes_\sigma u$ and $u \otimes_\sigma s
    \succ u \otimes_\sigma t$.
  \end{enumerate}
\end{lemma}

\begin{proof}
  It suffices to prove this for closed $s,t,u$ and closed $\sigma$ in
  $\beta$-normal form. The proof is similar to the proof of
  Lemma~\ref{lem:plusparts}. For instance, we show by coinduction that
  for closed $w_1,\ldots,w_n$ if $s w_1 \ldots w_n \succ t w_1 \ldots
  w_n$ and $u w_1 \ldots w_n \succeq \lift(1) w_1 \ldots w_n$ then $(s
  \otimes u) w_1 \ldots w_n \succ (t \otimes u) w_1 \ldots w_n$.
\end{proof}

We observe that standard equality properties of addition and
multiplication extend to interpretation terms of other types:

\begin{lemma}\label{lem:approxproperties}
For all types $\sigma$ and all terms $s,t,u$ of type $\sigma$, we
have:
\begin{enumerate}
\item\label{lem:approx:symmetry} $s \oplus_\sigma t \approx t
  \oplus_\sigma s$ and $s \otimes_\sigma t \approx t \otimes_\sigma
  s$;
\item\label{lem:approx:assoc} $s \oplus_\sigma (t \oplus_\sigma u)
  \approx (s \oplus_\sigma t) \oplus_\sigma u$ and $s \otimes_\sigma
  (t \otimes_\sigma u) \approx (s \otimes_\sigma t) \otimes_\sigma u$;
\item\label{lem:approx:distribution} $s \otimes_\sigma (t
  \oplus_\sigma u) \approx (s \otimes_\sigma t) \oplus_\sigma (s
  \otimes_\sigma u)$;
\item\label{lem:approx:neutral} $(\lift_\sigma 0) \oplus_\sigma s
  \approx s$ and $(\lift_\sigma 1) \otimes_\sigma s \approx s$.
\end{enumerate}
\end{lemma}

\begin{proof}
  The proof is again analogous to the proof of
  Lemma~\ref{lem:plusparts}. For instance, for closed $s,t$ and closed
  $\sigma$ in $\beta$-normal form, we show by coinduction that $(s
  \oplus t) w_1 \ldots w_n \succeq (t \oplus s) w_1 \ldots w_n$ for
  closed $w_1,\ldots,w_n$ (and then the same with $\preceq$).
\end{proof}

\begin{lemma}
  \begin{enumerate}
  \item $\lift_\sigma(n+m) \approx_\sigma (\lift_\sigma n)
    \oplus_\sigma (\lift_\sigma n)$.
  \item $\lift_\sigma(n m) \approx_\sigma (\lift_\sigma n)
    \otimes_\sigma (\lift_\sigma n)$.
  \end{enumerate}
\end{lemma}

\begin{proof}
  It suffices to show this for closed~$\sigma$ in $\beta$-normal
  form. Then one proves by induction on~$\sigma$ that
  $(\lift_\sigma(n+m))\da = (\lift_\sigma n \oplus_\sigma \lift_\sigma
  n)\da$ (analogously for multiplication). This suffices by
  Corollary~\ref{cor_succ_da} and the reflexivity of~$\approx$.
\end{proof}

\subsection{Weak monotonicity}\label{sec_weakly_monotone}

We want to show that if $s \succeq s'$ then $t[\subst{x}{s}] \succeq
t[\subst{x}{s'}]$. A straightforward proof attempt runs into a problem
that, because of impredicativity of polymorphism, direct induction on
type structure is not possible. We adopt a method similar to Girard's
method of candidates from the termination proof.

\begin{definition}\label{def_wm_candidate}\normalfont
  By induction on the kind~$\kappa$ of a type constructor~$\tau$ we
  define the set~$\Cb_\tau$ of all candidates of type
  constructor~$\tau$.

  First assume $\kappa=*$, i.e., $\tau$ is a type. A a set~$X$ of
  terms of type~$\tau$ equipped with a binary relation~$\ge^X$ is a
  \emph{candidate of type~$\tau$} if it satisfies the following
  properties:
  \begin{enumerate}
  \item if $t \in X$ and $t' : \tau$ and $t' \leadsto t$ then $t' \in
    X$,
  \item if $t_1,t_2 \in X$ then $\circ_\tau t_1 t_2 \in X$ for $\circ
    \in \{\oplus,\otimes\}$,
  \item if $t : \nat$ then $\lift_\tau t \in X$.
  \end{enumerate}
  and the relation~$\ge^X$ satifies the following properties:
  \begin{enumerate}
  \item ${\succeq} \cap X \times X \subseteq {\ge^X}$,
  \item if $t_1 \ge^X t_2$ and $t_1' \leadsto t_1$ (resp.~$t_2'
    \leadsto t_2$) then $t_1' \ge^X t_2$ (resp.~$t_1 \ge^X t_2'$),
  \item if $t_1 \ge^X t_1'$ and $t_2 \ge^X t_2'$ then $\circ_\tau t_1
    t_2 \ge^X \circ_\tau t_1' t_2'$ for $\circ \in
    \{\oplus,\otimes\}$,
  \item if $t_1 \succeq_\nat t_2$ then $\lift_\tau(t_1) \ge^X
    \lift_\tau(t_2)$,
  \item if $t_1 \ge^X t_2$ then $\flatten_\tau(t_1) \succeq_\nat
    \flatten_\tau(t_2)$,
  \item $\ge^X$ is reflexive and transitive on~$X$.
  \end{enumerate}
  The relation~$\ge^X$ is a \emph{comparison candidate for~$X$},
  and~$X$ is a \emph{candidate set}.

  Now assume $\kappa = \kappa_1\arrkind\kappa_2$. A function $f :
  \Tc_{\kappa_1} \times \bigcup_{\xi\in\Tc_{\kappa_1}}\Cb_\xi \to
  \bigcup_{\xi\in\Tc_{\kappa_2}}\Cb_\xi$ is a \emph{candidate of type
    constructor~$\tau$} if for every closed type constructor~$\sigma$
  of kind~$\kappa_1$ and a candidate $X \in \Cb_\sigma$ we have
  $f(\sigma,X) \in \Cb_{\tau\sigma}$.
\end{definition}

\begin{lemma}\label{lem_beta_wm_candidate}
  If $\sigma =_\beta \sigma'$ then $\Cb_\sigma = \Cb_{\sigma'}$.
\end{lemma}

\begin{proof}
  Induction on the kind of~$\sigma$.
\end{proof}

\begin{definition}\label{def_wm_valuation}\normalfont
  Let $\omega$ be a mapping from type constructor variables to type
  constructors (respecting kinds). The mapping~$\omega$ extends in an
  obvious way to a mapping from type constructors to type
  constructors. A mapping~$\omega$ is \emph{closed for~$\sigma$} if
  $\omega(\alpha)$ is closed for $\alpha \in \FV(\sigma)$ (then
  $\omega(\sigma)$ is closed).

  An \emph{$\omega$-valuation} is a mapping~$\xi$ on type constructor
  variables such that $\xi(\alpha) \in \Cb_{\omega(\alpha)}$.

  For each type constructor~$\sigma$, each mapping~$\omega$ closed
  for~$\sigma$, and each $\omega$-valuation~$\xi$, we define
  $\val{\sigma}{\xi}{\omega}$ by induction on~$\sigma$:
  \begin{itemize}
  \item $\val{\alpha}{\xi}{\omega} = \xi(\alpha)$ for a type
    constructor variable~$\alpha$,
  \item $\val{\nat}{\xi}{\omega}$ is the set of all terms~$t \in
    \Iterms$ such that $t : \nat$; equipped with the relation
    $\gteq{\nat}{\xi}{\omega} = \succeq_\nat$,
  \item $\val{\sigma \arrtype \tau}{\xi}{\omega}$ is the set of all
    terms~$t$ such that $t : \omega(\sigma\arrtype\tau)$ and:
    \begin{itemize}
    \item for all $s \in \val{\sigma}{\xi}{\omega}$ we have
      $\app{t}{s} \in \val{\tau}{\xi}{\omega}$, and
    \item if $s_1 \gteq{\sigma}{\xi}{\omega} s_2$ then $\app{t}{s_1}
      \gteq{\tau}{\xi}{\omega} \app{t}{s_2}$;
    \end{itemize}
    equipped with the
    relation~$\gteq{\sigma\arrtype\tau}{\xi}{\omega}$ defined by:
    \begin{itemize}
    \item $t_1 \gteq{\sigma\arrtype\tau}{\xi}{\omega} t_2$ iff
      $t_1,t_2 \in \val{\sigma\arrtype\tau}{\xi}{\omega}$ and for
      every $s \in \val{\sigma}{\xi}{\omega}$ we have $t_1 s
      \gteq{\tau}{\xi}{\omega} t_2 s$,
    \end{itemize}
  \item $\val{\forall(\alpha:\kappa)[\sigma]}{\xi}{\omega}$ is the set
    of all terms~$t$ such that $t : \omega(\forall\alpha[\sigma])$ and:
    \begin{itemize}
    \item for every closed type constructor~$\varphi$ of kind~$\kappa$
      and every $X \in \Cb_\varphi$ we have $\tapp{t}{\varphi} \in
      \val{\sigma}{\xi[\subst{\alpha}{X}]}{\omega[\subst{\alpha}{\varphi}]}$;
    \end{itemize}
    equipped with the
    relation~$\gteq{\forall\alpha[\sigma]}{\xi}{\omega}$ defined by:
    \begin{itemize}
    \item $t_1 \gteq{\forall(\alpha:\kappa)[\sigma]}{\xi}{\omega} t_2$
      iff $t_1,t_2 \in
      \val{\forall(\alpha:\kappa)[\sigma]}{\xi}{\omega}$ and for every
      closed type constructor~$\varphi$ of kind~$\kappa$ and every $X
      \in \Cb_\varphi$ we have $t_1 \varphi
      \gteq{\sigma}{\xi[\subst{\alpha}{X}]}{\omega[\subst{\alpha}{\varphi}]}
      t_2 \varphi$,
    \end{itemize}
  \item
    $\val{\varphi \psi}{\xi}{\omega} =
    \val{\varphi}{\xi}{\omega}(\omega(\psi),\val{\psi}{\xi}{\omega})$,
  \item
    $\val{\lambda(\alpha:\kappa)\varphi}{\xi}{\omega}(\psi,X) =
    \val{\varphi}{\xi[\subst{\alpha}{X}]}{\omega[\subst{\alpha}{\psi}]}$
    for closed $\psi \in \Tc_\kappa$ and $X \in \Cb_\psi$.
  \end{itemize}
  In the above, if e.g.~$\val{\psi}{\xi}{\omega} \notin
  \Cb_{\omega(\psi)}$ then $\val{\varphi \psi}{\xi}{\omega}$ is
  undefined.
\end{definition}

Note that if $t \in \val{\sigma}{\xi}{\omega}$ then $t :
\omega(\sigma)$, and if $t_1 \gteq{\sigma}{\xi}{\omega} t_2$ then
$t_1,t_2\in\val{\sigma}{\xi}{\omega}$. For brevity we
use~$\val{\sigma}{\xi}{\omega}$ to denote both the pair
$(\val{\sigma}{\xi}{\omega},{\gteq{\sigma}{\xi}{\omega}})$ and its
first element, depending on the context. For a type~$\tau$,
by~$\gteq{\tau}{\xi}{\omega}$ we always denote the second element of
the pair~$\val{\tau}{\xi}{\omega}$. If $\tau$ is closed then~$\xi$
and~$\omega$ do not matter and we simply write~$\geq_\tau$
and~$\val{\tau}{}{}$.

\begin{lemma}\label{lem_val_wm_computable}
  If $\sigma$ is a type constructor, $\omega$ is closed for~$\sigma$,
  and $\xi$ is an $\omega$-valuation, then $\val{\sigma}{\xi}{\omega}
  \in \Cb_{\omega(\sigma)}$.
\end{lemma}

\begin{proof}
  Induction on~$\sigma$. If $\sigma=\alpha$ then $\xi(\alpha) \in
  \Cb_{\omega(\alpha)}$ by definition. If $\sigma=\nat$ then this
  follows from definitions.

  Assume $\sigma=\sigma_1\arrtype\sigma_2$. We check the properties of
  a candidate set.
  \begin{enumerate}
  \item The first property follows from the inductive hypothesis and
    property~2 of comparison candidates.
  \item Let $t_1,t_2 \in \val{\sigma}{\xi}{\omega}$. We need to show
    $\circ_\omega(\sigma) t_1 t_2 \in
    \val{\sigma_1\arrtype\sigma_2}{\xi}{\omega}$.

    Let $s \in \val{\sigma_1}{\xi}{\omega}$. Then
    $\circ_{\omega(\sigma)} t_1 t_2 s \leadsto
    \circ_{\omega(\sigma_2)} (t_1 s) (t_2 s)$. Because $t_i \in
    \val{\sigma_1\arrtype\sigma_2}{\xi}{\omega}$, we have $t_i s \in
    \val{\sigma_2}{\xi}{\omega}$. By the inductive
    hypothesis~$\val{\sigma_2}{\xi}{\omega} \in
    \Cb_{\omega(\sigma_2)}$, so $\circ_{\omega(\sigma_2)} (t_1 s) (t_2
    s) \in \val{\sigma_2}{\xi}{\omega}$. Hence
    $\circ_{\omega(\sigma_2)} t_1 t_2 s \in
    \val{\sigma_2}{\xi}{\omega}$ by property~1 of candidate sets.

    Let $s_1 \gteq{\sigma_1}{\xi}{\omega} s_2$. Then $s_i \in
    \val{\sigma_1}{\xi}{\omega}$. Because $t_j \in
    \val{\sigma_1\arrtype\sigma_2}{\xi}{\omega}$, we have $t_j s_i \in
    \val{\sigma_2}{\xi}{\omega}$ and $t_j s_1
    \gteq{\sigma_2}{\xi}{\omega} t_j s_2$. By the inductive
    hypothesis~$\gteq{\sigma_2}{\xi}{\omega}$ is a comparison
    candidate for~$\val{\sigma_2}{\xi}{\omega}$. Thus
    $\circ_{\omega(\sigma_2)} (t_1 s_1) (t_2 s_1)
    \gteq{\sigma_2}{\xi}{\omega} \circ_{\omega(\sigma_2)} (t_1 s_2)
    (t_2 s_2)$ by property~3 of comparison candidates. This suffices
    by property~2 of comparison candidates.
  \item Let $t : \nat$. Then $\lift_{\omega(\sigma)} t :
    \omega(\sigma)$.

    Let $s \in \val{\sigma_1}{\xi}{\omega}$. Then
    $\lift_{\omega(\sigma)}t s \leadsto \lift_{\omega(\sigma_2)}
    t$. By the inductive hypothesis $\lift_{\omega(\sigma_2)} t \in
    \val{\sigma_2}{\xi}{\omega}$. Hence $\lift_{\omega(\sigma)}t s \in
    \val{\sigma_2}{\xi}{\omega}$ by property~1 of candidate sets.

    Let $s_1,s_2 \in \val{\sigma_1}{\xi}{\omega}$. By the inductive
    hypothesis~$\gteq{\sigma_2}{\xi}{\omega}$ is a comparison
    candidate for~$\val{\sigma_2}{\xi}{\omega}$. We have
    $\lift_{\omega(\sigma_2)} t \gteq{\sigma_2}{\xi}{\omega}
    \lift_{\omega(\sigma_2)} t$ by the reflexivity
    of~$\gteq{\sigma_2}{\xi}{\omega}$ (property~6 of comparison
    candidates). This suffices by property~2 of comparison candidates,
    because $\lift_{\omega(\sigma)}t s_i \leadsto
    \lift_{\omega(\sigma_2)} t$.
  \end{enumerate}
  Now we check the properties of a comparison candidate
  for~$\val{\sigma_1\arrtype\sigma_2}{\xi}{\omega}$.
  \begin{enumerate}
  \item Suppose $t_1 \succeq t_2$ with $t_1,t_2 \in
    \val{\sigma}{\xi}{\omega}$. Let $s \in
    \val{\sigma_1}{\xi}{\omega}$. Then $t_1 s \succeq t_2 s$ by the
    definition of~$\succeq$. Hence $t_1 s \gteq{\sigma_2}{\xi}{\omega}
    t_2 s$ by the inductive hypothesis.
  \item Follows from the inductive hypothesis and the already shown
    property~1 of candidate sets
    for~$\val{\sigma_1\arrtype\sigma_2}{\xi}{\omega}$.
  \item Assume $t_i \gteq{\sigma}{\xi}{\omega} t_i'$. Let $s \in
    \val{\sigma_1}{\xi}{\omega}$. We have $\circ_{\omega(\sigma)} t_1
    t_2 s \leadsto \circ_{\omega(\sigma_2)} (t_1 s) (t_2 s)$ and
    $\circ_{\omega(\sigma)} t_1' t_2' s \leadsto
    \circ_{\omega(\sigma_2)} (t_1' s) (t_2' s)$. Since
    $t_i,t_i'\in\val{\sigma}{\xi}{\omega}$, we have $t_i s
    \gteq{\sigma_2}{\xi}{\omega} t_i' s$ and $t_i s, t_i' s \in
    \val{\sigma_2}{\xi}{\omega}$. By the inductive hypothesis $\circ
    (t_1 s) (t_2 s) \gteq{\sigma_2}{\xi}{\omega} \circ (t_1' s) (t_2'
    s)$, so $\circ t_1 t_2 s \gteq{\sigma_2}{\xi}{\omega} \circ t_1'
    t_2' s$ by property~2 of comparison candidates. This implies
    $\circ t_1 t_2 \gteq{\sigma}{\xi}{\omega} \circ t_1' t_2'$.
  \item Follows from Lemma~\ref{lem:liftgreater} and property~1 of
    comparison candidates.
  \item Assume $t_1 \gteq{\sigma}{\xi}{\omega} t_2$. Then
    $\flatten_{\omega(\sigma)} t_i \leadsto
    \flatten_{\omega(\sigma_2)} (t_i (\lift_{\omega(\sigma_1)}0))$. By
    the inductive hypothesis and property~3 of candidate sets
    $\lift_{\omega(\sigma_1)}0 \in \val{\sigma_1}{\xi}{\omega}$. Hence
    $t_i (\lift_{\omega(\sigma_1)}0) \in \val{\sigma_2}{\xi}{\omega}$
    and $t_1 (\lift_{\omega(\sigma_1)}0) \gteq{\sigma_2}{\xi}{\omega}
    t_2 (\lift_{\omega(\sigma_1)}0)$. Thus
    $\flatten_{\omega(\sigma_2)} (t_1 (\lift_{\omega(\sigma_1)}0))
    \succeq_\nat \flatten_{\omega(\sigma_2)} (t_2
    (\lift_{\omega(\sigma_1)}0))$ by the inductive hypothesis. This
    implies $\flatten_{\omega(\sigma)} t_1 \succeq_\nat
    \flatten_{\omega(\sigma)} t_2$.
  \item Follows directly from the inductive hypothesis.
  \end{enumerate}

  If $\sigma=\forall\alpha\tau$ then the proof is analogous to the
  case $\sigma=\sigma_1\arrtype\sigma_2$. If $\sigma=\varphi\psi$ or
  $\sigma=\lambda(\alpha:\kappa)\varphi$ then the claim follows from
  the inductive hypothesis and Lemma~\ref{lem_beta_wm_candidate}, like
  in the proof of Lemma~\ref{lem_val_computable}.
\end{proof}

\begin{lemma}\label{lem_wm_circ}
  If $\omega$ is closed for~$\sigma$ then $\circ_{\omega(\sigma)} \in
  \val{\sigma \arrtype \sigma \arrtype \sigma}{\xi}{\omega}$ for
  $\circ \in \{ \oplus, \otimes \}$.
\end{lemma}

\begin{proof}
  Let $t_1,t_2 \in \val{\sigma}{\xi}{\omega}$. Then
  $\circ_{\omega(\sigma)} t_1 t_2 \in \val{\sigma}{\xi}{\omega}$ by
  Lemma~\ref{lem_val_wm_computable} and property~2 of candidate
  sets.

  Let $t_2' \in \val{\sigma}{\xi}{\omega}$ be such that $t_2
  \gteq{\sigma}{\xi}{\omega} t_2'$. By
  Lemma~\ref{lem_val_wm_computable} and properties~5 and~3 of
  comparison candidates we have we have $\circ_{\omega(\sigma)} t_1
  t_2 \gteq{\sigma}{\xi}{\omega} \circ_{\omega(\sigma)} t_1
  t_2'$. This shows $\circ_{\omega(\sigma)} t_1 \in
  \val{\sigma\arrtype\sigma}{\xi}{\omega}$.

  Let $t_1' \in \val{\sigma}{\xi}{\omega}$ be such that $t_1
  \gteq{\sigma}{\xi}{\omega} t_1'$. Let $u \in
  \val{\sigma}{\xi}{\omega}$. By Lemma~\ref{lem_val_wm_computable} and
  properties~2 and~3 of comparison candidates we have
  $\circ_{\omega(\sigma)} t_1 u \gteq{\sigma}{\xi}{\omega}
  \circ_{\omega(\sigma)} t_1' u$. Hence $\circ_{\omega(\sigma)} t_1
  \gteq{\sigma\arrtype\sigma}{\xi}{\omega} \circ_{\omega(\sigma)}
  t_1'$. This shows $\circ_{\omega(\sigma)} \in
  \val{\sigma}{\xi}{\omega}$.
\end{proof}

\begin{lemma}\label{lem_wm_lift}
  If $\omega$ is closed for~$\sigma$ then $\lift_{\omega(\sigma)} \in
  \val{\nat\arrtype\sigma}{\xi}{\omega}$.
\end{lemma}

\begin{proof}
  By Lemma~\ref{lem_val_wm_computable} and property~4 of comparison
  candidates we have $\lift_{\omega(\sigma)}s_1
  \gteq{\sigma}{\xi}{\omega} \lift_{\omega(\sigma)}s_2$ for all $s_i :
  \nat$ with $s_1 \succeq_\nat s_2$. It remains to show that
  $\lift_{\omega(\sigma)}s \in \val{\sigma}{\xi}{\omega}$ for all $s :
  \nat$. This follows from Lemma~\ref{lem_val_wm_computable} and
  property~3 of candidate sets.
\end{proof}

\begin{lemma}\label{lem_wm_flatten}
  If $\omega$ is closed for~$\sigma$ then $\flatten_{\omega(\sigma)}
  \in \val{\sigma\arrtype\nat}{\xi}{\omega}$.
\end{lemma}

\begin{proof}
  Follows from Lemma~\ref{lem_val_wm_computable} and property~5 of
  comparison candidates.
\end{proof}

\begin{lemma}\label{lem_val_subst_wm}
  For any type constructors~$\sigma,\tau$ with $\alpha \notin
  \FV(\tau)$, a mapping~$\omega$ closed for~$\sigma$ and for~$\tau$,
  and an $\omega$-valuation~$\xi$, we have:
  \[
  \val{\sigma[\subst{\alpha}{\tau}]}{\xi}{\omega} =
  \val{\sigma}{\xi[\subst{\alpha}{\val{\tau}{\xi}{\omega}}]}{\omega[\subst{\alpha}{\omega(\tau)}]}.
  \]
\end{lemma}

\begin{proof}
  Let~$\omega' = \omega[\subst{\alpha}{\omega(\tau)}]$ and $\xi' =
  \xi[\subst{\alpha}{\val{\tau}{\xi}{\omega}}]$. The proof by
  induction on~$\sigma$ is analogous to the proof of
  Lemma~\ref{lem_val_subst}. The main difference is that in the case
  $\sigma = \sigma_1\arrtype\sigma_2$ we need to show that if e.g.~$t
  \in \val{\sigma[\subst{\alpha}{\tau}]}{\xi}{\omega}$ and $s_1
  \gteq{\sigma_1}{\xi'}{\omega'} s_2$ then $t s_1
  \gteq{\sigma_2}{\xi'}{\omega'} t s_2$. But then $s_1
  \gteq{\sigma_1[\subst{\alpha}{\tau}]}{\xi}{\omega} s_2$ by the
  inductive hypothesis, so $t s_1
  \gteq{\sigma_2[\subst{\alpha}{\tau}]}{\xi}{\omega} t s_2$ by
  definition. Hence $t s_1 \gteq{\sigma_2}{\xi'}{\omega'} t s_2$ by
  the inductive hypothesis.
\end{proof}

\begin{lemma}\label{lem_wm_forall}
  Let $\tau$ be a type constructor of kind~$\kappa$. Assume $\omega$
  is closed for $\forall\alpha[\sigma]$ and for~$\tau$.
  \begin{enumerate}
  \item If $t \in \val{\forall(\alpha:\kappa)[\sigma]}{\xi}{\omega}$
    then $t (\omega(\tau)) \in
    \val{\sigma[\subst{\alpha}{\tau}]}{\xi}{\omega}$.
  \item If $t_1 \gteq{\forall(\alpha:\kappa)[\sigma]}{\xi}{\omega}
    t_2$ then $t_1 (\omega(\tau))
    \gteq{\sigma[\subst{\alpha}{\tau}]}{\xi}{\omega} t_2
    (\omega(\tau))$.
  \end{enumerate}
\end{lemma}

\begin{proof}
  Analogous to the proof of Lemma~\ref{lem_forall}, using
  Lemma~\ref{lem_val_wm_computable} and Lemma~\ref{lem_val_subst_wm}.
\end{proof}

\begin{lemma}\label{lem_beta_val_wm}
  If $\omega$ is closed for~$\sigma,\sigma'$ and $\sigma =_\beta
  \sigma'$ then $\val{\sigma}{\xi}{\omega} =
  \val{\sigma'}{\xi}{\omega}$ and ${\gteq{\sigma}{\xi}{\omega}} =
      {\gteq{\sigma'}{\xi}{\omega}}$.
\end{lemma}

\begin{proof}
  Analogous to the proof of Lemma~\ref{lem_beta_val}, using
  Lemma~\ref{lem_val_subst_wm}.
\end{proof}

For two replacements $\delta_1 = \gamma_1 \circ \omega$ and $\delta_2
= \gamma_2 \circ \omega$ (see Definition~\ref{def_closure}) and an
$\omega$-valuation~$\xi$ we write $\delta_1 \gteq{\tau}{\xi}{\omega}
\delta_2$ iff $\delta_1(x) \gteq{\tau}{\xi}{\omega} \delta_2(x)$ for
each~$x : \tau$.

\begin{lemma}\label{lem_typable_wm_computable}
  Assume $t : \sigma$ and $\delta_1=\gamma_1\circ\omega$,
  $\delta_2=\gamma_2\circ\omega$ are replacements and~$\xi$ an
  $\omega$-valuation such that $\delta_1 \gteq{}{\xi}{\omega}
  \delta_2$ and $\omega$ is closed for~$\sigma$ and $\FTV(\omega(t)) =
  \emptyset$ and for all $x^\tau \in \FV(t)$ we have $\delta_i(x) \in
  \val{\tau}{\xi}{\omega}$. Then $\delta_i(t) \in
  \val{\sigma}{\xi}{\omega}$ and $\delta_1(t)
  \gteq{\sigma}{\xi}{\omega} \delta_2(t)$.
\end{lemma}

\begin{proof}
  Induction on the structure of~$t$. By the generation lemma for $t :
  \sigma$ there is a type~$\sigma'$ such that $\sigma' =_\beta \sigma$
  and $\FV(\sigma') \subseteq \FV(\sigma) \cup \FTV(t)$ and one of the
  cases below holds. Note that $\omega$ is closed for~$\sigma'$,
  because it is closed for~$\sigma$ and $\FTV(\omega(t)) =
  \emptyset$. Hence by Lemma~\ref{lem_beta_val_wm} it suffices to show
  $\delta_i(t) \in \val{\sigma'}{\xi}{\omega}$ and $\delta_1(t)
  \gteq{\sigma'}{\xi}{\omega} \delta_2(t)$.
  \begin{itemize}
  \item If $t = x^{\tau_1}$ and $\tau_1 =_\beta \sigma'$ then
    $\delta_i(t) \in \val{\tau_1}{\xi}{\omega} =
    \val{\sigma'}{\xi}{\omega}$ by assumption and
    Lemma~\ref{lem_beta_val_wm}. Also $\delta_1(t)
    \gteq{\sigma'}{\xi}{\omega} \delta_2(t)$ by assumption and
    Lemma~\ref{lem_beta_val_wm}.
  \item If $t = n$ is a natural number and $\sigma' = \nat$ then
    $\delta_i(t) = t$ and thus $t \in \val{\nat}{}{}$ and $\delta_1(t)
    \gteq{\nat}{\xi}{\omega} \delta_2(t)$ by definition and the
    reflexivity of~$\gteq{\nat}{\xi}{\omega}$.
  \item If $t$ is a function symbol then the claim follows from
    Lemma~\ref{lem_wm_circ}, Lemma~\ref{lem_wm_lift} or
    Lemma~\ref{lem_wm_flatten}, and the reflexivity
    of~$\gteq{}{\xi}{\omega}$.
  \item If $t = \abs{x:\sigma_1}{u}$ then $\sigma' =
    \sigma_1\arrtype\sigma_2$ and $u : \sigma_2$. Let $s \in
    \val{\sigma_1}{\xi}{\omega}$ and
    $\delta_i'=\delta_i[\subst{x}{s}]$. This is well-defined because
    $s : \omega(\sigma_1)$ and~$\omega(x)$ has
    type~$\omega(\sigma_1)$. We have $\delta_1' \gteq{}{\xi}{\omega}
    \delta_2'$ by the reflexivity of~$\gteq{\sigma_1}{\xi}{\omega}$
    (Lemma~\ref{lem_val_wm_computable} and property~6 of comparison
    candidates). Hence by the inductive hypothesis $\delta_i'(u) \in
    \val{\sigma_2}{\xi}{\omega}$. We have $\delta_i(\abs{x}{u}) s
    \leadsto \delta_i'(u)$, so $\delta_i(\abs{x}{u}) s \in
    \val{\sigma_2}{\xi}{\omega}$ by Lemma~\ref{lem_val_wm_computable}
    and property~1 of candidate sets.

    Let $s_1,s_2 \in \val{\sigma_1}{\xi}{\omega}$ be such that $s_1
    \gteq{\sigma_1}{\xi}{\omega} s_2$. Let
    $\delta_i'=\delta_i[\subst{x}{s_i}]$. We have $\delta_1
    \gteq{}{\xi}{\omega} \delta_2$. Hence by the inductive hypothesis
    $\delta_1'(u)\gteq{\sigma_2}{\xi}{\omega}\delta_2'(u)$. We have
    $\delta_i(\abs{x}{u}) s_i \leadsto \delta_i'(u)$. Thus
    $\delta_1(t) s_1 \gteq{\sigma_2}{\xi}{\omega} \delta_2(t) s_2$ by
    Lemma~\ref{lem_val_wm_computable} and property~2 of comparison
    candidates.

    Finally, we show $\delta_1(t)
    \gteq{\sigma_1\arrtype\sigma_2}{\xi}{\omega} \delta_2(t)$. Let $s
    \in \val{\sigma_1}{\xi}{\omega}$ and
    $\delta_i'=\delta_i[\subst{x}{s}]$. We have $\delta_1'
    \gteq{}{\xi}{\omega} \delta_2'$. By the inductive hypothesis
    $\delta_1'(u) \gteq{\sigma_2}{\xi}{\omega} \delta_2'(u)$. We have
    $\delta_i(\abs{x}{u}) s \leadsto \delta_i'(u)$. Thus $\delta_1(t)
    s \gteq{\sigma_2}{\xi}{\omega} \delta_2(t) s$ by
    Lemma~\ref{lem_val_wm_computable} and property~2 of comparison
    candidates.
  \item If $t = \tabs{\alpha:\kappa}{u}$ then $\sigma' =
    \forall\alpha[\tau]$ and $u : \tau$. Let $\psi$ be a closed type
    constructor of kind~$\kappa$ and let $X \in \Cb_\psi$. Let
    $\omega' = \omega[\subst{\alpha}{\psi}]$ and
    $\xi'=\xi[\subst{\alpha}{X}]$. Then $\omega'$ is closed for~$\tau$
    and $\FTV(\omega'(u)) = \emptyset$. Let
    $\delta_i'=\gamma_i\circ\omega'$. By the inductive hypothesis
    $\delta_i'(u) \in \val{\tau}{\xi'}{\omega'}$ and $\delta_1'(u)
    \gteq{\tau}{\xi'}{\omega'} \delta_2'(u)$. We have
    $\delta_i(\tabs{\alpha}{u}) \psi \leadsto \delta_i'(u)$. Hence
    $\delta_i(\tabs{\alpha}{u}) \psi \in \val{\tau}{\xi'}{\omega'}$ by
    Lemma~\ref{lem_val_wm_computable} and property~1 of candidate
    sets. Thus $\delta_i(\tabs{\alpha}{u}) \in
    \val{\forall\alpha[\tau]}{\xi}{\omega}$. Also
    $\delta_1(\tabs{\alpha}{u}) \psi \gteq{\tau}{\xi'}{\omega'}
    \delta_2(\tabs{\alpha}{u}) \psi$ by
    Lemma~\ref{lem_val_wm_computable} and property~2 of comparison
    candidates. Thus $\delta_1(\tabs{\alpha}{u})
    \gteq{\forall\alpha[\tau]}{\xi'}{\omega'}
    \delta_2(\tabs{\alpha}{u})$.
  \item If $t = t_1 t_2$ then $t_1 : \tau\arrtype\sigma'$ and $t_2 :
    \tau$ and $\FV(\tau) \subseteq \FV(\sigma) \cup
    \FTV(t)$. Hence~$\omega$ is closed for~$\tau$ and
    for~$\tau\arrtype\sigma'$. By the inductive hypothesis
    $\delta_i(t_1) \in \val{\tau\arrtype\sigma'}{\xi}{\omega}$ and
    $\delta_i(t_2) \in \val{\tau}{\xi}{\omega}$ and $\delta_1(t_1)
    \gteq{\tau\arrtype\sigma'}{\xi}{\omega} \delta_2(t_1)$ and
    $\delta_1(t_2) \gteq{\tau}{\xi}{\omega} \delta_2(t_2)$. By the
    definition of $\val{\tau\arrtype\sigma'}{\xi}{\omega}$ we have
    $\delta_i(t) = \delta_i(t_1)\delta_i(t_2) \in
    \val{\sigma'}{\xi}{\omega}$, and $\delta_1(t_1)\delta_1(t_2)
    \gteq{\sigma'}{\xi}{\omega} \delta_1(t_1)\delta_2(t_2)$. By the
    definition of~$\gteq{\tau\arrtype\sigma'}{\xi}{\omega}$ we have
    $\delta_1(t_1)\delta_2(t_2)\gteq{\sigma'}{\xi}{\omega}\delta_2(t_1)\delta_2(t_2)$. Hence
    $\delta_1(t)\gteq{\sigma'}{\xi}{\omega}\delta_2(t)$ by the
    transitivity of~$\gteq{\sigma'}{\xi}{\omega}$.
  \item If $t = s \psi$ then $s : \forall\alpha[\tau]$ and $\sigma' =
    \tau[\subst{\alpha}{\psi}]$. By the inductive hypothesis
    $\delta_i(s) \in \val{\forall\alpha[\tau]}{\xi}{\omega}$ and
    $\delta_1(s) \gteq{\forall\alpha[\tau]}{\xi}{\omega}
    \delta_2(s)$. Because $\FTV(\omega(t)) = \emptyset$, the mapping
    $\omega$ is closed for~$\psi$. So by Lemma~\ref{lem_wm_forall} we
    have $\delta_i(t) = \delta_i(s) \omega(\psi) \in
    \val{\tau[\subst{\alpha}{\psi}]}{\xi}{\omega}$ and $\delta_1(t)
    \gteq{\tau[\subst{\alpha}{\psi}]}{\xi}{\omega} \delta_2(t)$.
  \end{itemize}
\end{proof}

\begin{corollary}\label{cor_typable_wm_computable}
  If $t$ is closed and $t : \sigma$ then $t \in \val{\sigma}{}{}$.
\end{corollary}

\begin{lemma}\label{lem_gteq_to_succeq}
  If $\sigma$ is a closed type and $t_1 \geq_\sigma t_2$ then
  $t_1 \succeq_{\sigma} t_2$.
\end{lemma}

\begin{proof}
  By coinduction. By Lemma~\ref{lem_beta_val_wm} we may assume
  that~$\sigma$ is in $\beta$-normal form. The case $\sigma=\alpha$ is
  impossible because~$\sigma$ is closed. If $\sigma = \nat$ then
  ${\geq_\nat} = {\succeq_\nat}$.

  Assume $\sigma=\sigma_1\arrtype\sigma_2$. Let $u : \sigma_1$ be
  closed. By Corollary~\ref{cor_typable_wm_computable} we have $u \in
  \val{\sigma_1}{}{}$. Hence $t_1 u \geq_{\sigma_2} t_2 u$. By the
  coinductive hypothesis $t_1 u \succeq_{\sigma_2} t_2 u$. This
  implies $t_1 \succeq_{\sigma} t_2$.

  Assume $\sigma=\forall(\alpha:\kappa)\tau$. Let $\varphi$ be a
  closed type constructor of kind~$\kappa$. By
  Lemma~\ref{lem_val_wm_computable} we have $\val{\varphi}{}{} \in
  \Cb_\varphi$. By the definition of~$\geq_{\forall\alpha\tau}$ and
  Lemma~\ref{lem_val_subst_wm} we have $t_1 \varphi
  \geq_{\tau[\subst{\alpha}{\varphi}]} t_2 \varphi$. Note that
  $\tau[\subst{\alpha}{\varphi}]$ is still closed. Hence by the
  coinductive hypothesis $t_1 \varphi
  \succeq_{\tau[\subst{\alpha}{\varphi}]} t_2 \varphi$. This implies
  $t_1 \succeq_{\sigma} t_2$.
\end{proof}

\begin{corollary}\label{cor_gteq_succeq}
  If~$\sigma$ is a closed type then ${\geq_{\sigma}} =
  {\succeq_\sigma}$.
\end{corollary}

\begin{proof}
  Follows from Lemma~\ref{lem_gteq_to_succeq} and
  Lemma~\ref{lem_val_wm_computable} and property~1 of comparison
  candidates.
\end{proof}

\begin{lemma}\label{lem_succeq_subst}
  If $s \succeq_\sigma s'$ then $t[\subst{x}{s}] \succeq_\tau t[\subst{x}{s'}]$.
\end{lemma}

\begin{proof}
  It suffices to show this when
  $s,s',t[\subst{x}{s}],t[\subst{x}{s'}]$ and $\sigma,\tau$ are all
  closed. Assume $s \succeq_\sigma s'$. Then $s \geq_{\sigma} s'$
  by Corollary~\ref{cor_gteq_succeq}. Thus $t[\subst{x}{s}]
  \geq_{\tau} t[\subst{x}{s'}]$ follows from
  Lemma~\ref{lem_typable_wm_computable}. Hence $t[\subst{x}{s}]
  \succeq_\tau t[\subst{x}{s'}]$ by Corollary~\ref{cor_gteq_succeq}.
\end{proof}

\begin{corollary}\label{cor_app_wm}
  If $s \succeq s'$ then $t s \succeq t s'$.
\end{corollary}

\subsection{Encodings of inductive types}\label{sec_encodings}

\subsubsection{Product types}

\begin{definition}\normalfont
  We define the following abbreviations:
  \[
  \begin{array}{rcl}
    \sigma \times \tau &=& \forall p . (\sigma \arrtype \tau \arrtype p) \arrtype p \\
    \pair{t_1}{t_2}_{\sigma,\tau} &=& \tabs{p}{\abs{x:\sigma\arrtype\tau\arrtype p}{x t_1 t_2 % \oplus_p
    }} \\
%        &&\quad\lift_p (\flatten_\sigma t_1) \oplus_p \\ &&\quad\lift_p (\flatten_\tau t_2)}
%}} \\
    \pi^1_{\sigma,\tau}(t) &=& t \sigma (\abs{x:\sigma}{\abs{y:\tau}{x}}) \\
    \pi^2_{\sigma,\tau}(t) &=& t \tau (\abs{x:\sigma}{\abs{y:\tau}{y}})
  \end{array}
  \]
  We drop the type subscripts when clear or irrelevant.
\end{definition}

\begin{lemma}
  \begin{enumerate}
  \item If $\Gamma \proves t_1 : \sigma$ and $\Gamma \proves t_2 :
    \tau$ then $\Gamma \proves \pair{t_1}{t_2} : \sigma \times \tau$.
  \item If $\Gamma \proves t : \tau_1 \times \tau_2$ then $\Gamma
    \proves \pi^i(t) : \tau_i$.
  \end{enumerate}
\end{lemma}

\begin{lemma}
  \begin{enumerate}
  \item $\pi^i(\pair{t_1}{t_2}) \leadsto^* t_i %\oplus
    %\lift(\flatten(t_1)) \oplus \lift(\flatten(t_2))
    $.
  \item $\pi^i(\pair{t_1}{t_2}) \succeq t_i$.
  \end{enumerate}
\end{lemma}

\begin{lemma}
  \begin{enumerate}
  \item If $t_1 \succeq t_1'$ and $t_2 \succeq t_2'$ then
    $\pair{t_1}{t_2} \succeq \pair{t_1'}{t_2'}$.
%  \item If $t_1 \succ t_1'$ and $t_2 \succeq t_2'$ (or $t_1 \succeq
%    t_1'$ and $t_2 \succ t_2'$) then $\pair{t_1}{t_2} \succ
%    \pair{t_1'}{t_2'}$.
  \item If $t \succ t'$ (resp.~$t \succeq t'$) then $\pi^i(t) \succ
    \pi^i(t')$ (resp.~$\pi^i(t)\succeq \pi^i(t')$).
  \end{enumerate}
\end{lemma}

\LC{Note that the following is no longer true after removing the
  $\oplus$ from pairs: If $t_1 \succ t_1'$ and $t_2 \succeq t_2'$ (or
  $t_1 \succeq t_1'$ and $t_2 \succ t_2'$) then $\pair{t_1}{t_2} \succ
  \pair{t_1'}{t_2'}$.}

\subsubsection{Sum types}
\CK{I'm omitting these from \texttt{urzy\_emb} for the time being,
since using this will create similar problems for case/case as we have
for let/let -- which I hope I can avoid by using product types instead.
So, it might be better to not have them altogether, as it may lead to
questions; but YMMV}

\LC{I think they should be omitted if not used, giving a reference to
  where the encodings are explained for System F in the literature.}

\begin{definition}\normalfont
  We define the following abbreviations:
  \[
  \begin{array}{rcl}
    \sigma + \tau &=& \forall p . (\sigma \arrtype p) \arrtype (\tau \arrtype p) \arrtype p \\
    \iota^1_{\sigma,\tau}(t) &=&  \tabs{p}{\abs{x:\sigma\arrtype p}{\abs{y:\tau\arrtype p}{x t \oplus_p \\&&\quad\lift_p(\flatten_\sigma t)}}} \\
    \iota^2_{\sigma,\tau}(t) &=&  \tabs{p}{\abs{x:\sigma\arrtype p}{\abs{y:\tau\arrtype p}{y t \oplus_p \\&&\quad\lift_p(\flatten_\tau t)}}} \\
    \xcase{\rho}{t}{[x:\sigma]s_1}{[y:\tau]s_2} &=& t \rho (\abs{x:\sigma}{s_1}) (\abs{y:\tau}{s_2})
  \end{array}
  \]
  We drop the type subscripts when clear or irrelevant.
\end{definition}

\begin{lemma}
  \begin{enumerate}
  \item If $\Gamma \proves t : \sigma$ then $\Gamma \proves \iota^1(t) : \sigma + \tau$.
  \item If $\Gamma \proves t : \tau$ then $\Gamma \proves \iota^2(t) : \sigma + \tau$.
  \item If $\Gamma \proves t : \sigma + \tau$ and $\Gamma,x:\sigma
    \proves s_1 : \rho$ and $\Gamma,y:\tau\proves s_2 : \rho$ then
    $\xcase{}{t}{[x]s_1}{[y]s_2} : \rho$.
  \end{enumerate}
\end{lemma}

\begin{lemma}
  \begin{enumerate}
  \item $\xcase{}{\iota^i(t)}{[x]s_1}{[x]s_2} \leadsto
    s_i[\subst{x}{t}] \oplus \lift(\flatten(t))$.
  \item $\xcase{}{\iota^i(t)}{[x]s_1}{[x]s_2} \succeq
    s_i[\subst{x}{t}]$.
  \end{enumerate}
\end{lemma}

\begin{lemma}
  \begin{enumerate}
  \item If $t \succ t'$ (resp.~$t \succeq t'$) then $\iota^i(t) \succ
    \iota^i(t')$ (resp.~$\iota^i(t) \succeq \iota^i(t')$).
  \item If $t \succ t'$ (resp.~$t \succeq t'$) and $s_1 \succeq s_1'$
    and $s_2 \succeq s_2'$ then
    \[
    \xcase{}{t}{[x]s_1}{[x]s_2} \succ \xcase{}{t}{[x]s_1}{[x]s_2}
    \]
    (resp.~$\xcase{}{t}{[x]s_1}{[x]s_2} \succeq
    \xcase{}{t}{[x]s_1}{[x]s_2}$).
  \end{enumerate}
\end{lemma}

\subsubsection{Existential types}

\begin{definition}\normalfont
  We define the following abbreviations:
  \[
  \begin{array}{rcl}
    \Sigma \alpha . \sigma &=& \forall p . (\forall \alpha . \sigma \arrtype p) \arrtype p \\
    \expair{\tau}{t}_{\Sigma\alpha.\sigma} &=& \tabs{p}{\abs{x:\forall\alpha.\sigma\arrtype p}{x \tau t %\oplus_p \lift_p(\flatten_{\sigma[\subst{\alpha}{\tau}]}t)
    }} \\
    \xlet{\rho}{t}{\alpha,x:\sigma}{s} &=& t \rho (\tabs{\alpha}{\abs{x:\sigma}{s}})
  \end{array}
  \]
  We drop the type subscripts when clear or irrelevant.
\end{definition}

\begin{lemma}
  \begin{enumerate}
  \item If $\Gamma \proves t : \sigma[\subst{\alpha}{\tau}]$ then
    $\Gamma \proves \expair{\tau}{t} : \Sigma \alpha . \sigma$.
  \item If $\Gamma \proves t : \Sigma \alpha . \sigma$ and
    $\Gamma,x:\sigma \proves s : \rho$ and $\alpha \notin
    \FTV(\Gamma,\rho)$ then $\xlet{}{t}{\alpha,x}{s} : \rho$.
  \end{enumerate}
\end{lemma}

\begin{lemma}
  \begin{enumerate}
  \item $\xlet{}{\expair{\tau}{t}}{\alpha,x}{s} \leadsto
    s[\subst{\alpha}{\tau}][\subst{x}{t}] %\oplus \lift(\flatten(t))
    $.
  \item $\xlet{}{\expair{\tau}{t}}{\alpha,x}{s} \succeq
    s[\subst{\alpha}{\tau}][\subst{x}{t}]$.
  \end{enumerate}
\end{lemma}

\begin{lemma}
  \begin{enumerate}
  \item If $t \succeq t'$ then $\expair{\tau}{t} \succeq
    \expair{\tau}{t'}$.
  \item If $t \succ t'$ (resp.~$t \succeq t'$) and $s \succeq s'$ then
    \[
    \xlet{}{t}{\alpha,x}{s} \succ \xlet{}{\CKchange{t'}}{\alpha,x}{\CKchange{s'}}
    \]
    (resp.~$\xlet{}{t}{\alpha,x}{s} \succeq \xlet{}{\CKchange{t'}}{\alpha,x}{\CKchange{s'}}$).
  \end{enumerate}
\end{lemma}

\subsubsection{Heterogenous lists}

\begin{definition}\normalfont
  We define the following abbreviations:
  \[
  \begin{array}{rcl}
    \List &=& \forall p . (\forall \alpha . \alpha \arrtype p \arrtype p) \arrtype p \arrtype p \\
    \nil &=& \tabs{p}{\abs{f:\forall \alpha . \alpha \arrtype p \arrtype p}{\abs{a : p}{a}}} \\
    \cons_\rho(h,t) &=& \tabs{p}{\abs{f:\forall\alpha . \alpha \arrtype p \arrtype p}{\abs{a : p}{f \rho h (l p f a)}}} \\
    \fold_\rho(f,a,l) &=& l \rho f a
  \end{array}
  \]
  We drop the type subscripts when clear or irrelevant.
\end{definition}

\begin{lemma}
  \begin{enumerate}
  \item $\Gamma \proves \nil : \List$.
  \item If $\Gamma \proves h : \rho$ and $\Gamma \proves t : \List$
    then $\Gamma \proves \cons_\rho(h,t) : \List$.
  \item If $\Gamma \proves l : \List$ and $\Gamma \proves f : \forall
    \alpha . \alpha \arrtype \rho \arrtype \rho$ and $a : \rho$ then
    $\Gamma \proves \fold_\rho(f,a,l) : \rho$.
  \end{enumerate}
\end{lemma}

\begin{lemma}
  \begin{enumerate}
  \item $\fold_\rho(f,a,\nil) \leadsto a$.
  \item $\fold_\rho(f,a,\cons_\tau(h,t)) \leadsto f \tau h
    (\fold_\rho(f,a,t))$.
  \end{enumerate}
\end{lemma}

\begin{lemma}
  If $l \succ l'$ then $\fold_\rho(f,a,l) \succ \fold_\rho(f,a,l')$.
\end{lemma}

\section{Systems of interest and their properties}\label{sec:systems}

The systems of interest are sets of terms with a rewriting relation on
them. Interestingly, $\Iterms$ can be seen as an instance of this
general scheme.

\subsection{Systems of interest}

We use a syntax based on system~$\Fomega$, specialising
Section~\ref{sec_preliminaries}.

\begin{definition}\normalfont
  \emph{Kinds}, \emph{type constructors} and \emph{types} are defined
  like in Definition~\ref{def_types}, parameterised by a fixed
  set~$\Sigma_T$ of type constructor symbols.

  Given a fixed set~$\Sigma$ of function symbols, we define
  \emph{terms} like in Definition~\ref{def_terms} (based on
  Definition~\ref{def_preterms}) with the following restrictions:
  \begin{itemize}
  \item if $\mathtt{f} : \sigma \in \Sigma$ then $\sigma$ is closed and
    \[
    \sigma = \forall (\alpha_1 : \kappa_1) \ldots \forall (\alpha_n : \kappa_n)
    . \sigma_1 \arrtype \ldots \arrtype \sigma_k \arrtype \tau
    \]
    with~$\tau$ a type atom,
  \item for any subterm $t_1 t_2$ of a term~$t$, the subterm~$t_1$ is
    not a variable or an abstraction.
  \end{itemize}
\end{definition}

We use the notation
$\mathtt{f}_{\rho_1,\ldots,\rho_n}(s_1,\ldots,s_k)$ for
$\mathtt{f} \rho_1 \ldots \rho_n s_1 \ldots s_k$ when
\[
  \mathtt{f} : \forall (\alpha_1 : \kappa_1) \ldots
  \forall (\alpha_n : \kappa_n) . \sigma_1 \arrtype \ldots \arrtype
  \sigma_k \arrtype \tau
\]
is a function symbol in~$\Sigma$ with~$\tau$ a type atom, and $\rho_i$
is a type constructor of kind $\kappa_i$ for $i=1,\ldots,k$, and
$\Gamma \proves s_i : \sigma_i[\alpha_1 := \rho_1]\ldots[\alpha_n :=
  \rho_n]$ for $i=1,\ldots,k$, for an appropriate~$\Gamma$. We use
this notation to stress the fact that by default there is no explicit
application available. The application in the syntax of terms is used
just as a convenient syntax, but does not correspond to the usual
application operator since only applications of the form $\mathtt{f}
u_1 \ldots u_n$ are allowed. True application can be modelled by
including the symbol ${@} : \forall\alpha\forall\beta . (\alpha
\arrtype \beta) \arrtype \alpha \arrtype \beta$ in
$\Sigma$. Similarly, type application is modelled through a symbol
$\mathtt{A} : \forall \alpha : * \arrkind * . \forall \beta . (\forall
\beta [\alpha \beta]) \arrtype \alpha \beta$.

We use the notations and terminology of Section~\ref{sec_world}. To
avoid confusion, the terms, types, type constructors, etc.~in the
interpretation (those defined in Section~\ref{sec_world}) are always
referred to as interpretation terms, interpretation types,
interpretation type constructors, etc.

The rules are simply a set of term pairs, whose monotonic closure
generates the rewrite relation.

\begin{definition}\normalfont
We fix a variable environment $\Gamma$, and assume given a set
$\Rules$ of term pairs $(\ell,r)$, such that:
\begin{itemize}
\item $\FV(r) \subseteq \FV(\ell) \subseteq \mathit{keys}(\Gamma)$;
\item $\ell$ and $r$ have the same type under $\Gamma$;
\item $\Rules$ is stable: if $(\ell,r) \in \Rules$ and $\omega$ is a
  type constructor substitution and $\gamma$ is a term substitution
  such that $\omega(\Gamma) \proves \gamma(x) : \omega(\Gamma(x))$,
  then $(\gamma(\omega(\ell)),\gamma(\omega(r))) \in \Rules$.
\end{itemize}
The reduction relation $\arr{\Rules}$ is the smallest monotonic
relation that contains $\Rules$.
\end{definition}

\subsubsection{Map on heterogenous lists}

We have the following type constructor symbols:
\[
\begin{array}{c}
  \TypeConstructors = \{ \mathtt{List} : * \}
\end{array}
\]

We have the following function symbols:
\[
\begin{array}{rcl}
@ & : & \forall \alpha \forall \beta . (\alpha \arrtype \beta) \arrtype \alpha \arrtype \beta \\
\mathtt{tapp} & : & \forall \alpha : * \arrkind * . \forall \beta .
(\forall \beta [\alpha \beta]) \arrtype \alpha \beta \\
\mathtt{nil} & : & \List \\
\mathtt{cons} & : & \forall \alpha . \alpha \arrtype \List \arrtype \List \\
\mathtt{map} & : & (\forall \alpha . \alpha \arrtype \alpha) \arrtype \List \arrtype \List
\end{array}
\]

And finally the rules.
\[
\begin{array}{rcl}
@_{\sigma,\tau}(\abs{x}{s},t) & \red & s[x:=t] \\
\mathtt{tapp}_{\abs{\alpha}{\sigma},\tau}(\tabs{\alpha}{s}) & \red &
  s[\alpha:=\tau] \\
\mathtt{map}(f,\nil) & \red & \nil \\
\mathtt{map}(f,\cons_\tau(x,l)) & \red & \cons_\tau(@_{\tau,\tau}(f,x),\mathtt{map}(f,l))
\end{array}
\]

\subsubsection{Intuitionistic second-order propositional logic IPC2}

For the system of urzy\_emb, we have the following type constructor
symbols:
\[
\begin{array}{c}
\TypeConstructors = \{\quad
  \bot : *,\quad
  \mathtt{or} : * \arrkind * \arrkind *,\quad
  \mathtt{and} : * \arrkind * \arrkind *,\quad
  \exists : (* \arrkind *) \arrkind *
  \}
\end{array}
\]

We have the following function symbols:
\[
\begin{array}{rcl}
@ & : & \forall \alpha \forall \beta . (\alpha \arrtype \beta) \arrtype \alpha \arrtype \beta \\
\mathtt{tapp} & : & \forall \alpha : * \arrkind * . \forall \beta .
  (\forall \beta [\alpha \beta]) \arrtype \alpha \beta \\
\epsilon & : & \forall \alpha . \bot \arrtype \alpha \\
\mathtt{pair} & : & \forall \alpha \forall \beta . \alpha \arrtype \beta \arrtype
  \mathtt{and}\, \alpha\, \beta \\
\pi^1 & : & \forall \alpha \forall \beta . \mathtt{and}\, \alpha\, \beta \arrtype \alpha \\
\pi^2 & : & \forall \alpha \forall \beta . \mathtt{and}\, \alpha\, \beta \arrtype \beta \\
\mathtt{in}^1 & : & \forall \alpha \forall \beta . \alpha \arrtype
  \mathtt{or}\, \alpha\, \beta \\
\mathtt{in}^2 & : & \forall \alpha \forall \beta . \beta \arrtype
  \mathtt{or}\, \alpha\, \beta \\
\mathtt{case} & : & \forall \alpha \forall \beta \forall \gamma . \mathtt{or}\, \alpha\, \beta \arrtype
  (\alpha \arrtype \gamma) \arrtype (\beta \arrtype \gamma) \arrtype \gamma \\
\mathtt{let} & : & \forall \alpha : * \arrkind * . \forall \beta .
  (\exists (\alpha)) \arrtype
  (\forall \gamma . \alpha \gamma \arrtype \beta) \arrtype \beta \\
\mathtt{ext} & : & \forall \alpha : * \arrkind * . \forall \beta . \alpha \beta \arrtype
  \exists (\alpha)
\end{array}
\]

\LC{I think it's clearer to do this for closed terms only,
  because then termination for open terms follows by closing them with
  lambda-abstractions.}

\LC{You had some mistakes in the rules below. I think these were only
  typos, but re-check if the interpretation still works. Though the
  rules in the last group were all wrong -- the types didn't match.}

\CK{With the ability to have type variables of a kind $* \arrkind *$
  these feel \emph{much} more natural.  This should work out. :)}

And finally the rules.
\[
\begin{array}{rcl}
@_{\sigma,\tau}(\abs{x}{s},t) & \red & s[x:=t] \\
\mathtt{tapp}_{\abs{\alpha}{\sigma},\tau}(\tabs{\alpha}{s}) & \red &
  s[\alpha:=\tau] \\
\pi^1_{\sigma,\tau}(\mathtt{pair}_{\sigma,\tau}(s,t)) & \red & s \\
\pi^2_{\sigma,\tau}(\mathtt{pair}_{\sigma,\tau}(s,t)) & \red & t \\
\mathtt{case}_{\sigma,\tau,\rho}(\mathtt{in}^1_{\sigma,\tau}(u),
  \abs{x}{s},\abs{y}{t}) & \red & s[x:=u] \\
\mathtt{case}_{\sigma,\tau,\rho}(\mathtt{in}^2_{\sigma,\tau}(u),
  \abs{x}{s},\abs{y}{t}) & \red & t[x:=u] \\
\mathtt{let}_{\varphi,\rho}(\mathtt{ext}_{\varphi,\tau}(s),\tabs{\alpha}{\abs{x:\varphi \alpha}{t}}) & \red & t[\alpha:=\tau][x:=s] \\
\end{array}
\]
\[
\begin{array}{rcl}
\epsilon_\tau(\epsilon_\bot(s)) & \red & \epsilon_\tau(s) \\
@_{\sigma,\tau}(\epsilon_{\sigma \arrtype \tau}(s),t) & \red &
  \epsilon_\tau(s) \\
\mathtt{tapp}_{\varphi,\tau}(
  \epsilon_{\quant{\alpha}{\varphi\alpha}}(s)) & \red &
  \epsilon_{\varphi\tau}(s) \\
\pi^1_{\sigma,\tau}(\epsilon_{\mathtt{and}\,\sigma\,\tau}(s)) & \red &
  \epsilon_\sigma(s) \\
\pi^2_{\sigma,\tau}(\epsilon_{\mathtt{and}\,\sigma\,\tau}(s)) & \red &
  \epsilon_\tau(s) \\
\mathtt{case}_{\sigma,\tau,\rho}(\epsilon_{\mathtt{or}\,\sigma\,\tau}(
  u),\abs{x:\sigma}{s},\abs{y:\tau}{t}) & \red & \epsilon_\rho(u) \\
\mathtt{let}_{\varphi,\rho}(\epsilon_{\exists(\varphi)}(s),\tabs{\alpha}{\abs{x:\varphi\alpha}{t}}) & \red &
  \epsilon_\rho(s) \\
\end{array}
\]
\begin{itemize}
%\[
%\begin{array}{rcl}
\item $
\epsilon_\rho(\mathtt{case}_{\sigma,\tau,\bot}(u,\abs{x:\sigma}{s},\abs{y:\tau}{t}))
  %& \red &
  \red
  \mathtt{case}_{\sigma,\tau,\rho}(u,\abs{x:\sigma}{\epsilon_\rho(s)},
  \abs{y:\tau}{\epsilon_\rho(t)}) $%\\
\item $
@_{\rho,\pi}(\mathtt{case}_{\sigma,\tau,\rho \arrtype \pi}(u,
  \abs{x:\sigma}{s},\abs{y:\tau}{t}),v) %& \red &
  \red
  \mathtt{case}_{\sigma,\tau,\pi}(u,
  \abs{x:\sigma}{@_{\rho,\pi}(s,v)},\abs{y:\tau}{@_{\rho,\pi}(t,v)}) $%\\
\item $
\mathtt{tapp}_{\varphi,\pi}(\mathtt{case}_{\sigma,\tau,
  \quant{\alpha}{\varphi\alpha}}(u,\abs{x:\sigma}{s},\abs{y:\tau}{t})) %& \red &
  \red
  \mathtt{case}_{\sigma,\tau,\varphi\pi}(u,
  \abs{x:\sigma}{\mathtt{tapp}_{\varphi,\pi}(s)},\\
  \abs{y:\tau}{\mathtt{tapp}_{\varphi,\pi}(t)}) $%\\
\item $
\pi^1_{\rho,\pi}(\mathtt{case}_{\sigma,\tau,\mathtt{and}\,\rho\,\pi}(u,
\abs{x:\sigma}{s},\abs{y:\tau}{t})) %& \red &
  \red
  \mathtt{case}_{\sigma,\tau,\rho}(u,\abs{x:\sigma}{\pi^1_{\rho,\pi}(s)},
  \abs{y:\tau}{\pi^1_{\rho,\pi}(t)}) $%\\
\item $
\pi^2_{\rho,\pi}(\mathtt{case}_{\sigma,\tau,\mathtt{and}\,\rho,\pi}(u,
  \abs{x:\sigma}{s},\abs{y:\tau}{t})) %& \red &
  \red
  \mathtt{case}_{\sigma,\tau,\pi}(u,\abs{x:\sigma}{\pi^2_{\rho,\pi}(s)},
  \abs{y:\tau}{\pi^2_{\rho,\pi}(t)}) $%\\
\item $
\mathtt{case}_{\rho,\pi,\xi}(\mathtt{case}_{\sigma,\tau,\mathtt{or}\,
  \rho\,\pi}(u,\abs{x:\sigma}{s},\abs{y:\tau}{t}),\abs{z:\rho}{v},\abs{a:\pi}{w}) %& \red &
  \red\\
  \mathtt{case}_{\sigma,\tau,\xi}(u,
    \abs{x:\sigma}{\mathtt{case}_{\rho,\pi,\xi}(s,\abs{z:\rho}{v},\abs{a:\pi}{w})},
    \abs{y:\tau}{\mathtt{case}_{\rho,\pi,\xi}(t,\abs{z:\rho}{v},\abs{a:\pi}{w})}) $%\\
\item $
    \mathtt{let}_{\varphi,\rho}(
  \mathtt{case}_{\sigma,\tau,\exists\varphi}(
  u,\abs{x:\sigma}{s},\abs{y:\tau}{t}),v) %& \red &
  \red\\
  \mathtt{case}_{\sigma,\tau,\rho}(u,
  \abs{x:\sigma}{\mathtt{let}_{\varphi,\rho}(s,v)},
  \abs{y:\tau}{\mathtt{let}_{\varphi,\rho}(t,v)})
  $%\\
%\end{array}
%\]
\end{itemize}
\LC{The following rules were wrong. The types didn't match -- you
  forgot the lambda-abstractions.}
\CK{They now seem to be okay, though!}
\begin{itemize}
\item
  $\epsilon_\tau(\mathtt{let}_{\varphi,\bot}(s,\tabs{\alpha}{\abs{x:\varphi\alpha}{t}}))
  \red
  \mathtt{let}_{\varphi,\tau}(s,\tabs{\alpha}{\abs{x:\varphi\alpha}{\epsilon_\tau(t)}})$
\item $@_{\tau,\rho}(\mathtt{let}_{\varphi, \tau \arrtype
  \rho}(s,\tabs{\alpha}{\abs{x:\varphi\alpha}{t}}),u) \red
  \mathtt{let}_{\varphi,\rho}(s,\tabs{\alpha}{\abs{x:\varphi\alpha}{@_{\tau,\rho}(t,
      u)}})$
\item
  $\mathtt{tapp}_{\psi,\rho}(\mathtt{let}_{\varphi,\forall\beta[\psi\beta]}(s,\tabs{\alpha}{\abs{x:\varphi\alpha}{t}}))
  \red
  \mathtt{let}_{\varphi,\psi\rho}(s,\tabs{\alpha}{\abs{x:\varphi\alpha}{\mathtt{tapp}_{\psi,\rho}(t)}})$
\item
  $\pi^1_{\tau,\rho}(\mathtt{let}_{\varphi,
  \mathtt{and}\,\tau,\rho}(s,\tabs{\alpha}{\abs{x:\varphi\alpha}{t}}))
  \red
  \mathtt{let}_{\varphi,\tau}(s,\tabs{\alpha}{\abs{x:\varphi\alpha}{\pi^1_{\tau,
        \rho}(t)}})$
\item
  $\pi^2_{\tau,\rho}(\mathtt{let}_{\varphi,
  \mathtt{and}\,\tau\,\rho}(s,\tabs{\alpha}{\abs{x:\varphi\alpha}{t}}))
  \red
  \mathtt{let}_{\varphi,\rho}(s,\tabs{\alpha}{\abs{x:\varphi\alpha}{\pi^2_{\tau,\rho}(t)}})$
\item $\mathtt{case}_{\tau,\rho,\pi}(
  \mathtt{let}_{\varphi,\mathtt{or}\,\tau\,\rho}(s,\tabs{\alpha}{\abs{x:\varphi\alpha}{t}}),\abs{x:\tau}{u},\abs{y:\rho}{v})
  \red
  \mathtt{let}_{\varphi,\pi}(s,\tabs{\alpha}{\abs{x:\varphi\alpha}{\mathtt{case}_{\tau,\rho,\pi}(t,\abs{x:\tau}{u},\abs{y:\rho}{v})}})$
\item
  $\mathtt{let}_{\psi,\rho}(\mathtt{let}_{\varphi,\exists\psi}(s,\tabs{\alpha}{\abs{x:\varphi\alpha}{t}}),u)
  \red
  \mathtt{let}_{\varphi,\rho}(s,\tabs{\alpha}{\abs{x:\varphi\alpha}{\mathtt{let}_{\psi,\rho}(t,u)}})$
\end{itemize}

\LC{To be completely precise we should define a translation $\Phi$
  from the system urzy\_emb to the above and show that if $s \red t$
  in urzy\_emb then $\Phi(s) \red \Phi(t)$. But this should be easy
  once the reductions are defined correctly.}

\CK{Question: we are doing substitution in the above, but can we not
  avoid  that, and instead reason modulo $\beta$-reduction also in
  terms?  We already require left-hand sides to be patterns,
  essentially, so it shouldn't matter much whether we have $t[x:=u]$
  or $(\abs{y}{t}) \cdot u$.  I do not care much either way, and if
  it would require a lot of change to the proofs it's probably not
  worth it, but it seems like a natural way of thinking about
  terms and types.}

\LC{I think we can say we're doing $\beta$-reduction implicitly. This
  works thanks to Lemma~\ref{lem_succ_red}.}

\subsection{Interpreting interesting terms}

All terms will be mapped to interpretation terms, which are compared
using $\succ$ to obtain a decrease that can be used with
rule removal. \CK{Not too important at this stage, but eventually this
paragraph will need changing as rule removal has not yet been
introduced.}

\begin{definition}\normalfont
A \emph{type constructor mapping} is a function $\Typemap$ which maps
a type constructor symbol to a closed interpretation type constructor
of the same kind.

A fixed type constructor mapping $\Typemap$ is extended inductively to
a function from type constructors to closed interpretation type
constructors in the expected way.
\CK{Is this still the right thing to say? Currently, it's basically a
substitution: type constructors $c$ are replaced by $\Typemap(c)$, and
everything else stays the same (only we implicitly $\beta$-normalise as
we do all the time).}
\LC{It depends how you treat e.g. $\to$ -- is this the same symbol in
  the syntax and the interpretation, or two different symbols? I think
  this doesn't matter much.}
We denote the extended mapping
by~$\typeinterpret{\sigma}$. Thus, for example
$\typeinterpret{\quant{\alpha}{\sigma}} =
\quant{\alpha}{\typeinterpret{\sigma}}$ and $\typeinterpret{\sigma
  \arrtype \tau} = \typeinterpret{\sigma} \arrtype
\typeinterpret{\tau}$.
\end{definition}

Similarly, we employ a \emph{symbol mapping} as an aid to interpret
\emph{terms}.

\begin{definition}\normalfont
  A \emph{symbol mapping} is a function $\Termmap$ which assigns to
  each function symbol $\mathtt{f} : \rho$ a closed interpretation
  term $\Termmap(\mathtt{f})$ of type~$\typeinterpret{\rho}$. For a
  fixed symbol mapping $\Termmap$, we define $\interpret{s}$
  inductively:
  \[
    \begin{array}{rcl}
      \interpret{x} & = & x \\
      \interpret{\tabs{\alpha}{s}} & = & \tabs{\alpha}{\interpret{s}} \\
      \interpret{\abs{x:\sigma}{s}} & = & \abs{x:\typeinterpret{\sigma}}{
                                          \interpret{s}} \\
      \interpret{\app{t_1}{t_2}} &=& \app{\interpret{t_1}}{\interpret{t_2}} \\
      \interpret{\tapp{t}{\tau}} &=& \tapp{\interpret{t}}{\typeinterpret{\tau}} \\
      \interpret{\mathtt{f}} &=& \Termmap(\mathtt{f})
    \end{array}
  \]

  Symbol mapping is extended to contexts as follows:
  \[
    \itp{\Gamma} := \{ (x : \typeinterpret{\tau}) \mid (x : \tau) \in \Gamma \}
  \]
\end{definition}

Interpretation mapping preserves typing:

\begin{lemma}
If $\Gamma \vdash s : \sigma$ then $\itp{\Gamma} \vdash \interpret{s}
: \typeinterpret{\sigma}$.
\end{lemma}

\begin{proof} % Now this is straightforward with the new definitions
  By induction on the form of $s$.\qed
\end{proof}

\subsection{Monotonicity and rule removal}

\begin{definition}\normalfont
  A \emph{$\sigma$-context}~$C_\sigma$ is a term with a fresh function
  symbol $\Box_\sigma \notin \Sigma$ of type~$\sigma$ occurring
  exactly once. By~$C_\sigma[t]$ we denote a term obtained
  from~$C_\sigma$ by substituting~$t$ for~$\Box_\sigma$. We drop the
  $\sigma$ subscripts when clear or irrelevant.

  A relation~$R$ on terms of type~$\sigma$ is \emph{monotonic} if
  $R(s, t)$ implies $R(C[s], C[t])$ for every $\sigma$-context~$C$.
\end{definition}

We use \emph{rule removal}:

\begin{theorem}\label{thm:ruleremove}
Let $\Rules = \Rules_1 \cup \Rules_2$, and suppose that
$\arr{\Rules_1}\: \subseteq\:\succ$ and
$\arr{\Rules_2}\:\subseteq\:\succeq$ for a well-founded ordering
$\succ$ and a compatible quasi-ordering $\succeq$.  Then
$\arr{\Rules}$ is terminating if and only if $\arr{\Rules_2}$ is
(which is certainly the case if $\Rules_2 = \emptyset$).
\end{theorem}

\begin{proof}
By well-foundedness of $\succ$, every infinite decreasing $\arr{\Rules}$
sequence can only use finitely many steps using $\arr{\Rules_1}$.
\qed
\end{proof}

If $\succ$ and $\succeq$ are monotonic, this gives rise to the
following algorithm:
\begin{enumerate}
\item While $\Rules$ is non-empty:
  \begin{enumerate}
  \item Orient all rules in $\Rules$ using $\succeq$ or $\succ$; at least
    one of them must be oriented using $\succ$.
  \item Remove all rules ordered by $\succ$ from $\Rules$.
  \end{enumerate}
\end{enumerate}
If this algorithm succeeds, we have proven termination.

We propose using a pair $(\succinterpret,\succeqinterpret)$ defined as
follows: $s \succinterpret t$ if $\interpret{s} \succ \interpret{t}$ and
$s \succeqinterpret t$ if $\interpret{s} \succeq \interpret{t}$ (for a
fixed type constructor mapping $\Typemap$ and symbol mapping $\Termmap$).
To use this pair to prove termination of $\arr{\Rules}$ with rule removal,
two things must be proved:

\begin{itemize}
\item all rules in $\Rules$ can be oriented with $\succeqinterpret$ or
  $\succinterpret$ and at least one with $\succinterpret$;
\item $\succinterpret$ and $\succeqinterpret$ are both monotonic.
\end{itemize}

The former requirement has to be verified for every individual rule.
For the latter requirement, we can provide some sufficient criteria that
guarantee monotonicity of both $\succinterpret$ and $\succeqinterpret$.

\begin{definition}\normalfont
  An interpretation term~$t$ is \emph{safe for~$x$} if $s_1 \succ s_2$
  implies $t[\subst{x}{s_1}] \succ t[\subst{x}{s_2}]$. A symbol
  mapping~$\Termmap$ is \emph{safe} if for all symbols $\afun :
  \forall (\alpha_1 : \kappa_1) \ldots \forall (\alpha_n : \kappa_n)
  . \sigma_1 \arrtype \ldots \arrtype \sigma_k \arrtype \tau$
  with~$\tau$ a type atom we have: $\Termmap(\afun) = \tabs{\alpha_1
    \dots \alpha_n}{\abs{x_1 \dots x_k}{t}}$ with $t$ safe for
  each~$x_i$.
\end{definition}

\begin{lemma}
  \begin{enumerate}
  \item $x u_1 \ldots u_m$ is safe for~$x$.
  \item If $t$ is safe for~$x$ then so is~$\lift(t)$
    and~$\flatten(t)$.
  \item If $s_1$ is safe for~$x$ or $s_2$ is safe for~$x$ then $s_1
    \oplus s_2$ is safe for~$x$.
  \item If either:
    \begin{itemize}
    \item $s_1$ is safe for~$x$ and $s_2 \succeq \lift(1)$, or
    \item $s_2$ is safe for~$x$ and $s_1 \succeq \lift(1)$,
    \end{itemize}
    then $s_1 \otimes s_2$ is safe for~$x$.
  \item If~$t$ is safe for~$x$ then so is~$\tabs{\alpha}{t}$
    and~$\abs{y}{t}$ ($y \ne x$).
%  \item If $t_1$ is safe for~$x$ or~$t_2$ is safe for~$x$ then
%    $\pair{t_1}{t_2}$ is safe for~$x$.
  \item If $t$ is safe for~$x$ then so is~$\pi^1(t)$ and~$\pi^2(t)$.
  \item If $t$ is safe for~$x$ then so is~$\iota^1(t)$ and~$\iota^2(t)$.
  \CK{Not outcommenting this one because I haven't changed it yet (but
  probably needs to be done in the future to be consistent with the
  others.}
  \item If $t$ is safe for~$x$ then so is~$\xcase{}{t}{[x]s_1}{[y]s_2}$.
  %\item If $t$ is safe for~$x$ then so is~$\expair{\tau}{t}$.
  \item If $t$ is safe for~$x$ then so is~$\xlet{}{t}{\alpha,x}{s}$.
  \end{enumerate}
\end{lemma}

\begin{proof}
  TODO
\end{proof}

\begin{lemma}
  If~$\Termmap$ is safe then both $\succinterpret$ and
  $\succeqinterpret$ are monotonic.
\end{lemma}

\begin{proof}
  TODO
\end{proof}

\CK{We do need that if $s \succ t$ then $s\sigma \succ t\sigma$ for
  $\sigma$ a type substitution.  We have that by definition, right?}
\LC{Yes, this follows by manipulating closures.}

\section{Some useful lemmas}

Some things I will need:

\begin{lemma}\label{lem:substitutioninterpret}
We have:
\begin{enumerate}
\item\label{lem:substitutioninterpret:types}
  $\typeinterpret{\sigma}[\alpha:=\typeinterpret{\tau}] =
  \typeinterpret{\sigma[\alpha:=\tau]}$
\item\label{lem:substitutioninterpret:mixed}
  $\interpret{s}[\alpha:=\typeinterpret{\tau}] =
  \interpret{s[\alpha:=\tau]}$
\item\label{lem:substitutioninterpret:terms}
  $\interpret{s}[x:=\interpret{t}] = \interpret{s[x:=t]}$
\end{enumerate}
\end{lemma}

\begin{proof}
TODO
\end{proof}

\subsection{Orienting $\beta$-reduction}

\subsection{Orienting type instantiation}

\subsection{Other}

\section{Some systems of interest}

\subsection{Interpretations}

\subsubsection{Map on heterogenous lists}

We use the following type constructor mapping:
\[
\begin{array}{rcl}
  \Typemap(\List) & = & \List
\end{array}
\]

And the following function symbol mapping:
\[
\begin{array}{rcl}
\Termmap(@) & = & \Lambda\alpha\Lambda\beta\lambda x: \alpha \arrtype \beta . \lambda y :
  \alpha . x \cdot y \oplus \lift_\beta(\flatten_\alpha(
  y) \oplus 1) \\
\Termmap(\mathtt{tapp}) & = & \Lambda \alpha : * \arrkind * . \Lambda \beta . \lambda x : \quant{\gamma}{\alpha\gamma} . x * \beta \oplus \lift_{\alpha\beta}(1) \\
\Termmap(\mathtt{nil}) & = & \nil \\
\Termmap(\mathtt{cons}) & = & \tabs{\alpha}{\abs{x:\alpha}{\abs{y:\List}{\cons_\alpha(x,y)\oplus_\List \lift_\List(\flatten_\alpha(x) \oplus_\nat \flatten_\List(y))}}} \\
\Termmap(\mathtt{map}) & = & \lambda f:\forall\alpha . \alpha\arrtype\alpha . \lambda l:\List . \\
& &\quad\fold_\List(\tabs{\alpha}{\abs{x:\alpha}{\abs{a:\List}{\cons_\alpha(f \alpha x \oplus_\alpha x, a)\oplus_\List \lift_\List(1)}}},\nil,l)
\end{array}
\]

\subsubsection{IPC2}

We use the following type constructor mapping:
\[
\begin{array}{rcl}
\Typemap(\bot) & = & \nat \\
\Typemap(\mathtt{and}) & = & \lambda\alpha_1\lambda\alpha_2 . \alpha_1\times\alpha_2 \\
\Typemap(\mathtt{or}) & = & \lambda\alpha_1\lambda\alpha_2 . \alpha_1\times\alpha_2 \\
\Typemap(\exists) & = & \lambda(\alpha : * \arrkind *) . \Sigma \gamma . \alpha \gamma
\end{array}
\]
\LC{Is $\Typemap(\mathtt{or}) = \lambda\alpha_1\lambda\alpha_2 . \alpha_1+\alpha_2$ worth a try?}
\CK{It's what I tried before, thinking it would simplify things, but
  then I got the same problem for case/case as I then got for let/let.
  A product type will likely be better here}
And the following function symbol mapping:
\[
\begin{array}{rcll}
\Termmap(\epsilon) & = & \Lambda \alpha:* . \lambda x:\nat. &
  \mathtt{lift}_\alpha(x) \\
\Termmap(@) & = & \Lambda\alpha\Lambda\beta\lambda x: \alpha \arrtype \beta . \lambda y :
  \alpha . \quad & x \cdot y \oplus \lift_\beta(\flatten_\alpha(
  y) \oplus 1) \\
\Termmap(\mathtt{tapp}) & = & \Lambda \alpha : * \arrkind * . \Lambda \beta . \lambda x : \quant{\gamma}{\alpha\gamma} . \quad & x * \beta \oplus \lift_{\alpha\beta}(1) \\
\Termmap(\mathtt{ext}) & = & \Lambda \alpha : * \arrkind * . \Lambda \beta : * . \lambda x:\alpha\beta . &
  \expair{\beta}{x} \CKchange{\oplus \lift_{\Sigma\gamma.\beta\gamma}(
  \flatten_{\alpha\gamma}(x))} \\
\Termmap(\mathtt{pair}) & = & \Lambda \alpha \Lambda \beta \lambda x :
  \alpha, y : \beta.\quad & \pair{x}{y} \CKchange{\oplus \lift_{
  \alpha \times \beta}(\flatten_\alpha(x) \oplus \flatten_{\beta}(y))} \\
\Termmap(\pi^1) & = & \Lambda \alpha \Lambda \beta \lambda x :
  \alpha \times \beta . \quad
  & \pi^1(x) \oplus \lift_{\alpha}(1) \\
\Termmap(\pi^2) & = & \Lambda \alpha \Lambda \beta \lambda x :
  \alpha\times\beta.\quad
  & \pi^2(x) \oplus \lift_{\beta}(1) \\
\Termmap(\mathtt{in}^1) & = & \Lambda \alpha \Lambda \beta
  \lambda x : \alpha.\quad & \pair{x}{\lift_\beta(1)}
  \CKchange{\oplus \lift_{\alpha
  \times \beta}(\flatten_{\alpha}(x))} \\
\Termmap(\mathtt{in}^2) & = & \Lambda \alpha \Lambda \beta
  \lambda x : \beta.\quad & \pair{\lift_\alpha(1)}{x}
  \CKchange{\oplus \lift_{\alpha \times \beta}(\flatten_{\beta}(x))} \\
\end{array}
\]
\[
\begin{array}{rcl}
\Termmap(\mathtt{let}) & = & \Lambda \alpha : * \arrkind * . \Lambda \beta : * . \lambda x : \Sigma \xi . \alpha\xi,
  y : \quant{\xi}{\alpha\xi \arrtype \beta}. \\
  & & \hfill (\xlet{}{x}{\xi,z}{y\xi z}) \oplus \lift_{\beta}(\flatten(y) \oplus
  1) \\
\Termmap(\mathtt{case}) & = & \Lambda \alpha,\beta,\xi . \lambda x : \alpha \times \beta,
  y : (\alpha \arrtype \xi), z : (\beta \arrtype \xi). \\
  & & \quad
  \lift_\xi(37) \oplus (\lift_\xi(\flatten_{\alpha\times\beta}(x)\oplus 3)
  \otimes \\
  & & \quad\phantom{ABCDEFGHIJKL}
    (\ y \cdot \pi^1(x) \oplus (z \cdot \pi^2(x) \oplus \lift_\xi(11)\ ) \\
\end{array}
\]

\subsection{Rule orientation}

\CK{Note: I am representing the rules slightly differently here than
before: with variables for the type denotations rather than arbitrary
types.  The idea is that the rules can of course be instantiated.  It
is easily changed to the other way if that is preferred.}

\LC{I don't understand this. What is a ``variable for type
  denotation''? How does it differ from a type (constructor)
  variable?}

\CK{It doesn't. However, when a type denotation is $\sigma$ (as it is
  int he rules), then I assume that this does not stand in for a
  variable, but for a specific type -- and then the translation will
  have to contain $\typeinterpret{\sigma}$ instead of just $\sigma$.}

\begin{itemize}
\item $@_{\alpha,\beta}(\abs{x}{s},t) \red s[x:=t]$ \\ We have
  $\interpret{@_{\alpha,\beta}(\abs{x:\sigma}{s},t)} \arrrbeta
  (\abs{x:\alpha}{\interpret{s}}) \cdot \interpret{t} \oplus
  \lift_\beta(\flatten_\alpha(\interpret{t}) \oplus 1) \leadsto
  \interpret{s}[x:=\interpret{t}] \oplus \lift(\flatten(\interpret{t})
  \oplus 1)$.  Since, by Lemma \ref{lem:liftgreater} we have
  $\lift(\flatten(\interpret{t}) \oplus 1) \succeq \lift(1)$, by Lemma
  \ref{lem:plustimesmonotonic} this term $\succeq
  \interpret{s}[x:=\interpret{t}] \oplus \lift(1)$, and by Lemma
  \ref{lem:plusparts} this $\succ
  \interpret{s}[x:=\interpret{t}]$, which equals $\interpret{s[x:=t]}$
  by Lemma \ref{lem:substitutioninterpret}.
  Since, by Lemma \ref{lem_succ_red} $\leadsto \cdot \succ$ is
  contained in $\succ$ ,we have the required orientation of the rule.
\item $\mathtt{tapp}_{\lambda\alpha.\varphi\alpha,\beta}(
  \tabs{\alpha}{s}) \red s[\alpha:=\tau]$ \\ We have
  $\interpret{\mathtt{tapp}_{\lambda \alpha.\varphi\alpha,\beta}(
  \tabs{\alpha}{s})} \arrrbeta (\tabs{\alpha}{\interpret{s}}) *
   \beta \oplus \lift_{\varphi \beta}(1) \leadsto
  \interpret{s}[\alpha:=\typeinterpret{\tau}] \oplus \lift(1) \succ
  \interpret{s}[\alpha:=\typeinterpret{\tau}] =
  \interpret{s[\alpha:=\tau]}$, using Lemma \ref{lem:plusparts}.
  Thus, we can remove this rule.
\item $\pi^1_{\alpha,\beta}(\mathtt{pair}_{\alpha,\beta}(s,t)) \red
  s$ \\
  We have $\interpret{\mathtt{pair}_{\alpha,\beta}(s,t))} \arrrbeta
  \Lambda \xi.\abs{f}{f \cdot \interpret{s} \cdot \interpret{t}
  \oplus \lift_\xi(\flatten(\interpret{s}))\  \oplus \\
  \lift_\xi(\flatten(\interpret{t}))}
  $ and therefore
  $\interpret{\pi^1_{\alpha,\beta}(\mathtt{pair}_{\alpha,\beta}(s,t))}
  \arrrbeta (\Lambda \xi.\abs{f}{f \cdot \interpret{s} \cdot
  \interpret{t} \oplus \lift_\xi(\flatten(\interpret{s})) \oplus
  \lift_\xi(\flatten(\interpret{t}))}) * \alpha \cdot (\abs{yz}{y})
  \oplus \lift_\alpha(1) \leadsto^*
  (\abs{yz}{y}) \cdot \interpret{s} \cdot
  \interpret{t} \oplus \lift_\alpha(\flatten(\interpret{s})) \oplus
  \lift_\alpha(\flatten(\interpret{t})) \oplus \lift_\alpha(1) \leadsto^*
  \interpret{s} \oplus \lift_\alpha(\dots) \oplus \lift_\alpha(1)$, and
  by Lemma \ref{lem:plusparts} (and monotonicity of $\succeq$) this
  term $\succ \interpret{s}$.
\item $\pi^2_{\alpha,\beta}(\mathtt{pair}_{\alpha,\beta}(s,t)) \red
  t$ \\
  In the same way as above, we have $\interpret{\pi^2_{\alpha,\beta}(
  \mathtt{pair}_{\alpha,\beta}(s,t))} \arrrbeta
  \interpret{t} \oplus \lift_\beta(\dots) \oplus \lift_\beta(1)
  \succ \interpret{t}$.
\item $\mathtt{case}_{\alpha,\beta,\xi}(\mathtt{in}^1_{\alpha,\beta}(u),
  \abs{x}{s},\abs{y}{t}) \red s[x:=u]$ \\
  Write $X_\chi := \lift_\chi(\flatten_\alpha(\interpret{u}))$ and
  $Y := (\abs{x}{\interpret{s}}) \cdot \lift_\alpha(0) \oplus
  (\abs{y}{\interpret{t}}) \cdot \lift_\beta(0)$.
  We have $\interpret{\mathtt{in}^1_{\alpha,\beta}(u)} \arrrbeta
  \Lambda \chi.\abs{p}{(p * (\alpha \arrtype \chi) \cdot (\abs{yz}{y})
  \cdot \interpret{u} \oplus X_\chi)}$.
  Therefore $\interpret{\mathtt{case}_{\alpha,\beta,\xi}(
  \mathtt{in}^1_{\alpha,\beta}(u),\abs{x}{s},\abs{y}{t})} \arrrbeta
  (\Lambda \chi.\abs{p}{(p * (\alpha \arrtype \chi) \cdot (\abs{yz}{y})
  \cdot \interpret{u} \oplus X_\chi)}) * \xi \cdot
  (\Lambda \chi.\abs{f}{f \cdot (\abs{x}{\interpret{s}}) \cdot
  (\abs{y}{\interpret{t}})}) \oplus Y \oplus \lift_\xi(7) \arrrbeta
  ((\Lambda \chi.\abs{f}{f \cdot (\abs{x}{\interpret{s}}) \cdot
  \abs{y}{\interpret{t}}}) * (\alpha \arrtype \xi) \cdot (\abs{yz}{y})
  \cdot \interpret{u} \oplus X_\xi) \oplus Y \oplus \lift_\xi(7)
  \arrrbeta
  ((\abs{yz}{y}) \cdot (\abs{x}{\interpret{s}}) \cdot
  \abs{y}{\interpret{t}}) \cdot \interpret{u} \oplus X_\xi) \oplus Y
  \oplus \lift_\xi(7) \arrrbeta
  \interpret{s}[x:=\interpret{u}] \oplus X_\xi \oplus Y
  \oplus \lift_\xi(7)$.  By Lemma \ref{lem:plusparts} this term
  $\succ \interpret{s}[x:=\interpret{u}]$, which is exactly
  $\interpret{s[x:=u]}$ by Lemma \ref{lem:substitutioninterpret}.
\item $\mathtt{case}_{\alpha,\beta,\xi}(\mathtt{in}^2_{\alpha,\beta}(u),
  \abs{x}{s},\abs{y}{t}) \red t[x:=u]$ \\
  Symmetric to the case above.
\item $\mathtt{let}_{\varphi,\alpha}(\mathtt{ext}_{\varphi,\beta}(s),
  \tabs{\gamma}{\abs{x:\varphi\gamma}{t}}) \red t[\alpha:=\beta][x:=s]$ \\
  We have $\interpret{\mathtt{ext}_{\varphi,\beta}(s)} \arrrbeta
  \Lambda \xi.\abs{y}{(y * \beta \cdot \interpret{s} \oplus X_\xi)}$ for
  some term $X_\xi$.  Therefore
  $\interpret{\mathtt{let}_{\varphi,\alpha}(\mathtt{ext}_{\varphi,
  \beta}(s),\tabs{\alpha}{\abs{x:\varphi\alpha}{t}})} \arrrbeta
  (\Lambda \xi.\abs{y}{(y * \beta \cdot \interpret{s} \oplus X_\xi)})
  * \alpha \cdot (\tabs{\gamma}{\abs{x}{\interpret{t}}}) \oplus
  \lift_\alpha(Y \oplus 1)$ for some $Y$, which
  $\arrrbeta (\interpret{t}[x:=\interpret{s}] \oplus X_\alpha) \oplus
  \lift_\alpha(Y \oplus 1)$.
  By Lemma \ref{lem:plusparts}, this $\succ
  \interpret{t}[x:=\interpret{s}] \oplus X_\alpha$, which $\succeq
  \interpret{t}[x:=\interpret{s}]$.  Then by Lemma
  \ref{lem:substitutioninterpret}, this equals $\interpret{t[x:=u]}$.
%  Let $u := \mathtt{ext}_{\quant{\alpha}{\sigma},\tau}(s)$ and
%  $w := \tabs{\alpha}{\abs{x}{t}}$.  Then we have:
%  \begin{itemize}
%  \item $\interpret{u} =
%    \tabs{\xi}{\abs{y:\quant{\alpha}{\sigma \arrtype \xi}}{
%    y * \typeinterpret{\tau} \cdot \interpret{s}}}$ (which has type
%    $\quant{\xi}{\quant{\alpha}{\sigma \arrtype \xi} \arrtype \xi}$);
%  \item $\interpret{w} = \tabs{\alpha}{\abs{x:\typeinterpret{\sigma}}{
%    \interpret{t}}}$ (which has type $\quant{\alpha}{\sigma \arrtype
%    \rho}$ with $\alpha \notin \FTV(\rho)$);
%  \item $\interpret{\mathtt{let}_{\quant{\alpha}{\sigma},\rho}(u,w)} =
%    \interpret{u} * \rho \cdot \interpret{w} \oplus
%    \lift(\flatten(\interpret{w})\oplus 1) \succeq
%    \interpret{u} * \rho \cdot \interpret{w} \oplus \lift(1)$ by
%    Lemmas \ref{lem:liftgreater} and \ref{lem:plustimesmonotonic} as
%    before; by Lemma \ref{lem:plustimesmonotonic} again this term
%    $\succ \interpret{u} * \rho \cdot \interpret{w}
%    \leadsto (\abs{y}{y * \typeinterpret{\tau} \cdot \interpret{s}})
%    \cdot \interpret{w} \leadsto \interpret{w} * \typeinterpret{\tau}
%    \cdot \interpret{s} \leadsto (\abs{x:\typeinterpret{\sigma}[\alpha:=
%    \typeinterpret{\tau}]}{\interpret{t}[\alpha:=\typeinterpret{\tau}]})
%    \cdot \interpret{s} \leadsto \interpret{t}[\alpha:=\typeinterpret{
%    \tau}][x:=\interpret{s}]$.  By Lemma
%    \ref{lem:substitutioninterpret} this is equal to
%    $\interpret{t[\alpha:=\tau][x:=s]}$.
%  \end{itemize}
%\item $
%\mathtt{case}_{\rho,\pi,\xi}(\mathtt{case}_{\sigma,\tau,\mathtt{or}(
%  \rho,\pi)}(u,\abs{x}{s},\abs{y}{t}),\abs{z}{v},\abs{a}{w}) %& \red &
%  \red\\
%  \mathtt{case}_{\sigma,\tau,\xi}(u,
%    \abs{x}{\mathtt{case}_{\rho,\pi,\xi}(s,\abs{z}{v},\abs{a}{w})},
%    \abs{y}{\mathtt{case}_{\rho,\pi,\xi}(t,\abs{z}{v},\abs{a}{w})}) $\\
%  We have:
%  \begin{itemize}
%  \item $aa := \interpret{\mathtt{case}_{\sigma,\tau,\mathtt{or}(\rho,
%    \pi)}(u,\abs{x}{s},\abs{y}{t})} =$\\$
%    \lift_{\typeinterpret{\rho} \times \typeinterpret{\pi}}(37) \oplus
%    (\ \lift_{\typeinterpret{\rho} \times \typeinterpret{\pi}}(
%      \flatten_{\typeinterpret{\sigma} \times \typeinterpret{\tau}}(
%        \interpret{u}) \oplus 1) \otimes$ \\
%    \phantom{x} \hfill
%    $(\ ((\abs{x}{\interpret{s}}) \cdot \proj^1(\interpret{u})) \oplus
%    ((\abs{y}{\interpret{t}}) \cdot \proj^2(\interpret{u})) \oplus
%    \lift(1)\ )\ )$
%  \end{itemize}
\end{itemize}

==================

\CK{This one is really the nastiest to handle, and will likely take
some tweaking in the interpretation to get right:}
\begin{itemize}
\item Goal: \\$
\mathtt{case}_{\rho,\pi,\xi}(\mathtt{case}_{\sigma,\tau,\mathtt{or}\,
  \rho\,\pi}(u,\abs{x:\sigma}{s},\abs{y:\tau}{t}),\abs{z:\rho}{v},\abs{a:\pi}{w}) \red \\
  \mathtt{case}_{\sigma,\tau,\xi}(u,
    \abs{x:\sigma}{\mathtt{case}_{\rho,\pi,\xi}(s,\abs{z:\rho}{v},\abs{a:\pi}{w})},
    \abs{y:\tau}{\mathtt{case}_{\rho,\pi,\xi}(t,\abs{z:\rho}{v},\abs{a:\pi}{w})})
$
\item Towards interpretation, let's note what we need: \\
  $\mathcal{J}(\mathtt{case})_{\rho,\pi,\xi}(
    \mathcal{J}(\mathtt{case})_{\sigma,\tau,\typeinterpret{\mathtt{or}\,
    \rho\,\pi}}(\interpret{u},\abs{x}{\interpret{s}},
    \abs{y}{\interpret{t}}),\abs{z}{\interpret{v}},
    \abs{a}{\interpret{w}}) \succeq \\
  \mathcal{J}(\mathtt{case})_{\sigma,\tau,\xi}(\interpret{u},
    \abs{x}{\mathcal{J}(\mathtt{case})_{\rho,\pi,\xi}(\interpret{s},
    \abs{z}{\interpret{v}},\abs{a}{\interpret{w}})},\\
    \phantom{ABCDEFGHIJ}
    \abs{y}{\mathcal{J}(\mathtt{case})_{\rho,\pi,\xi}(\interpret{t},
    \abs{z}{\interpret{v}},\abs{a}{\interpret{w}})})
$ \\
  with $x : \sigma,y:\tau,z:\rho,a:\pi$ (to avoid having to indicate
  type denotations all the time); note that I am treating them as type
  variables here, otherwise they would have to be interpreted too.
\item Note that the type interpretation $\typeinterpret{\mathtt{or}\,
  \rho\,\pi}$ evaluates to $\rho \times \pi$.  This is the output type
  of the inner case in the left-hand side.
\item Recall that:
\[
\begin{array}{rcl}
\Termmap(\mathtt{case}) & = & \Lambda \alpha,\beta,\xi . \lambda x : \alpha \times \beta,
  y : (\alpha \arrtype \xi), z : (\beta \arrtype \xi). \\
  & & \quad
  \lift_\xi(37) \oplus (\lift_\xi(\flatten_{\alpha\times\beta}(x)\oplus 3)
    \otimes \\
  & & \quad\phantom{ABCDEFGHIJKL}
    (\ y \cdot \pi^1(x) \oplus z \cdot \pi^2(x) \oplus
    \lift_\xi(11)\ ) \\
\end{array}
\]
\item Let's fill in the inner $\mathtt{case}$ interpretations in the
  right-hand side: \\
  $\mathcal{J}(\mathtt{case})_{\rho,\pi,\xi}(
    \mathcal{J}(\mathtt{case})_{\sigma,\tau,\typeinterpret{\mathtt{or}\,
    \rho\,\pi}}(\interpret{u},\abs{x}{\interpret{s}},
    \abs{y}{\interpret{t}}),\abs{z}{\interpret{v}},
    \abs{a}{\interpret{w}}) \succeq \\
  \mathcal{J}(\mathtt{case})_{\sigma,\tau,\xi}(\interpret{u},\abs{x}{
    \lift_\xi(37) \oplus \lift_\xi(\flatten_{\rho \times \pi}(
      \interpret{s}) \oplus 3) \otimes \\
      \phantom{AB} \hfill (\
      ((\lambda z.\interpret{v}) \cdot \pi^1(\interpret{s})) \oplus
      ((\lambda a.\interpret{w}) \cdot \pi^2(\interpret{s})) \oplus
      \lift_\xi(11)\ )},\\
    \phantom{ABCDEFGHIJ}\abs{y}{
    \lift_\xi(37) \oplus \lift_\xi(\flatten_{\rho \times \pi}(
      \interpret{t}) \oplus 3) \otimes \\
      \phantom{AB} \hfill (\
      ((\lambda z.\interpret{v}) \cdot \pi^1(\interpret{t})) \oplus
      ((\lambda a.\interpret{w}) \cdot \pi^2(\interpret{t})) \oplus
      \lift_\xi(11)\ )})
$
\item And $\beta$-normalise them.  We're allowed to do that by
  Lemma \ref{lem_succ_red}. \\
  $\mathcal{J}(\mathtt{case})_{\rho,\pi,\xi}(
    \mathcal{J}(\mathtt{case})_{\sigma,\tau,\typeinterpret{\mathtt{or}\,
    \rho\,\pi}}(\interpret{u},\abs{x}{\interpret{s}},
    \abs{y}{\interpret{t}}),\abs{z}{\interpret{v}},
    \abs{a}{\interpret{w}}) \succeq \\
  \mathcal{J}(\mathtt{case})_{\sigma,\tau,\xi}(\interpret{u},\abs{x}{
    \lift_\xi(37) \oplus \lift_\xi(\flatten_{\rho \times \pi}(
      \interpret{s}) \oplus 3) \otimes \\
      \phantom{AB} \hfill (\
      \interpret{v}[z:=\pi^1(\interpret{s})] \oplus
      \interpret{w}[z:=\pi^2(\interpret{s})] \oplus
      \lift_\xi(11)\ )},\\
    \phantom{ABCDEFGHIJ}\abs{y}{
    \lift_\xi(37) \oplus \lift_\xi(\flatten_{\rho \times \pi}(
      \interpret{t}) \oplus 3) \otimes \\
      \phantom{AB} \hfill (\
      \interpret{v}[z:=\pi^1(\interpret{t})] \oplus
      \interpret{w}[a:=\pi^2(\interpret{t})] \oplus
      \lift_\xi(11)\ )})
$
\item Now we do the inner case interpretation in the left-hand side; we
  immediately perform the $\beta$-reduction step. \\
  $\mathcal{J}(\mathtt{case})_{\rho,\pi,\xi}(
    \\
    \phantom{AB}
    \lift_{\rho \times \pi}(37) \oplus
    \lift_{\rho \times \pi}(\flatten_{\sigma \times \tau}(\interpret{u})
    \oplus 3) \otimes \\
    \phantom{ABCDEFGHIJK}
    (\ \interpret{s}[x:=\pi^1(\interpret{u})] \oplus
       \interpret{t}[y:=\pi^2(\interpret{u})] \oplus
       \lift_{\rho \times \pi}(11)
    \ ), \\
  \lambda z.\interpret{v},\ \lambda a.\interpret{w}) \succeq \\
  \mathcal{J}(\mathtt{case})_{\sigma,\tau,\xi}(\interpret{u},\abs{x}{
    \lift_\xi(37) \oplus \lift_\xi(\flatten_{\rho \times \pi}(
      \interpret{s}) \oplus 3) \otimes \\
      \phantom{AB} \hfill (\
      \interpret{v}[z:=\pi^1(\interpret{s})] \oplus
      \interpret{w}[z:=\pi^2(\interpret{s})] \oplus
      \lift_\xi(11)\ )},\\
    \phantom{ABCDEFGHIJ}\abs{y}{
    \lift_\xi(37) \oplus \lift_\xi(\flatten_{\rho \times \pi}(
      \interpret{t}) \oplus 3) \otimes \\
      \phantom{AB} \hfill (\
      \interpret{v}[z:=\pi^1(\interpret{t})] \oplus
      \interpret{w}[a:=\pi^2(\interpret{t})] \oplus
      \lift_\xi(11)\ )})
$
\item Now I will fill in the outer $\mathtt{case}$ interpretation on
  the left. To avoid this getting horribly messy, I will use the
  shorthand notation $A$ explained below.\\
  $\lift_\xi(37) \oplus
  \lift_\xi(\flatten_{\rho \times \pi}(A) \oplus 3) \otimes \\
  \phantom{ABCDEFG}
  ( \interpret{v}[z:=\pi^1(A)] \oplus \interpret{w}[a:=\pi^2(A)]
  \oplus \lift_\xi(11) ) \succeq \\
  \mathcal{J}(\mathtt{case})_{\sigma,\tau,\xi}(\interpret{u},\abs{x}{
    \lift_\xi(37) \oplus \lift_\xi(\flatten_{\rho \times \pi}(
      \interpret{s}) \oplus 3) \otimes \\
      \phantom{AB} \hfill (\
      \interpret{v}[z:=\pi^1(\interpret{s})] \oplus
      \interpret{w}[z:=\pi^2(\interpret{s})] \oplus
      \lift_\xi(11)\ )},\\
    \phantom{ABCDEFGHIJ}\abs{y}{
    \lift_\xi(37) \oplus \lift_\xi(\flatten_{\rho \times \pi}(
      \interpret{t}) \oplus 3) \otimes \\
      \phantom{AB} \hfill (\
      \interpret{v}[z:=\pi^1(\interpret{t})] \oplus
      \interpret{w}[a:=\pi^2(\interpret{t})] \oplus
      \lift_\xi(11)\ )})
$ \\
  \\
  Here, $A =
    \lift_{\rho \times \pi}(37) \oplus
    \lift_{\rho \times \pi}(\flatten_{\sigma \times \tau}(\interpret{u})
    \oplus 3) \otimes \\
    \phantom{ABCDEFGHIJK}
    (\ \interpret{s}[x:=\pi^1(\interpret{u})] \oplus
       \interpret{t}[y:=\pi^2(\interpret{u})] \oplus
       \lift_{\rho \times \pi}(11)
    \ )$.
\item And let's of course also fill in the right-hand side. \\
  $\lift_\xi(37) \oplus
  \lift_\xi(\flatten_{\rho \times \pi}(A) \oplus 3) \otimes \\
  \phantom{ABCDEFG}
  ( \interpret{v}[z:=\pi^1(A)] \oplus \interpret{w}[a:=\pi^2(A)]
  \oplus \lift_\xi(11) ) \succeq \\
  \lift_\xi(37) \oplus
  \lift_\xi(\flatten_{\sigma \times \tau}(\interpret{u}) \oplus 3)
  \otimes \\
  \phantom{ABCDEFG}
  (\ B_{\interpret{s}}[x:=\pi^1(\interpret{u})] \oplus
     B_{\interpret{t}}[y:=\pi^2(\interpret{u})] \oplus \lift_\xi(11))
  $
 \\
  Here, $B_q =
    \lift_\xi(37) \oplus \lift_\xi(\flatten_{\rho \times \pi}(
      \interpret{q}) \oplus 3) \otimes \\
      \phantom{AB} \hfill (\
      \interpret{v}[z:=\pi^1(q)] \oplus
      \interpret{w}[z:=\pi^2(q)] \oplus
      \lift_\xi(11)\ )$.
\item Note that $s$ is a bound variable in $s$ and $y$ a bound variable
  in $t$; these variables do not occur in $B_q$.  So, we can rewrite
  the above inequality to:
  $\lift_\xi(37) \oplus
  \lift_\xi(\flatten_{\rho \times \pi}(A) \oplus 3) \otimes \\
  \phantom{ABCDEFG}
  ( \interpret{v}[z:=\pi^1(A)] \oplus \interpret{w}[a:=\pi^2(A)]
  \oplus \lift_\xi(11) ) \succeq \\
  \lift_\xi(37) \oplus
  \lift_\xi(\flatten_{\sigma \times \tau}(\interpret{u}) \oplus 3)
  \otimes \\
  \phantom{ABCDEFG}
  (\ B_{\interpret{s}[x:=\pi^1(\interpret{u})]} \oplus
     B_{\interpret{t}[y:=\pi^2(\interpret{u})]} \oplus \lift_\xi(11))
  $
\item By Lemma \ref{lem:approxproperties} we can reorder parts of
  $\oplus$.
  If \CK{(TODO: assumption here)} we also have that $(A \oplus B) \otimes
  C \approx A \otimes C \oplus B \otimes C$, then we obtain the
  following proof obligation: \\
  $\lift_\xi(37)\ \oplus \\
  \phantom{AB}\lift_\xi(\flatten_{\rho \times \pi}(A)) \otimes
  \interpret{v}[z:=\pi^1(A)] \oplus \\
  \phantom{AB}\lift_\xi(\flatten_{\rho \times \pi}(A)) \otimes
  \interpret{w}[a:=\pi^2(A)] \oplus \\
  \phantom{AB}\lift_\xi(\flatten_{\rho \times \pi}(A)) \otimes
  \lift_\xi(11) \oplus \\
  \phantom{AB}\lift_\xi(3) \otimes \interpret{v}[z:=\pi^1(A)] \oplus \\
  \phantom{AB}\lift_\xi(3) \otimes \interpret{w}[a:=\pi^2(A)] \oplus \\
  \phantom{AB}\lift_\xi(3) \otimes \lift_\xi(11) \\
  \succeq \\
  \lift_\xi(37) \oplus \\
  \phantom{AB} \lift_\xi(\flatten_{\sigma \times \tau}(\interpret{u}))
  \otimes B_{\interpret{s}[x:=\pi^1(\interpret{u})]} \oplus \\
  \phantom{AB} \lift_\xi(\flatten_{\sigma \times \tau}(\interpret{u}))
  \otimes B_{\interpret{t}[y:=\pi^2(\interpret{u})]} \oplus \\
  \phantom{AB} \lift_\xi(\flatten_{\sigma \times \tau}(\interpret{u}))
  \otimes \lift_\xi(11) \oplus \\
  \phantom{AB}\lift_\xi(3) \otimes B_{\interpret{s}[x:=
    \pi^1(\interpret{u})]} \oplus \\
  \phantom{AB}\lift_\xi(3) \otimes B_{\interpret{t}[y:=
    \pi^2(\interpret{u})]} \oplus \\
  \phantom{AB}\lift_\xi(3) \otimes \lift_\xi(11)
  $
\item By Lemma \ref{lem:plustimesmonotonic} we can strike parts of
  $\oplus$ away against each other in the left- and right-hand side.
  We can also reorder the sides of an $\otimes$ and $\oplus$, giving:
  \CK{(TODO: by ??)} \\
  $\lift_\xi(\flatten_{\rho \times \pi}(A)) \otimes
  \interpret{v}[z:=\pi^1(A)] \oplus \\
  \phantom{AB}\lift_\xi(\flatten_{\rho \times \pi}(A)) \otimes
  \interpret{w}[a:=\pi^2(A)] \oplus \\
  \phantom{AB}\lift_\xi(\flatten_{\rho \times \pi}(A)) \otimes
  \lift_\xi(11) \oplus \\
  \phantom{AB}\lift_\xi(3) \otimes \interpret{v}[z:=\pi^1(A)] \oplus \\
  \phantom{AB}\lift_\xi(3) \otimes \interpret{w}[a:=\pi^2(A)] \\
  \succeq \\
  \lift_\xi(\flatten_{\sigma \times \tau}(\interpret{u}))
  \otimes B_{\interpret{s}[x:=\pi^1(\interpret{u})]} \oplus \\
  \phantom{AB} \lift_\xi(\flatten_{\sigma \times \tau}(\interpret{u}))
  \otimes B_{\interpret{t}[y:=\pi^2(\interpret{u})]} \oplus \\
  \phantom{AB} \lift_\xi(11) \otimes
    \lift_\xi(\flatten_{\sigma \times \tau}(\interpret{u})) \oplus \\
  \phantom{AB}\lift_\xi(3) \otimes B_{\interpret{s}[x:=
    \pi^1(\interpret{u})]} \oplus \\
  \phantom{AB}\lift_\xi(3) \otimes B_{\interpret{t}[y:=
    \pi^2(\interpret{u})]} \\
  $
\item Now, if use the distribution property, as well as the
  properties that $a \otimes b \approx b \otimes a$ and $a \oplus
  b \approx b \oplus a$ and $\lift_\xi(a) R \lift_\xi(b) \approx
  \lift_\xi(a R b)$ \CK{(TODO)}, note that
  $B_q \approx \\
  \lift_\xi(37 + 3 * 11) \oplus \\
  \phantom{AB}\lift_\xi(3) \otimes \interpret{v}[z:=\pi^1(q)] \oplus \\
  \phantom{AB}\lift_\xi(3) \otimes \interpret{w}[a:=\pi^2(q)] \\
  \phantom{AB}\lift_\xi(11) \otimes \lift_\xi(\flatten_{\rho \times
    \pi}(q)) \oplus \\
  \phantom{AB}\lift_\xi(\flatten_{\rho \times \pi}(q)) \otimes
    \interpret{v}[z:=\pi^1(q)] \oplus \\
  \phantom{AB}\lift_\xi(\flatten_{\rho \times \pi}(q)) \otimes
    \interpret{w}[a:=\pi^2(q)] \oplus \\
  $
  Using this, we expand the left-hand side of the inequality above: \\
  $\lift_\xi(\flatten_{\rho \times \pi}(A)) \otimes
  \interpret{v}[z:=\pi^1(A)] \oplus \\
  \phantom{AB}\lift_\xi(\flatten_{\rho \times \pi}(A)) \otimes
  \interpret{w}[a:=\pi^2(A)] \oplus \\
  \phantom{AB}\lift_\xi(\flatten_{\rho \times \pi}(A)) \otimes
  \lift_\xi(11) \oplus \\
  \phantom{AB}\lift_\xi(3) \otimes \interpret{v}[z:=\pi^1(A)] \oplus \\
  \phantom{AB}\lift_\xi(3) \otimes \interpret{w}[a:=\pi^2(A)] \\
  \succeq \\
  \lift_\xi(\flatten_{\sigma \times \tau}(\interpret{u}))
  \otimes B_{\interpret{s}[x:=\pi^1(\interpret{u})]} \oplus \\
  \phantom{AB} \lift_\xi(\flatten_{\sigma \times \tau}(\interpret{u}))
  \otimes B_{\interpret{t}[y:=\pi^2(\interpret{u})]} \oplus \\
  \phantom{AB} \lift_\xi(11) \otimes
    \lift_\xi(\flatten_{\sigma \times \tau}(\interpret{u})) \oplus \\
  \phantom{AB}\lift_\xi(3) \otimes B_{\interpret{s}[x:=
    \pi^1(\interpret{u})]} \oplus \\
  \phantom{AB}\lift_xi(3 *(37 + 3 * 11)) \oplus
  \phantom{AB}\lift_\xi(3 * 3) \otimes \interpret{v}[z:=\pi^1(
    \interpret{t}[y:=\pi^2(\interpret{u})])] \oplus \\
  \phantom{AB}\lift_\xi(3 * 3) \otimes \interpret{w}[a:=\pi^2(
    \interpret{t}[y:=\pi^2(\interpret{u})])] \oplus \\
  \phantom{AB}\lift_\xi(3 * 11) \otimes \lift_\xi(\flatten_{\rho \times
    \pi}(\interpret{t}[y:=\pi^2(\interpret{u})])) \oplus
  \phantom{AB}\lift_\xi(3) \otimes B_{\interpret{t}[y:=
    \pi^2(\interpret{u})]} \\
  $
\item -----------------
\item Taking into account that $\lift_\xi(n) \otimes \lift_\xi(m)
  \approx \lift_\xi(n+m)$ and that $\lift_\xi(n) \otimes a \oplus
  \lift_xi(m) \otimes a = \lift_xi(n+m) \otimes a$ \CK{(TODO: check
  this)}, we can slightly simplify the right-hand side, obtaining: \\
\end{itemize}

==================

\begin{itemize}
\item By Lemma \ref{lem:approxproperties} we can reorder parts of
  $\oplus$ and by \ref{lem:plustimesmonotonic} we can strike parts of
  $\oplus$ away against each other in the left- and right-hand side,
  giving a proof obligation: \\
  $\langle\ \  \interpret{u} * \typeinterpret{\mathtt{or}\,\rho\,\pi} \cdot
    (\Lambda \chi\lambda f.f \cdot (\abs{x}{\interpret{s}}) \cdot
    (\abs{y}{\interpret{t}})) \oplus \\
    \phantom{A}
    \interpret{s}[x:=\lift(0)]
    \oplus \interpret{t}[y:=
    \lift(0)] \oplus \lift(7))\ \ \rangle \\
    \phantom{AA} * \xi \cdot (\Lambda \chi\lambda f.f \cdot
    (\abs{z}{\interpret{v}}) \cdot (\abs{a}{\interpret{w}})) \succeq \\
  \interpret{u} * \xi \cdot
    (\Lambda \chi\lambda f.f \cdot A \cdot B) \oplus \\
    \phantom{A} \interpret{s}[x:=\lift(0)] * \xi \cdot (\Lambda \chi.
      \lambda f.f \cdot
      (\abs{z}{\interpret{v}}) \cdot (\abs{a}{\interpret{w}})) \\
    \phantom{A}\oplus \interpret{t}[y:=\lift(0) * \xi \cdot (\Lambda \chi.
      \lambda f.f \cdot (\abs{z}{\interpret{v}}) \cdot
      (\abs{a}{\interpret{w}})) \\
    \phantom{A} \oplus \interpret{v}[z:=\lift(0)] \\
    \phantom{A} \oplus \interpret{w}[a:=\lift(0)] \\
    \phantom{A} \oplus \lift(7) \\
    \phantom{A} \oplus \lift(7)$.
    where \\
    $A =
    \abs{x}{\interpret{s} * \xi \cdot (\Lambda \chi.\lambda f.f \cdot
    (\abs{z}{\interpret{v}}) \cdot (\abs{a}{\interpret{w}})) \oplus \\
    \phantom{ABCDEFGHIJKL}
    \interpret{v}[z:=\lift(0)] \oplus
    \interpret{w}[a:=\lift(0)] \oplus \lift(7)}$ \\
    and $B =
    \abs{y}{\interpret{t} * \xi \cdot (\Lambda \chi.\lambda f.
    f \cdot (\abs{z}{\interpret{v}}) \cdot
    (\abs{a}{\interpret{w}})) \oplus \\
    \phantom{ABCDEFGHIJKL}
    \interpret{v}[z:=\lift(0)] \oplus
    \interpret{w}[a:=\lift(0)] \oplus \lift(7)}$.
\item This does not look so good. But now note that by definition,
  $(s \oplus t) * \tau \leadsto (s * \tau) \oplus (t * \tau)$ and
  also $(s \oplus t) \cdot u \leadsto (s \cdot u) \oplus (t \cdot u)$.
  We can use this to split up the left-hand side: \\
  $\interpret{u} * \typeinterpret{\mathtt{or}\,\rho\,\pi} \cdot
    (\Lambda \chi\lambda f.f \cdot (\abs{x}{\interpret{s}}) \cdot
    (\abs{y}{\interpret{t}})) * \xi \cdot (\Lambda \chi\lambda f.f \cdot
    (\abs{z}{\interpret{v}}) \cdot (\abs{a}{\interpret{w}})) \oplus \\
  \phantom{A}\interpret{s}[x:=\lift(0)] * \xi \cdot (\Lambda \chi
    \lambda f.f \cdot (\abs{z}{\interpret{v}}) \cdot
    (\abs{a}{\interpret{w}})) \oplus \\
  \phantom{A}\interpret{t}[y:=\lift(0)] * \xi \cdot (\Lambda \chi
    \lambda f.f \cdot (\abs{z}{\interpret{v}}) \cdot
    (\abs{a}{\interpret{w}})) \oplus \\
  \phantom{A}\lift_{\typeinterpret{\mathtt{or}\,\rho\,\tau}}(7)
    * \xi \cdot (\Lambda \chi\lambda f.f \cdot
    (\abs{z}{\interpret{v}}) \cdot (\abs{a}{\interpret{w}})) \\
  \leadsto^* \\
  \interpret{u} * \typeinterpret{\mathtt{or}\,\rho\,\pi} \cdot
    (\Lambda \chi\lambda f.f \cdot (\abs{x}{\interpret{s}}) \cdot
    (\abs{y}{\interpret{t}})) * \xi \cdot (\Lambda \chi\lambda f.f \cdot
    (\abs{z}{\interpret{v}}) \cdot (\abs{a}{\interpret{w}})) \oplus \\
  \phantom{A}\interpret{s}[x:=\lift(0)] * \xi \cdot (\Lambda \chi
    \lambda f.f \cdot (\abs{z}{\interpret{v}}) \cdot
    (\abs{a}{\interpret{w}})) \oplus \\
  \phantom{A}\interpret{t}[y:=\lift(0)] * \xi \cdot (\Lambda \chi
    \lambda f.f \cdot (\abs{z}{\interpret{v}}) \cdot
    (\abs{a}{\interpret{w}})) \oplus \\
  \phantom{A}\lift_{xi}(7)$.

  PROBLEM: in the right-hand side, $\interpret{u}$ is applied to
  something larger than in the left-hand side.  That is not something
  that will be much helped by splitting additions.  So, a different
  approach may be needed.  Will ponder on this. (But leaving it out
  there because the problem is important for finding the right
  interpretation.)
\end{itemize}

\CK{END OF CASE/CASE CHALLENGE (UNFINISHED).}

\CK{Note: this goes wrong, and may be tricky to fix because of the
horrible interpretation of $\mathtt{or}$.  It may be better to go back
to pairing for $\mathtt{or}$.  However, the $\mathtt{let}$ cannot be
changed in such a way.  I will now set out how we can deal with
$\mathtt{let}/\mathtt{let}$, since it's the case most likely to lead
to problems that are hard to work around.}

\newpage

In this, I say that $\Termmap(\mathtt{let}) =$ \\
$\Lambda \varphi : *
\arrkind *.\Lambda \beta : *.\lambda x : \forall \chi[\forall \xi[
\varphi\xi \arrtype \chi] \arrtype \chi].\lambda y : \forall \xi[
\alpha \xi \arrtype \beta].$ \\
\phantom{AB}\hfill
  $A_{\varphi,\beta,x,y} \otimes
    (x * \beta \cdot (y \oplus C_{\varphi,\beta,x,y}))
  \oplus \\
\phantom{AB}\hfill
  B_{\varphi,\beta,x,y} \otimes (y * \Pi_{\varphi,\beta,x,y} \cdot
    D_{\varphi,\beta,x,y})
  \oplus \\
\phantom{AB}\hfill
  E_{\varphi,\beta,x,y}$.

Here, terms $A,\dots,E$ and type $\Pi$ are yet to be determined.

In the following, I will not use $\leadsto$ in either side but simply
write $=$, essentially reasoning modulo $\leadsto$ (which I think we
can safely do, but formalising can be done afterwards if it all works
out).

\begin{itemize}
\item We need:
  $\interpret{\mathtt{let}_{\psi,\rho}(\mathtt{let}_{\varphi,\exists
  \psi}(s,\Lambda \alpha.\lambda x : \varphi\alpha.t),u)}$ \\
  $\succeq^?$ \\
  $\interpret{\mathtt{let}_{\varphi,\rho}(s,\Lambda \alpha.\lambda x:
  \varphi\alpha.\mathtt{let}_{\psi,\rho}(t,u))}$
\item That is: \\
  $\Termmap(\mathtt{let})_{\psi,\rho}(
  \Termmap(\mathtt{let})_{\varphi,\forall\beta[\forall\alpha[\psi\alpha
  \arrtype \beta] \arrtype \beta]}(
  \interpret{s},\Lambda \alpha.\lambda x : \varphi\alpha.\interpret{t}),
  \interpret{u})$ \\
  $\succeq^?$ \\
  $\Termmap(\mathtt{let})_{\varphi,\rho}(
  \interpret{s},\Lambda \alpha.\lambda x:\varphi\alpha.
  \Termmap(\mathtt{let})_{\psi,\rho}(\interpret{t},\interpret{u}))$
\item Let's expand and evaluate the inner occurrences of
  $\Termmap(\mathtt{let})$: \\
  $\Termmap(\mathtt{let})_{\psi,\rho}( \\
  \phantom{AB}
    A_Q \otimes (\interpret{s} * \forall\beta[\forall \alpha[\psi\alpha
    \arrtype \beta] \arrtype \beta] \cdot ((\Lambda \alpha.\lambda x :
  \varphi\alpha.\interpret{t}) \oplus C_Q)) \oplus \\
  \phantom{AB}
    B_Q \otimes ((\Lambda \alpha.\lambda x : \varphi\alpha.\interpret{t})
    * \Pi_Q \cdot D_Q) \oplus \\
  \phantom{AB}
    E_Q\ , \\
  \phantom{A} \interpret{u}\ )$ \\
  $\succeq^?$ \\
  $\Termmap(\mathtt{let})_{\varphi,\rho}(
  \interpret{s},\Lambda \alpha.\lambda x:\varphi\alpha. \\
  \phantom{AB}
  A_R \otimes (\interpret{t} * \rho \cdot (\interpret{u} \oplus
    C_R)) \oplus \\
  \phantom{AB}
    B_R \otimes (\interpret{u} * \Pi_R \cdot D_R) \oplus \\
  \phantom{AB}
  E_R\ )$ \\

  Here, $Q$ stands for the subscript $\varphi,\forall\beta[\forall
  \alpha[\psi\alpha\arrtype \beta] \arrtype\beta],\interpret{s},
  \Lambda \alpha.\lambda x:\varphi\alpha.\interpret{t}$ and
  $R$ stands for the subscript $\psi,\rho,\interpret{t},\interpret{u}$.
\item Let's evaluate the left-hand side as far as we already can: \\
  $\Termmap(\mathtt{let})_{\psi,\rho}( \\
  \phantom{AB}
    A_Q \otimes (\interpret{s} * \forall\beta[\forall \alpha[\psi\alpha
    \arrtype \beta] \arrtype \beta] \cdot ((\Lambda \alpha.\lambda x :
  \varphi\alpha.\interpret{t}) \oplus C_Q)) \oplus \\
  \phantom{AB}
    B_Q \otimes \interpret{t}[\alpha:=\Pi_Q][x:=D_Q] \oplus \\
  \phantom{AB}
    E_Q\ , \\
  \phantom{A} \interpret{u}\ )$ \\
  $\succeq^?$ \\
  $\Termmap(\mathtt{let})_{\varphi,\rho}(
  \interpret{s},\Lambda \alpha.\lambda x:\varphi\alpha. \\
  \phantom{AB}
  A_R \otimes (\interpret{t} * \rho \cdot (\interpret{u} \oplus
    C_R)) \oplus \\
  \phantom{AB}
  B_R \otimes (\interpret{u} * \Pi_R \cdot D_R) \oplus \\
  \phantom{AB}
  E_R\ )$ \\
\pagebreak
\item Okay, let's expand the outer lets. \\
  $A_P \otimes (\ \\
  \phantom{A} (\:\:
    A_Q \otimes (\interpret{s} * \forall\beta[\forall \alpha[\psi\alpha
    \arrtype \beta] \arrtype \beta] \cdot ((\Lambda \alpha.\lambda x :
  \varphi\alpha.\interpret{t}) \oplus C_Q)) \oplus \\
  \phantom{AB}
    B_Q \otimes \interpret{t}[\alpha:=\Pi_Q][x:=D_Q] \oplus \\
  \phantom{AB}
    E_Q \\
  \phantom{A} ) * \rho \cdot (\interpret{u} \oplus C_P)\ )\ \oplus \\
  \phantom{A} B_P \otimes (\interpret{u} * \Pi_P \cdot D_P)\ \oplus \\
  \phantom{A} E_P$ \\
  $\succeq^?$ \\
  $A_S \otimes\ ( \\
  \phantom{AB} \interpret{s} * \rho \cdot (\\
  \phantom{AB} (\:\: \Lambda \alpha.\lambda x:\varphi\alpha.
    A_R \otimes (\interpret{t} * \rho \cdot
    (\interpret{u} \oplus C_R)) \oplus B_R \otimes (\interpret{u} *
    \Pi_R \cdot D_R) \oplus E_R \\
  \phantom{AB} ) \oplus C_S) \\
  \phantom{A} )\ \oplus \\
  \phantom{A} B_S \otimes\ ( \\
  \phantom{AB} (\:\: A_R \otimes (\interpret{t} * \rho \cdot
    (\interpret{u} \oplus C_R)) \oplus B_R \otimes (\interpret{u} *
    \Pi_R \cdot D_R) \oplus E_R\ )[\alpha:=\Pi_S][x:=D_S] \\
  \phantom{A} )\ \oplus \\
  \phantom{A} E_S$ \\
  Here, $P$ stands for the subscript $\psi,\rho,
  A_Q \times \dots \oplus E_Q,\interpret{u}$ and
  $S$ stands for the subscript $\varphi,\rho,\interpret{s},
  \Lambda \alpha.\lambda x \dots E_R$.
\item Using the definitions of $\oplus$ and $\otimes$, we can rewrite
  the left-hand side as follows: \\
  $A_P \otimes (\ \\
  \phantom{A} (\:\: (A_Q * \rho \cdot (\interpret{u} \oplus C_P))\:\:
  \otimes \\
  \phantom{AB} (\interpret{s} * \forall\beta[\forall \alpha[\psi\alpha
    \arrtype \beta] \arrtype \beta] \cdot ((\Lambda \alpha.\lambda x :
    \varphi\alpha.\interpret{t}) \oplus C_Q) * \rho \cdot
    (\interpret{u} \oplus C_P)) \\
  \phantom{A} ) \oplus \\
  \phantom{A} (\:\: (B_Q * \rho \cdot (\interpret{u} \oplus C_P))\:\:
  \otimes \\
  \phantom{AB} \interpret{t}[\alpha:=\Pi_Q][x:=D_Q] * \rho \cdot
    (\interpret{u} \oplus C_P)\\
  \phantom{A} ) \oplus \\
  \phantom{A} E_Q * \rho \cdot (\interpret{u} \oplus C_P)\ )\ \oplus \\
  \phantom{A} B_P \otimes (\interpret{u} * \Pi_P \cdot D_P)\ \oplus \\
  \phantom{A} E_P$ \\
  $\succeq^?$ \\
  $A_S \otimes\ ( \\
  \phantom{AB} \interpret{s} * \rho \cdot (\\
  \phantom{AB} (\:\: \Lambda \alpha.\lambda x:\varphi\alpha.
    A_R \otimes (\interpret{t} * \rho \cdot
    (\interpret{u} \oplus C_R)) \oplus B_R \otimes (\interpret{u} *
    \Pi_R \cdot D_R) \oplus E_R \\
  \phantom{AB} ) \oplus C_S) \\
  \phantom{A} )\ \oplus \\
  \phantom{A} B_S \otimes\ ( \\
  \phantom{AB} (\:\: A_R \otimes (\interpret{t} * \rho \cdot
    (\interpret{u} \oplus C_R)) \oplus B_R \otimes (\interpret{u} *
    \Pi_R \cdot D_R) \oplus E_R\ )[\alpha:=\Pi_S][x:=D_S] \\
  \phantom{A} )\ \oplus \\
  \phantom{A} E_S$ \\
\item Further progress will likely require filling in some of those
  terms $A\dots E$.  Note that for monotonicity, we must require that
  always $A_? \succeq \lift(1)$ and $B_? \succeq \lift(1)$.
  The difficulty is that, to be able to use absolute positiveness, the
  left-hand side should at least have a part that $\succeq
  \interpret{s} * \rho \cdot \langle$that very large term$\rangle$.
  Since $s$ could be anything, note that $\langle$whatever$\rangle
  \otimes \interpret{s} * \rho \cdot \langle$something smaller than
  that very large term$\rangle$ is not comparable.
\item --------------------------
\item A pondering: if we neglect the monotonicity requirement and
  simply choose $\Termmap(\mathtt{let}) = \Lambda \varphi.\Lambda \beta.
  \lambda x.\lambda y.x * \beta \cdot y$, then we obtain the following
  inequality: \\
  $\interpret{s} * \forall\beta[\forall \alpha[\psi\alpha
    \arrtype \beta] \arrtype \beta] \cdot (\Lambda \alpha.\lambda x :
    \varphi\alpha.\interpret{t}) * \rho \cdot \interpret{u}$ \\
  $\succeq^?$ \\
  $\interpret{s} * \rho \cdot (\Lambda \alpha.\lambda x:\varphi\alpha.
    \interpret{t} * \rho \cdot \interpret{u})$ \\
  Does this work out somehow? It seems quite incomparable to me, but
  perhaps with the types these are $\approx$-equal?
\item --------------------------
\item Alternatively\dots\ what if we don't make C 0? \\
  $\interpret{s} * (\Sigma\alpha.\psi\alpha) \cdot ((\Lambda \alpha.\lambda x :
    \varphi\alpha.\interpret{t}) \oplus C_Q) * \rho \cdot
    (\interpret{u} \oplus C_P)$ \\
  $\succeq^?$ \\
  $\interpret{s} * \rho \cdot (\:\: (\:\: \Lambda \alpha.\lambda x:\varphi\alpha.
    \interpret{t} * \rho \cdot (\interpret{u} \oplus C_R)\:\:) \oplus C_S\:\:)$ \\

  Here, $Q := \varphi,\Sigma\alpha.\psi\alpha,\interpret{s},\interpret{t}$ \\
  and $R := \psi,\rho,\interpret{t},\interpret{u}$ \\
  and $P :=\psi,\rho,\interpret{s} * (\Sigma \alpha.\psi\alpha) \cdot ((\Lambda \alpha.\lambda x.\interpret{t}) \oplus C_Q),\interpret{u}$ \\
  and $S := \varphi,\rho,\interpret{s},\Lambda \alpha.\lambda x.\interpret{st} * \rho \cdot (\interpret{u} \oplus C_R)$ \

  Is there any way to define $C_{\alpha,\beta,x,y}$ so that the above expression holds?
\item --------------------------
\item Generalised, what we want is roughly the following:
  \begin{itemize}
  \item Suppose $s : \forall \alpha [ \forall \vec{\beta} [\varphi_1\vec{\beta} \arrtype \dots \arrtype \varphi_n\vec{\beta} \arrtype \alpha] \arrtype \alpha]$.
  \item Then: $s * \forall \gamma [\psi\gamma] \cdot (\Lambda \vec{\beta} \lambda \vec{x}.t) * \tau \succeq s * (\psi\tau) \cdot (\Lambda \vec{\beta} \lambda \vec{x}.t * \tau)$
  \item And: $s * (\pi \arrtype \rho) \cdot (\Lambda \vec{\beta} \lambda \vec{x}.t) \cdot u \succeq s * \rho \cdot (\Lambda \vec{\beta} \lambda \vec{x}.t \cdot u)$
  \end{itemize}
  If we have these two, we can answer the pondering with ``yes''.
\end{itemize}

\LC{I don't think any of the above can be shown easily. The problem is
  that you apply different types to $s$. To prove~$\approx$ one would
  need to somehow consider how the normal form of~$s$ looks like, and
  then see what happens when we reduce. Now, in the first problem
  above, one can prove that the normal form of~$s$ is (assuming~$s$ is
  closed): $\Lambda \beta . \lambda f : \forall \alpha . \varphi
  \alpha \to \beta . f \tau w$ for some $\tau$ and~$w$. If $\beta
  \notin \FV(\tau)$ then we may prove $f \notin \FV(w)$ and in that
  case I think I can prove the $\approx$-equality. But in general we
  may have $\beta \in \FV(\tau)$, and then after reducing you get a
  more complex problem with comparing the two substitution variants
  of~$w$, where~$w$ may be arbitrary of type~$\varphi \tau$. I think
  the difficulty with the other two problems is analogous.}

\CK{In general you cannot have any $\beta_i \in \FV(\tau)$, because
  $\vec{\beta}$ are bound type variables in $\Lambda\vec{\beta}\lambda
  \vec{x}.t$; by $\alpha$-conversion, we can assume that no $\beta_i$
  or $x_i$ occurs anywhere else.}

\LC{By~$\tau$ here I meant an arbitrary type, not necessarily equal to
  any of the types mentioned before. Let's call it $\zeta$
  instead. You can prove that the normal form of~$s$ has the form
  $\Lambda \beta . \lambda f : \forall \alpha . \varphi \alpha \to
  \beta . f \zeta w$ with $\zeta$ and $w$ arbitrary of the appropriate
  kind/type, with possibly $\beta \in \FV(\zeta)$. But that's about
  all you know about~$s$.}

\LC{Well, even this is a simplification, because in our system we also
  have $\oplus,\otimes,\lift$, so the normal form of~$s$ could be also
  e.g.~$\Lambda \beta . \lambda f : \forall \alpha . \varphi \alpha
  \to \beta . f \zeta w \oplus_\beta f \zeta' w'$}

\LC{The problem here essentially reduces to the following
  problem. Given $s : \forall \alpha . \tau \to \rho$ with $\alpha
  \notin \FV(\rho)$ (but possibly $\alpha \in \FV(\tau)$), do we have
  $s \sigma_1 t_1 \succeq s \sigma_2 t_2$ for all appropriate
  $\sigma_i,t_i$? I'm not sure if this is true. It it is, then I don't
  have no idea of how to prove it syntactically. But if it's true then
  this should somehow follow from parametricity of polymorphism. Maybe
  to really get this we would need to switch to interpreting terms in
  a particular model of~$\Fomega$ instead of interpreting them
  syntactically by terms of extended~$\Fomega$. Compare: Wadler
  ``Theorems for Free''.}

\CK{This seems very unlikely to be true. Can we choose $s =
\flatten$ and $\sigma_1 = \sigma_2 = \mathtt{nat}$ and $t_1 = 1$ and
$t_2 = 2$?}

\LC{Yes, you're right. By ``appropriate $\sigma_i,t_i$'' I had in mind
  that there is some appropriate relation between $t_1$ and $t_2$. But
  now I think this can't be done. Because
  $\flatten,\lift,\oplus,\otimes$ ``match on'' the type we don't
  really have parametricity. And you've just almost provided a
  counterexample to your original problem. Take $s = \Lambda \alpha
  . \lambda f : \alpha . \lift_\alpha(\flatten_\alpha(f))$ and $\pi =
  \rho = \nat$ and $t = \lambda x : \nat . x$ and $u = 1$. Then
  \[
  s * (\pi \arrtype \rho) \cdot t \cdot u \succeq s * \rho \cdot (t \cdot u)
  \]
  is equivalent to
  \[
  \lift_{\nat\arrtype\nat} (\flatten_{\nat\arrtype\nat} (\lambda x . x)) 1 \succeq \lift_\nat(\flatten_\nat ((\lambda x . x) 1))
  \]
  which after reduction is equivalent to
  \[
  0 \succeq 1
  \]
  So this is unfortunately false. It would probably be true without
  our additional function symbols, but we need them.}

\LC{But maybe this can be done with Logical Relations? I'll think
  about this\ldots}

\LC{No, I don't think so anymore.}

\CK{Well, let's say that this will be a great Future Work section.
  Thinking about it, we already have enough to merit publication
  of the initial ideas just by getting two versions of polymorphic
  map (with either
  $\mathtt{map} : \forall\alpha\beta [(\alpha \arrtype \beta) \arrtype
  (\mathtt{list} \alpha) \arrtype (\mathtt{list} \beta)]$ or
  $\mathtt{map} : \forall \varphi [
  \forall \alpha [\alpha \arrtype \varphi\alpha]
  \arrtype \mathtt{list} \arrtype \mathtt{list}]$) and part of urzy.
  Deepening the theory to get more examples -- whether in this way or
  through some other extension of the relation -- is probably even
  better to publish separately (for example in a journal paper where
  you have the space to put in the proofs).}

\CK{Note: I do suspect that this problem is important to solve
  eventually for more than just $\mathtt{let}$: from what I recall of
  the discussion regarding $\mathtt{fold}$, I have a feeling that
  interpreting $\mathtt{fold}$ would end up with similar problems.}

==================

\newpage

\[
\begin{array}{rcl}
\epsilon_\tau(\epsilon_\bot(s)) & \red & \epsilon_\tau(s) \\
@_{\sigma,\tau}(\epsilon_{\sigma \arrtype \tau}(s),t) & \red &
  \epsilon_\tau(s) \\
\mathtt{tapp}_{\varphi,\tau}(
  \epsilon_{\quant{\alpha}{\varphi\alpha}}(s)) & \red &
  \epsilon_{\varphi\tau}(s) \\
\pi^1_{\sigma,\tau}(\epsilon_{\mathtt{and}\,\sigma\,\tau}(s)) & \red &
  \epsilon_\sigma(s) \\
\pi^2_{\sigma,\tau}(\epsilon_{\mathtt{and}\,\sigma\,\tau}(s)) & \red &
  \epsilon_\tau(s) \\
\mathtt{case}_{\sigma,\tau,\rho}(\epsilon_{\mathtt{or}\,\sigma\,\tau}(
  u),\abs{x:\sigma}{s},\abs{y:\tau}{t}) & \red & \epsilon_\rho(u) \\
\mathtt{let}_{\varphi,\rho}(\epsilon_{\exists(\varphi)}(s),\tabs{\alpha}{\abs{x:\varphi\alpha}{t}}) & \red &
  \epsilon_\rho(s) \\
\end{array}
\]
\begin{itemize}
%\[
%\begin{array}{rcl}
\item $
\epsilon_\rho(\mathtt{case}_{\sigma,\tau,\bot}(u,\abs{x:\sigma}{s},\abs{y:\tau}{t}))
  %& \red &
  \red
  \mathtt{case}_{\sigma,\tau,\rho}(u,\abs{x:\sigma}{\epsilon_\rho(s)},
  \abs{y:\tau}{\epsilon_\rho(t)}) $%\\
\item $
@_{\rho,\pi}(\mathtt{case}_{\sigma,\tau,\rho \arrtype \pi}(u,
  \abs{x:\sigma}{s},\abs{y:\tau}{t}),v) %& \red &
  \red
  \mathtt{case}_{\sigma,\tau,\pi}(u,
  \abs{x:\sigma}{@_{\rho,\pi}(s,v)},\abs{y:\tau}{@_{\rho,\pi}(t,v)}) $%\\
\item $
\mathtt{tapp}_{\varphi,\pi}(\mathtt{case}_{\sigma,\tau,
  \quant{\alpha}{\varphi\alpha}}(u,\abs{x:\sigma}{s},\abs{y:\tau}{t})) %& \red &
  \red
  \mathtt{case}_{\sigma,\tau,\varphi\pi}(u,
  \abs{x:\sigma}{\mathtt{tapp}_{\varphi,\pi}(s)},\\
  \abs{y:\tau}{\mathtt{tapp}_{\varphi,\pi}(t)}) $%\\
\item $
\pi^1_{\rho,\pi}(\mathtt{case}_{\sigma,\tau,\mathtt{and}\,\rho\,\pi}(u,
\abs{x:\sigma}{s},\abs{y:\tau}{t})) %& \red &
  \red
  \mathtt{case}_{\sigma,\tau,\rho}(u,\abs{x:\sigma}{\pi^1_{\rho,\pi}(s)},
  \abs{y:\tau}{\pi^1_{\rho,\pi}(t)}) $%\\
\item $
\pi^2_{\rho,\pi}(\mathtt{case}_{\sigma,\tau,\mathtt{and}\,\rho,\pi}(u,
  \abs{x:\sigma}{s},\abs{y:\tau}{t})) %& \red &
  \red
  \mathtt{case}_{\sigma,\tau,\pi}(u,\abs{x:\sigma}{\pi^2_{\rho,\pi}(s)},
  \abs{y:\tau}{\pi^2_{\rho,\pi}(t)}) $%\\
\item $
\mathtt{case}_{\rho,\pi,\xi}(\mathtt{case}_{\sigma,\tau,\mathtt{or}\,
  \rho\,\pi}(u,\abs{x:\sigma}{s},\abs{y:\tau}{t}),\abs{z:\rho}{v},\abs{a:\pi}{w}) %& \red &
  \red\\
  \mathtt{case}_{\sigma,\tau,\xi}(u,
    \abs{x:\sigma}{\mathtt{case}_{\rho,\pi,\xi}(s,\abs{z:\rho}{v},\abs{a:\pi}{w})},
    \abs{y:\tau}{\mathtt{case}_{\rho,\pi,\xi}(t,\abs{z:\rho}{v},\abs{a:\pi}{w})}) $%\\
\item $
    \mathtt{let}_{\varphi,\rho}(
  \mathtt{case}_{\sigma,\tau,\exists\varphi}(
  u,\abs{x:\sigma}{s},\abs{y:\tau}{t}),v) %& \red &
  \red\\
  \mathtt{case}_{\sigma,\tau,\rho}(u,
  \abs{x:\sigma}{\mathtt{let}_{\varphi,\rho}(s,v)},
  \abs{y:\tau}{\mathtt{let}_{\varphi,\rho}(t,v)})
  $%\\
%\end{array}
%\]
\end{itemize}
\begin{itemize}
\item
  $\epsilon_\tau(\mathtt{let}_{\varphi,\bot}(s,\tabs{\alpha}{\abs{x:\varphi\alpha}{t}}))
  \red
  \mathtt{let}_{\varphi,\tau}(s,\tabs{\alpha}{\abs{x:\varphi\alpha}{\epsilon_\tau(t)}})$
\item $@_{\tau,\rho}(\mathtt{let}_{\varphi, \tau \arrtype
  \rho}(s,\tabs{\alpha}{\abs{x:\varphi\alpha}{t}}),u) \red
  \mathtt{let}_{\varphi,\rho}(s,\tabs{\alpha}{\abs{x:\varphi\alpha}{@_{\tau,\rho}(t,
      u)}})$
\item
  $\mathtt{tapp}_{\psi,\rho}(\mathtt{let}_{\varphi,\forall\beta[\psi\beta]}(s,\tabs{\alpha}{\abs{x:\varphi\alpha}{t}}))
  \red
  \mathtt{let}_{\varphi,\psi\rho}(s,\tabs{\alpha}{\abs{x:\varphi\alpha}{\mathtt{tapp}_{\psi,\rho}(t)}})$
\item
  $\pi^1_{\tau,\rho}(\mathtt{let}_{\varphi,
  \mathtt{and}\,\tau,\rho}(s,\tabs{\alpha}{\abs{x:\varphi\alpha}{t}}))
  \red
  \mathtt{let}_{\varphi,\tau}(s,\tabs{\alpha}{\abs{x:\varphi\alpha}{\pi^1_{\tau,
        \rho}(t)}})$
\item
  $\pi^2_{\tau,\rho}(\mathtt{let}_{\varphi,
  \mathtt{and}\,\tau\,\rho}(s,\tabs{\alpha}{\abs{x:\varphi\alpha}{t}}))
  \red
  \mathtt{let}_{\varphi,\rho}(s,\tabs{\alpha}{\abs{x:\varphi\alpha}{\pi^2_{\tau,\rho}(t)}})$
\item $\mathtt{case}_{\tau,\rho,\pi}(
  \mathtt{let}_{\varphi,\mathtt{or}\,\tau\,\rho}(s,\tabs{\alpha}{\abs{x:\varphi\alpha}{t}}),\abs{x:\tau}{u},\abs{y:\rho}{v})
  \red
  \mathtt{let}_{\varphi,\pi}(s,\tabs{\alpha}{\abs{x:\varphi\alpha}{\mathtt{case}_{\tau,\rho,\pi}(t,\abs{x:\tau}{u},\abs{y:\rho}{v})}})$
\item
  $\mathtt{let}_{\psi,\rho}(\mathtt{let}_{\varphi,\exists\psi}(s,\tabs{\alpha}{\abs{x:\varphi\alpha}{t}}),u)
  \red
  \mathtt{let}_{\varphi,\rho}(s,\tabs{\alpha}{\abs{x:\varphi\alpha}{\mathtt{let}_{\psi,\rho}(t,u)}})$
\end{itemize}

\end{document}
