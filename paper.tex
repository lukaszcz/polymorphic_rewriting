\documentclass[runningheads,a4paper]{llncs}
\pdfoutput=1

\bibliographystyle{plainurl}

\usepackage{amssymb}
\setcounter{tocdepth}{3}
\usepackage{enumerate}
\usepackage[colorlinks=true]{hyperref}
\usepackage{tikz}
\usepackage{xcolor,latexsym,amsmath,extarrows,alltt}
\usepackage{xspace}
\usepackage{booktabs}
\usepackage{mathtools}
\usepackage{enumitem}
\usepackage{stmaryrd}
\usepackage{microtype}
\usepackage{bussproofs}
\usepackage{multirow}
\usepackage{proof}

\newcommand{\Iterms}{\mathcal{I}}
\newcommand{\World}{\mathcal{W}}
\newcommand{\Rules}{\mathcal{R}}
\newcommand{\Typevars}{\mathcal{A}}
\newcommand{\Vars}{\mathcal{V}}
\newcommand{\ITypes}{\mathcal{Y}}
\newcommand{\Types}{\mathcal{T}}
\newcommand{\Terms}{\mathcal{T}\!\mathit{erms}}
\newcommand{\TypeConstructors}{\mathcal{C}}
\newcommand{\Typemap}{\mathcal{T\!M}}
\newcommand{\Termmap}{\mathcal{J}}

\newcommand{\quant}[2]{\forall #1[#2]}
\newcommand{\interpret}[1]{\llparenthesis #1 \rrparenthesis}
\newcommand{\arr}[1]{\to_{#1}}
\newcommand{\arrtype}{\Rightarrow}
\newcommand{\arreta}{\leadsto_\eta}
\newcommand{\arrbeta}{\leadsto_\beta}
\newcommand{\arretain}{\leadsto_\eta^{\mathtt{in}}}
\newcommand{\arrnormalise}{\leadsto}
\newcommand{\normstep}{\leadsto_\mu}
\newcommand{\abs}[2]{\lambda #1.#2}
\newcommand{\tabs}[2]{\Lambda #1.#2}
\newcommand{\abstraction}[2]{\backslash #1.#2}
\newcommand{\app}[2]{#1 \cdot #2}
\newcommand{\apps}[3]{#1 \cdot #2 \cdots #3}
\newcommand{\tapp}[2]{#1 * #2}
\newcommand{\pair}[2]{\langle #1,#2 \rangle}
\newcommand{\subst}[2]{#1:=#2}
\newcommand{\etalong}[1]{#1\uparrow^\eta}
\newcommand{\betanormal}[1]{#1\downarrow_\beta}
\newcommand{\almostetalong}[1]{\overline{#1}}

\newcommand{\FTV}{\mathit{FTV}}
\newcommand{\FV}{\mathit{FV}}

\newcommand{\nat}{\mathtt{nat}}
\newcommand{\proj}{\pi}
\newcommand{\flatten}{\mathtt{flatten}}
\newcommand{\lift}{\mathtt{lift}}
\newcommand{\con}{\mathtt{c}}

\newcommand{\ur}{\upharpoonright}
\newcommand{\da}{\downarrow}
\newcommand{\SN}{\mathrm{SN}}
\newcommand{\Cb}{\mathbb{C}}
\newcommand{\Nbb}{\mathbb{N}}
\newcommand{\val}[3]{\ensuremath{\llbracket#1\rrbracket_{#2}^{#3}}}
\newcommand{\proves}{\vdash}

\newcommand{\CK}[1]{\textcolor{blue}{#1}}

\begin{document}

\mainmatter

\title{TODO list
  \thanks{The authors are supported by lots of people.}}
\subtitle{What we need to do to get where we want to be}

\author{{\L}ukasz Czajka and Cynthia Kop}
\authorrunning{{\L}. Czajka and C. Kop}
\institute{
Department of Computer Science, University of Copenhagen (DIKU)
\\
Institute of Computer Science, Radboud University Nijmegen (RU)
\\
\email{lukaszcz@mimuw.edu.pl}
\quad\quad\quad
\email{C.Kop@cs.ru.nl}
}

\maketitle

\begin{abstract}
The introduction of this paper is a TODO list.
The remainder is meant for filling in the TODOs with what we already
have.
The hope is that the end result is something useful. :)
\end{abstract}

\section*{THE LIST}

\renewcommand{\theenumii}{\arabic{enumi}.\arabic{enumii}}

Here's what we need to do:
\begin{enumerate}
\item Define a world $\World$ and a well-founded ordering $\succ$ on
  $\World$:
  \begin{enumerate}
  \item Define a set of terms $\World$ typed under some variation of
    System F-$\omega$.
  \item Define relations $\succ$ and $\succeq$ on the elements of $\World$.
  \item Prove that $\succ$ is a well-founded ordering relation and that
    $\succeq$ is a compatible quasi-ordering.
  \end{enumerate}
\item Specify what systems we are interested in analysing, and prove
  standard results which will make their analysis doable.
  \begin{enumerate}
  \item Specify a form of system which includes all the systems of interest.
  \item Specify a default way of interpreting terms in these systems.
  \item Prove that in all such systems, using our way of interpreting
    terms: if $\interpret{\ell} \succ \interpret{r}$ (resp.\ $\interpret{
    \ell} \succeq \interpret{r}$) for a rule  $\ell \to r$, then
    $\interpret{s} \succ \interpret{t}$ whenever $s \arr{\Rules} t$ by
    this rule (resp.\ $\interpret{s} \succeq \interpret{t}$).
  \end{enumerate}
\item Obtain useful lemmas regarding these defaults.
  \begin{enumerate}
  \item $\interpret{s[x:=t]} = \interpret{s}[x:=\interpret{t}]$.
  \item $\interpret{s\sigma} = \interpret{s}\sigma$.
  \item \dots?
  \end{enumerate}
\item For some system of interest, prove its termination:
  \begin{enumerate}
  \item Present the system and give interpretations (following the
    default scheme) for all ways of constructing terms.
  \item Show that $\ell \succ r$ or $\ell \succeq r$ for all rules.
    Remove the rules which are oriented using $\succ$ and repeat,
    until all rules have been removed.
  \end{enumerate}
\end{enumerate}

\renewcommand{\theenumii}{\alph{enumii}}

We use \emph{rule removal}:

\begin{theorem}
Let $\Rules = \Rules_1 \cup \Rules_2$, and suppose that $\arr{\Rules_1}\:
\subseteq\:\succ$ and $\arr{\Rules_2}\:\subseteq\:\succeq$ for a
well-founded ordering $\succ$ and a compatible quasi-ordering $\succeq$.
Then $\arr{\Rules}$ is terminating if and only if $\arr{\Rules_2}$ is
(which is certainly the case if $\Rules_2 = \emptyset$).
\end{theorem}

\begin{proof}
By well-foundedness of $\succ$, every infinite decreasing $\arr{\Rules}$
sequence can only use finitely many steps using $\arr{\Rules_1}$.
\qed
\end{proof}

This gives rise to the following algorithm:
\begin{enumerate}
\item While $\Rules$ is non-empty:
  \begin{enumerate}
  \item Orient all rules in $\Rules$ using $\succeq$ or $\succ$; at least
    one of them must be oriented using $\succ$.
  \item Remove all rules ordered by $\succ$ from $\Rules$.
  \end{enumerate}
\end{enumerate}
If this algorithm succeeds, we have proven termination.

\section{Defining a world}

\subsection{Defining the set $\World$}

\subsubsection{Interpretation terms}
We define the set of types for interpretation terms.

\begin{definition}\label{def:itypes}
We assume given an infinite set $\Typevars$ of \emph{type variables}.
The set $\ITypes$ of \emph{interpretation types} is given by:
\begin{itemize}
\item $\alpha \in \ITypes$ for all $\alpha \in \Typevars$, and
  $\FTV(\alpha) = \{ \alpha \}$.
\item $\nat \in \ITypes$, and $\FTV(\nat) = \emptyset$.
\item $\sigma \arrtype \tau \in \ITypes$ if both $\sigma \in \ITypes$
  and $\tau \in \ITypes$, and $\FTV(\sigma \arrtype \tau) = \FTV(\sigma)
  \cup \FTV(\tau)$.
\item $\sigma \times \tau \in \ITypes$ if both $\sigma \in \ITypes$
  and $\tau \in \ITypes$, and $\FTV(\sigma \times \tau) = \FTV(\sigma)
  \cup \FTV(\tau)$.
\item $\quant{\alpha}{\sigma} \in \ITypes$ if $\alpha \in \Typevars$ and
  $\sigma \in \ITypes$, and $\FTV(\quant{\alpha}{\sigma}) =
  \FTV(\sigma) \setminus \{ \alpha \}$.
\end{itemize}
\end{definition}

\begin{definition}\label{def:typesubst}
A \emph{type substitution} is a partial function $[\alpha_1:=\sigma_1,
\dots,\alpha_n:=\sigma_n]$ mapping a finite set of type variables to
types.  We let $\tau[\alpha_1:=\sigma_1,\dots,\alpha_n:=\sigma_n]$
denote $\tau$ with all occurrences of some $\alpha_i$ replaced by the
corresponding $\sigma_i$.  We use alpha-conversion to guarantee that
substitution does not capture variables in any of the $\sigma_i$.
\end{definition}

The set $\Iterms$ of interpretation terms is now defined as follows.

\begin{definition}\label{def_typing}
We assume given an infinite set $\Vars$ of variables, and let $\Gamma$
refer to a mapping from a finite subset of $\Vars$ to the set of
interpretation types.  The set $\Iterms$ of interpretation terms consists
of all expressions $s$ such that $\Gamma \vdash s : \sigma$ can be
inferred for some interpretation type $\sigma$ and mapping $\Gamma$ by
the following clauses:
\begin{itemize}
\item $\Gamma \vdash n : \nat$ for every natural number $n$.
\item $\Gamma \vdash x : \sigma$ for every $(x : \sigma) \in \Gamma$.
\item $\Gamma \vdash \mathtt{f} : \sigma$ for all $(\mathtt{f} :
  \sigma)$ in the following set: $\{ \oplus_\sigma : \sigma \arrtype
  \sigma \arrtype \sigma,\ \otimes_\sigma : \sigma \arrtype \sigma \arrtype
  \sigma,\ \proj^1_{\sigma,\tau} : (\sigma \times \tau) \arrtype
  \sigma,\ \proj^2_{\sigma,\tau} : (\sigma \times \tau) \arrtype \tau,\ 
  \flatten_{\sigma} : \sigma \arrtype \nat,\ 
  \lift_{\sigma} : \nat \arrtype \sigma
  \mid \sigma \in \ITypes \}$.
\item $\Gamma \vdash \pair{s}{t} : \sigma \times \tau$ if $\Gamma \vdash
  s : \sigma$ and $\Gamma \vdash t : \tau$.
\item $\Gamma \vdash \abs{x:\sigma}{s} : \sigma \arrtype \tau$ if $x
  \in \Vars$ and $\Gamma \uplus \{ x : \sigma \} \vdash s : \tau$.
\item $\Gamma \vdash \tabs{\alpha}{s} : \quant{\alpha}{\sigma}$ if
  $\alpha \in \Typevars$ and $\Gamma \vdash s : \sigma$ and for all
  $(x : \tau) \in \Gamma$: $\alpha \notin \FTV(\tau)$
\item $\Gamma \vdash \app{s}{t} : \tau$ if $\Gamma \vdash s :
  \sigma \arrtype \tau$ and $\Gamma \vdash t : \sigma$
\item $\Gamma \vdash \tapp{s}{\tau} : \sigma[\subst{\alpha}{\tau}]$ if
  $\Gamma \vdash s : \quant{\alpha}{\sigma}$
\end{itemize}
We say that $s$ is \emph{closed} if $\emptyset \vdash s : \sigma$.
\end{definition}

Note that for a given $\Gamma$, if $s$ is typable under $\Gamma$, then
there is only one choice for the type (this is easily proved by
induction on the form of $s$). Thus, all closed terms have a unique
type.

\subsubsection{Normalising interpretation terms}
Interpretation term equality is considered modulo $\alpha$-conversion.
We will be particularly interested in terms in $\eta$-long form.

\begin{definition}
For a given variable environment $\Gamma$ and interpretation terms $s,
t$ which are well-typed under $\Gamma$, we let $\arreta$ be defined
inductively together with a helper relationship $\arretain$, as follows.
\begin{itemize}
\item $s \arreta \abs{x}{(\app{s}{x})}$ if $s : \sigma \arrtype \tau$
  and $s$ is not an abstraction $\abs{y}{s'}$
\item $s \arreta \tabs{\alpha}{(\tapp{s}{\alpha})}$ if $s : \quant{
  \alpha}{\tau}$ and $s$ is not a type abstraction $\tabs{\beta}{s'}$
\item $s \arreta t$ if $s \arretain t$
\item $\abs{x}{s} \arretain \abs{x}{t}$ if $s \arreta t$
\item $\tabs{\alpha}{s} \arretain \tabs{\alpha}{t}$ if $s \arreta t$
\item $\app{s}{u} \arretain \app{s}{v}$ if $u \arreta v$
\item $\app{s}{u} \arretain \app{t}{u}$ if $s \arretain t$
\item $\tapp{s}{\sigma} \arretain \app{t}{\sigma}$ if $s \arretain t$
\end{itemize}
A term is in \emph{$\beta$-normal form} if it cannot be reduced by
$\arrbeta$< and in \emph{$\eta$-long form} if it cannot be reduced by
$\arreta$.
\end{definition}

To define the world of \emph{final interpretation terms}, we will
normalise certain elements of $\Iterms$ using the relation
$\arrnormalise$, which contains both $\arreta$ and key normalisation
steps.

\begin{definition}
We define the relation $\normstep$ on interpretation terms as the
smallest relation for which the following properties are satisfied:
\begin{itemize}
\item if $s \normstep t$ then both $\abs{x}{s} \normstep \abs{x}{t}$ and
  $\tabs{\alpha}{s} \normstep \tabs{\alpha}{t}$
\item if $s' \normstep t'$ then both $\app{s'}{u} \normstep \app{t'}{u}$
  and $\app{u}{s'} \normstep \app{u}{t'}$ and $\tapp{s'}{\sigma} \normstep
  \tapp{t'}{\sigma}$
\item $\app{\app{\oplus_{\nat}}{n}}{m} \normstep (n+m)$ 
\item $\app{\app{\otimes_{\nat}}{n}}{m} \normstep (n * m)$ 
\item $\app{\app{\circ_{\sigma \arrtype \tau}}{(\abs{x:\sigma}{s})}}{
  (\abs{x:\sigma}{t})} \normstep \abs{x:\sigma}{\app{\app{\circ_\tau}{
  s}}{t}}$ for $\circ \in \{ \oplus, \otimes \}$
\item $\app{\app{\circ_{\quant{\alpha}{\sigma}}}{(\tabs{\alpha}{s})}}{
    (\tabs{\alpha}{t})} \normstep \tabs{\alpha}{\app{\app{\circ_\sigma}{s}}{t}}$
  for $\circ \in \{ \oplus, \otimes \}$
\item $\app{\proj^1_{\sigma,\tau}}{(s,t)} \normstep s$
\item $\app{\proj^2_{\sigma,\tau}}{(s,t)} \normstep t$
\item $\app{\flatten_\nat}{s} \normstep s$
\item $\app{\flatten_{\sigma \arrtype \tau}}{s} \normstep
  \app{s}{(\app{\lift_\sigma}{0})}$
\item $\app{\flatten_{\quant{\alpha}{\sigma}}}{s} \normstep
  \app{\flatten_{\sigma[\subst{\alpha}{\nat}]}}{(\tapp{s}{\nat})}$
\item $\app{\lift_\nat}{s} \normstep s$
\item $\app{\lift_{\sigma \arrtype \tau}}{s} \normstep
  \abs{x:\sigma}{\app{\lift_{\tau}}{x}}$
\item $\app{\lift_{\quant{\alpha}{\sigma}}}{s} \normstep
  \tabs{\alpha}{\app{\lift_{\sigma}}{s}}$
\item $\app{(\abs{x:\sigma}{s})}{t} \normstep s[\subst{x}{t}]$
\item $\tapp{(\tabs{\alpha}{s})}{\sigma} \normstep
  s[\subst{\alpha}{\sigma}]$.
\end{itemize}
We let $\arrnormalise$ be the union of $\arreta$ and $\normstep$.
We let $\arrbeta$ denote a reduction using the last two rules (which
may be applied anywhere in an interpretation term).

A \emph{final interpretation term} is a term $s \in \Iterms$ such that
(a) $\FV(s) = \FTV(s) = \emptyset$, and (b) $s$ is in normal form with
respect to $\arrnormalise$.  We let $\World$ be the set of all final
interpretation terms. By~$\World_\tau$ we denote the set of all final
interpretation terms of type~$\tau$.
\end{definition}

NOTE: In the remainder of this section, we shall often speak simply of
``terms'' when referring to interpretation terms.

\subsubsection{Key properties of $\arrnormalise$}

In the remainder of this section, we will often abuse notation to omit
$\cdot$ and $*$.  Thus, $s t$ can refer to both $\app{s}{t}$ and
$\tapp{s}{t}$.  Due to typing, this notation is not ambiguous.
We will also denote $\abstraction{a}{s}$ for either $\abs{a}{s}$ or
$\tabs{a}{s}$, depending on typing.  Thus, we have:

\begin{lemma}\label{lem_abusive_notation}
The following properties hold:
\begin{enumerate}
\item\label{lem_abusive_notation_shape}
  Every interpretation term has the form $s t_1 \dots t_n$ with
  $s$ a variable, function symbol or abstraction $\abstraction{a}{s'}$
  (for $n \geq 0$).
\item\label{lem_abusive_notation_eta}
  If $s t_1 \dots t_n \arreta t$, then one of the following holds:
  \begin{itemize}
  \item $t = s t_1 \dots t_i' \dots t_n$ with $t_i \arreta t_i'$
  \item $n = 0$ and $s = \abstraction{a}{s'}$, and $t = \abstraction{a
    }{t'}$ with $s' \arreta t'$
  \item $n > 0$ or $s$ is not an abstraction, and $t =
    \abstraction{a}{s t_1 \dots t_n a}$
  \end{itemize}
\end{enumerate}
\end{lemma}

\begin{proof}
(\ref{lem_abusive_notation_shape}) follows by induction on the size of
interpretation terms (and a simple case analysis).
(\ref{lem_abusive_notation_eta}) follows quickly by the definition of
$\arreta$ and induction on $n$, using only the first two cases for the
induction hypothesis with $\arretain$.
\qed
\end{proof}

An essential property for reasoning is that $\arrnormalise$ preserves
typing.

\begin{lemma}[Subject reduction]
  If $\Gamma \vdash t : \tau$ and $t \arrnormalise t'$ then
  $\Gamma \vdash t' : \tau$.
\end{lemma}

\begin{proof}
  TODO
\end{proof}

By~$\SN$ we denote the set of all interpretation terms which are
terminating under $\arrnormalise$. For $t \in \SN$ by~$\nu(t)$ we
denote the length of the longest reduction starting at~$t$.

The following lemma is obvious, but worth stating explicitly.

\begin{lemma}\label{lem_reduce_abs}
If $\abstraction{a}{s} \arrnormalise^* t$, then $t = \abstraction{a}{
t}$ and $s \arrnormalise^* t'$.
If $s \in \SN$ then both $\abs{x}{s}$ and $\tabs{\alpha}{s}$ are also
in $\SN$.
\end{lemma}

\begin{proof}
We observe that every reduct of $\abs{x}{s}$ has the form $\abs{x}{s'}$
with $s \arrnormalise s'$, and similar for $\tabs{\alpha}{s}$.
Thus, the first statement follows by induction on the length of the
reduction $\abstraction{a}{s} \arrnormalise^* t$, and the second by
induction on $s$ using $\arrnormalise$.
\qed
\end{proof}

We also quickly see that variables are terminating.

\begin{lemma}\label{lem_var_sn}
Let $x$ be a variable and $t_1,\dots,t_n$ be types or elements of $\SN$
(or a combination therefore) such that $s := x t_1 \ldots x_n$ is
well-typed under $\Gamma$.  Then $s \in \SN$.
\end{lemma}

\begin{proof}
By induction first on the type $\sigma$ of $x t_1 \ldots t_n$, second
on $(t_1,\dots,t_n)$ (ordered with the product extension of
$\arrnormalise$ for those which are terms; the types will not be
altered).  It suffices to prove that $t \in \SN$ for any $t$ such that
$s \arrnormalise t$.

Since all rule schemes of $\normstep$ have the form $u s_1 \ldots s_k$
with $u$ a function symbol or abstraction, $\normstep$ cannot be applied
at the root or head.  Thus, if $s \normstep t$ then $t$ has the form $x
t_1 \ldots t_i' \ldots t_n$ with $t_i \normstep t_n$, and we complete
with the second induction hypothesis.  We similarly complete if the
reduction uses $\arreta$ to reduce one of the $t_i$.

By Lemma~\ref{lem_reduce_abs}, the only remaining case is a root step by
$\arreta$, so $\Gamma \proves s : \sigma_1 \arrtype \sigma_2$ and
$t = \abstraction{a}{x t_1 \ldots t_n a}$.
If $a$ is a variable, then $\Gamma \cup \{a : \sigma_1\} \proves a :
\sigma_1$, which is a smaller type, so $a \in \SN$; since $\Gamma \cup
\{a : \sigma_1\} \proves x t_1 \ldots t_n a : \sigma_2$, which is a
smaller type, the first induction hypothesis states that this term is
in $\SN$ as well, and by Lemma~\ref{lem_reduce_abs} so is $t$.
If $a$ is a type, the reasoning is similar.
\end{proof}

We note that relatively little can be done with terms of variable type.

\begin{lemma}\label{lem_typevar_reduce}
Let $\Gamma \proves s : \alpha$ and suppose $s \arrnormalise t$.
Then $s \arrbeta t$.
\CK{Here, I'm actually already assuming that we are avoiding product
types, as otherwise this statement is not true.}
\end{lemma}

\begin{proof}
Evident by investigating the available rules.
\end{proof}

It will prove easy to separate $\beta$-reduction steps from the others.

\begin{lemma}\label{lem_beta_props}
Let $\arrbeta$ denote a reduction using $\normstep$ with one of the last
two rules (but anywhere in a term).  Then:
\begin{itemize}
\item $\arrbeta$ is both terminating and confluent, so we can uniquely
  define $\betanormal{s}$ for every term $s$;
\item if $s \arrnormalise t$ then $\betanormal{s} \arrnormalise^*
  \betanormal{t}$, and if the step $s \arrnormalise t$ is not an
  $\arrbeta$ step, then even $\betanormal{s} \arrnormalise^+
  \betanormal{t}$;
\item therefore, $s \in \SN$ if $\betanormal{s} \in \SN$.
\end{itemize}
\end{lemma}

\begin{proof}
TODO

\CK{Note: I really don't like doing this.  I think it should be possible
to prove termination of $\arrbeta$ alongside the other rules.  However,
in the presence of $\eta$-expansion, having these results makes it a lot
easier to derive the necessary lemmas, so I'm putting the result here
to make sure that what I write up is actually true.  We can think about
maybe ditching this lemma later (or keeping it if you think it's fine).}

\CK{Whenever this lemma is used, I will note it using blue text.}
\end{proof}

\subsubsection{Computability}
In the rest of this section we adapt the Tait-Girard computability
method to prove termination of~$\arrnormalise$. The proof is an
adaptation of chapters~6 and~14 from the book ``Proofs and Types'' by
Girard, and chapters~10 and~11 from the book ``Lectures on the
Curry-Howard Isomorphism'' by Sorensen and Urzyczyn.

NOTE: For now the proof does not take product types into account. I'm
not sure if explicit products are necessary in the definition, because
in contrast to the simply-typed lambda-calculus they may be encoded in
the polymorphic lambda-calculus.

NOTE: Currently, $\flatten$ and $\lift$ are not accounted for either,
but adding them should be similar to~$\oplus$ and~$\otimes$.

\begin{definition}\label{def_candidate}
  A term~$t$ is \emph{neutral} if there does not exists a sequence of
  terms or types~$u_1,\ldots,u_n$ with $n \ge 1$ such that $t u_1 \ldots
  u_n$ is a redex by $\normstep$ (so the one-step relation not including
  $\eta$-expansion).

  A set~$X$ of interpretation terms of type~$\tau$ in context~$\Gamma$
  is a \emph{candidate of type~$\tau$} when:
  \begin{enumerate}
  \item $X \subseteq \SN$;
  \item if $t \in X$ and $t \arrnormalise t'$ then $t' \in X$;
  \item if $t$ is neutral and for every~$t'$ with $t \normstep \cup
    \arretain t'$ we have $t' \in X$, then $t \in X$;
  \item if $t_1,t_2 \in X$ then $\circ_\tau t_1 t_2 \in X$ for $\circ
    \in \{\oplus,\otimes\}$.
  \end{enumerate}
  Note that the third item above implies:
  \begin{itemize}
  \item if $t$ is neutral and in normal form then $t \in X$;
  \item $X$ contains all variables of type $\tau$.
  \end{itemize}
  The set of all candidates of type~$\tau$ in context~$\Gamma$ is
  denoted by~$\Cb_\tau^\Gamma$.
\end{definition}

\begin{definition}\label{def_reducibility_valuation}
  Let $\omega$ be a mapping from type variables to types. A
  \emph{$\Gamma,\omega$-valuation} is a mapping~$\xi$ from type
  variables to candidates such that $\xi(\alpha)$ is a candidate of
  type~$\omega(\alpha)$ (in context~$\Gamma$).

  For each type~$\sigma$, context~$\Gamma$, mapping~$\omega$
  and each $\Gamma,\omega$-valuation~$\xi$, the set $\val{\sigma}{\omega,\xi}{\Gamma}$ is
  defined by induction on~$\sigma$:
  \begin{itemize}
  \item $\val{\alpha}{\omega,\xi}{\Gamma} = \xi(\alpha)$ for a type
    variable~$\alpha$,
  \item $\val{\nat}{\omega,\xi}{\Gamma}$ is the set of all
    terms~$t \in \SN$ such that $\Gamma \proves t : \nat$,
  \item $\val{\sigma \to \tau}{\omega,\xi}{\Gamma}$ is the set of all
    terms~$t$ such that $\Gamma \proves t : \omega(\sigma \to \tau)$,
    and for every~$s \in \val{\sigma}{\omega,\xi}{\Gamma}$ we have
    $\app{t}{s} \in \val{\tau}{\omega,\xi}{\Gamma}$,
  \item $\val{\forall\alpha[\sigma]}{\omega,\xi}{\Gamma}$ is the set
    of all terms~$t$ such that
    $\Gamma \proves t : \omega(\forall\alpha[\sigma])$ and for every
    type~$\tau$ and every $X \in \Cb_\tau^\Gamma$ we have
    $\tapp{t}{\tau} \in \val{\sigma}{\omega[\subst{\alpha}{\tau}],
    \xi[\subst{\alpha}{X}]}{\Gamma}$.
  \end{itemize}
\end{definition}

\begin{lemma}\label{lem_val_typable}
  If $t \in \val{\sigma}{\omega,\xi}{\Gamma}$ then
  $\Gamma \proves t : \omega(\sigma)$.
\end{lemma}

\begin{proof}
  Follows from definitions.
\end{proof}

\begin{lemma}\label{lem_abstraction_computability}
Suppose $\val{\sigma}{\omega,\xi}{\Gamma}$ and $\val{\tau}{\omega,\xi}{
\Gamma}$ are candidates.
Then $\abs{x}{s} \in \val{\sigma \to \tau}{\omega,\xi}{\Gamma}$ if and
only if $s[x:=t] \in \val{\tau}{\omega,\xi}{\Gamma}$ for all $t \in
\val{\sigma}{\omega,\xi}{\Gamma}$.
\end{lemma}

=================

\begin{proof}
First suppose $\abs{x}{s} \in \val{\sigma \to \tau}{\omega,\xi}{\Gamma}$,
so for all $t \in \val{\sigma}{\omega,\xi}{\Gamma}$ we have
$(\abs{x}{s})t \in \val{\tau}{\omega,\xi}{\Gamma}$.  As
$\val{\tau}{\omega,\xi}{\Gamma}$ and $(\abs{x}{s})t \arrnormalise s[x:=
t]$ we have $s[x:=t] \in \val{\tau}{\omega,\xi}{\Gamma}$ as well.

Now suppose $s[x:=t] \in \val{\tau}{\omega,\xi}{\Gamma}$ for all $t \in
\val{\sigma}{\omega,\xi}{\Gamma}$.  Let $t \in \val{\sigma}{\omega,\xi}{
\Gamma}$.  Then:
\begin{itemize}
\item $t \in \SN$ because $\val{\sigma}{\omega,\xi}{\Gamma}$ is a
  candidate
\item $s = s \in \SN$ because every infinite reduction in $s$ induces
  an infinite reduction in $s[x:=t]$ -- TODO
\item if $s \arrnormalise^* s'$ and $t \arrnormalise^* t'$ then
  $s[x:=t] \arrnormalise^* s'[x:=t'] \in \val{\tau}{\omega,\xi}{\Gamma}$
  because:
  \begin{itemize}
  \item $t' \in \val{\sigma}{\omega,\xi}{\Gamma}$ because
    $\val{\sigma}{\omega,\xi}{\Gamma}$ is a candidate and therefore
    closed under reduction
  \item $s[x:=t'] \in \val{\tau}{\omega,\xi}{\Gamma}$ by assumption
  \item $s'[x:=t'] \in \val{\tau}{\omega,\xi}{\Gamma}$ because TODO
  \end{itemize}
\end{itemize}

PROBLEM: this hinges on the argument that if $s[x:=t]$ is computable
then so is $s'[x:=t]$ if $s \arrnormalise s$.  This is not obvious in
the presence of $\eta$-expansion because it is possible that, for
instance, $s = x$, $s' = \abs{y}{\app{x}{y}}$ and $t = \abs{z}{t'}$,
in which case we do not have $s[x:=t] \arrnormalise s'[x:=t]$.  I do
believe that the lemma holds, however\dots\ but am not sure what the
best way to prove it is. (It would almost certainly work if we proved
termination of $\beta$ steps separately and used induction on
$\beta$-normalised terms, but this seems like a step that could be
avoided.)  It is also very possible that we don't need this in this
form; for example, we could define $\arrnormalise$ to allow steps with
$\arreta$ only on terms in $\normstep$-normal form.
\end{proof}







\begin{lemma}\label{lem_left_monotonicity}
If $s \normstep t$ or $s \arretain t$, then $s u \arrnormalise t u$ for
any $u$ of matching type.
\end{lemma}

\begin{proof}
If $s \normstep t$ then this follows by monotonicity of $\normstep$.
If $s \arretain t$, then this follows because $s u \arretain t u$ if
$s \arretain t$.
\end{proof}

\begin{lemma}\label{lem_preserve_circ}
If $s = \circ_\tau s_1 \ldots s_n$ and $s \arrnormalise^* \circ_\tau
t_1 \ldots t_n$, then each $s_i \arrnormalise^* t_i$.
\end{lemma}

\begin{proof}
We say that a term $s$ is $\tau$-headed if (a) $s = \circ_\tau$, (b)
$s = s_1 s_2$ and $s_1$ is $\tau$-headed, or (c) $s = \abs{x}{s'}$ and
$s'$ is $\tau$-headed.  A quick case analysis on $\arreta$ and the
available rules shows that if $s$ is $\tau$-headed and $s \arrnormalise
t$, then one of the following holds:
\begin{itemize}
\item the reduction uses $\arreta$ or is not at the head, and $t$ is
  also $\tau$-headed;
\item the reduction uses a rule of $\normstep$ at the head, and $t$ is
  a natural number or $\sigma$-headed with $\sigma$ a strict subtype of
  $\tau$.
\end{itemize}

Now let $s = \circ_\tau s_1 \ldots s_n \arrnormalise^* \circ_\tau
t_1 \ldots t_n =: t$.  Since both $s$ and $t$ are $\tau$-headed, the
observation above gives us that this reduction cannot use any $\normstep$
steps at the head.  It also cannot use $\arreta$ at the head, because
this would result in an abstraction, which $t$ is not.  Thus, all
reduction steps must take place in some $s_i$.
\end{proof}

\begin{lemma}\label{lem:top_reduction}
If $s \arrnormalise^* t$ and $t \arreta u$ by a reduction at the top,
then there exists $s'$ such that $s \arreta s'$ at the top, and $s'
\arrnormalise^* u$.
If $s \arrnormalise^* t$ and $t \normstep u$ by a reduction at the head,
and $s \normstep s'$ by a head-reduction with the same rule, then
$s' \arrnormalise^* u$.

(Here, rules for $\circ_\sigma$ and $\circ_\tau$ are considered different
if $\sigma \neq \tau$.)
\end{lemma}

\begin{proof}
For the first statement, observe that $u = \abstraction{a}{t a}$.
Since $\arreta$ can be applied, $t$ is not an abstraction, and therefore
neither is $s$.  Let $s' := \abstraction{a}{s a}$.  Then clearly $s
\arreta s'$ at the top, and since the reduction $s \arrnormalise^* t$
does not use any $\arreta$-steps at the top (since $t$ is not an
abstraction), Lemma~\ref{lem_left_monotonicity} provides $s a
\arrnormalise^* t a$.

For the second statement, consider the rules that might be applied.
If $t = \circ n m$ for $n,m \in \mathbb{N}$ and the same rule can be
applied on $s$, then $s = t$ and there is nothing to prove.
If $t = \circ (\abstraction{a}{t_1}) (\abstraction{a}{t_2}) t_3 \ldots
t_n$ and $u = (\abstraction{a}{\circ t_1 t_2}) t_3 \ldots t_n$, then
because the same rule is already applicable on $s$ and $s$ has the
same type, we can write $s = \circ (\abstraction{a}{s_1})
(\abstraction{a}{s_2}) s_3 \ldots s_n$; by
Lemma~\ref{lem_preserve_circ} each $s_i \arrnormalise^* t_i$.  But then
$s \arrnormalise (\abstraction{a}{\circ s_1 s_2}) s_3 \ldots s_n$
indeed reduces to $u$.
\end{proof}

\begin{lemma}\label{lem_substitute_sn}
Let $\gamma$ be a substitution. If $s\gamma \in \SN$, then $s \in \SN$.
\end{lemma}

\begin{proof}
By induction on $s\gamma$, oriented with the union of $\arrnormalise$
and the subterm relation.

If $s$ is a natural number or function symbol, then $s = s\gamma \in
\SN$.

If $s$ is a variable, then $s \in \SN$ by Lemma~\ref{lem_var_sn}.

If $s = \abstraction{a}{s'}$, then by Lemma~\ref{lem_reduce_abs}, $s
\in \SN$ if $s'$ is; this follows by the induction hypothesis because
(using $\alpha$-conversion if necessary) $s\gamma = \abstraction{a}{
s'\gamma}$.

If $s = t s_1 \ldots s_n$ with $n > 0$ and $t$ not an application,
then note that by the induction hypothesis we can safely assume that
both $t$ and all $s_i$ are in $\SN$.  For $s$ to not be in $\SN$,
eventually a reduction at the head or top must be taken.  There are
three possibilities:
\begin{itemize}
\item The first step at the head is $\eta$-expansion:
  $s \arrnormalise^* t' s_1' \ldots s_n' \arreta \abstraction{a}{t'
  s_1' \ldots s_n' a} =: u \arrnormalise \dots$.
  By Lemma~\ref{lem:top_reduction},also $s \arreta \abstraction{a}{
  t s_1 \ldots s_n a} =: s' \arrnormalise^* u \arrnormalise^* \dots$.
  Since $n > 0$, $s\gamma$ is not an abstraction, so also
  $s\gamma \arreta \abstraction{a}{(t\gamma) (s_1\gamma) (s_n\gamma) a}
  = s'\gamma$.  By the induction hypothesis, $s'$ must be in $\SN$;
  contradiction.
\item The first step at the head is $\beta$-reduction:
\item ================
\end{itemize}
\end{proof}

\begin{lemma}\label{lem_nat_reducible}
  $\val{\nat}{\omega,\xi}{\Gamma} \in \Cb_{\nat}^\Gamma$.
\end{lemma}

\begin{proof}
  We check the conditions in Definition~\ref{def_candidate}.
  \begin{enumerate}
  \item $\val{\nat}{\omega,\xi}{\Gamma} \subseteq \SN$ follows
    directly from Definition~\ref{def_reducibility_valuation}.
  \item Let $t \in \val{\nat}{\omega,\xi}{\Gamma}$ and
    $t \leadsto t'$. Then $\Gamma \proves t : \nat$ and $t \in
    \SN$. Hence $t' \in \SN$, and $\Gamma \proves t' : \nat$ by the
    subject reduction lemma. Thus
    $t' \in \val{\nat}{\omega,\xi}{\Gamma}$.
  \item Let $t$ be neutral and $\Gamma \proves t : \nat$. Assume that
    for all~$t'$ with $t \leadsto t'$ we have
    $t' \in \val{\nat}{\omega,\xi}{\Gamma}$, so in particular
    $t' \in \SN$. But then $t \in \SN$. Hence
    $t \in \val{\nat}{\omega,\xi}{\Gamma}$.
  \item Let $t_1,t_2 \in \SN$ be such that
    $\Gamma \proves t_i : \nat$. Obviously,
    $\Gamma \proves \circ_\nat t_1 t_2 : \nat$. Also
    $\circ_\nat t_1 t_2 \in \SN$ follows from definitions:
    if $\circ_\nat t_1 t_2 \arrnormalise^* t$ then either $t \in \Nbb$
    (so $t$ is a normal form), or $t = \circ_\nat t_1' t_2'$ with
    $t_1 \arrnormalise^* t_1'$ or $t_2 \arrnormalise t_2'$. So
    $\circ_\nat t_1 t_2 \in \val{\nat}{\omega,\xi}{\Gamma}$.
  \end{enumerate}
\end{proof}


\begin{lemma}\label{lem_val_computable}
  $\val{\sigma}{\omega,\xi}{\Gamma} \in \Cb_{\omega(\sigma)}^\Gamma$.
\end{lemma}

\begin{proof}
  Induction on~$\sigma$. First, if $\sigma = \alpha$ for a type
  variable~$\alpha$ then
  $\val{\sigma}{\omega,\xi}{\Gamma} = \xi(\alpha) \in
  \Cb_{\omega(\sigma)}^\Gamma$ by definition. If $\sigma = \nat$ then
  $\val{\nat}{\omega,\xi}{\Gamma} \in \Cb_{\nat}^\Gamma$ by
  Lemma~\ref{lem_nat_reducible}.

  Assume $\sigma = \tau_1 \to \tau_2$. We check the conditions in
  Definition~\ref{def_candidate}.
  \begin{enumerate}
  \item Let $t \in \val{\tau_1\to\tau_2}{\omega,\xi}{\Gamma}$ and
    assume there is an infinite reduction
    $t \leadsto t_1 \leadsto t_2 \leadsto t_3 \leadsto \ldots$. By the
    inductive hypothesis $\val{\tau_1}{\omega,\xi}{\Gamma}$ and
    $\val{\tau_2}{\omega,\xi}{\Gamma}$ are candidates. So
    $x \in \val{\tau_1}{\omega,\xi}{\Gamma}$ because it is neutral and
    normal. Then $t x \in \val{\tau_2}{\omega,\xi}{\Gamma}$. Thus
    $t x$~is strongly normalising. But
    $t x \leadsto t_1 x \leadsto t_2 x \leadsto t_3 x \leadsto
    \ldots$. Contradiction.

    TODO -- same problem
  \item Let $t \in \val{\tau_1\to\tau_2}{\omega,\xi}{\Gamma}$ and
    $t \leadsto t'$. Let $u \in
    \val{\tau_1}{\omega,\xi}{\Gamma}$. Then
    $t u \in \val{\tau_2}{\omega,\xi}{\Gamma}$. By the inductive
    hypothesis $\val{\tau_2}{\omega,\xi}{\Gamma}$ is a candidate, so
    $t' u \in \val{\tau_2}{\omega,\xi}{\Gamma}$. Also note that
    $\Gamma \proves t' : \omega(\tau_1 \to \tau_2)$ by the subject
    reduction lemma. Hence
    $t' \in \val{\tau_1\to\tau_2}{\omega,\xi}{\Gamma}$.
  \item Let $t$ be neutral and
    $\Gamma \proves t : \omega(\tau_1 \to \tau_2)$ and assume for
    every~$t'$ with $t \leadsto t'$ we have
    $t' \in \val{\tau_1\to\tau_2}{\omega,\xi}{\Gamma}$. Let
    $u \in \val{\tau_1}{\omega,\xi}{\Gamma}$. By the inductive
    hypothesis $\val{\tau_1}{\omega,\xi}{\Gamma}$ is a candidate, so
    $u \in \SN$. By induction on~$\nu(u)$ we show that
    $t u \in \val{\tau_2}{\omega,\xi}{\Gamma}$. Assume
    $t u \leadsto t''$. We show
    $t'' \in \val{\tau_2}{\omega,\xi}{\Gamma}$. Because~$t$ is
    neutral, $t u$ cannot be a redex. So there are two cases.
    \begin{itemize}
    \item $t'' = t u'$ with $u \leadsto u'$. Then
      $t u' \in \val{\tau_2}{\omega,\xi}{\Gamma}$ by the inductive
      hypothesis for~$u$.
    \item $t'' = t' u$ with $t \leadsto t'$. Then
      $t' \in \val{\tau_1\to\tau_2}{\omega,\xi}{\Gamma}$, so
      $t' u \in \val{\tau_2}{\omega,\xi}{\Gamma}$.
    \end{itemize}
    We have thus shown that if $t u \leadsto t''$ then
    $t'' \in \val{\tau_2}{\omega,\xi}{\Gamma}$. By the (main)
    inductive hypothesis $\val{\tau_2}{\omega,\xi}{\Gamma}$ is a
    candidate, and $t u$ is neutral, so also
    $t u \in \val{\tau_2}{\omega,\xi}{\Gamma}$. Since
    $u \in \val{\tau_1}{\omega,\xi}{\Gamma}$ was arbitrary, we have
    shown $t \in \val{\tau_1\to\tau_2}{\omega,\xi}{\Gamma}$.
  \item Assume $t_1,t_2 \in \val{\tau_1\to\tau_2}{\omega,\xi}{\Gamma}$.
    We have already shown that this implies $t_1,t_2 \in \SN$.
    Since $\circ_{\omega(\tau_1\to\tau_2)} t_1 t_2$ is neutral, it is
    in $\val{\tau_1\to\tau_2}{\omega,\xi}{\Gamma}$ if all its reducts
    are, which we prove by induction on $t_1,t_2$.  For any reduct of
    the form $\circ_{\omega(\tau_1\to\tau_2)} t_1' t_2$ or
    $\circ_{\omega(\tau_1\to\tau_2)} t_1 t_2'$ we complete by the
    inductive hypothesis.  The only alternative is when $t_1 =
    \abs{x}{t_1'},\ t_2 = \abs{x}{t_2'}$ and
    $\circ_{\omega(\tau_1\to\tau_2)} t_1 t_2 \arrnormalise
    \abs{x}{\circ_{\omega(\tau_2)} t_1' t_2'} =: s$,
    By Lemma~\ref{lem_abstraction_computability} that is the case if
    $(\circ_{\omega(\tau_2)} t_1' t_2')[x:=t] \in
    \val{\tau_2}{\omega,\xi}{\Gamma}$ for all $t \in \val{\tau_1}{
    \omega,\xi}{\Gamma}$.
    However, since $t_1 = \abs{x}{t_1'}$ and $t_2 = \abs{x}{t_2'}$ are
    in $\val{\tau_1\to\tau_2}{\omega,\xi}{\Gamma}$, the same lemma
    provides that $t_1'[x:=t]$ and $t_2'[x:=t]$ are in
    $\val{\tau_2}{\omega,\xi}{\Gamma}$; as this set is a candidate by
    the inductive hypothesis, we indeed obtain $(\circ_{\omega(\tau_2)}
    t_1' t_2')[x:=t] \in \val{\tau_2}{\omega,\xi}{\Gamma}$.
  \end{enumerate}

    ===================

  Assume $\sigma = \forall\alpha[\tau]$. We check the conditions in
  Definition~\ref{def_candidate}.
  \begin{enumerate}
  \item Let $t \in \val{\forall\alpha[\tau]}{\omega,\xi}{\Gamma}$ and
    assume there is an infinite reduction
    $t \leadsto t_1 \leadsto t_2 \leadsto t_3 \leadsto
    \ldots$. Let~$\tau'$ be an arbitrary type and let
    $S \in \Cb_{\tau'}^\Gamma$ (e.g.~take~$S$ to be the set of
    terminating terms of type~$\tau'$ in context~$\Gamma$). Then
    $t \tau' \in
    \val{\tau}{\omega[\subst{\alpha}{\tau'}],\xi[\subst{\alpha}{S}]}{\Gamma}$. By
    the inductive hypothesis
    $\val{\tau}{\omega[\subst{\alpha}{\tau'}],\xi[\subst{\alpha}{S}]}{\Gamma}$
    is a candidate, so $t \tau' \in \SN$. But
    $t \tau' \leadsto t_1 \tau' \leadsto t_2 \tau' \leadsto t_3 \tau'
    \leadsto \ldots$. Contradiction.
  \item Let $t \in \val{\forall\alpha[\tau]}{\omega,\xi}{\Gamma}$ and
    $t \leadsto t'$. By the subject reduction lemma
    $\Gamma \proves t' : \omega(\forall\alpha[\tau])$. Let~$\tau'$ be
    a type and~$X \in \Cb_{\tau'}^\Gamma$. Then
    $t \tau' \in
    \val{\tau}{\omega[\subst{\alpha}{\tau'}],\xi[\subst{\alpha}{X}]}{\Gamma}$. By
    the inductive hypothesis
    $\val{\tau}{\omega[\subst{\alpha}{\tau'}],\xi[\subst{\alpha}{X}]}{\Gamma}$
    is a candidate, so
    $t' \tau' \in
    \val{\tau}{\omega[\subst{\alpha}{\tau'}],\xi[\subst{\alpha}{X}]}{\Gamma}$. Therefore
    $t' \in \val{\forall\alpha[\tau]}{\omega,\xi}{\Gamma}$.
  \item Let $t$ be neutral and
    $\Gamma \proves t : \omega(\forall\alpha[\tau])$ and assume for
    every~$t'$ with $t \leadsto t'$ we have
    $t' \in
    \val{\forall\alpha[\tau]}{\omega,\xi}{\Gamma}$. Let~$\tau'$ be a
    type and~$X \in \Cb_{\tau'}^\Gamma$. Assume
    $t \tau' \leadsto t''$. Then $t'' = t' \tau'$ with
    $t \leadsto t'$, because~$t$ is neutral. Hence
    $t \tau' \leadsto t' \tau' \in
    \val{\tau}{\omega[\subst{\alpha}{\tau'}],\xi[\subst{\alpha}{X}]}{\Gamma}$. By
    the inductive
    hypothesis~$\val{\tau}{\omega[\subst{\alpha}{\tau'}],\xi[\subst{\alpha}{X}]}{\Gamma}$
    is a candidate, and also $t \tau'$ is neutral, so
    $t \tau' \in
    \val{\tau}{\omega[\subst{\alpha}{\tau'}],\xi[\subst{\alpha}{X}]}{\Gamma}$. This
    implies that
    $t \in \val{\forall\alpha[\tau]}{\omega,\xi}{\Gamma}$.
  \item Assume
    $t_1,t_2 \in \val{\forall\alpha[\tau]}{\omega,\xi}{\Gamma}$. We
    have already shown that this implies $t_1,t_2 \in \SN$. Hence also
    $\circ_{\omega(\forall\alpha[\tau])} t_1 t_2 \in \SN$ by
    Lemma~\ref{lem_circ_sn}. We show
    $\circ_{\omega(\forall\alpha[\tau])} t_1 t_2 \in
    \val{\forall\alpha[\tau]}{\omega,\xi}{\Gamma}$ by induction
    on~$\nu(\circ_{\omega(\forall\alpha[\tau])} t_1 t_2)$. We have
    already proven that, because
    $\circ_{\omega(\forall\alpha[\tau])} t_1 t_2$ is neutral, it
    suffices to show that if
    $\circ_{\omega(\forall\alpha[\tau])} t_1 t_2 \leadsto t$ then
    $t \in \val{\forall\alpha[\tau]}{\omega,\xi}{\Gamma}$. If
    $t = \circ_{\omega(\forall\alpha[\tau])} t_1' t_2$ or
    $t = \circ_{\omega(\forall\alpha[\tau])} t_1 t_2'$ with
    $t_i \leadsto t_i'$ then this follows from the inductive
    hypothesis. So assume $t_i = \Lambda\alpha . t_i'$ and
    $t = \Lambda \alpha . \circ_{\tau} t_1' t_2'$. Note that
    $t \in \SN$. Let $\tau'$ be a type and $X \in
    \Cb_{\tau'}^\Gamma$. By nested induction on~$\nu(t)$ we show that
    if $t \alpha \leadsto w$ then
    $w \in
    \val{\tau}{\omega[\subst{\alpha}{\tau'}],\xi[\subst{\alpha}{X}]}{\Gamma}$. This
    suffices, because~$t \alpha$ is neutral. The only case which
    doesn't follow directly from the inductive hypothesis is when
    $w = \circ_{\omega(\tau)} t_1' t_2'$. Because
    $\Lambda \alpha . t_i' \in
    \val{\forall\alpha[\tau]}{\omega,\xi}{\Gamma}$, we have
    $(\Lambda \alpha . t_i') \alpha \in
    \val{\tau}{\omega[\subst{\alpha}{\tau'}],\xi[\subst{\alpha}{X}]}{\Gamma}$. Hence,
    $t_i' \in
    \val{\tau}{\omega[\subst{\alpha}{\tau'}],\xi[\subst{\alpha}{X}]}{\Gamma}$
    because~$\val{\tau}{\omega[\subst{\alpha}{\tau'}],\xi[\subst{\alpha}{X}]}{\Gamma}$
    is a candidate by the inductive hypothesis. Thus also
    $w = \circ_{\omega(\tau)} t_1' t_2' \in
    \val{\tau}{\omega[\subst{\alpha}{\tau'}],\xi[\subst{\alpha}{X}]}{\Gamma}$.
  \end{enumerate}
\end{proof}

\begin{lemma}\label{lem_val_subst}
  $\val{\sigma[\subst{\alpha}{\tau}]}{\omega,\xi}{\Gamma} =
  \val{\sigma}{\omega[\subst{\alpha}{\tau}],\xi[\subst{\alpha}{\val{\tau}{\omega,\xi}{\Gamma}}]}{\Gamma}$.
\end{lemma}

\begin{proof}
  TODO
\end{proof}

\begin{lemma}
  $\circ_{\omega(\sigma)} \in \val{\sigma \to \sigma \to
    \sigma}{\omega,\xi}{\Gamma}$ for
  $\circ \in \{ \oplus, \otimes \}$.
\end{lemma}

\begin{proof}
  Follows from Definition~\ref{def_typing} and
  Lemma~\ref{lem_val_computable}.
\end{proof}

\begin{lemma}
  $\flatten_{\omega(\sigma)} \in
  \val{\sigma\to\nat}{\omega,\xi}{\Gamma}$.
\end{lemma}

\begin{proof}
  TODO
\end{proof}

\begin{lemma}
  $\lift_{\omega(\sigma)} \in
  \val{\nat\to\sigma}{\omega,\xi}{\Gamma}$.
\end{lemma}

\begin{proof}
  TODO
\end{proof}

\begin{lemma}
  If for all $u \in \val{\tau_1}{\omega,\xi}{\Gamma}$ we have
  $t[\subst{x}{u}] \in \val{\tau_2}{\omega,\xi}{\Gamma}$, then
  $\lambda x : \omega(\tau_1) . t \in
  \val{\tau_1\to\tau_2}{\omega,\xi}{\Gamma}$.
\end{lemma}

\begin{proof}
  By Lemma~\ref{lem_val_computable} the
  sets~$\val{\tau_i}{\omega,\xi}{\Gamma}$ are candidates, so
  $\val{\tau_i}{\omega,\xi}{\Gamma} \subseteq \SN$. Let
  $u \in \val{\tau_1}{\omega,\xi}{\Gamma}$. We show
  $(\lambda x : \omega(\tau_1) . t) u \in
  \val{\tau_2}{\omega,\xi}{\Gamma}$ by induction on $\nu(t) +
  \nu(u)$. Suppose $(\lambda x : \omega(\tau_1) . t) u \leadsto
  w$. There are three cases.
  \begin{itemize}
  \item $w = t[\subst{x}{u}]$. Then
    $w \in \val{\tau_2}{\omega,\xi}{\Gamma}$ by assumption.
  \item $w = (\lambda x : \omega(\tau_1) . t') u$ with
    $t \leadsto t'$. Because $\val{\tau_2}{\omega,\xi}{\Gamma}$ is a
    candidate, still
    $t'[\subst{x}{u}] \in \val{\tau_2}{\omega,\xi}{\Gamma}$. Also
    $\nu(t') < \nu(t)$, so $w \in \val{\tau_2}{\omega,\xi}{\Gamma}$
    follows from the inductive hypothesis.
  \item $w = (\lambda x : \omega(\tau_1) . t) u'$ with
    $u \leadsto u'$. Because $\val{\tau_i}{\omega,\xi}{\Gamma}$ are
    candidates, still $u' \in \val{\tau_1}{\omega,\xi}{\Gamma}$ and
    $t[\subst{x}{u'}] \in \val{\tau_2}{\omega,\xi}{\Gamma}$. Also
    $\nu(u') < \nu(u)$, so $w \in \val{\tau_2}{\omega,\xi}{\Gamma}$
    follows from the inductive hypothesis.
  \end{itemize}
  Because $(\lambda x : \omega(\tau_1) . t) u$ is neutral and
  $\val{\tau_2}{\omega,\xi}{\Gamma}$ is a candidate, this shows
  $(\lambda x : \omega(\tau_1) . t) u \in
  \val{\tau_2}{\omega,\xi}{\Gamma}$.
\end{proof}

\begin{lemma}
  If for every type~$\tau$ and every $X \in \Cb_\tau^\Gamma$ we have
  $t \in
  \val{\sigma}{\omega[\subst{\alpha}{\tau}],\xi[\subst{\alpha}{X}]}{\Gamma}$,
  then
  $\Lambda \alpha . t \in
  \val{\forall\alpha[\sigma]}{\omega,\xi}{\Gamma}$.
\end{lemma}

\begin{proof}
  Let~$\tau$ be a type and $X \in \Cb_\tau^\Gamma$. By
  Lemma~\ref{lem_val_computable} the
  set~$\val{\forall\alpha[\sigma]}{\omega,\xi}{\Gamma}$ is a
  candidate, so $t \in \SN$. By induction on~$\nu(t)$ we show
  $(\Lambda \alpha . t) \alpha \in
  \val{\sigma}{\omega[\subst{\alpha}{\tau}],\xi[\subst{\alpha}{X}]}{\Gamma}$.
  Because~$\val{\sigma}{\omega[\subst{\alpha}{\tau}],\xi[\subst{\alpha}{X}]}{\Gamma}$
  is a candidate by Lemma~\ref{lem_val_computable}, it suffices to
  show that for every~$w$ with $(\Lambda \alpha . t) \leadsto w$ we
  have
  $w \in
  \val{\sigma}{\omega[\subst{\alpha}{\tau}],\xi[\subst{\alpha}{X}]}{\Gamma}$. There
  are two cases.
  \begin{itemize}
  \item $w = (\Lambda \alpha . t') \alpha$. Then $\nu(t') < \nu(t)$
    and
    $w \in
    \val{\sigma}{\omega[\subst{\alpha}{\tau}],\xi[\subst{\alpha}{X}]}{\Gamma}$
    follows from the inductive hypothesis.
  \item $w = t$. Then
    $w \in
    \val{\sigma}{\omega[\subst{\alpha}{\tau}],\xi[\subst{\alpha}{X}]}{\Gamma}$
    by assumption.
  \end{itemize}
\end{proof}

\begin{lemma}
  If $t \in \val{\forall\alpha[\sigma]}{\omega,\xi}{\Gamma}$ then
  $t \tau \in \val{\sigma[\subst{\alpha}{\tau}]}{\omega,\xi}{\Gamma}$
  for any type~$\tau$.
\end{lemma}

\begin{proof}
  By Lemma~\ref{lem_val_computable} the
  set~$\val{\tau}{\omega,\xi}{\Gamma}$ is a candidate of
  type~$\tau$. By hypothesis
  $t \tau \in
  \val{\sigma}{\omega[\subst{\alpha}{\tau}],\xi[\subst{\alpha}{\val{\tau}{\omega,\xi}{\Gamma}}]}{\Gamma}$. Hence
  $t \tau \in \val{\sigma[\subst{\alpha}{\tau}]}{\omega,\xi}{\Gamma}$
  by Lemma~\ref{lem_val_subst}.
\end{proof}

\begin{lemma}\label{lem_typable_computable}
  If $\Gamma \proves t : \sigma$ then
  $\omega(t) \in \val{\sigma}{\omega,\xi}{\Gamma}$.
\end{lemma}

\begin{proof}
  Idea: by induction on~$t$, using the previous lemmas. One
  generalizes the inductive hypothesis to: if
  $x_1 : \tau_1,\ldots,x_n:\tau_n \proves t : \sigma$ then for all
  $u_1\in\val{\tau_1}{\omega,\xi}{\Gamma},\ldots,u_n\in\val{\tau_n}{\omega,\xi}{\Gamma}$
  we have
  $\omega(t[\subst{x_1}{u_1},\ldots,\subst{x_n}{u_n}]) \in
  \val{\sigma}{\omega,\xi}{\Gamma}$.
\end{proof}

\begin{corollary}
  If $\Gamma \proves t : \sigma$ then $t \in \SN$.
\end{corollary}

\begin{proof}
  Follows from Lemma~\ref{lem_typable_computable},
  Lemma~\ref{lem_val_computable} and Definition~\ref{def_candidate}.
\end{proof}

\begin{lemma}
Every term $s \in \Iterms$ with $\FV(s) = \FTV(s) = \emptyset$ reduces
to a unique final interpretation term $s\downarrow$.
\end{lemma}

\begin{proof}
By proving termination and local confluence of $\leadsto$ (although it
actually suffices to only prove local confluence for fully closed terms).

TODO.
\qed
\end{proof}

\begin{lemma}
The only final interpretation terms of type $\nat$ are the natural
numbers.
\end{lemma}

\begin{proof}
  This is~NOT~TRUE. Consider
  $\oplus_{\nat\to\nat} \lift_\nat \lift_\nat n$. Need to add more
  rewrite rules?
\end{proof}

\subsection{Defining $\succ$ and $\succeq$}

We will define $\succ$ and $\succeq$ on elements of $\World$, using
coinduction: $s \succ t$ (resp.\ $s \succeq t$) if $s \succ_\sigma t$
(resp.\ $s \succeq_\sigma t$) can be obtained for $\sigma$ the type of
$s,t$, following Definition~\ref{def:succ}.

\begin{definition}\label{def:succ}
  Let $R \in \{ \succ,\succeq \}$. For~$s,t \in \World_\sigma$, the
  relation $s\ R_{\sigma}\ t$ is defined coinductively by the
  following rules.
  \[
    \begin{array}{c}
    \infer={s\ R_\nat\ t}{s\da\ R\ t\da \text{ in natural
        numbers}}\quad\quad
    \infer={s\ R_{\sigma\to\tau}\ t}{\app{s}{q}\ R_{\tau}\ \app{t}{q}
      \text{ for every } q \in \World_\sigma} \\ \\
    \infer={s\ R_{\forall\alpha[\sigma]}\ t}{\tapp{s}{\tau}\ R_{\sigma[\subst{\alpha}{\tau}]}\ \tapp{t}{\tau}
      \text{ for every closed type } \tau}
    \end{array}
  \]
\end{definition}

\subsection{Properties of $\succ$ and $\succeq$}

We're going to at least need to see that $\succ$ is a well-founded ordering:

\begin{lemma}
$\succ$ is well-founded.
\end{lemma}

\begin{proof}
  By induction on the type~$\tau$ one shows that there does not exist
  an infinite sequence
  $t_1 \succ_\tau t_2 \succ_\tau t_3 \succ_\tau \ldots$ For instance,
  if
  $t_1 \succ_{\forall\alpha[\tau]} t_2 \succ_{\forall\alpha[\tau]} t_3
  \succ_{\forall\alpha[\tau]} \ldots$ then
  $\tapp{t_1}{\nat} \succ_{\tau[\subst{\alpha}{\nat}]}
  \tapp{t_2}{\nat} \succ_{\tau[\subst{\alpha}{\nat}]} \tapp{t_3}{\nat}
  \succ_{\tau[\subst{\alpha}{\nat}]} \ldots$, which is impossible by
  the inductive hypothesis.
\end{proof}

\begin{lemma}
Both $\succ$ and $\succeq$ are transitive.
\end{lemma}

\begin{proof}
  We show this for~$\succeq$, the proof for~$\succ$ being
  analogous. We proceed by coinduction.

  If $t_1 \succeq_\nat t_2 \succeq_\nat t_3$ then
  $t_1\da \ge t_2\da \ge t_3\da$, so $t_1\da \ge t_3\da$. Thus
  $t_1 \succeq_\nat t_3$.

  If $t_1 \succeq_{\sigma\to\tau}t_2\succeq_{\sigma\to\tau}t_3$ then
  $\app{t_1}{q}\succeq_{\tau}\app{t_2}{q}\succeq_\tau\app{t_3}{q}$ for
  $q \in \World_\sigma$. Hence $\app{t_1}{q}\succeq_\tau\app{t_3}{q}$
  for $q \in \World_\sigma$ by the coinductive hypothesis. Thus
  $t_1\succeq_{\sigma\to\tau} t_3$.

  If $t_1 \succeq_{\forall\alpha[\sigma]}t_2\succeq_{\forall\alpha[\sigma]}t_3$ then
  $\tapp{t_1}{\tau}\succeq_{\sigma[\subst{\alpha}{\tau}]}\tapp{t_2}{\tau}\succeq_{\sigma[\subst{\alpha}{\tau}]}\tapp{t_3}{\tau}$ for
  any closed type~$\tau$. Hence
  $\tapp{t_1}{\tau}\succeq_{\sigma[\subst{\alpha}{\tau}]}\tapp{t_3}{\tau}$
  by the coinductive hypothesis. Thus $t_1\succeq_{\forall\alpha[\sigma]} t_3$.\qed
\end{proof}

And that $\succeq$ is a quasi-ordering:

\begin{lemma}
$\succeq$ is reflexive.
\end{lemma}

\begin{proof}
  By coinduction.\qed
\end{proof}

Finally, they must be compatible:

\begin{lemma}
We have $\succ \cdot \succeq\ \subseteq\ \succ$
\end{lemma}

\begin{proof}
By coinduction, analogous to the transitivity proof.\qed
\end{proof}

I think that's all that absolutely \emph{has} to be proven to make the
argument work.  However, it would be great if we could also for
instance obtain that always $\app{\app{\oplus}{s}}{t} \succeq s$ and
that $\app{\app{\oplus}{s}}{(\app{\lift}{1})} \succ s$.

LC: I think these also hold by coinduction because they hold for
type~$\nat$. But one needs to generalize the coinductive hypothesis to
$\app{\app{\oplus}{s}}{t} \cdot t_1 \cdot \ldots \cdot t_n
\succeq_\sigma s \cdot t_1 \cdot \ldots \cdot t_n$ (and with some
additional type arguments also).

\section{Systems of interest and their properties}

The systems of interest are sets of terms with a rewriting relation on
them.  Interestingly, $\Iterms$ can be seen of an instance of this general
scheme.

\subsection{Systems of interest}

Types are built from a set of type constructors, using $\arrtype$ and
$\forall$.

\begin{definition}
We assume given a fixed set $\TypeConstructors$ of \emph{type
constructors}, each paired with an integer \emph{arity} $\geq 0$, as
well as the infinite set $\Typevars$ of type variables.  The set
$\Types$ of types is given by:
\begin{itemize}
\item $\alpha \in \Types$ for all $\alpha \in \Typevars$
\item $\con(\sigma_1,\dots,\sigma_n) \in \Types$ if $(\con,n) \in
  \TypeConstructors$ and $\sigma_1,\dots,\sigma_n \in \Types$
\item $\sigma \arrtype \tau \in \Types$ if $\sigma,\tau \in \Types$
\item $\quant{\alpha}{\sigma} \in \Types$ if $\alpha \in \Typevars$ and
  $\sigma \in \Types$
\end{itemize}
We let $\FTV(\sigma)$ be defined in the obvious way (much like
Definition~\ref{def:itypes}).
\end{definition}

Terms are built from a set of function symbols, using (type) abstraction
and (type) application as for interpretation terms.

\begin{definition}
We assume given a fixed set $\Sigma$ of \emph{function symbols}, each
paired with an arity $n$ and a type $\sigma_1 \arrtype \dots \arrtype
\sigma_n \arrtype \tau$, as well as the infinite set $\Vars$ of variables.
The set $\Terms$ of terms consists of those expressions $s$ such that
$\Gamma \vdash s : \sigma$ can be derived for some type $\sigma$ and
environment $\Gamma$ using the following clauses:
\begin{itemize}
\item $\Gamma \vdash x : \sigma$ for every $(x : \sigma) \in \Gamma$.
\item $\Gamma \vdash \mathtt{f}(s_1,\dots,s_n) : \tau$ if
  $(\mathtt{f} : (n,\sigma_1 \arrtype \dots \arrtype \sigma_n \arrtype
  \tau))$ in $\Sigma$ and $\Gamma \vdash s_i : \sigma_i$ for $1 \leq
  i \leq n$
\item $\Gamma \vdash \abs{x:\sigma}{s} : \sigma \arrtype \tau$ if $x
  \in \Vars$ and $\Gamma \uplus \{ x : \sigma \} \vdash s : \tau$.
\item $\Gamma \vdash \tabs{\alpha}{s} : \quant{\alpha}{\sigma}$ if
  $\alpha \in \Typevars$ and $\Gamma \vdash s : \sigma$ and for all
  $(x : \tau) \in \Gamma$: $\alpha \notin \FTV(\tau)$
\item $\Gamma \vdash \tapp{s}{\tau} : \sigma[\subst{\alpha}{\tau}]$ if
  $\Gamma \vdash s : \quant{\alpha}{\sigma}$
\end{itemize}
\end{definition}

Note that there is no explicit application; systems which include a form
of application should be modelled simply using a set of symbols $\{
@_{\sigma,\tau}: (2,(\sigma \arrtype \tau) \arrtype \sigma \arrtype \tau)
\mid \sigma,\tau \in \Types \} \subseteq \Sigma$.

TODO: are there interesting systems where the type application $*$ is
not the only way for types to appear in terms?  If so, we might as well
not have the exceptional case, easier to go general straight away.

LC: yes, e.g., when you have explicit existential quantification over
types, like in urzy\_emb.

I'm thinking that maybe here it will be easier to just go with
system $F_\omega$ from the beginning instead of system~$F$, because
there you have in-built type constructors.

TODO: describe what rules look like.  Are the cases where substitution
/ type substitution is used limited to a few special cases (in which
case we can just add those cases as special) or is it very typical?

LC: (type) substitution occurs with more rules, in e.g. urzy\_emb

Should we describe rules using variables which are instantiated, or
simply assume that typical systems have infinitely many rules (e.g.,
all instances of $\beta$-reductions are a separate rule)? We're
already using infinite signatures -- should we head straight for
polymorphism?

\subsubsection{Some example systems.}

TODO: describe here how system F and urzy\_emb can be seen as instances
of this general case.

\subsection{Interpreting interesting terms}

To start, all types must be mapped to interesting types.  This is
easily done:

\begin{definition}
A \emph{type constructor mapping} is a function $\Typemap$ which assigns
to each $(\con:n) \in \TypeConstructors$ a type $\sigma$ with
$\FTV(\sigma) \subseteq \{ \alpha_1,\dots,\alpha_n \}$.  A type
constructor mapping is extended to a function operating on types as
follows:
\[
\begin{array}{rcl}
\Typemap(\alpha) & = & \alpha \\
\Typemap(\con(\sigma_1,\dots,\sigma_n)) & = &
  \tau[\alpha_1:=\Typemap(\sigma_1),\dots,\alpha_n:=\Typemap(\sigma_n)]\ 
  \text{if}\ \Typemap(\con) = \tau \\
\Typemap(\sigma \arrtype \tau) & = & \Typemap(\sigma) \arrtype
  \Typemap(\tau) \\
\Typemap(\quant{\alpha}{\sigma}) & = & \quant{\alpha}{\Typemap(\sigma)} \\
\end{array}
\]
\end{definition}

Clearly, a type constructor mapping maps types to interpretation types,
and $\FTV(\Typemap(\sigma)) \subseteq \FTV(\sigma)$.

Terms are mapped to interpretation terms in a very similar way:

\begin{definition}
A \emph{symbol mapping} is a function $\Termmap$ which assigns to each
$(\mathtt{f}:(n,\sigma)) \in \Sigma$ a final interpretation term
$\Termmap(\mathtt{f})$ of the form $\abs{x_1:\sigma_1 \dots x_n:
\sigma_n}{t}$, such that $\emptyset \vdash \Termmap(\mathtt{f}) :
\Typemap(\sigma)$.  Considering $\Termmap$ fixed, we define the
\emph{interpretation} of each term $s$, $\interpret{s}$, as follows:
\[
\begin{array}{rcl}
\interpret{x} & = & x \\
\interpret{\mathtt{f}(s_1,\dots,s_n)} & = &
  t[x_1:=\interpret{s_1},\dots,x_n:=\interpret{s_n}]\ \text{if}\ 
  \Termmap(\mathtt{f}) = \abs{x_1:\sigma_1 \dots x_n:\sigma_n}{t} \\
\interpret{\abs{x:\sigma}{s}} & = & \abs{x:\Termmap(\sigma)}{
  \interpret{s}} \\
\interpret{\tabs{\alpha}{s}} & = & \tabs{\alpha}{\interpret{s}} \\
\interpret{\tapp{s}{\tau}} & = & \tapp{\interpret{s}}{\Termmap(\tau)} \\
\end{array}
\]
\end{definition}

TODO: prove that this indeed maps to well-typed interpretation terms of
the expected type.

TODO: observe that this choice does not really allow us to order the
type instantiation rule with $\succ$, just with $\succeq$.  However, this
isn't actually a problem since, if all other rules can be removed, we have
termination anyway.  However, we could allow for a custom interpretation
there as well, or consider the $*$ merely one case of a more general kind
of function symbol.

\subsection{Monotonicity}

This relies on the definition of rules (a form of stability may also be
required), but we really want to have that if $\interpret{\ell} \succ
\interpret{r}$ for some rule, then $\interpret{s} \succ \interpret{t}$
whenever $s \arr{\Rules} t$ by that rule.

\section{Some useful lemmas}

\subsection{Orienting $\beta$-reduction}

\subsection{Orienting type instantiation}

\subsection{Other}

\section{Some system of interest -- urzy\_emb?}

\subsection{Interpretations}

\subsection{Rule orientation}

\end{document}

