\documentclass[runningheads,a4paper]{llncs}
\pdfoutput=1

\bibliographystyle{plainurl}

\usepackage{amssymb}
\setcounter{tocdepth}{3}
\usepackage{enumerate}
\usepackage[colorlinks=true]{hyperref}
\usepackage{tikz}
\usepackage{xcolor,latexsym,amsmath,extarrows,alltt}
\usepackage{xspace}
\usepackage{booktabs}
\usepackage{mathtools}
\usepackage{enumitem}
\usepackage{stmaryrd}
\usepackage{microtype}
\usepackage{bussproofs}
\usepackage{multirow}
\usepackage{proof}

\newcommand{\Iterms}{\mathcal{I}}
\newcommand{\World}{\mathcal{W}}
\newcommand{\Rules}{\mathcal{R}}
\newcommand{\Typevars}{\mathcal{A}}
\newcommand{\Vars}{\mathcal{V}}
\newcommand{\ITypes}{\mathcal{Y}}
\newcommand{\Types}{\mathcal{T}}
\newcommand{\Terms}{\mathcal{T}\!\mathit{erms}}
\newcommand{\TypeConstructors}{\mathcal{C}}
\newcommand{\Typemap}{\mathcal{T\!M}}
\newcommand{\Termmap}{\mathcal{J}}

\newcommand{\quant}[2]{\forall #1[#2]}
\newcommand{\interpret}[1]{\llparenthesis #1 \rrparenthesis}
\newcommand{\arr}[1]{\to_{#1}}
\newcommand{\arrtype}{\Rightarrow}
\newcommand{\arreta}{\rightarrow_\eta}
\newcommand{\abs}[2]{\lambda #1.#2}
\newcommand{\tabs}[2]{\Lambda #1.#2}
\newcommand{\abstraction}[2]{\backslash #1.#2}
\newcommand{\app}[2]{#1 \cdot #2}
\newcommand{\apps}[3]{#1 \cdot #2 \cdots #3}
\newcommand{\tapp}[2]{#1 * #2}
\newcommand{\pair}[2]{\langle #1,#2 \rangle}
\newcommand{\subst}[2]{#1:=#2}
\newcommand{\etalong}[1]{#1\uparrow^\eta}
\newcommand{\almostetalong}[1]{\overline{#1}}

\newcommand{\FTV}{\mathit{FTV}}
\newcommand{\FV}{\mathit{FV}}

\newcommand{\nat}{\mathtt{nat}}
\newcommand{\proj}{\pi}
\newcommand{\flatten}{\mathtt{flatten}}
\newcommand{\lift}{\mathtt{lift}}
\newcommand{\con}{\mathtt{c}}

\newcommand{\ur}{\upharpoonright}
\newcommand{\da}{\downarrow}
\newcommand{\SN}{\mathrm{SN}}
\newcommand{\Cb}{\mathbb{C}}
\newcommand{\Nbb}{\mathbb{N}}
\newcommand{\val}[3]{\ensuremath{\llbracket#1\rrbracket_{#2}^{#3}}}
\newcommand{\proves}{\vdash}

\newcommand{\CK}[1]{\textcolor{blue}{CK: #1}}
\newcommand{\LC}[1]{\textcolor{purple}{LC: #1}}

\begin{document}

\mainmatter

\title{TODO list
  \thanks{The authors are supported by lots of people.}}
\subtitle{What we need to do to get where we want to be}

\author{{\L}ukasz Czajka and Cynthia Kop}
\authorrunning{{\L}. Czajka and C. Kop}
\institute{
Department of Computer Science, University of Copenhagen (DIKU)
\\
Institute of Computer Science, Radboud University Nijmegen (RU)
\\
\email{lukaszcz@mimuw.edu.pl}
\quad\quad\quad
\email{C.Kop@cs.ru.nl}
}

\maketitle

\begin{abstract}
The introduction of this paper is a TODO list.
The remainder is meant for filling in the TODOs with what we already
have.
The hope is that the end result is something useful. :)
\end{abstract}

\section*{THE LIST}

\renewcommand{\theenumii}{\arabic{enumi}.\arabic{enumii}}

Here's what we need to do:
\begin{enumerate}
\item Define a world $\World$ and a well-founded ordering $\succ$ on
  $\World$:
  \begin{enumerate}
  \item Define a set of terms $\World$ typed under some variation of
    System F-$\omega$.
  \item Define relations $\succ$ and $\succeq$ on the elements of $\World$.
  \item Prove that $\succ$ is a well-founded ordering relation and that
    $\succeq$ is a compatible quasi-ordering.
  \end{enumerate}
\item Specify what systems we are interested in analysing, and prove
  standard results which will make their analysis doable.
  \begin{enumerate}
  \item Specify a form of system which includes all the systems of interest.
  \item Specify a default way of interpreting terms in these systems.
  \item Prove that in all such systems, using our way of interpreting
    terms: if $\interpret{\ell} \succ \interpret{r}$ (resp.\ $\interpret{
    \ell} \succeq \interpret{r}$) for a rule  $\ell \to r$, then
    $\interpret{s} \succ \interpret{t}$ whenever $s \arr{\Rules} t$ by
    this rule (resp.\ $\interpret{s} \succeq \interpret{t}$).
  \end{enumerate}
\item Obtain useful lemmas regarding these defaults.
  \begin{enumerate}
  \item $\interpret{s[x:=t]} = \interpret{s}[x:=\interpret{t}]$.
  \item $\interpret{s\sigma} = \interpret{s}\sigma$.
  \item \dots?
  \end{enumerate}
\item For some system of interest, prove its termination:
  \begin{enumerate}
  \item Present the system and give interpretations (following the
    default scheme) for all ways of constructing terms.
  \item Show that $\ell \succ r$ or $\ell \succeq r$ for all rules.
    Remove the rules which are oriented using $\succ$ and repeat,
    until all rules have been removed.
  \end{enumerate}
\end{enumerate}

\renewcommand{\theenumii}{\alph{enumii}}

We use \emph{rule removal}:

\begin{theorem}
Let $\Rules = \Rules_1 \cup \Rules_2$, and suppose that $\arr{\Rules_1}\:
\subseteq\:\succ$ and $\arr{\Rules_2}\:\subseteq\:\succeq$ for a
well-founded ordering $\succ$ and a compatible quasi-ordering $\succeq$.
Then $\arr{\Rules}$ is terminating if and only if $\arr{\Rules_2}$ is
(which is certainly the case if $\Rules_2 = \emptyset$).
\end{theorem}

\begin{proof}
By well-foundedness of $\succ$, every infinite decreasing $\arr{\Rules}$
sequence can only use finitely many steps using $\arr{\Rules_1}$.
\qed
\end{proof}

This gives rise to the following algorithm:
\begin{enumerate}
\item While $\Rules$ is non-empty:
  \begin{enumerate}
  \item Orient all rules in $\Rules$ using $\succeq$ or $\succ$; at least
    one of them must be oriented using $\succ$.
  \item Remove all rules ordered by $\succ$ from $\Rules$.
  \end{enumerate}
\end{enumerate}
If this algorithm succeeds, we have proven termination.

\section{Defining a world}

\subsection{Defining the set $\World$}

\subsubsection{Interpretation terms}
We define the set of types for interpretation terms.

\begin{definition}\label{def:itypes}
We assume given an infinite set $\Typevars$ of \emph{type variables}.
The set $\ITypes$ of \emph{interpretation types} is given by:
\begin{itemize}
\item $\alpha \in \ITypes$ for all $\alpha \in \Typevars$, and
  $\FTV(\alpha) = \{ \alpha \}$.
\item $\nat \in \ITypes$, and $\FTV(\nat) = \emptyset$.
\item $\sigma \arrtype \tau \in \ITypes$ if both $\sigma \in \ITypes$
  and $\tau \in \ITypes$, and $\FTV(\sigma \arrtype \tau) = \FTV(\sigma)
  \cup \FTV(\tau)$.
\item $\sigma \times \tau \in \ITypes$ if both $\sigma \in \ITypes$
  and $\tau \in \ITypes$, and $\FTV(\sigma \times \tau) = \FTV(\sigma)
  \cup \FTV(\tau)$.
\item $\quant{\alpha}{\sigma} \in \ITypes$ if $\alpha \in \Typevars$ and
  $\sigma \in \ITypes$, and $\FTV(\quant{\alpha}{\sigma}) =
  \FTV(\sigma) \setminus \{ \alpha \}$.
\end{itemize}
\end{definition}

\begin{definition}\label{def:typesubst}
A \emph{type substitution} is a partial function $[\alpha_1:=\sigma_1,
\dots,\alpha_n:=\sigma_n]$ mapping a finite set of type variables to
types.  We let $\tau[\alpha_1:=\sigma_1,\dots,\alpha_n:=\sigma_n]$
denote $\tau$ with all occurrences of some $\alpha_i$ replaced by the
corresponding $\sigma_i$.  We use alpha-conversion to guarantee that
substitution does not capture variables in any of the $\sigma_i$.
\end{definition}

The set $\Iterms$ of interpretation terms is now defined as follows.

\begin{definition}\label{def_typing}
We assume given an infinite set $\Vars$ of variables, and let $\Gamma$
refer to a mapping from a finite subset of $\Vars$ to the set of
interpretation types.  The set $\Iterms$ of interpretation terms consists
of all expressions $s$ such that $\Gamma \vdash s : \sigma$ can be
inferred for some interpretation type $\sigma$ and mapping $\Gamma$ by
the following clauses:
\begin{itemize}
\item $\Gamma \vdash n : \nat$ for every natural number $n$.
\item $\Gamma \vdash x : \sigma$ for every $(x : \sigma) \in \Gamma$.
\item $\Gamma \vdash \mathtt{f} : \sigma$ for all $(\mathtt{f} :
  \sigma)$ in the following set: $\{ \oplus_\sigma : \sigma \arrtype
  \sigma \arrtype \sigma,\ \otimes_\sigma : \sigma \arrtype \sigma \arrtype
  \sigma,\ \proj^1_{\sigma,\tau} : (\sigma \times \tau) \arrtype
  \sigma,\ \proj^2_{\sigma,\tau} : (\sigma \times \tau) \arrtype \tau,\ 
  \flatten_{\sigma} : \sigma \arrtype \nat,\ 
  \lift_{\sigma} : \nat \arrtype \sigma
  \mid \sigma \in \ITypes \}$.
\item $\Gamma \vdash \pair{s}{t} : \sigma \times \tau$ if $\Gamma \vdash
  s : \sigma$ and $\Gamma \vdash t : \tau$.
\item $\Gamma \vdash \abs{x:\sigma}{s} : \sigma \arrtype \tau$ if $x
  \in \Vars$ and $\Gamma \uplus \{ x : \sigma \} \vdash s : \tau$.
\item $\Gamma \vdash \tabs{\alpha}{s} : \quant{\alpha}{\sigma}$ if
  $\alpha \in \Typevars$ and $\Gamma \vdash s : \sigma$ and for all
  $(x : \tau) \in \Gamma$: $\alpha \notin \FTV(\tau)$
\item $\Gamma \vdash \app{s}{t} : \tau$ if $\Gamma \vdash s :
  \sigma \arrtype \tau$ and $\Gamma \vdash t : \sigma$
\item $\Gamma \vdash \tapp{s}{\tau} : \sigma[\subst{\alpha}{\tau}]$ if
  $\Gamma \vdash s : \quant{\alpha}{\sigma}$
\end{itemize}
We say that $s$ is \emph{closed} if $\emptyset \vdash s : \sigma$.
\end{definition}

Note that for a given $\Gamma$, if $s$ is typable under $\Gamma$, then
there is only one choice for the type (this is easily proved by
induction on the form of $s$). Thus, all closed terms have a unique
type.

\subsubsection{Normalising interpretation terms}
Term equality is considered modulo $\alpha$-conversion.  In addition,
we are particularly interested in interpretation terms in
\emph{$\eta$-long form}.

\begin{definition}
For a given variable environment $\Gamma$ and interpretation term $s$
which is well-typed under $\Gamma$, the \emph{$\eta$-long form} of $s$,
denoted $\etalong{s}$, is defined as follows:
\begin{itemize}
\item if $\Gamma \vdash s : \sigma \arrtype \tau$ and $s = \abs{x}{s'}$,
  then $\etalong{s} =  \abs{x}{(\etalong{s'})}$
\item if $\Gamma \vdash s : \sigma \arrtype \tau$ and $s$ does not have
  the form $\abs{x}{s'}$, then $\etalong{s} =  \abs{x}{(
  \etalong{(\app{s}{x})})}$
\item if $\Gamma \vdash s : \quant{\alpha}{\sigma}$ and $s = \tabs{
  \alpha}{s'}$, then $\etalong{s} = \tabs{\alpha}{(\etalong{s'})}$
\item if $\Gamma \vdash s : \quant{\alpha}{\sigma}$ and $s$ does not have
  the form $\tabs{\alpha}{s'}$, then $\etalong{s} = \tabs{\alpha}{
  (\etalong{(\tapp{s}{\alpha})})}$
\item if $\Gamma \vdash s : \nat$ or $\Gamma \vdash s : \alpha$ or
  $\Gamma \vdash s : \sigma \times \tau$, then $\etalong{s} =
  \almostetalong{s}$, where
  \begin{itemize}
  \item $\almostetalong{s} = s$ if $s$ is a natural number, variable or
    function symbol
  \item $\almostetalong{s} = \pair{\etalong{s_1}}{\etalong{s_2}}$ if
    $s = \pair{s_1}{s_2}$
  \item $\almostetalong{s} = \etalong{s}$ if $s$ has the form
    $\abs{x}{s'}$ or $\tabs{\alpha}{s'}$
  \item $\almostetalong{s} = \app{\almostetalong{s_1}}{(\etalong{s_2})}$
    if $s = \app{s_1}{s_2}$
  \item $\almostetalong{s} = \tapp{\almostetalong{s'}}{\tau}$
    if $s = \tapp{s'}{\tau}$
  \end{itemize}
\end{itemize}
A term $s$ is in \emph{$\eta$-long form} if $s = \etalong{s}$.
\end{definition}

It is clear that the $\eta$-long form of an interpretation term is
unique; the following lemma shows that it is also always well-defined.

\begin{lemma}
For all interpretation terms $s$, the function $\etalong{s}$ is
well-defined.
\end{lemma}

\begin{proof}
Define here the \emph{depth} function on interpretation terms as
follows:
\begin{itemize}
\item $\mathit{depth}(n) = \mathit{depth}(x) = \mathit{depth}(\mathtt{f})
  = 0$
\item $\mathit{depth}(\pair{s}{t}) = \max(\mathit{depth}(s),\mathit{
  depth}(t)) + 1$
\item $\mathit{depth}(\abs{x}{s}) = \mathit{depth}(\tabs{\alpha}{s}) =
  \mathit{depth}(s) + 1$
\item $\mathit{depth}(\app{s}{t}) = \max(\mathit{depth}(s),\mathit{
  depth}(t)+1)$
\item $\mathit{depth}(\tapp{s}{\tau}) = \mathit{depth}(s)$
\end{itemize}
(This definition is clearly well-defined as the term under consideration
becomes smaller each step.)
We can see that $\etalong{x}$ is well-defined for all variables by
induction on their type.  This we use to see that $\etalong{(\apps{s}{
x_1}{x_n})}$ is well-defined for $s$ a variable, natural number or
function symbol by induction on its type.  Thus, well-definedness of
$\etalong{s}$ for all $s$ with depth $0$ follows; also $\almostetalong{
s} = s$ is well-defined for such $s$.
For interpretation terms of depth $\geq 1$, well-definedness of
$\etalong{s}$ and $\overline{s}$ follows by induction on
$(\mathit{depth}(s)$, $1$, the size of the type of $s)$ in the case
of $\etalong{s}$ and
$(\mathit{depth}(s)$, $0$, the size of $s)$ in the case of
$\almostetalong{s}$.
\end{proof}

To define the world of \emph{final interpretation terms}, we will
normalise certain elements of $\Iterms$ using the relation $\leadsto$.

\begin{definition}
We define the relation $\leadsto$ on interpretation terms as the
smallest relation for which the following properties are satisfied:
\begin{enumerate}
\item\label{leadsto:mono:abs}
  if $s \leadsto t$ then both $\abs{x}{s} \leadsto \abs{x}{t}$ and
  $\tabs{\alpha}{s} \leadsto \tabs{\alpha}{t}$
\item\label{leadsto:mono:right}
  if $s \leadsto t$ then $\app{u}{s} \leadsto \app{u}{t}$
\item\label{leadsto:mono:left}
  if $s \leadsto t$ then both $\app{s}{u} \leadsto \app{t}{u}$ and
  $\tapp{s}{\sigma} \leadsto \tapp{t}{\sigma}$
\item\label{leadsto:plus:base}
  $\app{\app{\oplus_{\nat}}{n}}{m} \leadsto (n+m)$ 
\item\label{leadsto:times:base}
  $\app{\app{\otimes_{\nat}}{n}}{m} \leadsto (n \cdot m)$ 
\item\label{leadsto:circ:arrow}
  $\app{\app{\circ_{\sigma \arrtype \tau}}{s}}{t} \leadsto \abs{x:
  \sigma}{\app{\app{\circ_\tau}{(\app{s}{x})}}{(\app{t}{x})}}$ for
  $\circ \in \{ \oplus, \otimes \}$
\item\label{leadsto:circ:forall}
  $\app{\app{\circ_{\quant{\alpha}{\sigma}}}{s}}{t} \leadsto
  \tabs{\alpha}{\app{\app{\circ_\sigma}{(\tapp{s}{\alpha})}}{(
  \tapp{t}{\alpha})}}$ for $\circ \in \{ \oplus, \otimes \}$
\item $\app{\proj^1_{\sigma,\tau}}{(s,t)} \leadsto s$
\item $\app{\proj^2_{\sigma,\tau}}{(s,t)} \leadsto t$
\item $\app{\flatten_\nat}{s} \leadsto s$
\item $\app{\flatten_{\sigma \arrtype \tau}}{s} \leadsto
  \app{s}{(\app{\lift_\sigma}{0})}$
\item $\app{\flatten_{\quant{\alpha}{\sigma}}}{s} \leadsto
  \app{\flatten_{\sigma[\subst{\alpha}{\nat}]}}{(\tapp{s}{\nat})}$
\item $\app{\lift_\nat}{s} \leadsto s$
\item $\app{\lift_{\sigma \arrtype \tau}}{s} \leadsto
  \abs{x:\sigma}{\app{\lift_{\tau}}{x}}$
\item $\app{\lift_{\quant{\alpha}{\sigma}}}{s} \leadsto
  \tabs{\alpha}{\app{\lift_{\sigma}}{s}}$
\item\label{leadsto:beta:abs}
  $\app{(\abs{x:\sigma}{s})}{t} \leadsto s[\subst{x}{t}]$
\item\label{leadsto:beta:tabs}
  $\tapp{(\tabs{\alpha}{s})}{\sigma} \leadsto
  s[\subst{\alpha}{\sigma}]$.
\end{enumerate}
We say that $s$ is a \emph{redex} if $s$ reduces by one of the rules
(\ref{leadsto:plus:base})--(\ref{leadsto:beta:tabs}), and that $s$
\emph{reduces at the head} to $t$ if the derivation of $s \leadsto t$
does not use (\ref{leadsto:mono:abs}) or (\ref{leadsto:mono:right}).

A \emph{final interpretation term} is a term $s \in \Iterms$ such that
(a) $\FV(s) = \FTV(s) = \emptyset$, (b) $s$ is in normal form with
respect to $\leadsto$, and (c) $s$ is in $\eta$-long form.  We let
$\World$ be the set of all final interpretation terms. By~$\World_\tau$
we denote the set of all final interpretation terms of type~$\tau$.
\end{definition}

NOTE: in the remainder of this section, we shall often speak simply of
``terms'' when referring to interpretation terms.

\subsubsection{Key properties of $\leadsto$}
In the remainder of this section, we will often abuse notation to omit
$\cdot$ and $*$.  Thus, $s t$ can refer to both $\app{s}{t}$ and
$\tapp{s}{t}$.  Due to typing, this notation is not ambiguous.  We will
also denote $\abstraction{a}{s}$ for either $\abs{a}{s}$ or
$\tabs{a}{s}$, depending on typing.  Thus, we have:

\begin{lemma}\label{lem_abusive_notation}
Every interpretation term has the form $s t_1 \dots t_n$ with
$s$ a variable, function symbol or abstraction $\abstraction{a}{s'}$
(for $n \geq 0$).
\end{lemma}

\begin{proof}
By induction on the size of interpretation terms (and a simple case
analysis).
\qed
\end{proof}

\begin{lemma}[Subject reduction]
  If $\Gamma \vdash t : \tau$ and $t \leadsto t'$ then
  $\Gamma \vdash t' : \tau$.
\end{lemma}

\begin{proof}
  TODO
\end{proof}

By~$\SN$ we denote the set of all terminating interpretation
terms. For $t \in \SN$ by~$\nu(t)$ we denote the length of the longest
reduction starting at~$t$. We use the notation $t u$ for either
$\app{t}{u}$ when~$u$ is a term, or $\tapp{t}{u}$ when~$u$ is a type.

The following lemma is obvious, but worth stating explicitly.

\begin{lemma}\label{lem_reduce_abs}
If $\abstraction{a}{s} \leadsto^* t$, then $t = \abstraction{a}{
t}$ and $s \leadsto^* t'$.
If $s \in \SN$ then both $\abs{x}{s}$ and $\tabs{\alpha}{s}$ are also
in $\SN$.
\end{lemma}

\begin{proof}
We observe that every reduct of $\abs{x}{s}$ has the form $\abs{x}{s'}$
with $s \leadsto s'$, and similar for $\tabs{\alpha}{s}$.
Thus, the first statement follows by induction on the length of the
reduction $\abstraction{a}{s} \leadsto^* t$, and the second by induction
on $s$ using $\leadsto$.
\qed
\end{proof}

\begin{lemma}\label{lem_circ_sn_base}
  If $t_1,t_2 \in \SN$ then $\circ_\nat t_1 t_2 \in \SN$ for
  $\circ \in \{\oplus,\otimes\}$.
  \CK{Changed this because I don't think it'll work out to do this for
  higher types without assuming a kind of computability of $t_1,t_2$ --
  not with the changed definition of the $\circ$ rules (it could be
  that $t_1$ is terminating but $t_1 x$ is not).} \LC{Right, with the
  previous rules this was a relatively simple induction on~$\tau$, now
  it won't work.}
\end{lemma}

\begin{proof}
  By induction on $t_1,t_2$ oriented with $\leadsto$.
  $\circ_\nat t_1 t_2 \in \SN$ if $s \in \SN$ for all $s$ such that
  $\circ_\nat t_1 t_2 \in \SN \leadsto s$.  If
  $s = \circ_\nat t_1' t_2$ or $s = \circ_\nat t_1 t_2'$ then we
  complete by the induction hypothesis. Otherwise $s \in \mathbb{N}$
  is obviously in $\SN$.
\end{proof}

\begin{lemma}
If $s$ is a closed interpretation term in $\eta$-long form which is
terminating under $\leadsto$, then there is a final interpretation term
$t$ such that $s \leadsto^* t$.
\end{lemma}

\begin{proof}
TODO
\CK{And honestly not sure whether we even need this.}
\end{proof}

\LC{What do we need these $\eta$-expansions for? I think this just
  works now with the modified $\leadsto$-rules for $\oplus,\otimes$.}

\subsubsection{Computability}
In the rest of this section we adapt the Tait-Girard computability
method to prove termination of~$\leadsto$. The proof is an adaptation
of chapters~6 and~14 from the book ``Proofs and Types'' by Girard, and
chapters~10 and~11 from the book ``Lectures on the Curry-Howard
Isomorphism'' by Sorensen and Urzyczyn.

NOTE: For now the proof does not take product types into account. I'm
not sure if explicit products are necessary in the definition, because
in contrast to the simply-typed lambda-calculus they may be encoded in
the polymorphic lambda-calculus.

NOTE: Currently, $\flatten$ and $\lift$ are not accounted for either,
but adding them should be similar to~$\oplus$ and~$\otimes$.

\begin{definition}\label{def_candidate}
  A term~$t$ is \emph{neutral} if there does not exists a sequence of
  terms or types~$u_1,\ldots,u_n$ with $n \ge 1$ such that
  $t u_1 \ldots u_n$ is a redex (by~$\leadsto$).

  A set~$X$ of interpretation terms of type~$\tau$ in context~$\Gamma$
  is a \emph{candidate of type~$\tau$} when:
  \begin{enumerate}
  \item $X \subseteq \SN$;
  \item if $t \in X$ and $t \leadsto t'$ then $t' \in X$;
  \item if $t$ is neutral and for every~$t'$ with $t \leadsto t'$ we
    have $t' \in X$, then $t \in X$;
  \item if $t_1,t_2 \in X$ then $\circ_\tau t_1 t_2 \in X$ for $\circ
    \in \{\oplus,\otimes\}$;
  \item conditions analogous to the previous one for $\flatten$ and
    $\lift$ \ldots
  \end{enumerate}
  Note that item~3 above implies:
  \begin{itemize}
  \item if $t$ is neutral and in normal form then $t \in X$.
  \end{itemize}
  The set of all candidates of type~$\tau$ in context~$\Gamma$ is
  denoted by~$\Cb_\tau^\Gamma$.
\end{definition}

\begin{definition}\label{def_reducibility_valuation}
  Let $\omega$ be a mapping from type variables to types. A
  \emph{$\Gamma,\omega$-valuation} is a mapping~$\xi$ from type
  variables to candidates such that $\xi(\alpha)$ is a candidate of
  type~$\omega(\alpha)$ (in context~$\Gamma$).

  For each type~$\sigma$, context~$\Gamma$, mapping~$\omega$
  and each $\Gamma,\omega$-valuation~$\xi$, the set $\val{\sigma}{\omega,\xi}{\Gamma}$ is
  defined by induction on~$\sigma$:
  \begin{itemize}
  \item $\val{\alpha}{\omega,\xi}{\Gamma} = \xi(\alpha)$ for a type
    variable~$\alpha$,
  \item $\val{\nat}{\omega,\xi}{\Gamma}$ is the set of all
    terms~$t \in \SN$ such that $\Gamma \proves t : \nat$,
  \item $\val{\sigma \to \tau}{\omega,\xi}{\Gamma}$ is the set of all
    terms~$t$ such that $\Gamma \proves t : \omega(\sigma \to \tau)$,
    and for every~$s \in \val{\sigma}{\omega,\xi}{\Gamma}$ we have
    $\app{t}{s} \in \val{\tau}{\omega,\xi}{\Gamma}$,
  \item $\val{\forall\alpha[\sigma]}{\omega,\xi}{\Gamma}$ is the set
    of all terms~$t$ such that
    $\Gamma \proves t : \omega(\forall\alpha[\sigma])$ and for every
    type~$\tau$ and every $X \in \Cb_\tau^\Gamma$ we have
    $\tapp{t}{\alpha} \in
    \val{\sigma}{\omega[\subst{\alpha}{\tau}],\xi[\subst{\alpha}{X}]}{\Gamma}$.
  \end{itemize}
\end{definition}

\begin{lemma}\label{lem_val_typable}
  If $t \in \val{\sigma}{\omega,\xi}{\Gamma}$ then
  $\Gamma \proves t : \omega(\sigma)$.
\end{lemma}

\begin{proof}
  Follows from definitions.
\end{proof}

\begin{lemma}\label{lem_nat_reducible}
  $\val{\nat}{\omega,\xi}{\Gamma} \in \Cb_{\nat}^\Gamma$.
\end{lemma}

\begin{proof}
  We check the conditions in Definition~\ref{def_candidate}.
  \begin{enumerate}
  \item $\val{\nat}{\omega,\xi}{\Gamma} \subseteq \SN$ follows
    directly from Definition~\ref{def_reducibility_valuation}.
  \item Let $t \in \val{\nat}{\omega,\xi}{\Gamma}$ and
    $t \leadsto t'$. Then $\Gamma \proves t : \nat$ and $t \in
    \SN$. Hence $t' \in \SN$, and $\Gamma \proves t' : \nat$ by the
    subject reduction lemma. Thus
    $t' \in \val{\nat}{\omega,\xi}{\Gamma}$.
  \item Let $t$ be neutral and $\Gamma \proves t : \nat$. Assume that
    for all~$t'$ with $t \leadsto t'$ we have
    $t' \in \val{\nat}{\omega,\xi}{\Gamma}$, so in particular
    $t' \in \SN$. But then $t \in \SN$. Hence
    $t \in \val{\nat}{\omega,\xi}{\Gamma}$.
  \item Let $t_1,t_2 \in \SN$ be such that
    $\Gamma \proves t_i : \nat$. Obviously,
    $\Gamma \proves \circ_\nat t_1 t_2 : \nat$. Also
    $\circ_\nat t_1 t_2 \in \SN$ follows by Lemma~\ref{lem_circ_sn_base}.
    So $\circ_\nat t_1 t_2 \in \val{\nat}{\omega,\xi}{\Gamma}$.
  \end{enumerate}
\end{proof}

\LC{The following lemma is essentially just the two lemmas you
  commented out, plus using property 2 of candidates for the other
  direction. I corrected the statement (the statements of the
  commented-out lemmas were also incomplete -- I forgot about the
  typing).}
\CK{Yeah, I realised that afterwards -- I needed them \emph{before}
  the main proof, and hadn't realised that they were given later
  as well.}
\begin{lemma}\label{lem_abstraction_computable}
  Suppose it is given that $\val{\sigma}{\omega',\xi'}{\Gamma}$ and
  $\val{\tau}{\omega,\xi}{\Gamma}$ are candidates for all suitable
  $\omega',\xi'$.  Then
  \begin{itemize}
  \item
    $\abs{x:\omega(\tau)}{s} \in \val{\tau \arrtype
      \sigma}{\omega,\xi}{ \Gamma}$ if and only if
    $\Gamma \proves \abs{x:\omega(\tau)}{s} : \omega(\tau \arrtype
    \sigma)$ and $s[x:=t] \in \val{\sigma}{\omega,\xi}{\Gamma}$ for
    all $t \in \val{ \tau}{\omega,\xi}{\Gamma}$;
  \item
    $\tabs{\alpha}{s} \in \val{\quant{\alpha}{\sigma}}{\omega,\xi}{
      \Gamma}$ if and only if
    $\Gamma \proves \tabs{\alpha}{s} : \omega(\quant{\alpha}{\sigma})$
    and for every type~$\tau$ and all $X \in \Cb_\tau^\Gamma$ we have
    $s[\alpha:=\tau] \in
    \val{\sigma}{\omega[\subst{\alpha}{\tau}],\xi[\subst{\alpha}{X}]}{\Gamma}$.
  \end{itemize}
\end{lemma}

\begin{proof}
  First suppose $\abs{x:\sigma}{s} \in \val{\sigma \arrtype \tau}{\omega,
  \xi}{\Gamma}$.  Then for all $t \in \val{\sigma}{\omega,\xi}{\Gamma}$ we
  have $\app{(\abs{x:\sigma}{s})}{t} \in \val{\tau}{\omega,\xi}{\Gamma}$.
  As this set is a candidate, it is closed under $\leadsto$, so also
  $s[x:=t] \in \val{\tau}{\omega,\xi}{\Gamma}$.
  Similarly, if $\tabs{\alpha}{s} \in \quant{\alpha}{\sigma}$, then
  $\tapp{(\tabs{\alpha}{s})}{\tau} \in \val{\sigma}{
  \omega[\subst{\alpha}{\tau}],\xi[\subst{\alpha}{X}]}{\Gamma}$, and we are
  done because $\tapp{(\tabs{\alpha}{s})}{\tau} \leadsto s[\alpha:=\tau]$.

  Now suppose (**): $s[x:=t] \in \val{\sigma}{\omega,\xi}{\Gamma}$ for all
  $t \in \val{\tau}{\omega,\xi}{\Gamma}$.  Let $t \in \val{\tau}{\omega,
  \xi}{\Gamma}$.  Then:
  \begin{itemize}
  \item $t \in \SN$ because $\val{\tau}{\omega,\xi}{\Gamma}$ is a candidate;
  \item $s \in \SN$ because every infinite reduction in $s$ induces an
    infinite reduction in $s[x:=t]$ ($\leadsto$ is stable);
  \item if $s \leadsto^* s'$ and $t \leadsto^* t'$, then:
    \begin{itemize}
    \item $s[x:=t] \leadsto^* s'[x:=t']$ by monotonicity and stability of
      $\leadsto$;
    \item therefore $s'[x:=t'] \in \val{\sigma}{\omega,\xi}{\Gamma}$, because
      $\val{\sigma}{\omega,\xi}{\Gamma}$ is a candidate and therefore closed
      under $\leadsto$;
    \item $\app{(\abs{x}{s'})}{t'}$ is neutral, so in
      $\val{\sigma}{\omega,\xi}{\Gamma}$ if all its reducts are;
    \item by induction on $s',t'$ oriented with $\leadsto$ therefore
      $\app{(\abs{x}{s'})}{t'} \in \val{\sigma}{\omega,\xi}{\Gamma}$.
    \end{itemize}
  \end{itemize}
  A similar reasoning applies to $s[\alpha:=\tau]$.
\end{proof}

\begin{lemma}\label{lem_val_computable}
  $\val{\sigma}{\omega,\xi}{\Gamma} \in \Cb_{\omega(\sigma)}^\Gamma$.
\end{lemma}

\begin{proof}
  Induction on~$\sigma$. First, if $\sigma = \alpha$ for a type
  variable~$\alpha$ then
  $\val{\sigma}{\omega,\xi}{\Gamma} = \xi(\alpha) \in
  \Cb_{\omega(\sigma)}^\Gamma$ by definition. If $\sigma = \nat$ then
  $\val{\nat}{\omega,\xi}{\Gamma} \in \Cb_{\nat}^\Gamma$ by
  Lemma~\ref{lem_nat_reducible}.

  Assume $\sigma = \tau_1 \to \tau_2$. We check the conditions in
  Definition~\ref{def_candidate}.
  \begin{enumerate}
  \item Let $t \in \val{\tau_1\to\tau_2}{\omega,\xi}{\Gamma}$ and
    assume there is an infinite reduction
    $t \leadsto t_1 \leadsto t_2 \leadsto t_3 \leadsto \ldots$. By the
    inductive hypothesis $\val{\tau_1}{\omega,\xi}{\Gamma}$ and
    $\val{\tau_2}{\omega,\xi}{\Gamma}$ are candidates. So
    $x \in \val{\tau_1}{\omega,\xi}{\Gamma}$ because it is neutral and
    normal. Then $t x \in \val{\tau_2}{\omega,\xi}{\Gamma}$. Thus
    $t x$~is strongly normalising. But
    $t x \leadsto t_1 x \leadsto t_2 x \leadsto t_3 x \leadsto
    \ldots$. Contradiction.
  \item Let $t \in \val{\tau_1\to\tau_2}{\omega,\xi}{\Gamma}$ and
    $t \leadsto t'$. Let $u \in
    \val{\tau_1}{\omega,\xi}{\Gamma}$. Then
    $t u \in \val{\tau_2}{\omega,\xi}{\Gamma}$. By the inductive
    hypothesis $\val{\tau_2}{\omega,\xi}{\Gamma}$ is a candidate, so
    $t' u \in \val{\tau_2}{\omega,\xi}{\Gamma}$. Also note that
    $\Gamma \proves t' : \omega(\tau_1 \to \tau_2)$ by the subject
    reduction lemma. Hence
    $t' \in \val{\tau_1\to\tau_2}{\omega,\xi}{\Gamma}$.
  \item Let $t$ be neutral and
    $\Gamma \proves t : \omega(\tau_1 \to \tau_2)$ and assume for
    every~$t'$ with $t \leadsto t'$ we have
    $t' \in \val{\tau_1\to\tau_2}{\omega,\xi}{\Gamma}$. Let
    $u \in \val{\tau_1}{\omega,\xi}{\Gamma}$. By the inductive
    hypothesis $\val{\tau_1}{\omega,\xi}{\Gamma}$ is a candidate, so
    $u \in \SN$. By induction on~$\nu(u)$ we show that
    $t u \in \val{\tau_2}{\omega,\xi}{\Gamma}$. Assume
    $t u \leadsto t''$. We show
    $t'' \in \val{\tau_2}{\omega,\xi}{\Gamma}$. Because~$t$ is
    neutral, $t u$ cannot be a redex. So there are two cases.
    \begin{itemize}
    \item $t'' = t u'$ with $u \leadsto u'$. Then
      $t u' \in \val{\tau_2}{\omega,\xi}{\Gamma}$ by the inductive
      hypothesis for~$u$.
    \item $t'' = t' u$ with $t \leadsto t'$. Then
      $t' \in \val{\tau_1\to\tau_2}{\omega,\xi}{\Gamma}$, so
      $t' u \in \val{\tau_2}{\omega,\xi}{\Gamma}$.
    \end{itemize}
    We have thus shown that if $t u \leadsto t''$ then
    $t'' \in \val{\tau_2}{\omega,\xi}{\Gamma}$. By the (main)
    inductive hypothesis $\val{\tau_2}{\omega,\xi}{\Gamma}$ is a
    candidate, and $t u$ is neutral, so also
    $t u \in \val{\tau_2}{\omega,\xi}{\Gamma}$. Since
    $u \in \val{\tau_1}{\omega,\xi}{\Gamma}$ was arbitrary, we have
    shown $t \in \val{\tau_1\to\tau_2}{\omega,\xi}{\Gamma}$.
  \item Assume $t_1,t_2 \in \val{\tau_1\to\tau_2}{\omega,\xi}{\Gamma}$.
    We have already shown that this implies $t_1,t_2 \in \SN$.
    Since $s := \circ_{\omega(\tau_1\to\tau_2)} t_1 t_2$ is neutral,
    we have also already seen that $s \in \val{\tau_1\to\tau_2}{\omega,
    \xi}{\Gamma}$ if $s' \in \val{\tau_1\to\tau_2}{\omega,\xi}{\Gamma}$
    whenever $s \leadsto s'$.
    This we show by induction on $t_1,t_2$ (oriented with $\leadsto$).
    If $s' = \circ_{\omega(\tau_1\to\tau_2)} t_1' t_2$, then note that
    $t_1' \in \val{\tau_1\to\tau_2}{\omega,\xi}{\Gamma}$ because we
    have already shown that $\val{\tau_1\to\tau_2}{\omega,\xi}{\Gamma}$
    is closed under $\leadsto$; thus, we can complete by the induction
    hypothesis.
    If $s' = \circ_{\omega(\tau_1\to\tau_2)} t_1 t_2'$, we complete in
    the same way.
    The only alternative is that $s' = \abs{x:\omega(\tau_1)}{\circ_{
    \omega(\tau_2)} (t_1 x) (t_2 x)}$.
    Let $u \in \val{\tau_1}{\omega,\xi}{\Gamma}$.  Since $t_1,t_2 \in
    \val{\tau_1\to\tau_2}{\omega,\xi}{\Gamma}$, we have that $t_1 u$
    and $t_2 u$ are in $\val{\tau_2}{\omega,\xi}{\Gamma}$ by
    definition.  Since, $\val{\tau_2}{\omega,\xi}{\Gamma}$ is a
    candidate, this means that $\circ_{\omega(\tau_2)} (t_1 u) (t_2 u) =
    (\circ_{\omega(\tau_2)} (t_1 x) (t_2 x))[x:=u]$ is in
    $\val{\tau_2}{\omega,\xi}{\Gamma}$ as well.  By
    Lemma~\ref{lem_abstraction_computable}, we conclude that $s' \in
    \val{\tau_1\to\tau_2}{\omega,\xi}{\Gamma}$.
  \end{enumerate}

  Assume $\sigma = \forall\alpha[\tau]$. We check the conditions in
  Definition~\ref{def_candidate}.
  \begin{enumerate}
  \item Let $t \in \val{\forall\alpha[\tau]}{\omega,\xi}{\Gamma}$ and
    assume there is an infinite reduction
    $t \leadsto t_1 \leadsto t_2 \leadsto t_3 \leadsto
    \ldots$. Let~$\tau'$ be an arbitrary type and let
    $S \in \Cb_{\tau'}^\Gamma$ (e.g.~take~$S$ to be the set of
    terminating terms of type~$\tau'$ in context~$\Gamma$).
    \CK{It is not guaranteed that this will work! For that we really
    do need that $\circ s t$ is SN if $s$ and $t$ are.  However, can't
    we just take $\tau' := \nat$?} \LC{I think $\tau' := \nat$ indeed works here.}
    Then
    $t \tau' \in
    \val{\tau}{\omega[\subst{\alpha}{\tau'}],\xi[\subst{\alpha}{S}]}{\Gamma}$. By
    the inductive hypothesis
    $\val{\tau}{\omega[\subst{\alpha}{\tau'}],\xi[\subst{\alpha}{S}]}{\Gamma}$
    is a candidate, so $t \tau' \in \SN$. But
    $t \tau' \leadsto t_1 \tau' \leadsto t_2 \tau' \leadsto t_3 \tau'
    \leadsto \ldots$. Contradiction.
  \item Let $t \in \val{\forall\alpha[\tau]}{\omega,\xi}{\Gamma}$ and
    $t \leadsto t'$. By the subject reduction lemma
    $\Gamma \proves t' : \omega(\forall\alpha[\tau])$. Let~$\tau'$ be
    a type and~$X \in \Cb_{\tau'}^\Gamma$. Then
    $t \tau' \in
    \val{\tau}{\omega[\subst{\alpha}{\tau'}],\xi[\subst{\alpha}{X}]}{\Gamma}$. By
    the inductive hypothesis
    $\val{\tau}{\omega[\subst{\alpha}{\tau'}],\xi[\subst{\alpha}{X}]}{\Gamma}$
    is a candidate, so
    $t' \tau' \in
    \val{\tau}{\omega[\subst{\alpha}{\tau'}],\xi[\subst{\alpha}{X}]}{\Gamma}$. Therefore
    $t' \in \val{\forall\alpha[\tau]}{\omega,\xi}{\Gamma}$.
  \item Let $t$ be neutral and
    $\Gamma \proves t : \omega(\forall\alpha[\tau])$ and assume for
    every~$t'$ with $t \leadsto t'$ we have
    $t' \in
    \val{\forall\alpha[\tau]}{\omega,\xi}{\Gamma}$. Let~$\tau'$ be a
    type and~$X \in \Cb_{\tau'}^\Gamma$. Assume
    $t \tau' \leadsto t''$. Then $t'' = t' \tau'$ with
    $t \leadsto t'$, because~$t$ is neutral. Hence
    $t \tau' \leadsto t' \tau' \in
    \val{\tau}{\omega[\subst{\alpha}{\tau'}],\xi[\subst{\alpha}{X}]}{\Gamma}$. By
    the inductive
    hypothesis~$\val{\tau}{\omega[\subst{\alpha}{\tau'}],\xi[\subst{\alpha}{X}]}{\Gamma}$
    is a candidate, and also $t \tau'$ is neutral, so
    $t \tau' \in
    \val{\tau}{\omega[\subst{\alpha}{\tau'}],\xi[\subst{\alpha}{X}]}{\Gamma}$. This
    implies that
    $t \in \val{\forall\alpha[\tau]}{\omega,\xi}{\Gamma}$.
  \item Assume
    $t_1,t_2 \in \val{\forall\alpha[\tau]}{\omega,\xi}{\Gamma}$. We
    have already shown that this implies $t_1,t_2 \in \SN$, and since
    $s := \circ_{\omega(\forall\alpha[\tau])} t_1 t_2$ is neutral, that
    $s \in \val{\forall\alpha[\tau]}{\omega,\xi}{\Gamma}$ if $s' \in
    \val{\forall\alpha[\tau]}{\omega,\xi}{\Gamma}$ whenever $s \leadsto
    s'$.  This we show by induction on $t_1,t_2$.
    The cases when $t_1$ or $t_2$ are reduced are immediate with the
    induction hypotheses; the only remaining case is when $s' =
    \tabs{\alpha}{\circ_{\omega(\tau)} (t_1 \alpha) (t_2 \alpha)}$.
    For all types $\sigma$ and $X \in \Cb_{\sigma}^\Gamma$ we have both
    $t_1 \sigma$ and $t_2 \sigma$ in $\val{\tau}{\omega[\subst{\alpha}{
    \sigma}],\xi[\subst{\alpha}{X}]}{\Gamma}$ (by definition of
    $t_1,t_2 \in \val{\forall\alpha[\tau]}{\omega,\xi}{\Gamma}$).
    But then, because $\val{\tau}{\omega[\subst{\alpha}{\sigma}],
    \xi[\subst{\alpha}{X}]}{\Gamma}$ is a candidate by the inductive
    hypothesis, we have $\circ_{\omega(\tau[\subst{\alpha}{\sigma})}
    (t_1 \sigma) (t_2\sigma) = (\circ_{\omega(\tau)} (t_1 \alpha) (t_2
    \alpha))[\subst{\alpha}{\sigma}] \in \val{\tau}{\omega[\subst{
    \alpha}{\sigma}],\xi[\subst{\alpha}{X}]}{\Gamma}$ for all types
    $\sigma$, so $s' \in \val{\forall\alpha[\tau]}{\omega,\xi}{\Gamma}$
    by Lemma~\ref{lem_abstraction_computable}.
  \end{enumerate}
\end{proof}

\begin{lemma}\label{lem_val_subst}
  $\val{\sigma[\subst{\alpha}{\tau}]}{\omega,\xi}{\Gamma} =
  \val{\sigma}{\omega[\subst{\alpha}{\tau}],\xi[\subst{\alpha}{\val{\tau}{\omega,\xi}{\Gamma}}]}{\Gamma}$.
\end{lemma}

\begin{proof}
  TODO
\end{proof}

\begin{lemma}
  $\circ_{\omega(\sigma)} \in \val{\sigma \to \sigma \to
    \sigma}{\omega,\xi}{\Gamma}$ for
  $\circ \in \{ \oplus, \otimes \}$.
\end{lemma}

\begin{proof}
  Follows from Definition~\ref{def_typing} and
  Lemma~\ref{lem_val_computable}.
\end{proof}

\begin{lemma}
  $\flatten_{\omega(\sigma)} \in
  \val{\sigma\to\nat}{\omega,\xi}{\Gamma}$.
\end{lemma}

\begin{proof}
  TODO
\end{proof}

\begin{lemma}
  $\lift_{\omega(\sigma)} \in
  \val{\nat\to\sigma}{\omega,\xi}{\Gamma}$.
\end{lemma}

\begin{proof}
  TODO
\end{proof}

\begin{lemma}
  If $t \in \val{\forall\alpha[\sigma]}{\omega,\xi}{\Gamma}$ then
  $t \tau \in \val{\sigma[\subst{\alpha}{\tau}]}{\omega,\xi}{\Gamma}$
  for any type~$\tau$.
\end{lemma}

\begin{proof}
  By Lemma~\ref{lem_val_computable} the
  set~$\val{\tau}{\omega,\xi}{\Gamma}$ is a candidate of
  type~$\tau$. By hypothesis
  $t \tau \in
  \val{\sigma}{\omega[\subst{\alpha}{\tau}],\xi[\subst{\alpha}{\val{\tau}{\omega,\xi}{\Gamma}}]}{\Gamma}$. Hence
  $t \tau \in \val{\sigma[\subst{\alpha}{\tau}]}{\omega,\xi}{\Gamma}$
  by Lemma~\ref{lem_val_subst}.
\end{proof}

\begin{lemma}\label{lem_typable_computable}
  If $\Gamma \proves t : \sigma$ then
  $\omega(t) \in \val{\sigma}{\omega,\xi}{\Gamma}$.
\end{lemma}

\begin{proof}
  Idea: by induction on~$t$, using the previous lemmas. One
  generalizes the inductive hypothesis to: if
  $x_1 : \tau_1,\ldots,x_n:\tau_n \proves t : \sigma$ then for all
  $u_1\in\val{\tau_1}{\omega,\xi}{\Gamma},\ldots,u_n\in\val{\tau_n}{\omega,\xi}{\Gamma}$
  we have
  $\omega(t[\subst{x_1}{u_1},\ldots,\subst{x_n}{u_n}]) \in
  \val{\sigma}{\omega,\xi}{\Gamma}$.
\end{proof}

\begin{corollary}
  If $\Gamma \proves t : \sigma$ then $t \in \SN$.
\end{corollary}

\begin{proof}
  Follows from Lemma~\ref{lem_typable_computable},
  Lemma~\ref{lem_val_computable} and Definition~\ref{def_candidate}.
\end{proof}

\begin{lemma}
Every term $s \in \Iterms$ with $\FV(s) = \FTV(s) = \emptyset$ reduces
to a unique final interpretation term $s\downarrow$.
\end{lemma}

\begin{proof}
By proving termination and local confluence of $\leadsto$ (although it
actually suffices to only prove local confluence for fully closed terms).

TODO.
\qed
\end{proof}

\begin{lemma}
The only final interpretation terms of type $\nat$ are the natural
numbers.
\end{lemma}

\begin{proof}
  This is~NOT~TRUE. Consider
  $\oplus_{\nat\to\nat} \lift_\nat \lift_\nat n$. Need to add more
  rewrite rules?
  \CK{Better now?} \LC{Yes, I think it works now.}
\end{proof}

\subsection{Defining $\succ$ and $\succeq$}

We will define $\succ$ and $\succeq$ on elements of $\World$, using
coinduction: $s \succ t$ (resp.\ $s \succeq t$) if $s \succ_\sigma t$
(resp.\ $s \succeq_\sigma t$) can be obtained for $\sigma$ the type of
$s,t$, following Definition~\ref{def:succ}.

\begin{definition}\label{def:succ}
  Let $R \in \{ \succ,\succeq \}$. For~$s,t \in \World_\sigma$, the
  relation $s\ R_{\sigma}\ t$ is defined coinductively by the
  following rules.
  \[
    \begin{array}{c}
    \infer={s\ R_\nat\ t}{s\da\ R\ t\da \text{ in natural
        numbers}}\quad\quad
    \infer={s\ R_{\sigma\to\tau}\ t}{\app{s}{q}\ R_{\tau}\ \app{t}{q}
      \text{ for every } q \in \World_\sigma} \\ \\
    \infer={s\ R_{\forall\alpha[\sigma]}\ t}{\tapp{s}{\tau}\ R_{\sigma[\subst{\alpha}{\tau}]}\ \tapp{t}{\tau}
      \text{ for every closed type } \tau}
    \end{array}
  \]
\end{definition}

\CK{Actually, by definition of ``final interpretation terms'' you
don't need to normalise in the natural number case.}

\subsection{Properties of $\succ$ and $\succeq$}

We're going to at least need to see that $\succ$ is a well-founded ordering:

\begin{lemma}
$\succ$ is well-founded.
\end{lemma}

\begin{proof}
  By induction on the size of the type~$\tau$ one shows that there does
  not exist an infinite sequence
  $t_1 \succ_\tau t_2 \succ_\tau t_3 \succ_\tau \ldots$ For instance,
  if
  $t_1 \succ_{\forall\alpha[\tau]} t_2 \succ_{\forall\alpha[\tau]} t_3
  \succ_{\forall\alpha[\tau]} \ldots$ then
  $\tapp{t_1}{\nat} \succ_{\tau[\subst{\alpha}{\nat}]}
  \tapp{t_2}{\nat} \succ_{\tau[\subst{\alpha}{\nat}]} \tapp{t_3}{\nat}
  \succ_{\tau[\subst{\alpha}{\nat}]} \ldots$, which is impossible by
  the inductive hypothesis.
\end{proof}

\begin{lemma}
Both $\succ$ and $\succeq$ are transitive.
\end{lemma}

\begin{proof}
  We show this for~$\succeq$, the proof for~$\succ$ being
  analogous. We proceed by coinduction.

  If $t_1 \succeq_\nat t_2 \succeq_\nat t_3$ then
  $t_1\da \ge t_2\da \ge t_3\da$, so $t_1\da \ge t_3\da$. Thus
  $t_1 \succeq_\nat t_3$.

  If $t_1 \succeq_{\sigma\to\tau}t_2\succeq_{\sigma\to\tau}t_3$ then
  $\app{t_1}{q}\succeq_{\tau}\app{t_2}{q}\succeq_\tau\app{t_3}{q}$ for
  $q \in \World_\sigma$. Hence $\app{t_1}{q}\succeq_\tau\app{t_3}{q}$
  for $q \in \World_\sigma$ by the coinductive hypothesis. Thus
  $t_1\succeq_{\sigma\to\tau} t_3$.

  If $t_1 \succeq_{\forall\alpha[\sigma]}t_2\succeq_{\forall\alpha[\sigma]}t_3$ then
  $\tapp{t_1}{\tau}\succeq_{\sigma[\subst{\alpha}{\tau}]}\tapp{t_2}{\tau}\succeq_{\sigma[\subst{\alpha}{\tau}]}\tapp{t_3}{\tau}$ for
  any closed type~$\tau$. Hence
  $\tapp{t_1}{\tau}\succeq_{\sigma[\subst{\alpha}{\tau}]}\tapp{t_3}{\tau}$
  by the coinductive hypothesis. Thus $t_1\succeq_{\forall\alpha[\sigma]} t_3$.\qed
\end{proof}

And that $\succeq$ is a quasi-ordering:

\begin{lemma}
$\succeq$ is reflexive.
\end{lemma}

\begin{proof}
  By coinduction.\qed
\end{proof}

Finally, they must be compatible:

\begin{lemma}
We have $\succ \cdot \succeq\ \subseteq\ \succ$
\end{lemma}

\begin{proof}
By coinduction, analogous to the transitivity proof.\qed
\end{proof}

I think that's all that absolutely \emph{has} to be proven to make the
argument work.  However, it would be great if we could also for
instance obtain that always $\app{\app{\oplus}{s}}{t} \succeq s$ and
that $\app{\app{\oplus}{s}}{(\app{\lift}{1})} \succ s$.

\LC{I think these also hold by coinduction because they hold for
type~$\nat$. But one needs to generalize the coinductive hypothesis to
$\app{\app{\oplus}{s}}{t} \cdot t_1 \cdot \ldots \cdot t_n
\succeq_\sigma s \cdot t_1 \cdot \ldots \cdot t_n$ (and with some
additional type arguments also).}

\section{Systems of interest and their properties}

The systems of interest are sets of terms with a rewriting relation on
them.  Interestingly, $\Iterms$ can be seen as an instance of this general
scheme.

\subsection{Systems of interest}

Types are built from a set of type constructors, using $\arrtype$ and
$\forall$.

\begin{definition}
We assume given a fixed set $\TypeConstructors$ of \emph{type
constructors}, each paired with an integer \emph{arity} $\geq 0$, as
well as the infinite set $\Typevars$ of type variables.  The set
$\Types$ of types is given by:
\begin{itemize}
\item $\alpha \in \Types$ for all $\alpha \in \Typevars$
\item $\con(\sigma_1,\dots,\sigma_n) \in \Types$ if $(\con,n) \in
  \TypeConstructors$ and $\sigma_1,\dots,\sigma_n \in \Types$
\item $\sigma \arrtype \tau \in \Types$ if $\sigma,\tau \in \Types$
\item $\quant{\alpha}{\sigma} \in \Types$ if $\alpha \in \Typevars$ and
  $\sigma \in \Types$
\end{itemize}
We let $\FTV(\sigma)$ be defined in the obvious way (much like
Definition~\ref{def:itypes}).
\end{definition}

Terms are built from a set of function symbols, using (type) abstraction
and (type) application as for interpretation terms.

\begin{definition}
We assume given a fixed set $\Sigma$ of \emph{function symbols}, each
paired with an arity $n$ and a type $\sigma_1 \arrtype \dots \arrtype
\sigma_n \arrtype \tau$, as well as the infinite set $\Vars$ of variables.
The set $\Terms$ of terms consists of those expressions $s$ such that
$\Gamma \vdash s : \sigma$ can be derived for some type $\sigma$ and
environment $\Gamma$ using the following clauses:
\begin{itemize}
\item $\Gamma \vdash x : \sigma$ for every $(x : \sigma) \in \Gamma$.
\item $\Gamma \vdash \mathtt{f}(s_1,\dots,s_n) : \tau$ if
  $(\mathtt{f} : (n,\sigma_1 \arrtype \dots \arrtype \sigma_n \arrtype
  \tau))$ in $\Sigma$ and $\Gamma \vdash s_i : \sigma_i$ for $1 \leq
  i \leq n$
\item $\Gamma \vdash \abs{x:\sigma}{s} : \sigma \arrtype \tau$ if $x
  \in \Vars$ and $\Gamma \uplus \{ x : \sigma \} \vdash s : \tau$.
\item $\Gamma \vdash \tabs{\alpha}{s} : \quant{\alpha}{\sigma}$ if
  $\alpha \in \Typevars$ and $\Gamma \vdash s : \sigma$ and for all
  $(x : \tau) \in \Gamma$: $\alpha \notin \FTV(\tau)$
\item $\Gamma \vdash \tapp{s}{\tau} : \sigma[\subst{\alpha}{\tau}]$ if
  $\Gamma \vdash s : \quant{\alpha}{\sigma}$
\end{itemize}
\end{definition}

Note that there is no explicit application; systems which include a form
of application should be modelled simply using a set of symbols $\{
@_{\sigma,\tau}: (2,(\sigma \arrtype \tau) \arrtype \sigma \arrtype \tau)
\mid \sigma,\tau \in \Types \} \subseteq \Sigma$.

\CK{are there interesting systems where the type application $*$ is
not the only way for types to appear in terms?  If so, we might as well
not have the exceptional case, easier to go general straight away.}

\LC{yes, e.g., when you have explicit existential quantification over
types, like in urzy\_emb.}

I'm thinking that maybe here it will be easier to just go with
system $F_\omega$ from the beginning instead of system~$F$, because
there you have in-built type constructors.

\CK{describe what rules look like.  Are the cases where substitution
/ type substitution is used limited to a few special cases (in which
case we can just add those cases as special) or is it very typical?}

\LC{(type) substitution occurs with more rules, in e.g. urzy\_emb}

Should we describe rules using variables which are instantiated, or
simply assume that typical systems have infinitely many rules (e.g.,
all instances of $\beta$-reductions are a separate rule)? We're
already using infinite signatures -- should we head straight for
polymorphism?

\subsubsection{Some example systems.}

TODO: describe here how system F and urzy\_emb can be seen as instances
of this general case.

\subsection{Interpreting interesting terms}

To start, all types must be mapped to interesting types.  This is
easily done:

\begin{definition}
A \emph{type constructor mapping} is a function $\Typemap$ which assigns
to each $(\con:n) \in \TypeConstructors$ a type $\sigma$ with
$\FTV(\sigma) \subseteq \{ \alpha_1,\dots,\alpha_n \}$.  A type
constructor mapping is extended to a function operating on types as
follows:
\[
\begin{array}{rcl}
\Typemap(\alpha) & = & \alpha \\
\Typemap(\con(\sigma_1,\dots,\sigma_n)) & = &
  \tau[\alpha_1:=\Typemap(\sigma_1),\dots,\alpha_n:=\Typemap(\sigma_n)]\ 
  \text{if}\ \Typemap(\con) = \tau \\
\Typemap(\sigma \arrtype \tau) & = & \Typemap(\sigma) \arrtype
  \Typemap(\tau) \\
\Typemap(\quant{\alpha}{\sigma}) & = & \quant{\alpha}{\Typemap(\sigma)} \\
\end{array}
\]
\end{definition}

Clearly, a type constructor mapping maps types to interpretation types,
and $\FTV(\Typemap(\sigma)) \subseteq \FTV(\sigma)$.

Terms are mapped to interpretation terms in a very similar way:

\begin{definition}
A \emph{symbol mapping} is a function $\Termmap$ which assigns to each
$(\mathtt{f}:(n,\sigma)) \in \Sigma$ a final interpretation term
$\Termmap(\mathtt{f})$ of the form $\abs{x_1:\sigma_1 \dots x_n:
\sigma_n}{t}$, such that $\emptyset \vdash \Termmap(\mathtt{f}) :
\Typemap(\sigma)$.  Considering $\Termmap$ fixed, we define the
\emph{interpretation} of each term $s$, $\interpret{s}$, as follows:
\[
\begin{array}{rcl}
\interpret{x} & = & x \\
\interpret{\mathtt{f}(s_1,\dots,s_n)} & = &
  t[x_1:=\interpret{s_1},\dots,x_n:=\interpret{s_n}]\ \text{if}\ 
  \Termmap(\mathtt{f}) = \abs{x_1:\sigma_1 \dots x_n:\sigma_n}{t} \\
\interpret{\abs{x:\sigma}{s}} & = & \abs{x:\Termmap(\sigma)}{
  \interpret{s}} \\
\interpret{\tabs{\alpha}{s}} & = & \tabs{\alpha}{\interpret{s}} \\
\interpret{\tapp{s}{\tau}} & = & \tapp{\interpret{s}}{\Termmap(\tau)} \\
\end{array}
\]
\end{definition}

TODO: prove that this indeed maps to well-typed interpretation terms of
the expected type.

TODO: observe that this choice does not really allow us to order the
type instantiation rule with $\succ$, just with $\succeq$.  However, this
isn't actually a problem since, if all other rules can be removed, we have
termination anyway.  However, we could allow for a custom interpretation
there as well, or consider the $*$ merely one case of a more general kind
of function symbol.

\subsection{Monotonicity}

This relies on the definition of rules (a form of stability may also be
required), but we really want to have that if $\interpret{\ell} \succ
\interpret{r}$ for some rule, then $\interpret{s} \succ \interpret{t}$
whenever $s \arr{\Rules} t$ by that rule.

\section{Some useful lemmas}

\subsection{Orienting $\beta$-reduction}

\subsection{Orienting type instantiation}

\subsection{Other}

\section{Some system of interest -- urzy\_emb?}

\subsection{Interpretations}

\subsection{Rule orientation}

\end{document}

