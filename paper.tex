\documentclass[runningheads,a4paper]{llncs}
\pdfoutput=1

\bibliographystyle{plainurl}

\usepackage{amssymb}
\setcounter{tocdepth}{3}
\usepackage{enumerate}
\usepackage[colorlinks=true]{hyperref}
\usepackage{tikz}
\usepackage{xcolor,latexsym,amsmath,extarrows,alltt}
\usepackage{xspace}
\usepackage{booktabs}
\usepackage{mathtools}
\usepackage{stmaryrd}
\usepackage{microtype}
\usepackage{enumitem}
\usepackage{multirow}
\usepackage{proof}
\usepackage[T1]{fontenc}

\newcommand{\Fomega}{\mathtt{F}_\omega}

\newcommand{\Iterms}{\mathcal{I}}
\newcommand{\World}{\mathcal{W}}
\newcommand{\Rules}{\mathcal{R}}
\newcommand{\Typevars}{\mathcal{A}}
\newcommand{\Vars}{\mathcal{V}}
\newcommand{\ITypes}{\mathcal{Y}}
\newcommand{\Types}{\mathcal{T}}
\newcommand{\Terms}{\mathcal{T}\!\mathit{erms}}
\newcommand{\TypeConstructors}{\mathcal{C}}
\newcommand{\TypeQuantifiers}{\mathcal{Q}}
\newcommand{\Typemap}{\mathcal{T\!M}}
\newcommand{\Termmap}{\mathcal{J}}
\newcommand{\succinterpret}{\succ^{\llbracket\rrbracket}}
\newcommand{\succeqinterpret}{\succeq^{\llbracket\rrbracket}}

\newcommand{\cl}{\mathcal{C}}
\newcommand{\dom}{\mathrm{dom}}
\newcommand{\nf}{\mathrm{nf}}

\newcommand{\quant}[2]{\forall #1[#2]}
\newcommand{\qquant}[3]{#1 #2[#3]}
\newcommand{\typeinterpret}[1]{\llbracket #1 \rrbracket}
\newcommand{\interpret}[1]{\llbracket #1 \rrbracket}
\newcommand{\itp}[1]{\llbracket #1 \rrbracket}
\newcommand{\arr}[1]{\longrightarrow_{#1}}
\newcommand{\red}{\longrightarrow}
\newcommand{\arrtype}{\rightarrow}
\newcommand{\arrkind}{\Rightarrow}
\newcommand{\abs}[2]{\lambda #1.#2}
\newcommand{\tabs}[2]{\Lambda #1.#2}
\newcommand{\abstraction}[2]{\backslash #1.#2}
\newcommand{\app}[2]{#1 \cdot #2}
\newcommand{\apps}[3]{#1 \cdot #2 \cdots #3}
\newcommand{\tapp}[2]{#1 * #2}
\newcommand{\pair}[2]{\langle #1,#2 \rangle}
\newcommand{\subst}[2]{#1:=#2}
\newcommand{\meta}[2]{#1\langle#2\rangle}

\newcommand{\FTV}{\mathrm{FTV}}
\newcommand{\FV}{\mathrm{FV}}
\newcommand{\Tc}{\mathcal{T}}
\newcommand{\Vc}{\mathcal{V}}

\newcommand{\nat}{\mathtt{nat}}
\newcommand{\proj}{\pi}
\newcommand{\flatten}{\mathtt{flatten}}
\newcommand{\lift}{\mathtt{lift}}
\newcommand{\con}{\mathtt{c}}
\newcommand{\afun}{\mathtt{f}}

\newcommand{\ur}{\upharpoonright}
\newcommand{\da}{\mathord{\downarrow}}
\newcommand{\SN}{\mathrm{SN}}
\newcommand{\Cb}{\mathbb{C}}
\newcommand{\Nbb}{\mathbb{N}}
\newcommand{\val}[3]{\ensuremath{\llbracket#1\rrbracket_{#2}^{#3}}}
\newcommand{\proves}{\vdash}

\newcommand{\CK}[1]{\textcolor{blue}{CK: #1}}
\newcommand{\CKchange}[1]{\textcolor{blue}{#1}}
\newcommand{\LC}[1]{\textcolor{purple}{LC: #1}}

\begin{document}

\mainmatter

\title{Polymorphic Higher-Order Termination}

\author{{\L}ukasz Czajka and Cynthia Kop}
\authorrunning{{\L}. Czajka and C. Kop}
\institute{
Faculty of Informatics, TU Dortmund
\\
Institute of Computer Science, Radboud University Nijmegen (RU)
\\
\email{lukaszcz@mimuw.edu.pl}
\quad\quad\quad
\email{C.Kop@cs.ru.nl}
}

\maketitle

\begin{abstract}
\end{abstract}

\section{Introduction}

\section{Preliminaries}\label{sec_preliminaries}

In this section we introduce the System~$\Fomega$ (see e.g.,
Sorensen, Urzyczyn, ``Lectures on the Curry-Howard Isomorphism'',
Section~11.7.), which will form a basis both of our interpretations
and of a general syntax for the investigated systems.

First, we define the set of types.

\begin{definition}\label{def_types}\normalfont
  \emph{Kinds} are defined inductively:
  \begin{itemize}
  \item $*$ is a kind,
  \item if $\kappa_1,\kappa_2$ are kinds then so is $\kappa_1 \arrkind
    \kappa_2$.
  \end{itemize}

  We assume infinitely many \emph{type constructor variables} of each
  kind. Variables of kind~$*$ are \emph{type variables}.

  We assume a fixed set~$\Sigma_T$ of \emph{type constructor symbols}
  paired with a kind, denoted $c : \kappa$. Every type constructor
  symbol~$c$ occurs with only one kind declaration.

  We define \emph{type constructors} of kind~$\kappa$ by induction.
  Type constructors of kind~$*$ are called \emph{types}.
  \begin{itemize}
  \item A type constructor variable of kind~$\kappa$ is a type
    constructor of kind~$\kappa$.
  \item A type constructor symbol of kind~$\kappa$ is a type
    constructor of kind~$\kappa$.
  \item If $\varphi$ is a type constructor of kind $\kappa_1 \arrkind
    \kappa_2$ and $\psi$ is a type constructor of kind~$\kappa_1$ then
    $\varphi \psi$ is a type constructor of kind~$\kappa_2$.
  \item If $\alpha$ is a type constructor variable of kind~$\kappa_1$
    and $\varphi$ is a type constructor of kind~$\kappa_2$, then
    $\lambda\alpha . \varphi$ is a type constructor of kind $\kappa_1
    \arrkind \kappa_2$.
  \item If $\alpha$ is a type constructor variable of kind~$\kappa$
    and~$\tau$ is a type, then $\forall \alpha[\tau]$ is a type.
  \item If $\tau_1,\tau_2$ are types, then $\tau_1 \arrtype \tau_2$ is
    a type.
  \end{itemize}
  The set of type constructors of kind~$\kappa$ is denoted
  by~$\Tc_\kappa$.

  We use the notation $\forall \alpha . \tau$. When $\alpha$ is of
  kind $\kappa$ then we use the notations
  $\forall \alpha : \kappa . \tau$ and
  $\forall (\alpha : \kappa)[\tau]$. These are all just different
  notations used for convenience.

  We treat type constructors up to $\alpha$-conversion. Note
  that~$\forall$ binds variables.

  Beta-reduction on type constructors is defined as the compatible
  closure of the rule
  \[
  (\lambda\alpha.\varphi)\psi \to \varphi[\alpha := \psi]
  \]
  Note that type constructors are essentially simply-typed
  lambda-terms, so beta-reduction on type constructors terminates and
  is confluent, hence every type constructor~$\tau$ has a unique
  beta-normal form~$\nf_\beta(\tau)$. A \emph{type atom} is a type in
  $\beta$-normal form which is not an arrow $\tau_1\arrtype\tau_2$ or
  a quantification $\forall\alpha\tau$.

  We define $\FV(\varphi)$ -- the set of free type constructor
  variables of the type constructor~$\varphi$ -- in an obvious way by
  induction on the structure of~$\varphi$. A type
  constructor~$\varphi$ is \emph{closed} if
  $\FV(\varphi) = \emptyset$.
\end{definition}

Terms are built from a set of function symbols, using abstraction and
application.

\begin{definition}\label{def_preterms}\normalfont
  We assume given an infinite set $\Vars$ of variables, and let
  $\Gamma$ refer to a mapping from a finite subset of $\Vars$ to the
  set of types.

  We assume given a fixed set $\Sigma$ of \emph{function symbols},
  each paired with a type, denoted $\mathtt{f} : \tau$.  Every
  function symbol $\mathtt{f}$ occurs only with one type declaration.

  The set of preterms consists of all expressions $s$ such that
  $\Gamma \vdash s : \sigma$ can be inferred for some type $\sigma$
  and mapping $\Gamma$ by the following clauses:
  \begin{itemize}
  \item $\Gamma \vdash n : \nat$ for every natural number $n$.
  \item $\Gamma \vdash x : \sigma$ for every $(x : \sigma) \in \Gamma$.
  \item $\Gamma \vdash \mathtt{f} : \sigma$ for all
    $(\mathtt{f} : \sigma) \in \Sigma$.
  \item $\Gamma \vdash \abs{x:\sigma}{s} : \sigma \arrtype \tau$ if $x
    \in \Vars$ and $\Gamma \uplus \{ x : \sigma \} \vdash s : \tau$.
  \item $\Gamma \vdash \tabs{\alpha}{s} : \quant{\alpha}{\sigma}$ if
    $\alpha$ is a type constructor variable and $\Gamma \vdash s :
    \sigma$ and for all $(x : \tau) \in \Gamma$: $\alpha \notin
    \FV(\tau)$
  \item $\Gamma \vdash \app{s}{t} : \tau$ if $\Gamma \vdash s : \sigma
    \arrtype \tau$ and $\Gamma \vdash t : \sigma$
  \item $\Gamma \vdash \tapp{s}{\tau} : \sigma[\subst{\alpha}{\tau}]$
    if $\Gamma \vdash s : \quant{(\alpha:\kappa)}{\sigma}$ and~$\tau$
    is a type constructor of kind~$\kappa$,
  \item $\Gamma \vdash s : \tau$ if $\Gamma \vdash s : \tau'$ and
    $\tau =_\beta \tau'$.
  \end{itemize}
  The set of free variables of a preterm~$t$, denoted $\FV(t)$, is
  defined in the expected way. Analogously, we define the
  set~$\FTV(t)$ of type constructor variables occurring free
  in~$t$. We say that $t$ is \emph{closed} if $\FV(t) = \emptyset$ and
  $\FTV(t) = \emptyset$.
\end{definition}

If $\alpha$ is a type constructor variable of kind~$\kappa$ then we
use the notation $\tabs{\alpha:\kappa}{t}$.

Note that for a given $\Gamma$, if $s$ is typable under $\Gamma$, then
there is only one choice for the type modulo $\beta$-conversion (this
is easily proved by induction on the form of $s$). Thus, all closed
preterms have a unique type modulo $\beta$-conversion.

\begin{definition}\label{def_type_equiv}
  We define the type equivalence relation~$\equiv$ on preterms by
  induction on preterm structure.
  \begin{itemize}
  \item $x \equiv x$, $n \equiv n$,
  \item if $\sigma =_\beta \tau$ then $f_\sigma \equiv f_\tau$ for
    $f \in \Sigma$,
  \item if $\sigma =_\beta \tau$ and $s \equiv t$ then
    $\abs{x:\sigma}{s} \equiv \abs{x:\tau}{t}$,
  \item if $s \equiv t$ then $\tabs{\alpha}{s} \equiv
    \tabs{\alpha}{t}$,
  \item if $s \equiv s'$ and $t \equiv t'$ then $s \cdot t \equiv s'
    \cdot t'$,
  \item if $s \equiv t$ and $\sigma =_\beta \tau$ then
    $\tapp{s}{\sigma} \equiv \tapp{t}{\tau}$.
  \end{itemize}
  In other words, $s \equiv t$ iff $s$ and $t$ are identical modulo
  $\beta$-conversion in types.
\end{definition}

Note that~$\equiv$ is an equivalence relation.

\begin{lemma}
  If $\Gamma \vdash s : \tau$ and $s \equiv t$ then $\Gamma \vdash t :
  \tau$.
\end{lemma}

\begin{proof}
  Induction on~$s$.
\end{proof}

The set of terms is now defined as follows.

\begin{definition}\label{def_terms}\normalfont
  The set of \emph{terms} is the set of the equivalence classes
  of~$\equiv$.
\end{definition}

Because $\beta$-reduction on types is confluent and terminating, every
term has a canonical preterm representative -- the one with all types
occurring in it $\beta$-normalized. We say that a term is
\emph{closed} if its canonical representative is. We define $\FTV(t)$
as the value of~$\FTV$ on the canonical representative of~$t$.

Because typing and term formation operations (abstraction,
application, \ldots) are invariant under~$\equiv$, we may denote terms
by their (canonical) representatives and informally treat them
interchangeably.

We will often abuse notation to omit $\cdot$ and $*$. Thus, $s t$ can
refer to both $\app{s}{t}$ and $\tapp{s}{t}$. This is not ambiguous
due to typing. We will also use $\abstraction{a}{s}$ for either
$\abs{a}{s}$ or $\tabs{a}{s}$, depending on typing.

\begin{definition}\label{def_chi_kappa}\normalfont
  By induction on the kind~$\kappa$ we define a closed type
  constructor~$\chi_\kappa$. For $\kappa=*$ we take $\chi_\kappa =
  \nat$. For $\kappa=\kappa_1\arrkind\kappa_2$ we take $\chi_\kappa =
  \lambda \alpha:\kappa_1 . \chi_{\kappa_2}$.
\end{definition}

\begin{lemma}[Substitution lemma]
  \begin{enumerate}
  \item If $\Gamma \uplus \{ x : \sigma \} \vdash s : \tau$ and
    $\Gamma \proves t : \sigma$ then
    $\Gamma \proves s[\subst{x}{t}] : \tau$.
  \item If $\Gamma \proves t : \sigma$ and~$\tau$ is a type
    constructor of the same kind as the variable~$\alpha$ then
    $\Gamma[\subst{\alpha}{\tau}] \proves t[\subst{\alpha}{\tau}] :
    \sigma[\subst{\alpha}{\tau}]$.
  \end{enumerate}
\end{lemma}

\begin{proof}
  Induction on the typing derivation.
\end{proof}

\begin{lemma}[Generation lemma]
  Assume $\Gamma \proves t : \sigma$ and let
  $\Vc = \FV(\sigma) \cup \FTV(t) \cup \FTV(\Gamma)$. Then there is a
  type~$\sigma'$ such that $\sigma' =_\beta \sigma$ and
  $\FV(\sigma') \subseteq \Vc$ and one of the following holds.
  \begin{itemize}
  \item $t$ is a natural number and $\sigma' = \nat$.
  \item $t \equiv x$ is a variable and $(x : \tau) \in \Gamma$ and $\tau
    =_\beta \sigma'$.
  \item $t \equiv \mathtt{f}$ is a function symbol with $\mathtt{f} :
    \sigma'$ the following set: $\{ \oplus_{\tau} : \tau \arrtype \tau
    \arrtype \tau,\ \otimes_{\tau} : \tau \arrtype \tau \arrtype
    \tau,\ \flatten_{\tau} : \tau \arrtype \nat,\ \lift_{\tau} : \nat
    \arrtype \tau \}$ for some type~$\tau$.
  \item $t \equiv \abs{x:\tau_1}{s}$ and
    $\sigma'=\tau_1\arrtype\tau_2$ and $\Gamma \uplus \{ x : \tau_1 \}
    \vdash s : \tau_2$.
  \item $t \equiv \tabs{\alpha}{s}$ and
    $\sigma' = \quant{\alpha}{\tau}$ and $\Gamma \vdash s : \tau$ and
    for all $(x : \rho) \in \Gamma$: $\alpha \notin \FV(\rho)$.
  \item $t \equiv \app{t_1}{t_2}$ and
    $\Gamma \vdash t_1 : \tau \arrtype \sigma'$ and
    $\Gamma \vdash t_2 : \tau$ and $\FV(\tau) \subseteq \Vc$.
  \item $t \equiv \tapp{s}{\tau}$ and
    $\sigma' = \rho[\subst{\alpha}{\tau}]$ and
    $\Gamma \vdash s : \quant{(\alpha:\kappa)}{\rho}$ and~$\tau$ is a
    type constructor of kind~$\kappa$.
  \end{itemize}
\end{lemma}

\begin{proof}
  By induction on the derivation $\Gamma \proves t : \sigma$, using
  the substitution lemma. Note that if $\alpha \notin \Vc$ is of
  kind~$\kappa$ and e.g.~$\Gamma \proves s : \sigma'$ with~$s$ a
  subterm of~$t$, then
  $\Gamma \proves s : \sigma'[\subst{\alpha}{\chi_\kappa}]$ by the
  substitution lemma (see Definition~\ref{def_chi_kappa}).
\end{proof}

\section{Interpretations}

In this section we define the set~$\Iterms$ of interpretation terms,
and the relations~$\succ$ and~$\succeq$ on~$\Iterms$. We also define
the set~$\World$ of final interpretation terms as the setall closed
interpretation terms normalized with a certain reduction relation.

\subsection{Defining the sets~$\Iterms$ and~$\World$}\label{sec_world}

\subsubsection{Interpretation terms}

\begin{definition}\label{def_iterms}\normalfont
  The set~$\ITypes$ of \emph{interpretation types} is the set of types
  as in Definition~\ref{def_types} with $\Sigma_T = \{ \nat : * \}$,
  i.e., there is a single type constant~$\nat$.

  The set~$\Iterms$ of \emph{interpretation terms} is the set of terms
  from Definition~\ref{def_terms} (see also
  Definition~\ref{def_preterms}) where as types we take the
  interpretation types and as the set~$\Sigma$ of function symbols we
  take:
  \[
    \begin{array}{rcl}
      \Sigma &=& \{ \oplus_\sigma : \sigma \arrtype
                 \sigma \arrtype \sigma,\\ & & \otimes_\sigma : \sigma \arrtype \sigma
                 \arrtype \sigma,\\ & & \flatten_{\sigma} : \sigma \arrtype
                 \nat,\\ & & \lift_{\sigma} : \nat \arrtype \sigma \mid \sigma \in \ITypes
                 \}
    \end{array}
  \]
\end{definition}

To define the world of \emph{final interpretation terms}, we will
normalise certain elements of $\Iterms$ using the relation $\leadsto$.

\begin{definition}
  We define the relation $\leadsto$ on interpretation terms as the
  smallest relation for which the following properties are satisfied:
  \begin{enumerate}
  \item\label{leadsto:mono:abs}
    if $s \leadsto t$ then both $\abs{x}{s} \leadsto \abs{x}{t}$ and
    $\tabs{\alpha}{s} \leadsto \tabs{\alpha}{t}$
  \item\label{leadsto:mono:right}
    if $s \leadsto t$ then $\app{u}{s} \leadsto \app{u}{t}$
  \item\label{leadsto:mono:left}
    if $s \leadsto t$ then both $\app{s}{u} \leadsto \app{t}{u}$ and
    $\tapp{s}{\sigma} \leadsto \tapp{t}{\sigma}$
  \item\label{leadsto:beta:abs} $\app{(\abs{x:\sigma}{s})}{t} \leadsto
    s[\subst{x}{t}]$
  \item\label{leadsto:beta:tabs} $\tapp{(\tabs{\alpha}{s})}{\sigma}
    \leadsto s[\subst{\alpha}{\sigma}]$.
  \item\label{leadsto:plus:base}
    $\app{\app{\oplus_{\nat}}{n}}{m} \leadsto (n+m)$
  \item\label{leadsto:times:base} $\app{\app{\otimes_{\nat}}{n}}{m}
    \leadsto (n \cdot m)$
  \item\label{leadsto:circ:arrow} $\app{\app{\circ_{\sigma \arrtype
        \tau}}{s}}{t} \leadsto
    \abs{x:\sigma}{\app{\app{\circ_\tau}{(\app{s}{x})}}{(\app{t}{x})}}$
    for $\circ \in \{ \oplus, \otimes \}$
  \item\label{leadsto:circ:forall}
    $\app{\app{\circ_{\quant{\alpha}{\sigma}}}{s}}{t} \leadsto
    \tabs{\alpha}{\app{\app{\circ_\sigma}{(\tapp{s}{\alpha})}}{(
        \tapp{t}{\alpha})}}$ for $\circ \in \{ \oplus, \otimes \}$
  \item $\app{\flatten_\nat}{s} \leadsto s$
  \item $\app{\flatten_{\sigma \arrtype \tau}}{s} \leadsto
    \app{\flatten_\tau}{(\app{s}{(\app{\lift_\sigma}{0})})}$
  \item $\app{\flatten_{\quant{\alpha:\kappa}{\sigma}}}{s} \leadsto
    \app{\flatten_{\sigma[\subst{\alpha}{\chi_\kappa}]}}{(\tapp{s}{\chi_\kappa})}$
  \item $\app{\lift_\nat}{s} \leadsto s$
  \item $\app{\lift_{\sigma \arrtype \tau}}{s} \leadsto
    \abs{x:\sigma}{\app{\lift_{\tau}}{s}}$
  \item $\app{\lift_{\quant{\alpha}{\sigma}}}{s} \leadsto
    \tabs{\alpha}{\app{\lift_{\sigma}}{s}}$
  \end{enumerate}
  Note that the above rules are invariant under~$\equiv$ (by
  confluence of $\beta$-reduction on types), so they correctly define
  a relation on interpretation terms -- the equivalence classes
  of~$\equiv$.

  We say that $s$ is a \emph{redex} if $s$ reduces by one of the rules
  (\ref{leadsto:plus:base}).

  A \emph{final interpretation term} is an interpretation term
  $s \in \Iterms$ such that (a) $s$ is closed, and (b) $s$ is in
  normal form with respect to $\leadsto$.  We let $\World$ be the set
  of all final interpretation terms. By~$\World_\tau$ we denote the
  set of all final interpretation terms of interpretation type~$\tau$.
\end{definition}

In the remainder of this section, we shall often speak simply of
``terms'' and ``types'' when referring to interpretation terms and
interpretation types.

\subsubsection{Key properties of $\leadsto$}

\begin{lemma}[Subject reduction]
  If $\Gamma \vdash t : \tau$ and $t \leadsto t'$ then
  $\Gamma \vdash t' : \tau$.
\end{lemma}

\begin{proof}
  By induction on the definition of $t \leadsto t'$, using the
  generation and substitution lemmas.
\end{proof}

By~$\SN$ we denote the set of all terminating interpretation
terms. For $t \in \SN$ by~$\nu(t)$ we denote the length of the longest
reduction starting at~$t$.

The following lemma is obvious, but worth stating explicitly.

\begin{lemma}\label{lem_reduce_abs}
  If $\abstraction{a}{s} \leadsto^* t$, then $t = \abstraction{a}{t'}$
  and $s \leadsto^* t'$.  If $s \in \SN$ then both $\abs{x}{s}$ and
  $\tabs{\alpha}{s}$ are also in $\SN$.
\end{lemma}

\begin{proof}
  We observe that every reduct of $\abstraction{x}{s}$ has the form
  $\abstraction{x}{s'}$ with $s \leadsto s'$, and analogously for
  $\tabs{\alpha}{s}$.  Thus, the first statement follows by induction
  on the length of the reduction $\abstraction{a}{s} \leadsto^* t$,
  and the second statement by induction on $\nu(s)$.  \qed
\end{proof}

\begin{lemma}\label{lem_circ_sn_base}
  If $t_1,t_2 \in \SN$ then $\circ_\nat t_1 t_2 \in \SN$ for $\circ
  \in \{\oplus,\otimes\}$.
\end{lemma}

\begin{proof}
  By induction on $\nu(t_1) + \nu(t_2)$. Assume $t_1,t_2 \in \SN$. To
  prove $\circ_\nat t_1 t_2 \in \SN$ it suffices to show $s \in \SN$
  for all~$s$ such that $\circ_\nat t_1 t_2 \leadsto s$. If $s =
  \circ_\nat t_1' t_2$ or $s = \circ_\nat t_1 t_2'$ with $t_i \leadsto
  t_i'$ then we complete by the induction hypothesis. Otherwise $s \in
  \mathbb{N}$ is obviously in $\SN$.  \qed
\end{proof}

\subsubsection{Computability}

In the rest of this section we adapt Girard's method of candidates
(which itself is based on Tait's computability method) to prove
termination of~$\leadsto$. The proof is an adaptation of chapters~6
and~14 from the book ``Proofs and Types'' by Girard, and chapters~10
and~11 from the book ``Lectures on the Curry-Howard Isomorphism'' by
Sorensen and Urzyczyn. An important difference with system~$\Fomega$
and related ones is that the rules for $\oplus_\tau$, $\otimes_\tau$,
$\flatten_\tau$ and $\lift_\tau$ depend on the type~$\tau$. In
particular, type substitution in terms may create redexes. For
instance, if $\alpha$ is a type variable then $\oplus_\alpha t_1 t_2$
is not a redex, but $\oplus_{\sigma\arrtype\tau} t_1 t_2$ is. This
makes adapting the computability method a bit more difficult.

For the termination proof we assume without loss of generality that
the terms are given in orthodox Church-style, i.e., instead of using
contexts we assume that each variable occurrence is annotated with a
type (where two occurrences of the same variable must be annotated
with the same type). It suffices to prove termination on orthodox
Church-style typed terms, because any infinite reduction on an
interpretation term induces an infinite reduction on a corresponding
orthodox Church-style typed term.

We denote an occurrence of a variable~$x$ annotated with a type~$\tau$
by~$x^\tau$. So now e.g.~$\lambda x : \tau\arrtype\sigma
. x^{\tau\arrtype\sigma}y^\tau$ is an orthodox Church-style typed
term. When clear or irrelevant, we omit the type annotations for
readability, denoting the above term by~$\lambda x :
\tau\arrtype\sigma . x y$ or even~$\lambda x . x y$. Note that now
type substitution also needs to change the type annotations. Also,
each term has a unique type modulo $\beta$-conversion. We write $t :
\tau$ if $t$ has type~$\tau$. The generation and subject reduction
lemmas still holds for orthodox Church-style typed terms.

\begin{definition}\label{def_candidate}\normalfont
  A term~$t$ is \emph{neutral} if there does not exist a sequence of
  terms and types~$u_1,\ldots,u_n$ with $n \ge 1$ such that $t u_1
  \ldots u_n$ is a redex (by~$\leadsto$).

  By induction on the kind~$\kappa$ of a type constructor~$\tau$ we
  define the set~$\Cb_\tau$ of all candidates of type
  constructor~$\tau$.

  First assume $\kappa=*$, i.e., $\tau$ is a type. A set~$X$ of
  interpretation terms of type~$\tau$ is a \emph{candidate of
    type~$\tau$} when:
  \begin{enumerate}
  \item $X \subseteq \SN$;
  \item if $t \in X$ and $t \leadsto t'$ then $t' \in X$;
  \item if $t$ is neutral and for every~$t'$ with $t \leadsto t'$ we
    have $t' \in X$, then $t \in X$;
  \item if $t_1,t_2 \in X$ then $\circ_\tau t_1 t_2 \in X$ for
    $\circ \in \{\oplus,\otimes\}$;
  \item if $t \in \SN$ and $t : \nat$ then $\lift_\tau t \in X$;
  \item if $t \in X$ then $\flatten_\tau t \in \SN$.
  \end{enumerate}
  Note that item~3 above implies:
  \begin{itemize}
  \item if $t$ is neutral and in normal form then $t \in X$.
  \end{itemize}

  Now assume $\kappa = \kappa_1\arrkind\kappa_2$. A function $f :
  \Tc_{\kappa_1} \times \bigcup_{\xi\in\Tc_{\kappa_1}}\Cb_\xi \to
  \bigcup_{\xi\in\Tc_{\kappa_2}}\Cb_\xi$ is a \emph{candidate of type
    constructor~$\tau$} if for every closed type constructor~$\sigma$
  of kind~$\kappa_1$ and a candidate $X \in \Cb_\sigma$ we have
  $f(\sigma,X) \in \Cb_{\tau\sigma}$.
\end{definition}

Note that the elements of a candidate of type~$\tau$ are required to
have type~$\tau$.

\begin{lemma}\label{lem_beta_candidate}
  If $\sigma =_\beta \sigma'$ then $\Cb_\sigma = \Cb_{\sigma'}$.
\end{lemma}

\begin{proof}
  Induction on the kind of~$\sigma$.
\end{proof}

\begin{definition}\label{def_computability_valuation}\normalfont
  Let $\omega$ be a mapping from type constructor variables to type
  constructors (respecting kinds). The mapping~$\omega$ extends in an
  obvious way to a mapping from type constructors to type
  constructors. A mapping~$\omega$ is \emph{closed for~$\sigma$} if
  $\omega(\alpha)$ is closed for $\alpha \in \FV(\sigma)$ (then
  $\omega(\sigma)$ is closed).

  An \emph{$\omega$-valuation} is a mapping~$\xi$ from type
  constructor variables to candidates such that $\xi(\alpha) \in
  \Cb_{\omega(\alpha)}$.

  For each type constructor~$\sigma$, each mapping~$\omega$ closed
  for~$\sigma$, and each $\omega$-valuation~$\xi$, the set
  $\val{\sigma}{\xi}{\omega}$ is defined by induction on~$\sigma$:
  \begin{itemize}
  \item $\val{\alpha}{\xi}{\omega} = \xi(\alpha)$ for a type
    constructor variable~$\alpha$,
  \item $\val{\nat}{\xi}{\omega}$ is the set of all terms~$t \in \SN$
    such that $t : \nat$,
  \item $\val{\sigma \arrtype \tau}{\xi}{\omega}$ is the set of all
    terms~$t$ such that $t : \omega(\sigma\arrtype\tau)$ and for
    every~$s \in \val{\sigma}{\xi}{\omega}$ with $s : \omega(\sigma)$
    we have $\app{t}{s} \in \val{\tau}{\xi}{\omega}$,
  \item $\val{\forall(\alpha:\kappa)[\sigma]}{\xi}{\omega}$ is the set
    of all terms~$t$ such that $t : \omega(\forall\alpha[\sigma])$ and
    for every closed type constructor~$\varphi$ of kind~$\kappa$ and
    every $X \in \Cb_\varphi$ we have $\tapp{t}{\varphi} \in
    \val{\sigma}{\xi[\subst{\alpha}{X}]}{\omega[\subst{\alpha}{\varphi}]}$,
  \item
    $\val{\varphi \psi}{\xi}{\omega} =
    \val{\varphi}{\xi}{\omega}(\omega(\psi),\val{\psi}{\xi}{\omega})$,
  \item
    $\val{\lambda(\alpha:\kappa)\varphi}{\xi}{\omega}(\psi,X) =
    \val{\varphi}{\xi[\subst{\alpha}{X}]}{\omega[\subst{\alpha}{\psi}]}$
    for closed $\psi \in \Tc_\kappa$ and $X \in \Cb_\psi$.
  \end{itemize}
  In the above, if e.g.~$\val{\psi}{\xi}{\omega} \notin
  \Cb_{\omega(\psi)}$ then $\val{\varphi \psi}{\xi}{\omega}$ is
  undefined.
\end{definition}

If~$\varphi$ is closed then $\omega,\xi$ do not affect the value
of~$\val{\varphi}{\xi}{\omega}$, so then we simply
write~$\val{\varphi}{}{}$.

\begin{lemma}\label{lem_nat_computable}
  $\val{\nat}{}{} \in \Cb_{\nat}$.
\end{lemma}

\begin{proof}
  We check the conditions in Definition~\ref{def_candidate}.
  \begin{enumerate}
  \item $\val{\nat}{}{} \subseteq \SN$ follows
    directly from Definition~\ref{def_computability_valuation}.
  \item Let $t \in \val{\nat}{}{}$ and $t \leadsto t'$. Then $t :
    \nat$ and $t \in \SN$. Hence $t' \in \SN$, and $t' : \nat$ by the
    subject reduction lemma. Thus $t' \in \val{\nat}{}{}$.
  \item Let $t$ be neutral and $t : \nat$. Assume that for all~$t'$
    with $t \leadsto t'$ we have $t' \in \val{\nat}{}{}$, so in
    particular $t' \in \SN$. But then $t \in \SN$. Hence $t \in
    \val{\nat}{}{}$.
  \item Let $t_1,t_2 \in \SN$ be such that $t_i : \nat$. Obviously,
    $\circ_\nat t_1 t_2 : \nat$. Also $\circ_\nat t_1 t_2 \in \SN$
    follows by Lemma~\ref{lem_circ_sn_base}. So $\circ_\nat t_1 t_2
    \in \val{\nat}{}{}$.
  \item Let $t \in \SN$ be such that $t : \nat$. Then $\lift_\nat t :
    \nat$. It remains to show $\lift_\nat t \in \SN$. Any infinite
    reduction from~$\lift_\nat t$ has the form $\lift_\nat t
    \leadsto^* \lift_\nat t_0 \leadsto t_1 \leadsto t_2 \leadsto
    \ldots$ or $\lift_\nat t \leadsto \lift_\nat t_0 \leadsto
    \lift_\nat t_1 \leadsto \lift_\nat t_2 \leadsto \ldots$, where $t
    \leadsto^* t_0$ and $t_i \leadsto t_{i+1}$. This contradicts $t
    \in \SN$.
  \item Let $t \in \SN$ be such that $t : \nat$. The proof of
    $\flatten_\nat t \in \SN$ is analogous to the proof of $\lift_\nat
    t \in \SN$ above.
  \end{enumerate}
\end{proof}

\begin{lemma}\label{lem_chi_kappa_computable}
  $\val{\chi_\kappa}{}{} \in \Cb_{\chi_\kappa}$.
\end{lemma}

\begin{proof}
  Induction on~$\kappa$. If $\kappa = *$ then this follows from
  Lemma~\ref{lem_nat_computable}. If $\kappa=\kappa_1\arrkind\kappa_2$
  then $\chi_\kappa = \lambda \alpha : \kappa_1
  . \chi_{\kappa_2}$. Let~$\psi$ be a closed type constructor of
  kind~$\kappa_1$ and let $X \in \Cb_{\chi_{\kappa_1}}$. We have
  $\val{\chi_\kappa}{}{}(\psi,X) = \val{\chi_{\kappa_2}}{}{}$ because
  $\chi_{\kappa_2}$ is closed. By the inductive hypothesis
  $\val{\chi_\kappa}{}{}(\psi,X) = \val{\chi_{\kappa_2}}{}{} \in
  \Cb_{\chi_{\kappa_2}}$. This implies $\val{\chi_\kappa}{}{} \in
  \Cb_{\chi_\kappa}$.\qed
\end{proof}

\begin{lemma}\label{lem_abstraction_computable}
  Let $\sigma,\tau$ be types. Suppose $\val{\tau}{\xi'}{\omega'} \in
  \Cb_{\omega'(\tau)}$ and $\val{\sigma}{\xi'}{\omega'} \in
  \Cb_{\omega'(\sigma)}$ for all suitable $\omega',\xi'$. Then
  \begin{itemize}
  \item
    $\abs{x}{s} \in \val{\tau \arrtype \sigma}{\xi}{\omega}$ if and
    only if $\abs{x}{s} : \omega(\tau \arrtype \sigma)$ and $s[x:=t]
    \in \val{\sigma}{\xi}{\omega}$ for all $t \in
    \val{\tau}{\xi}{\omega}$;
  \item
    $\tabs{\alpha}{s} \in
    \val{\quant{(\alpha:\kappa)}{\sigma}}{\xi}{\omega}$ if and only if
    $\tabs{\alpha}{s} : \omega(\quant{(\alpha:\kappa)}{\sigma})$ and
    for every closed type constructor~$\varphi$ of kind~$\kappa$ and
    all $X \in \Cb_\varphi$ we have $s[\alpha:=\varphi] \in
    \val{\sigma}{\xi[\subst{\alpha}{X}]}{\omega[\subst{\alpha}{\varphi}]}$.
  \end{itemize}
\end{lemma}

\begin{proof}
  First suppose
  $\abs{x:\omega(\tau)}{s} \in \val{\tau \arrtype
    \sigma}{\xi}{\omega}$. Then
  $\abs{x:\omega(\tau)}{s} : \omega(\tau\arrtype\sigma)$ and for all
  $t \in \val{\tau}{\xi}{\omega}$ we have
  $\app{(\abs{x:\omega(\tau)}{s})}{t} \in \val{\sigma}{\xi}{\omega}$.
  As this set is a candidate, it is closed under $\leadsto$, so also
  $s[x:=t] \in \val{\sigma}{\xi}{\omega}$. Similarly, if
  $\tabs{\alpha}{s} \in \val{\quant{\alpha}{\sigma}}{\xi}{\omega}$,
  then $\tabs{\alpha}{s} : \quant{\alpha}{\sigma}$ and
  $\tapp{(\tabs{\alpha}{s})}{\varphi} \in
  \val{\sigma}{\xi[\subst{\alpha}{X}]}{\omega[\subst{\alpha}{\varphi}]}$,
  and we are done because
  $\tapp{(\tabs{\alpha}{s})}{\tau} \leadsto s[\alpha:=\varphi]$ and
  $\val{\sigma}{\xi[\subst{\alpha}{X}]}{\omega[\subst{\alpha}{\varphi}]}$
  is a candidate, so it is closed under~$\leadsto$.

  Now suppose $s[x:=t] \in \val{\sigma}{\xi}{\omega}$ for all
  $t \in \val{\tau}{\xi}{\omega}$. Let
  $t \in \val{\tau}{\xi}{\omega}$. Then $t \in \SN$ because
  $\val{\tau}{\xi}{\omega}$ is a candidate. Also $s \in \SN$ because
  every infinite reduction in $s$ induces an infinite reduction in
  $s[x:=t]$ ($\leadsto$ is stable) and
  $\val{\sigma}{\xi}{\omega} \subseteq \SN$ is a candidate. For all
  $s',t'$ with $s \leadsto^* s'$ and $t \leadsto^* t'$, we show by
  induction on~$\nu(s') + \nu(t')$ that
  $\app{(\abs{x}{s'})} t' \in \val{\sigma}{\xi}{\omega}$. We have
  $\app{(\abs{x}{s'})} t' : \omega(\sigma)$ by definition and the
  subject reduction theorem (note that $t : \omega(\tau)$ because
  $\val{\tau}{\xi}{\omega} \in \Cb_{\omega(\tau)}$). The set
  $\val{\sigma}{\xi}{\omega}$ is a candidate, and
  $\app{(\abs{x}{s'})}{t'}$ is neutral, so in
  $\val{\sigma}{\xi}{\omega}$ if all its reducts are. Thus assume
  $\app{(\abs{x}{s'})}{t'} \leadsto u$. If
  $u = \app{(\abs{x}{s'})}{t''}$ with $t' \leadsto t''$ or
  $u = \app{(\abs{x}{s''})}{t'}$ with $s' \leadsto s''$, then
  $u \in \val{\sigma}{\xi}{\omega}$ by the inductive hypothesis. So
  assume $u = s'[x:=t']$. We have $s[x:=t] \leadsto^* s'[x:=t']$ by
  monotonicity and stability of $\leadsto$. Therefore
  $u = s'[x:=t'] \in \val{\sigma}{\xi}{\omega}$, because
  $s[x:=t] \in \val{\sigma}{\xi}{\omega}$ and
  $\val{\sigma}{\xi}{\omega}$ is a candidate and hence closed under
  $\leadsto$.

  A similar reasoning applies to $s[\alpha:=\varphi]$.\qed
\end{proof}

\begin{lemma}\label{lem_val_computable}
  If $\sigma$ is a type constructor, $\omega$ is closed for~$\sigma$
  and $\xi$ is an $\omega$-valuation, then $\val{\sigma}{\xi}{\omega}
  \in \Cb_{\omega(\sigma)}$.
\end{lemma}

\begin{proof}
  By induction on the structure of~$\sigma$ we show that
  $\val{\sigma}{\xi}{\omega} \in \Cb_{\omega(\sigma)}$ for all
  suitable $\omega,\xi$. First, if $\sigma = \alpha$ is a type
  constructor variable~$\alpha$ then $\val{\sigma}{\xi}{\omega} =
  \xi(\alpha) \in \Cb_{\omega(\sigma)}$ by definition. If $\sigma =
  \nat$ then $\val{\nat}{\xi}{\omega} \in \Cb_{\nat}$ by
  Lemma~\ref{lem_nat_computable}.

  Assume $\sigma = \tau_1 \arrtype \tau_2$. We check the conditions in
  Definition~\ref{def_candidate}.
  \begin{enumerate}
  \item Let $t \in \val{\tau_1\arrtype\tau_2}{\xi}{\omega}$ and assume
    there is an infinite reduction $t \leadsto t_1 \leadsto t_2
    \leadsto t_3 \leadsto \ldots$. By the inductive hypothesis
    $\val{\tau_1}{\xi}{\omega}$ and $\val{\tau_2}{\xi}{\omega}$ are
    candidates. Let~$x$ be a fresh variable. Then $x^{\omega(\tau_1)}
    : \omega(\tau_1)$ and $x^{\omega(\tau_1)} \in
    \val{\tau_1}{\xi}{\omega}$ because it is neutral and normal. Thus
    $t x \in \val{\tau_2}{\xi}{\omega} \subseteq \SN$. But $t x
    \leadsto t_1 x \leadsto t_2 x \leadsto t_3 x \leadsto
    \ldots$. Contradiction.
  \item Let $t \in \val{\tau_1\arrtype\tau_2}{\xi}{\omega}$ and $t
    \leadsto t'$. Let $u \in \val{\tau_1}{\xi}{\omega}$ be such that
    $u : \omega(\tau_1)$. Then $t u \in \val{\tau_2}{\xi}{\omega}$. By
    the inductive hypothesis $\val{\tau_2}{\xi}{\omega}$ is a
    candidate, so $t' u \in \val{\tau_2}{\xi}{\omega}$. Also note that
    $t' : \omega(\tau_1 \arrtype \tau_2)$ by the subject reduction
    lemma. Hence $t' \in \val{\tau_1\arrtype\tau_2}{\xi}{\omega}$.
  \item Let $t$ be neutral such that $t : \omega(\tau_1 \arrtype
    \tau_2)$. Assume for every~$t'$ with $t \leadsto t'$ we have $t'
    \in \val{\tau_1\arrtype\tau_2}{\xi}{\omega}$. Let $u \in
    \val{\tau_1}{\xi}{\omega}$ be such that $u : \omega(\tau_1)$. By
    the inductive hypothesis $\val{\tau_1}{\xi}{\omega}$ is a
    candidate, so $u \in \SN$. By induction on~$\nu(u)$ we show that
    $t u \in \val{\tau_2}{\xi}{\omega}$. Assume $t u \leadsto t''$. We
    show $t'' \in \val{\tau_2}{\xi}{\omega}$. Because~$t$ is neutral,
    $t u$ cannot be a redex. So there are two cases.
    \begin{itemize}
    \item $t'' = t u'$ with $u \leadsto u'$. Then $u' \in
      \val{\tau_1}{\xi}{\omega}$ because~$\val{\tau_1}{\xi}{\omega}$
      is a candidate, and~$u' : \omega(\tau_1)$ by the subject
      reduction lemma. So $t u' \in \val{\tau_2}{\xi}{\omega}$ by the
      inductive hypothesis for~$u$.
    \item $t'' = t' u$ with $t \leadsto t'$. Then $t' \in
      \val{\tau_1\arrtype\tau_2}{\xi}{\omega}$ by point~2 above. So
      $t' u \in \val{\tau_2}{\xi}{\omega}$.
    \end{itemize}
    We have thus shown that if $t u \leadsto t''$ then $t'' \in
    \val{\tau_2}{\xi}{\omega}$. By the (main) inductive hypothesis
    $\val{\tau_2}{\omega,\xi}{\Gamma}$ is a candidate. Because $t u$
    is neutral, the above implies $t u \in
    \val{\tau_2}{\xi}{\omega}$. Since $u \in
    \val{\tau_1}{\xi}{\omega}$ was arbitrary with $u :
    \omega(\tau_1)$, we have shown $t \in
    \val{\tau_1\arrtype\tau_2}{\xi}{\omega}$.
  \item Assume $t_1,t_2 \in \val{\tau_1\arrtype\tau_2}{\xi}{\omega}$.
    We have already shown that this implies $t_1,t_2 \in \SN$. Let $s
    = \circ_{\omega(\tau_1\arrtype\tau_2)} t_1 t_2$. We show $s \in
    \val{\tau_1\arrtype\tau_2}{\xi}{\omega}$ by induction on $\nu(t_1)
    + \nu(t_2)$. Note that $s : \omega(\tau_1\arrtype\tau_2)$ because
    $t_i : \omega(\tau_1\arrtype\tau_2)$. Since $s$ is neutral, we
    have already seen in point~3 above that to prove $s \in
    \val{\tau_1\arrtype\tau_2}{\xi}{\omega}$ it suffices to show that
    $s' \in \val{\tau_1\arrtype\tau_2}{\xi}{\omega}$ whenever $s
    \leadsto s'$. If $s' = \circ_{\omega(\tau_1\arrtype\tau_2)} t_1'
    t_2$ with $t_1 \leadsto t_1'$, then note that $t_1' \in
    \val{\tau_1\arrtype\tau_2}{\xi}{\omega}$ because we have already
    shown that $\val{\tau_1\arrtype\tau_2}{\xi}{\omega}$ is closed
    under $\leadsto$; thus, we can complete by the induction
    hypothesis. If $s' = \circ_{\omega(\tau_1\arrtype\tau_2)} t_1
    t_2'$, we complete in the same way.  The only alternative is that
    $s' = \abs{x:\omega(\tau_1)}{\circ_{\omega(\tau_2)}(t_1x)(t_2x)}$.
    Let $u \in \val{\tau_1}{\xi}{\omega}$. Then $u : \omega(\tau_1)$
    because $\val{\tau_1}{\xi}{\omega} \in \Cb_{\omega(\tau_1)}$ by
    the inductive hypothesis. Since $t_1,t_2 \in
    \val{\tau_1\arrtype\tau_2}{\xi}{\omega}$, we have that $t_1 u$ and
    $t_2 u$ are in $\val{\tau_2}{\xi}{\omega}$ by definition. Since
    $\val{\tau_2}{\xi}{\omega}$ is a candidate, this means that
    $\circ_{\omega(\tau_2)} (t_1 u) (t_2 u) = (\circ_{\omega(\tau_2)}
    (t_1 x) (t_2 x))[x:=u]$ is in $\val{\tau_2}{\xi}{\omega}$ as well.
    By Lemma~\ref{lem_abstraction_computable}, we conclude that $s'
    \in \val{\tau_1\arrtype\tau_2}{\xi}{\omega}$.
  \item Let $t \in \SN$ satisfy $t : \nat$, and let $s =
    \lift_{\omega(\tau_1\arrtype\tau_2)}(t)$. We show $s \in
    \val{\tau_1\arrtype\tau_2}{\xi}{\omega}$ by induction
    on~$\nu(t)$. We have $s : \omega(\tau_1\arrtype\tau_2)$ because $t
    : \nat$. Since~$s$ is neutral, we have already proved above in
    point~3 that it suffices to show that $s' \in
    \val{\tau_1\arrtype\tau_2}{\xi}{\omega}$ whenever $s \leadsto
    s'$. If $s' = \lift_{\omega(\tau_1\arrtype\tau_2)}(t')$ with $t
    \leadsto t'$ then still $t' \in \SN$ and $t' : \nat$, so $s' \in
    \val{\tau_1\arrtype\tau_2}{\xi}{\omega}$ by the inductive
    hypothesis. The only alternative is that $s' = \lambda x :
    \omega(\tau_1) . \lift_{\omega(\tau_2)}(t)$. Let $u \in
    \val{\tau_1}{\xi}{\omega}$ be such that $u :
    \omega(\tau_1)$. Because $\val{\tau_2}{\xi}{\omega} \in
    \Cb_{\omega(\tau_2)}$ by the (main) inductive hypothesis
    for~$\sigma$, we have $\lift_{\omega(\tau_2)}(t) \in
    \val{\tau_2}{\xi}{\omega}$. Since $\lift_{\omega(\tau_2)}(t) =
    (\lift_{\omega(\tau_2)}x)[\subst{x}{t}]$ we obtain $s' \in
    \val{\tau_1\arrtype\tau_2}{\xi}{\omega}$ by
    Lemma~\ref{lem_abstraction_computable}.
  \item Let $t \in \val{\tau_1\arrtype\tau_2}{\xi}{\omega}$.  We show
    $s := \flatten_{\omega(\tau_1\arrtype\tau_2)}t \in \SN$. We have
    already shown $t \in \SN$ in point~1 above. Thus any infinite
    reduction starting from~$s$ must have the form $s \leadsto^*
    \flatten_{\omega(\tau_1\arrtype\tau_2)}t' \leadsto
    \flatten_{\omega(\tau_2)}(t' (\lift_{\omega(\tau_1)}0)) \leadsto
    \ldots$ with $t \leadsto^* t'$. We have already shown in point~2
    above that $\val{\tau_1\arrtype\tau_2}{\xi}{\omega}$ is closed
    under~$\leadsto$, so $t' \in
    \val{\tau_1\arrtype\tau_2}{\xi}{\omega}$. By the inductive
    hypothesis $\val{\tau_1}{\xi}{\omega} \in\Cb_{\omega(\tau_1)}$, so
    $\lift_{\omega(\tau_1)}0 \in \val{\tau_1}{\xi}{\omega}$ by
    property~5 of candidates. Hence $t' (\lift_{\omega(\tau_1)}0) \in
    \val{\tau_2}{\xi}{\omega}$ by definition. But by the inductive
    hypothesis~$\val{\tau_2}{\xi}{\omega}$ is a candidate, so
    $\flatten_{\omega(\tau_2)}(t'(\lift_{\omega(\tau_1)}0))\in\SN$. Contradiction.
  \end{enumerate}

  Assume $\sigma = \forall(\alpha:\kappa)[\tau]$. We check the
  conditions in Definition~\ref{def_candidate}.
  \begin{enumerate}
  \item Let $t \in \val{\forall(\alpha:\kappa)[\tau]}{\xi}{\omega}$
    and assume there is an infinite reduction $t \leadsto t_1 \leadsto
    t_2 \leadsto t_3 \leadsto \ldots$. Recall that~$\chi_\kappa$ from
    Definition~\ref{def_chi_kappa} is a closed type constructor of
    kind~$\kappa$. By Lemma~\ref{lem_chi_kappa_computable} we have
    $\val{\chi_{\kappa}}{}{} \in \Cb_{\chi_\kappa}$. Then $t
    \chi_\kappa \in
    \val{\tau}{\xi[\subst{\alpha}{\val{\chi_\kappa}{}{}}]}{\omega[\subst{\alpha}{\chi_\kappa}]}$. By
    the inductive hypothesis
    $\val{\tau}{\xi[\subst{\alpha}{\val{\chi_\kappa}{}{}}]}{\omega[\subst{\alpha}{\chi_\kappa}]}$
    is a candidate, so $t \chi_\kappa \in \SN$. But $t \chi_\kappa
    \leadsto t_1 \chi_\kappa \leadsto t_2 \chi_\kappa \leadsto t_3
    \chi_\kappa \leadsto \ldots$. Contradiction.
  \item Let $t \in \val{\forall\alpha[\tau]}{\xi}{\omega}$ and $t
    \leadsto t'$. By the subject reduction lemma $t' :
    \omega(\forall\alpha[\tau])$. Let~$\varphi$ be a closed type
    constructor of kind~$\kappa$ and~$X \in \Cb_{\varphi}$. Then $t
    \varphi \in
    \val{\tau}{\xi[\subst{\alpha}{X}]}{\omega[\subst{\alpha}{\varphi}]}$. By
    the inductive hypothesis
    $\val{\tau}{\xi[\subst{\alpha}{X}]}{\omega[\subst{\alpha}{\varphi}]}$
    is a candidate, so $t' \varphi \in
    \val{\tau}{\xi[\subst{\alpha}{X}]}{\omega[\subst{\alpha}{\varphi}]}$. Therefore
    $t' \in \val{\forall\alpha[\tau]}{\xi}{\omega}$.
  \item Let $t$ be neutral such that $t :
    \omega(\forall\alpha[\tau])$, and assume that for every~$t'$ with
    $t \leadsto t'$ we have $t' \in
    \val{\forall\alpha[\tau]}{\xi}{\omega}$. Let~$\varphi$ be a closed
    type constructor of kind~$\kappa$ and~$X \in
    \Cb_{\varphi}$. Assume $t \varphi \leadsto t''$. Then $t'' = t'
    \varphi$ with $t \leadsto t'$, because~$t$ is neutral. Hence $t
    \varphi \leadsto t' \varphi \in
    \val{\tau}{\xi[\subst{\alpha}{X}]}{\omega[\subst{\alpha}{\varphi}]}$. By
    the inductive
    hypothesis~$\val{\tau}{\xi[\subst{\alpha}{X}]}{\omega[\subst{\alpha}{\varphi}]}$
    is a candidate. Also $t \varphi$ is neutral, so $t \varphi \in
    \val{\tau}{\xi[\subst{\alpha}{X}]}{\omega[\subst{\alpha}{\varphi}]}$
    because~$t''$ was arbitrary with $t \varphi \leadsto t''$. This
    implies that $t \in \val{\forall\alpha[\tau]}{\xi}{\omega}$.
  \item Assume $t_1,t_2 \in
    \val{\forall\alpha[\tau]}{\xi}{\omega}$. We have already shown
    that this implies $t_1,t_2 \in \SN$. We prove
    $\circ_{\omega(\forall\alpha[\tau])} t_1 t_2 \in
    \val{\forall\alpha['tau]}{\xi}{\omega}$ by induction on $\nu(t_1)
    + \nu(t_2)$. Since $s := \circ_{\omega(\forall\alpha[\tau])} t_1
    t_2$ is neutral, we have already proven that it suffices to show
    that $s' \in \val{\forall\alpha[\tau]}{\xi}{\omega}$ whenever $s
    \leadsto s'$. The cases when $t_1$ or $t_2$ are reduced are
    immediate with the induction hypotheses. The only remaining case
    is when $s'=\tabs{\alpha}{\circ_{\omega(\tau)} (t_1 \alpha) (t_2
      \alpha)}$.  For all closed type constructors $\varphi$ of
    kind~$\kappa$ and all $X \in \Cb_{\varphi}^\Gamma$ we have both
    $t_1 \varphi$ and $t_2 \varphi$ in
    $\val{\tau}{\xi[\subst{\alpha}{X}]}{\omega[\subst{\alpha}{\varphi}]}$
    (by definition of $t_1,t_2 \in
    \val{\forall\alpha[\tau]}{\xi}{\omega}$). Let $\omega' =
    \omega[\subst{\alpha}{\varphi}]$. By bound variable renaming, we
    may assume $\omega(\alpha) = \alpha$ and $\alpha$ does not occur
    in~$t_1,t_2$. Because
    $\val{\tau}{\xi[\subst{\alpha}{X}]}{\omega[\subst{\alpha}{\varphi}]}$
    is a candidate by the inductive hypothesis for~$\sigma$, we have
    \[
    \circ_{\omega'(\tau)} (t_1 \varphi)
    (t_2\varphi) = (\circ_{\omega(\tau)} (t_1 \alpha) (t_2
    \alpha))[\subst{\alpha}{\varphi}] \in
    \val{\tau}{\xi[\subst{\alpha}{X}]}{\omega[\subst{\alpha}{\varphi}]}.
    \]
    Hence $s' \in \val{\forall\alpha[\tau]}{\xi}{\omega}$ by
    Lemma~\ref{lem_abstraction_computable}.
  \item Let $t \in \SN$ be such that $t : \nat$. By induction
    on~$\nu(t)$ we show $s := \lift_{\omega(\forall\alpha[\tau])}(t)
    \in \val{\forall\alpha[\tau]}{\xi}{\omega}$. First note that $s :
    \omega(\forall\alpha[\tau])$. Since~$s$ is neutral, by the already
    proven point~3 above, it suffices to show that $s' \in
    \val{\forall\alpha[\tau]}{\xi}{\omega}$ whenever $s \leadsto
    s'$. The case when~$t$ is reduced is immediate by the inductive
    hypothesis. The only remaining case is when $s' =
    \tabs{\alpha}{\lift_{\omega(\tau)}(t)}$ (without loss of
    generality assuming $\omega(\alpha) = \alpha$). Let $\varphi$ be a
    closed type constructor of kind~$\kappa$ and let $X \in
    \Cb_\varphi$. Because
    $\val{\tau}{\xi[\subst{\alpha}{X}]}{\omega[\subst{\alpha}{\varphi}]}$
    is a candidate, we have
    \[
    \lift_{\omega[\subst{\alpha}{\varphi}](\tau)}(t) =
    (\lift_{\omega(\tau)}(t))[\subst{\alpha}{\varphi}] \in
    \val{\tau}{\xi[\subst{\alpha}{X}]}{\omega[\subst{\alpha}{\varphi}]}.
    \]
    This implies $s' \in \val{\forall\alpha[\tau]}{\xi}{\omega}$.
  \item Let $t \in \val{\forall\alpha[\tau]}{\xi}{\omega}$. We show $s
    := \flatten_{\omega(\forall\alpha[\tau])}t \in \SN$. We have
    already shown $t \in \SN$ in point~1 above. Thus any infinite
    reduction starting from~$s$ must have the form $s \leadsto^*
    \flatten_{\omega(\forall\alpha[\tau])}t' \leadsto
    \flatten_{\omega(\tau)[\subst{\alpha}{\chi_\kappa}]}(t'
    \chi_\kappa) \leadsto \ldots$ with $t \leadsto^* t'$ (assuming
    $\omega(\alpha) = \alpha$ without loss of generality). We have
    already shown in point~2 above that
    $\val{\forall\alpha[\tau]}{\xi}{\omega}$ is closed
    under~$\leadsto$, so $t' \in
    \val{\forall\alpha[\tau]}{\xi}{\omega}$. We have
    $\val{\chi_\kappa}{}{} \in \Cb_{\chi_\kappa}$ by
    Lemma~\ref{lem_chi_kappa_computable}. Since~$\chi_\kappa$ is also
    closed, we have $t' \chi_\kappa \in
    \val{\tau}{\xi[\subst{\alpha}{\val{\chi_\kappa}{}{}}]}{\omega[\subst{\alpha}{\chi_\kappa}]}$
    by definition of $\val{\forall\alpha[\tau]}{\xi}{\omega}$. By the
    inductive hypothesis
    $\val{\tau}{\xi[\subst{\alpha}{\val{\chi_\kappa}{}{}}]}{\omega[\subst{\alpha}{\chi_\kappa}]}
    \in \Cb_{\omega[\subst{\alpha}{\chi_\kappa}](\tau)}$. Hence
    $\flatten_{\omega[\subst{\alpha}{\chi_\kappa}](\tau)}(t'\chi_\kappa)\in\SN$. But
    $\omega[\subst{\alpha}{\chi_\kappa}](\tau) =
    \omega(\tau)[\subst{\alpha}{\chi_\kappa}]$ because~$\chi_\kappa$
    is closed and $\omega(\alpha) = \alpha$. Contradiction.
  \end{enumerate}

  Assume $\sigma = \varphi\psi$, with $\psi$ of kind~$\kappa_1$ and
  $\varphi$ of kind~$\kappa_1\arrkind\kappa_2$. By the inductive
  hypothesis $\val{\psi}{\xi}{\omega} \in \Cb_{\omega(\psi)}$ and
  $\val{\varphi}{\xi}{\omega} \in \Cb_{\omega(\varphi)}$. Because
  applying~$\omega$ does not change kinds, we have
  $\val{\varphi\psi}{\xi}{\omega} =
  \val{\varphi}{\xi}{\omega}(\omega(\psi), \val{\psi}{\xi}{\omega})
  \in \Cb_{\omega(\varphi\psi)}$, by the definition of candidates of a
  type constructor with kind~$\kappa_1\arrkind\kappa_2$ and
  Lemma~\ref{lem_beta_candidate} (note that $\omega(\psi)$ is closed,
  because $\omega$ is closed for~$\sigma$).

  Finally, assume $\sigma = \lambda(\alpha:\kappa)\varphi$. Let $\psi$
  be a closed type constructor of kind~$\kappa$ and $X \in
  \Cb_{\psi}$. By the inductive hypothesis
  $\val{\lambda(\alpha:\kappa)\varphi}{\xi}{\omega}(\psi,X) =
  \val{\varphi}{\xi[\subst{\alpha}{X}]}{\omega[\subst{\alpha}{\psi}]}
  \in \Cb_{\omega[\subst{\alpha}{\psi}](\varphi)}$. Because $\psi$ is
  closed we have $\omega[\subst{\alpha}{\psi}](\varphi) =
  \omega(\varphi[\subst{\alpha}{\psi}]) =
  \omega((\lambda\alpha.\varphi)\psi) = \omega(\sigma\psi) =
  \omega(\sigma)\psi$. This implies that $\val{\sigma}{\xi}{\omega}
  \in \Cb_{\omega(\sigma)}$.
\end{proof}

\begin{lemma}\label{lem_circ}
  If $\omega$ is closed for~$\sigma$ then $\circ_{\omega(\sigma)} \in
  \val{\sigma \arrtype \sigma \arrtype \sigma}{\xi}{\omega}$ for
  $\circ \in \{ \oplus, \otimes \}$.
\end{lemma}

\begin{proof}
  Follows from definitions, Lemma~\ref{lem_val_computable} and
  property~4 of candidates.
\end{proof}

\begin{lemma}\label{lem_lift}
  If $\omega$ is closed for~$\sigma$ then $\lift_{\omega(\sigma)} \in
  \val{\nat\arrtype\sigma}{\xi}{\omega}$.
\end{lemma}

\begin{proof}
  Follows from definitions, Lemma~\ref{lem_val_computable} and
  property~5 of candidates.
\end{proof}

\begin{lemma}\label{lem_flatten}
  If $\omega$ is closed for~$\sigma$ then $\flatten_{\omega(\sigma)}
  \in \val{\sigma\arrtype\nat}{\xi}{\omega}$.
\end{lemma}

\begin{proof}
  Follows from definitions, Lemma~\ref{lem_val_computable} and
  property~6 of candidates.
\end{proof}

\begin{lemma}\label{lem_val_subst}
  For any type constructors~$\sigma,\tau$ with $\alpha \notin
  \FV(\tau)$, a mapping~$\omega$ closed for~$\sigma$ and for~$\tau$,
  and an $\omega$-valuation~$\xi$, we have:
  \[
  \val{\sigma[\subst{\alpha}{\tau}]}{\xi}{\omega} =
  \val{\sigma}{\xi[\subst{\alpha}{\val{\tau}{\xi}{\omega}}]}{\omega[\subst{\alpha}{\omega(\tau)}]}.
  \]
\end{lemma}

\begin{proof}
  Let~$\omega' = \omega[\subst{\alpha}{\omega(\tau)}]$ and $\xi' =
  \xi[\subst{\alpha}{\val{\tau}{\xi}{\omega}}]$. First note
  that~$\omega$ is closed for~$\sigma[\subst{\alpha}{\tau}]$
  and~$\omega'$ is closed for~$\sigma$. We proceed by induction
  on~$\sigma$. If $\alpha \notin \FV(\sigma)$ then the claim is
  obvious. If $\sigma = \alpha$ then
  $\val{\sigma[\subst{\alpha}{\tau}]}{\xi}{\omega} =
  \val{\tau}{\xi}{\omega} = \val{\sigma}{\xi'}{\omega'}$.

  Assume $\sigma = \sigma_1\arrtype\sigma_2$. We show
  $\val{\sigma[\subst{\alpha}{\tau}]}{\xi}{\omega} \subseteq
  \val{\sigma}{\xi'}{\sigma'}$. Let $t \in
  \val{\sigma[\subst{\alpha}{\tau}]}{\xi}{\omega}$. We have $t :
  \omega(\sigma[\subst{\alpha}{\tau}])$, so $t : \omega'(\sigma)$. Let
  $u \in \val{\sigma_1}{\xi'}{\omega'}$. By the inductive hypothesis
  $u \in \val{\sigma_1[\subst{\alpha}{\tau}]}{\xi}{\omega}$. Hence $t
  u \in \val{\sigma_2[\subst{\alpha}{\tau}]}{\xi}{\omega} =
  \val{\sigma_2}{\xi'}{\omega'}$, where the last equality follows from
  the inductive hypothesis. Thus $t \in
  \val{\sigma}{\xi'}{\omega'}$. The other direction is analogous. The
  case $\sigma = \forall\alpha[\sigma']$ is also analogous.

  Assume $\sigma = \varphi\psi$. We have
  $\val{\sigma[\subst{\alpha}{\tau}]}{\xi}{\omega} =
  \val{\varphi[\subst{\alpha}{\tau}]}{\xi}{\omega}(\omega(\psi[\subst{\alpha}{\tau}]),
  \val{\psi[\subst{\alpha}{\tau}]}{\xi}{\omega}) =
  \val{\varphi[\subst{\alpha}{\tau}]}{\xi}{\omega}(\omega'(\psi),
  \val{\psi[\subst{\alpha}{\tau}]}{\xi}{\omega}) =
  \val{\varphi}{\xi'}{\omega'}(\omega'(\psi),
  \val{\psi}{\xi'}{\omega'})$ where the last equality follows from the
  inductive hypothesis.

  Finally, assume $\sigma = \lambda(\beta:\kappa)\varphi$. Let $\psi
  \in \Tc_\kappa$ be closed and let $X \in \Cb_\psi$. We have
  $\val{\sigma[\subst{\alpha}{\tau}]}{\xi}{\omega}(\psi,X) =
  \val{\varphi[\subst{\alpha}{\tau}]}{\xi[\subst{\beta}{X}]}{\omega[\subst{\beta}{\tau}]}
  =
  \val{\varphi}{\xi'[\subst{\beta}{X}]}{\omega'[\subst{\beta}{\tau}]}
  = \val{\sigma}{\xi'}{\omega'}(\psi,X)$ where we use the inductive
  hypothesis in the penultimate equality.
\end{proof}

\begin{lemma}\label{lem_forall}
  Let $\tau$ be a type constructor of kind~$\kappa$. Assume $\omega$
  is closed for $\forall\alpha[\sigma]$ and for~$\tau$. If $t \in
  \val{\forall(\alpha:\kappa)[\sigma]}{\xi}{\omega}$ then $t
  (\omega(\tau)) \in \val{\sigma[\subst{\alpha}{\tau}]}{\xi}{\omega}$.
\end{lemma}

\begin{proof}
  By Lemma~\ref{lem_val_computable} we have~$\val{\tau}{\xi}{\omega}
  \in \Cb_{\omega(\tau)}$. So $t (\omega(\tau)) \in
  \val{\sigma}{\xi[\subst{\alpha}{\val{\tau}{\xi}{\omega}}]}{\omega[\subst{\alpha}{\omega(\tau)}]}$
  by $t \in \val{\forall(\alpha:\kappa)[\sigma]}{\xi}{\omega}$. Hence
  $t (\omega(\tau)) \in
  \val{\sigma[\subst{\alpha}{\tau}]}{\xi}{\omega}$ by
  Lemma~\ref{lem_val_subst}.
\end{proof}


\begin{lemma}\label{lem_beta_val}
  If $\omega$ is closed for~$\sigma,\sigma'$ and $\sigma =_\beta
  \sigma'$ then $\val{\sigma}{\xi}{\omega} =
  \val{\sigma'}{\xi}{\omega}$.
\end{lemma}

\begin{proof}
  It suffices to show the lemma for the case when~$\sigma$ is a
  $\beta$-redex. Then the general case follows by induction
  on~$\sigma$ and the length of reduction to a common reduct.

  So assume $(\lambda\alpha\tau)\sigma \to_\beta
  \tau[\subst{\alpha}{\sigma}]$. We have
  $\val{(\lambda\alpha\tau)\sigma}{\xi}{\omega} =
  \val{\lambda\alpha\tau}{\xi}{\omega}(\omega(\sigma),
  \val{\sigma}{\xi}{\omega}) =
  \val{\tau}{\xi[\subst{\alpha}{\val{\sigma}{\xi}{\omega}}]}{\omega[\subst{\alpha}{\omega(\sigma)}]}
  = \val{\tau[\subst{\alpha}{\sigma}]}{\xi}{\omega}$ where the last
  equality follows from Lemma~\ref{lem_val_subst}.
\end{proof}

A mapping~$\omega$ on type constructors is extended in the obvious way
to a mapping on terms. Note that $\omega$ also acts on the type
annotations of variable occurrences, e.g.~$\omega(\lambda x : \alpha
. x^\alpha) = \lambda x : \omega(\alpha) . x^{\omega(\alpha)}$.

\begin{lemma}\label{lem_typable_computable}
  If $t : \sigma$ and $\omega$ is closed for~$\sigma$ and
  $\FTV(\omega(t)) = \emptyset$ then $\omega(t) \in
  \val{\sigma}{\xi}{\omega}$.
\end{lemma}

\begin{proof}
  We prove by induction on the structure of~$t$ that if $t : \sigma$
  and $\omega$ is closed for~$\sigma$ and $\FTV(\omega(t)) =
  \emptyset$ and $x_1^{\tau_1},\ldots,x_n^{\tau_n}$ are all free
  variable occurrences in the canonical representative of~$t$ (so
  each~$\tau_i$ is $\beta$-normal), then for all
  $u_1\in\val{\tau_1}{\xi}{\omega},\ldots,u_n\in\val{\tau_n}{\xi}{\omega}$
  we have $\omega(t)[\subst{x_1}{u_1},\ldots,\subst{x_n}{u_n}] \in
  \val{\sigma}{\xi}{\omega}$. This suffices because
  $\omega(x_i^{\tau_i}) \in \val{\tau_i}{\xi}{\omega}$. Note that
  $\omega$ is closed for each~$\tau_i$ because $\FTV(\omega(t)) =
  \emptyset$ and~$t$ is typed, so no type constructor variable
  occurring free in~$\tau_i$ can be bound in~$t$ by a~$\Lambda$;
  e.g.~$\Lambda \alpha . x^\alpha$ is not a valid typed term (we
  assume~$\tau_i$ to be in $\beta$-normal form). For brevity, we use
  the notation $\omega^*(t) =
  \omega(t)[\subst{x_1}{u_1},\ldots,\subst{x_n}{u_n}]$. Note that
  $\omega^*(t) : \omega(\sigma)$.

  By the generation lemma for $t : \sigma$ there is a type~$\sigma'$
  such that $\sigma' =_\beta \sigma$ and $\FV(\sigma') \subseteq
  \FV(\sigma) \cup \FTV(t)$ and one of the cases below holds. Note
  that~$\omega$ is closed for~$\sigma'$ because it is closed
  for~$\sigma$ and $\FTV(\omega(t)) = \emptyset$. By
  Lemma~\ref{lem_beta_val} it suffices to show $\omega^*(t) \in
  \val{\sigma'}{\xi}{\omega}$.
  \begin{itemize}
  \item If $t = x_1^{\tau_1}$ and $\tau_1 =_\beta \sigma'$ then
    $\omega(t)[\subst{x_1}{u_1}] =
    (x_1^{\omega(\tau_1)})[\subst{x_1}{u_1}] = u_1 \in
    \val{\tau_1}{\xi}{\omega} = \val{\sigma'}{\xi}{\omega}$ by
    assumption and Lemma~\ref{lem_beta_val}.
  \item If $t = n$ is a natural number and $\sigma' = \nat$ then $t
    \in \val{\nat}{}{}$ by definition.
  \item If $t$ is a function symbol then the claim follows from
    Lemma~\ref{lem_circ}, Lemma~\ref{lem_lift} or
    Lemma~\ref{lem_flatten}.
  \item If $t = \abs{x:\sigma_1}{s}$ then
    $\sigma' = \sigma_1\arrtype\sigma_2$ and $s : \sigma_2$. Hence
    $\omega$ is closed for~$\sigma_2$. Let
    $u \in \val{\sigma_1}{\xi}{\omega}$. By the inductive hypothesis
    $\omega^*(s)[\subst{x}{u}] \in \val{\sigma_2}{\xi}{\omega}$. Hence
    $\omega^*(t) \in \val{\sigma'}{\xi}{\omega}$ by
    Lemma~\ref{lem_abstraction_computable}.
  \item If $t = \tabs{\alpha:\kappa}{s}$ then $\sigma' =
    \forall\alpha[\tau]$ and $s : \tau$. Let $\psi$ be a closed type
    constructor of kind~$\kappa$ and let $X \in \Cb_\psi$. Let
    $\omega_1 = \omega[\subst{\alpha}{\psi}]$ and
    $\xi_1=\xi[\subst{\alpha}{X}]$. Then $\omega_1$ is closed
    for~$\tau$ and $\FTV(\omega_1(s)) = \emptyset$. By the inductive
    hypothesis $\omega_1^*(s) \in \val{\tau}{\xi_1}{\omega_1}$. We
    have $\omega_1^*(s) = \omega^*(s)[\subst{\alpha}{\psi}]$ (assuming
    $\alpha$ chosen fresh such that $\omega(\alpha) = \alpha$). Hence
    $\omega^*(t) \in \val{\tau}{\xi}{\omega}$ by
    Lemma~\ref{lem_abstraction_computable}.
  \item If $t = t_1 t_2$ then $t_1 : \tau\arrtype\sigma'$ and
    $t_2 : \tau$ and $\FV(\tau) \subseteq \FV(\sigma) \cup
    \FTV(t)$. Hence~$\omega$ is closed for~$\tau$ and
    for~$\tau\arrtype\sigma'$. By the inductive hypothesis
    $\omega^*(t_1) \in \val{\tau\arrtype\sigma'}{\xi}{\omega}$ and
    $\omega^*(t_2) \in \val{\tau}{\xi}{\omega}$. We have
    $\omega^*(t_2) : \omega(\tau)$. Then by definition
    $\omega^*(t) = (\omega^*(t_1))(\omega^*(t_2)) \in
    \val{\sigma'}{\xi}{\omega}$.
  \item If $t = s \psi$ then $s : \forall\alpha[\tau]$ and $\sigma' =
    \tau[\subst{\alpha}{\psi}]$. By the inductive hypothesis
    $\omega^*(s) \in \val{\forall\alpha[\tau]}{\xi}{\omega}$. Because
    $\FTV(\omega(t)) = \emptyset$, the mapping $\omega$ is closed
    for~$\psi$. So by Lemma~\ref{lem_forall} we have $\omega^*(t) =
    \omega^*(s) \omega(\psi) \in
    \val{\tau[\subst{\alpha}{\psi}]}{\xi}{\omega}$.\qed
  \end{itemize}
\end{proof}

\begin{theorem}\label{thm_sn}
  If $\Gamma \proves t : \sigma$ then $t \in \SN$.
\end{theorem}

\begin{proof}
  For closed terms~$t$ and closed types~$\sigma$ this follows from
  Lemma~\ref{lem_typable_computable}, Lemma~\ref{lem_val_computable}
  and property~1 of candidates (Definition~\ref{def_candidate}). For
  arbitrary terms and types, this follows by closing the terms with an
  appropriate number of abstractions, and the types with corresponding
  $\forall$-quantifiers.\qed
\end{proof}

\begin{lemma}\label{lem_unique_final}
  Every term $s \in \Iterms$ has a unique normal form~$s\da$. If~$s$
  is closed then so is~$s\da$.
\end{lemma}

\begin{proof}
  One checks that~$\leadsto$ is locally confluent. Since it is
  terminating by Theorem~\ref{thm_sn}, it is confluent by Newman's
  lemma.\qed
\end{proof}

\begin{lemma}\label{lem_final_nat}
  The only final interpretation terms of type $\nat$ are the natural
  numbers.
\end{lemma}

\begin{proof}
  We show by induction on~$t$ that if $t$ is a final interpretation
  term of type~$\nat$ then $t$ is a natural number. Because~$t$ is
  closed and in normal form, if it is not a natural number then it
  must have the form $\mathtt{f}_\sigma t_1 \ldots t_n$ for a function
  symbol $\mathtt{f}$. For concreteness assume $\mathtt{f} =
  \oplus$. Then $n \ge 2$. Because~$t$ is closed, $\sigma$ cannot be a
  type variable. It also cannot be an arrow or a $\forall$-type,
  because then $t$ would contain a redex. So $\sigma=\nat$. Then
  $t_1,t_2$ are final interpretation terms of type~$\nat$, hence
  natural numbers by the inductive hypothesis. But then $t$ contains a
  redex. Contradiction.\qed
\end{proof}

\subsection{Defining $\succ$ and $\succeq$}

In what follows we assume a fixed implicit environment~$\Gamma$ under
which all considered terms are typable.

\begin{definition}\label{def_closure}\normalfont
  A \emph{closure} is a function $\cl = \gamma \circ \omega$
  satisfying:
  \begin{enumerate}
  \item $\omega$ is a type constructor substitution such that
    $\omega(\alpha)$ is closed for every type constructor
    variable~$\alpha$,
  \item $\gamma$ is a term substitution such that $\gamma(x)$ is
    closed and $\proves \gamma(x) : \omega(\Gamma(x))$ for every
    variable $x \in \dom(\Gamma)$.
  \end{enumerate}
  For~$\tau$ a type constructor, we use $\cl(\tau)$ to denote
  $\omega(\tau)$. We use the notation $\cl[\subst{x}{t}] =
  \gamma[\subst{x}{t}] \circ \omega$.
\end{definition}

Note that if $t \in \Iterms$ and $\Gamma \proves t : \tau$ then
$\cl(t)$ and $\cl(\tau)$ are closed and $\proves \cl(t) : \cl(\tau)$.

\begin{definition}\label{def:succ}\normalfont
  Let $R \in \{ \succ,\succeq \}$. For closed~$s,t\in\Iterms_\sigma$
  and closed~$\sigma$ in $\beta$-normal form, the relation
  $s\ R_{\sigma}\ t$ is defined coinductively by the following rules.
  \[
  \begin{array}{cc}
    \infer={s\ R_\nat\ t}{s\da\ R\ t\da \text{ in natural numbers}} \quad&\quad
    \infer={s\ R_{\sigma\arrtype\tau}\ t}{\app{s}{q}\ R_{\tau}\ \app{t}{q} \text{ for all } q \in \World_\sigma} \\ \\
    \multicolumn{2}{c}{
    \infer={s\ R_{\forall(\alpha:\kappa)[\sigma]}\ t}{\tapp{s}{\tau}\ R_{\nf_\beta(\sigma[\subst{\alpha}{\tau}])}\ \tapp{t}{\tau} \text{ for all closed } \tau \in \Tc_{\kappa}}}
  \end{array}
  \]
  We define $s \approx_\sigma t$ if both $s \succeq_\sigma t$ and $t
  \succeq_\sigma s$.

  For arbitrary types~$\sigma$ and arbitrary terms $s,t \in \Iterms$
  we define $s \succ_\sigma t$ if for every closure~$\cl$ we can
  obtain $\cl(s) \succ_{\nf_\beta(\cl(\sigma))} \cl(t)$ coinductively
  with the above rules. The relations $\succeq_\sigma$ and
  $\approx_\sigma$ are extended analogously. We drop the type
  subscripts when clear or irrelevant.
\end{definition}

Note that in the case for~$\nat$ the terms~$s\da$, $t\da$ are natural
numbers by Lemma~\ref{lem_final_nat} ($s\da,t\da$ are closed and in
normal form, so they are final interpretation terms).

Intuitively, the above definition means that e.g. $s \succ t$ iff
there exists a possibly infinite derivation tree using the above
rules. In such a derivation tree all leaves must witness $s\da > t\da$
in natural numbers. However, this also allows for infinite branches,
which solves the problem of repeating types due to impredicative
polymorphism. If e.g.  $s \succ_{\forall \alpha . \alpha} t$ then
$\tapp{s}{\forall\alpha.\alpha} \succ_{\forall \alpha . \alpha}
\tapp{t}{\forall\alpha.\alpha}$, which forces an infinite branch in
the derivation tree. According to our definition any infinite branch
may essentially be ignored.

\subsection{Properties of $\succ$ and $\succeq$}

First we state a simple lemma that will be used implicitly in what
follows.

\begin{lemma}
  If~$\tau$ is a closed interpretation type in $\beta$-normal form then
  one of the following holds:
  \begin{enumerate}
  \item $\tau = \nat$, or
  \item $\tau = \tau_1\arrtype\tau_2$, or
  \item $\tau = \forall\alpha\sigma$.
  \end{enumerate}
\end{lemma}

We're going to at least need to see that $\succ$ is a well-founded
ordering.

\begin{lemma}
  $\succ$ is well-founded.
\end{lemma}

\begin{proof}
  It suffices to show this for closed terms and closed types in
  $\beta$-normal form, because any infinite sequence $t_1 \succ_\tau
  t_2 \succ_\tau t_3 \succ_\tau \ldots$ induces an infinite sequence
  $\cl(t_1) \succ_{\nf_\beta(\cl(\tau))} \cl(t_2)
  \succ_{\nf_\beta(\cl(\tau))} \cl(t_3) \succ_{\nf_\beta(\cl(\tau))}
  \ldots$ for any closure~$\cl$. By induction on the size of a
  $\beta$-normal type~$\tau$ (with size measured as the number of the
  occurrences of~$\forall$ and~$\arrtype$) one proves that there does
  not exist an infinite sequence $t_1 \succ_\tau t_2 \succ_\tau t_3
  \succ_\tau \ldots$ For instance, if $\alpha$ has kind~$\kappa$ and
  $t_1 \succ_{\forall\alpha[\tau]} t_2 \succ_{\forall\alpha[\tau]} t_3
  \succ_{\forall\alpha[\tau]} \ldots$ then $\tapp{t_1}{\chi_\kappa}
  \succ_{\tau'} \tapp{t_2}{\chi_\kappa} \succ_{\tau'}
  \tapp{t_3}{\chi_\kappa} \succ_{\tau'} \ldots$, where
  $\tau'=\nf_\beta(\tau[\subst{\alpha}{\chi_\kappa}])$. Because $\tau$
  is in $\beta$-normal form, all redexes in
  $\tau[\subst{\alpha}{\chi_\kappa}]$ are created by the substitution
  and must have the form $\chi_\kappa u$. Hence, by the definition
  of~$\chi_\kappa$ (see Definition~\ref{def_chi_kappa}) the
  type~$\tau'$ is smaller than~$\tau$. This is impossible by the
  inductive hypothesis.
\end{proof}

\begin{lemma}
  Both $\succ$ and $\succeq$ are transitive.
\end{lemma}

\begin{proof}
  We show this for~$\succ$, the proof for~$\succeq$ being
  analogous. Again, it suffices to prove this for closed terms and
  closed types in $\beta$-normal form. We proceed by coinduction.

  If $t_1 \succ_\nat t_2 \succ_\nat t_3$ then $t_1\da > t_2\da >
  t_3\da$, so $t_1\da > t_3\da$. Thus $t_1 \succ_\nat t_3$.

  If $t_1 \succ_{\sigma\arrtype\tau}t_2\succ_{\sigma\arrtype\tau}t_3$
  then $\app{t_1}{q}\succ_{\tau}\app{t_2}{q}\succ_\tau\app{t_3}{q}$
  for $q \in \World_\sigma$. Hence
  $\app{t_1}{q}\succ_\tau\app{t_3}{q}$ for $q \in \World_\sigma$ by
  the coinductive hypothesis. Thus $t_1\succ_{\sigma\arrtype\tau}
  t_3$.

  If $t_1
  \succeq_{\forall(\alpha:\kappa)[\sigma]}t_2\succ_{\forall(\alpha:\kappa)[\sigma]}t_3$
  then
  $\tapp{t_1}{\tau}\succ_{\sigma'}\tapp{t_2}{\tau}\succ_{\sigma'}\tapp{t_3}{\tau}$
  for any closed type constructor~$\tau$ of kind~$\kappa$, where
  $\sigma' = \nf_\beta(\sigma[\subst{\alpha}{\tau}])$. Hence
  $\tapp{t_1}{\tau}\succ_{\sigma'}\tapp{t_3}{\tau}$ by the coinductive
  hypothesis. Thus $t_1\succeq_{\forall\alpha[\sigma]} t_3$.\qed
\end{proof}

And that $\succeq$ is a quasi-ordering:

\begin{lemma}
  $\succeq$ is reflexive.
\end{lemma}

\begin{proof}
  By coinduction one shows that $\succeq_\sigma$ is reflexive on
  closed terms for closed $\beta$-normal~$\sigma$. The general case is
  then immediate from definitions.\qed
\end{proof}

Finally, they must be compatible:

\begin{lemma}\label{lem:compatibility}
  We have $\succ \cdot \succeq\ \subseteq\ \succ$ and $\succeq \cdot
  \succ\ \subseteq\ \succ$.
\end{lemma}

\begin{proof}
  By coinduction, analogous to the transitivity proof.\qed
\end{proof}

\begin{lemma}\label{lem_succ_to_succeq}
  If $t \succ s$ then $t \succeq s$.
\end{lemma}

\begin{proof}
  By coinduction.
\end{proof}

\begin{lemma}\label{lem_succ_red}
  Assume $t \succ s$ (resp.~$t \succeq s$).
  \begin{enumerate}
  \item If $t \leadsto t'$ or $t' \leadsto t$ then $t' \succ s$ (resp.~$t' \succeq s$).
  \item If $s \leadsto s'$ or $s' \leadsto s$ then $t \succ s'$
    (resp.~$t \succeq s'$).
  \end{enumerate}
\end{lemma}

\begin{proof}
  We show the first point assuming $t \leadsto t'$, other cases being
  analogous. It suffices to show this for closed $t,t',s$ and the type
  closed and in $\beta$-normal form, because $t \leadsto t'$ implies
  $\cl(t) \leadsto \cl(t')$ for any closure~$\cl$.

  We proceed by coinduction. If $t \succ_\nat s$ then $t\da = t'\da$
  and the claim holds.

  If $t \succ_{\sigma\arrtype\tau} s$ then for every $q \in
  \World_\sigma$ we have $\app{t}{q} \succ_\tau \app{s}{q}$. We have
  $\app{t}{q} \leadsto \app{t'}{q}$. Hence $\app{t'}{q} \succ_\tau
  \app{s}{q}$ by the coinductive hypothesis. Thus $t'
  \succ_{\sigma\arrtype\tau} s$.

  If $t \succ_{\forall(\alpha:\kappa)\sigma} s$ then for every closed
  type constructor~$\tau$ of kind~$\kappa$ we have $\tapp{t}{\tau}
  \succ_{\sigma'} \tapp{s}{\tau}$ where $\sigma' =
  \nf_\beta(\sigma[\subst{\alpha}{\tau}])$. We have $\tapp{t}{\tau}
  \leadsto \tapp{t'}{\tau}$. Hence $\tapp{t'}{\tau} \succ_{\sigma'}
  \tapp{s}{\tau}$ by the coinductive hypothesis. Thus $t'
  \succ_{\forall(\alpha:\kappa)\sigma} s$.
\end{proof}

\begin{corollary}\label{cor_succ_da}
  For $R \in \{\succ,\succeq,\approx\}$: $s\ R\ t$ if and only if
  $s\downarrow\ R\ t\downarrow$.
\end{corollary}

For easier presentation, we will denote $\oplus$ and $\otimes$ in
\emph{infix, left-associative} notation, and omit the type denotation
where it is clear from context. Thus, $s \oplus t \oplus u$ should be
read as $\oplus_\sigma\,s\,(\oplus_\sigma\,t\,u)$ if $s$ has type
$\sigma$. Similarly, we will sometimes omit the type denotation from
$\flatten$ and $\lift$ when clear or irrelevant.

\begin{lemma}\label{lem:plusparts}
For all types $\sigma$, terms $s,t$ of type $\sigma$ and natural
numbers $n > 0$:
\begin{enumerate}
\item $s \oplus_{\sigma} t \succeq s$ and $s \oplus_{\sigma} t \succeq
  t$;
\item $s \oplus_{\sigma} (\lift_{\sigma} n) \succ s$ and
  $(\lift_{\sigma} n) \oplus_{\sigma} t \succ t$.
\end{enumerate}
\end{lemma}

\begin{proof}
  It suffices to prove this for closed $s,t$ and closed $\sigma$ in
  $\beta$-normal form.
  \begin{enumerate}
  \item By coinduction we show $(s \oplus t) u_1 \ldots u_m
    \succeq_\sigma s u_1 \ldots u_m$ for closed $u_1,\ldots,u_m$. The
    second case is similar.

    First note that $(s \oplus t) u_1 \ldots u_m \leadsto^* s u_1
    \ldots u_m \oplus t u_1 \ldots u_m$.

    If $\sigma = \nat$ then $((s \oplus t) u_1 \ldots u_m)\da = (s u_1
    \ldots u_m)\da + (t u_1 \ldots u_m)\da \ge (s u_1 \ldots
    u_m)\da$. Hence $(s \oplus t) u_1 \ldots u_m) \succeq_\nat s u_1
    \ldots u_m$.

    If $\sigma = \tau_1\arrtype\tau_2$ then by the coinductive
    hypothesis $(s \oplus t) u_1 \ldots u_m q \succeq_{\tau_2} s u_1
    \ldots u_m q$ for any $q \in \World_{\tau_1}$. Hence $(s \oplus t)
    u_1 \ldots u_m \succeq_\sigma s u_1 \ldots u_m$.

    If $\sigma = \forall(\alpha:\kappa)[\tau]$ then by the coinductive
    hypothesis $(s \oplus t) u_1 \ldots u_m \xi \succeq_{\sigma'} s
    u_1 \ldots u_m \xi$ for any closed $\xi \in \Tc_\kappa$, where
    $\sigma' = \tau[\subst{\alpha}{\xi}]$. Hence $(s \oplus t) u_1
    \ldots u_m \succeq_\sigma s u_1 \ldots u_m$.
  \item By coinduction we show $(s \oplus (\lift n)) u_1 \ldots u_m
    \succeq_\sigma s u_1 \ldots u_m$ for closed $u_1,\ldots,u_m$. The
    second case is similar.

    Note that $(s \oplus (\lift n)) u_1 \ldots u_m \leadsto^* s u_1
    \ldots u_m \oplus n$. From this the base case $\sigma=\nat$
    follows. The other cases follow from the induction hypothesis,
    like in the first point above.
  \end{enumerate}
\end{proof}

\begin{lemma}\label{lem:liftgreater}
  If $n \geq m$ (resp.~$n > m$) then $\lift_\sigma n \succeq
  \lift_\sigma m$ (resp.~$\lift_\sigma n \succ \lift_\sigma m$) for
  all types $\sigma$.
\end{lemma}

\begin{proof}
  Without loss of generality we may assume $\sigma$ closed and in
  $\beta$-normal form. By coinduction one shows $\lift(n) u_1 \ldots
  u_k \succeq \lift(m) u_1 \ldots u_k$ for closed
  $u_1,\ldots,u_k$. This is similar to the proof of
  Lemma~\ref{lem:plusparts}.
\end{proof}

\begin{lemma}\label{lem_flatten_succ}
  If $t \succ_\sigma s$ then $\flatten_\sigma t \succ_\nat
  \flatten_\sigma s$ for all types $\sigma$. The same holds
  with~$\succeq$ instead of~$\succ$.
\end{lemma}

\begin{proof}
  Without loss of generality we may assume~$\sigma$ is closed and in
  $\beta$-normal form. Using Lemma~\ref{lem_succ_red}, one shows by
  induction on~$\sigma$ that if $t \succ_\sigma s$ then
  $\flatten_\sigma t \succ_\nat (\flatten_\sigma s)$ (the proof
  for~$\succeq$ is analogous). The same holds with~$\succeq$ instead
  of~$\succ$.
\end{proof}

\begin{lemma}\label{lem_abs_succ}
  If $t \succ s$ then $\abs{x}{t} \succ \abs{x}{s}$ and
  $\tabs{\alpha}{t} \succ \tabs{\alpha}{s}$. The same holds
  with~$\succeq$ instead of~$\succ$.
\end{lemma}

\begin{proof}
  Assume $t \succ_\tau s$ and $\Gamma \proves x : \sigma$. Let~$\cl$
  be a closure. We need to show $\cl(\abs{x}{t})
  \succ_{\cl(\sigma\arrtype\tau)} \cl(\abs{x}{s})$. Let $u \in
  \World_{\cl(\sigma)}$. Then $\cl' = \cl[\subst{x}{u}]$ is a closure
  and $\cl'(t) \succ_{\cl(\tau)} \cl'(s)$. Hence $\cl(t)[\subst{x}{u}]
  \succ_{\cl(\tau)} \cl(s)[\subst{x}{u}]$. By Lemma~\ref{lem_succ_red}
  this implies $\cl(\abs{x}{t}) u \succ_{\cl(\tau)} \cl(\abs{x}{s})
  u$. Therefore $\cl(\abs{x}{t}) \succ_{\cl(\sigma\arrtype\tau)}
  \cl(\abs{x}{s})$. The proof for the second part is analogous.
\end{proof}

\begin{lemma}\label{lem:plustimesmonotonic}
  Let $s,t,u$ be terms of type $\sigma$.
  \begin{enumerate}
  \item If $s \succeq t$ then $s \oplus_\sigma u \succeq t
    \oplus_\sigma u$, $u \oplus_\sigma s \succeq u \oplus_\sigma t$,
    and $s \otimes_\sigma u \succeq t \otimes_\sigma u$, $u
    \otimes_\sigma s \succeq u \otimes_\sigma t$.
  \item If $s \succ t$ then $s \oplus_\sigma u \succ t \oplus_\sigma
    u$ and $u \oplus_\sigma s \succ u \oplus_\sigma t$. Moreover, if
    additionally $u \succeq \lift_\sigma(1)$ then also $s
    \otimes_\sigma u \succ t \otimes_\sigma u$ and $u \otimes_\sigma s
    \succ u \otimes_\sigma t$.
  \end{enumerate}
\end{lemma}

\begin{proof}
  It suffices to prove this for closed $s,t,u$ and closed $\sigma$ in
  $\beta$-normal form. The proof is similar to the proof of
  Lemma~\ref{lem:plusparts}. For instance, we show by coinduction that
  for closed $w_1,\ldots,w_n$ if $s w_1 \ldots w_n \succ t w_1 \ldots
  w_n$ and $u w_1 \ldots w_n \succeq \lift(1) w_1 \ldots w_n$ then $(s
  \otimes u) w_1 \ldots w_n \succ (t \otimes u) w_1 \ldots w_n$.
\end{proof}

We observe that standard equality properties of addition and
multiplication extend to interpretation terms of other types:

\begin{lemma}\label{lem:approxproperties}
For all types $\sigma$ and all terms $s,t,u$ of type $\sigma$, we
have:
\begin{enumerate}
\item\label{lem:approx:symmetry} $s \oplus_\sigma t \approx t
  \oplus_\sigma s$ and $s \otimes_\sigma t \approx t \otimes_\sigma
  s$;
\item\label{lem:approx:assoc} $s \oplus_\sigma (t \oplus_\sigma u)
  \approx (s \oplus_\sigma t) \oplus_\sigma u$ and $s \otimes_\sigma
  (t \otimes_\sigma u) \approx (s \otimes_\sigma t) \otimes_\sigma u$;
\item\label{lem:approx:distribution} $s \otimes_\sigma (t
  \oplus_\sigma u) \approx (s \otimes_\sigma t) \oplus_\sigma (s
  \otimes_\sigma u)$;
\item\label{lem:approx:neutral} $(\lift_\sigma 0) \oplus_\sigma s
  \approx s$ and $(\lift_\sigma 1) \otimes_\sigma s \approx s$.
\end{enumerate}
\end{lemma}

\begin{proof}
  The proof is again analogous to the proof of
  Lemma~\ref{lem:plusparts}. For instance, for closed $s,t$ and closed
  $\sigma$ in $\beta$-normal form, we show by coinduction that $(s
  \oplus t) w_1 \ldots w_n \succeq (t \oplus s) w_1 \ldots w_n$ for
  closed $w_1,\ldots,w_n$ (and then the same with $\preceq$).
\end{proof}

\begin{lemma}
  \begin{enumerate}
  \item $\lift_\sigma(n+m) \approx_\sigma (\lift_\sigma n)
    \oplus_\sigma (\lift_\sigma n)$.
  \item $\lift_\sigma(n m) \approx_\sigma (\lift_\sigma n)
    \otimes_\sigma (\lift_\sigma n)$.
  \end{enumerate}
\end{lemma}

\begin{proof}
  It suffices to show this for closed~$\sigma$ in $\beta$-normal
  form. Then one proves by induction on~$\sigma$ that
  $(\lift_\sigma(n+m))\da = (\lift_\sigma n \oplus_\sigma \lift_\sigma
  n)\da$ (analogously for multiplication). This suffices by
  Corollary~\ref{cor_succ_da} and the reflexivity of~$\approx$.
\end{proof}

\subsection{Weak monotonicity}\label{sec_weakly_monotone}

We want to show that if $s \succeq s'$ then $t[\subst{x}{s}] \succeq
t[\subst{x}{s'}]$. A straightforward proof attempt runs into a problem
that, because of impredicativity of polymorhism, direct induction on
type structure is not possible. We adopt a method similar to Girard's
method of candidates from the termination proof.

\begin{definition}\normalfont
  A set~$X$ of terms of type~$\tau$ is a \emph{candidate of
    type~$\tau$} when:
  \begin{enumerate}
  \item if $t \in X$ and $t \leadsto t'$ or $t' \leadsto t$ then $t'
    \in X$,
  %\item if $t \in X$ and $s_1 \succeq s_2$ then $t s_1 \succeq t s_2$.
  \end{enumerate}
  In the above we implicitly assume that all mentioned terms are
  well-typed.
\end{definition}

\begin{definition}\label{def_wm_valuation}\normalfont
  An $\omega$-valuation~$\xi$ is a mapping from type variables to
  candidates such that $\xi(\alpha)$ is a candidate of
  type~$\omega(\alpha)$.

  We define $\val{\tau}{\xi}{\omega}$ by induction on~$\tau$.
  \begin{itemize}
  \item $\val{\alpha}{\xi}{\omega} = \xi(\alpha)$.
  \item $\val{\nat}{\xi}{\omega}$ is the set of all terms $t \in
    \Iterms$ such that $t : \nat$.
  \item $\val{\sigma\arrtype\tau}{\xi}{\omega}$ is the set of all
    terms $t \in \Iterms$ such that $t : \omega(\sigma\arrtype\tau)$ and:
    \begin{itemize}
    \item for all $s \in \val{\sigma}{\xi}{\omega}$ we have $t s \in
      \val{\tau}{\xi}{\omega}$, and
    \item if $s_1 \succeq s_2$ and $s_i \in \val{\sigma}{\xi}{\omega}$
      then $t s_1 \succeq t s_2$.
    \end{itemize}
  \item $\val{\forall\alpha\sigma}{\xi}{\omega}$ is the set of all
    terms $t \in \Iterms$ such that $t : \omega(\forall\alpha\sigma)$
    and for every closed type~$\tau$ and every candidate~$X$ of
    type~$\tau$ we have $t \tau \in
    \val{\sigma}{\xi[\subst{\alpha}{X}]}{\omega[\subst{\alpha}{\tau}]}$.
  \end{itemize}
\end{definition}

\begin{lemma}
  $\val{\tau}{\xi}{\omega}$ is a candidate of type~$\omega(\tau)$.
\end{lemma}

\begin{proof}
  Induction on~$\tau$. If $\tau = \alpha$ then
  $\val{\alpha}{\xi}{\omega} = \xi(\alpha)$ is a candidate. If $\tau =
  \nat$ then this is obvious from definitions.

  Assume $\tau=\tau_1\arrtype\tau_2$.

  Assume $\tau=\forall\alpha\sigma$. TODO
\end{proof}

\begin{lemma}
  Let $t : \omega(\tau)$. Let $\gamma_1,\gamma_2$ be substitutions
  such that for $x \in \FV(t)$ of type~$\sigma$ we have $\gamma_i(x)
  \in \val{\sigma}{\xi}{\omega}$ and $\gamma_1(x) \succeq
  \gamma_2(x)$. Then $\gamma_i(t) \in \val{\tau}{\xi}{\omega}$ and
  $\gamma_1(t) \succeq \gamma_2(t)$.
\end{lemma}

\begin{proof}
  Induction on~$t$. We have the following cases.
  \begin{itemize}
  \item $t = x$. Then this follows from assumption on~$\gamma_i$.
  \item $t = t_1 t_2$ and $t_1 : \sigma\arrtype\tau$ and $t_2 :
    \sigma$. By the inductive hypothesis $\gamma_i(t_1) \in
    \val{\sigma\arrtype\tau}{\xi}{\omega}$ and $\gamma_i(t_2) \in
    \val{\sigma}{\xi}{\omega}$, and $\gamma_1(t_1) \succeq
    \gamma_2(t_1)$ and $\gamma_1(t_2) \succeq \gamma_2(t_2)$. By the
    definition of~$\val{}{}{}$ we have $\gamma_i(t) =
    \gamma_i(t_1)\gamma_i(t_2) \in \val{\tau}{\xi}{\omega}$, and
    $\gamma_1(t_1)\gamma_1(t_2) \succeq
    \gamma_1(t_1)\gamma_2(t_2)$. By the definition of~$\succeq$ also
    $\gamma_1(t_1)\gamma_2(t_2)\succeq\gamma_2(t_1)\gamma_2(t_2)$. By
    the transitivity of~$\succeq$ we obtain $\gamma_1(t) =
    \gamma_1(t_1)\gamma_1(t_2) \succeq \gamma_2(t_1)\gamma_2(t_2) =
    \gamma_2(t)$.
  \item $t = \abs{x}{u}$ and $\tau=\tau_1\arrtype\tau_2$. Let $s_1,s_2
    \in \val{\tau_1}{\xi}{\omega}$ be such that $s_1 \succeq s_2$. Let
    $\gamma_i'=\gamma[\subst{x}{s_i}]$. By the inductive hypothesis
    $\gamma_1'(u)\succeq\gamma_2'(u)$. We have $\gamma_i(\abs{x}{u})
    s_i \leadsto \gamma_i'(u)$. Hence $\gamma_1(t) s_1 \succeq
    \gamma_2(t) s_2$ by Lemma~??. An (ALMOST) analogous argument shows
    that if $s \in \val{\tau_1}{\xi}{\omega}$ then $\gamma_i(t) s \in
    \val{\tau_1\arrtype\tau_2}{\xi}{\omega}$.
  \item $t = u \phi$ and $\tau = \sigma[\subst{\alpha}{\phi}]$ and $u
    : \forall\alpha\sigma$. By the inductive hypothesis $\gamma_i(u)
    \in \val{\forall\alpha\sigma}{\xi}{\omega}$ and $\gamma_1(u)
    \succeq \gamma_2(u)$. By the definition of~$\succeq$ we have
    $\gamma_1(u) \phi \succeq \gamma_2(u) \phi$, i.e., $\gamma_1(t)
    \succeq \gamma_2(t)$. Because~$\val{\phi}{\xi}{\omega}$ is a
    candidate by Lemma~??, by the definition of~$\val{}{}{}$ we have
    $\gamma_i(u) \phi \in
    \val{\sigma}{\xi[\subst{\alpha}{\val{\phi}{\xi}{\omega}}]}{\omega[\subst{\alpha}{\phi}]}$. By
    Lemma~?? we have
    $\val{\sigma}{\xi[\subst{\alpha}{\val{\phi}{\xi}{\omega}}]}{\omega[\subst{\alpha}{\phi}]}
    = \val{\sigma[\subst{\alpha}{\phi}]}{\xi}{\omega}$.
  \item $t = \tabs{\alpha}{u}$ and $\tau = \forall\alpha\sigma$. Let
    $\phi$ be a closed type. TODO.
  \end{itemize}
\end{proof}

\begin{lemma}\label{lem_succeq_subst}
  If $s \succeq s'$ then $t[\subst{x}{s}] \succeq t[\subst{x}{s'}]$.
\end{lemma}

\begin{proof}
\end{proof}

\subsection{Encodings of inductive types}\label{sec_encodings}


\section{Systems of interest and their properties}\label{sec:systems}

The systems of interest are sets of terms with a rewriting relation on
them. Interestingly, $\Iterms$ can be seen as an instance of this
general scheme.

\subsection{Systems of interest}

We use a syntax based on system~$\Fomega$, specialising
Section~\ref{sec_preliminaries}.

\begin{definition}\normalfont
  \emph{Kinds}, \emph{type constructors} and \emph{types} are defined
  like in Definition~\ref{def_types}, parameterised by a fixed
  set~$\Sigma_T$ of type constructor symbols.

  Given a fixed set~$\Sigma$ of function symbols, we define
  \emph{terms} like in Definition~\ref{def_terms} (based on
  Definition~\ref{def_preterms}) with the following restrictions:
  \begin{itemize}
  \item if $\mathtt{f} : \sigma \in \Sigma$ then $\sigma$ is closed and
    \[
    \sigma = \forall (\alpha_1 : \kappa_1) \ldots \forall (\alpha_n : \kappa_n)
    . \sigma_1 \arrtype \ldots \arrtype \sigma_k \arrtype \tau
    \]
    with~$\tau$ a type atom,
  \item for any subterm $t_1 t_2$ of a term~$t$, the subterm~$t_1$ is
    not a variable or an abstraction.
  \end{itemize}
\end{definition}

We use the notation
$\mathtt{f}_{\rho_1,\ldots,\rho_n}(s_1,\ldots,s_k)$ for
$\mathtt{f} \rho_1 \ldots \rho_n s_1 \ldots s_k$ when
\[
  \mathtt{f} : \forall (\alpha_1 : \kappa_1) \ldots
  \forall (\alpha_n : \kappa_n) . \sigma_1 \arrtype \ldots \arrtype
  \sigma_k \arrtype \tau
\]
is a function symbol in~$\Sigma$ with~$\tau$ a type atom, and $\rho_i$
is a type constructor of kind $\kappa_i$ for $i=1,\ldots,k$, and
$\Gamma \proves s_i : \sigma_i[\alpha_1 := \rho_1]\ldots[\alpha_n :=
  \rho_n]$ for $i=1,\ldots,k$, for an appropriate~$\Gamma$. We use
this notation to stress the fact that by default there is no explicit
application available. The application in the syntax of terms is used
just as a convenient syntax, but does not correspond to the usual
application operator since only applications of the form $\mathtt{f}
u_1 \ldots u_n$ are allowed. True application can be modelled by
including the symbol ${@} : \forall\alpha\forall\beta . (\alpha
\arrtype \beta) \arrtype \alpha \arrtype \beta$ in
$\Sigma$. Similarly, type application is modelled through a symbol
$\mathtt{A} : \forall \alpha : * \arrkind * . \forall \beta . (\forall
\beta [\alpha \beta]) \arrtype \alpha \beta$.

We use the notations and terminology of Section~\ref{sec_world}. To
avoid confusion, the terms, types, type constructors, etc.~in the
interpretation (those defined in Section~\ref{sec_world}) are always
referred to as interpretation terms, interpretation types,
interpretation type constructors, etc.

The rules are simply a set of term pairs, whose monotonic closure
generates the rewrite relation.

\begin{definition}\normalfont
We fix a variable environment $\Gamma$, and assume given a set
$\Rules$ of term pairs $(\ell,r)$, such that:
\begin{itemize}
\item $\FV(r) \subseteq \FV(\ell) \subseteq \mathit{keys}(\Gamma)$;
\item $\ell$ and $r$ have the same type under $\Gamma$;
\item $\Rules$ is stable: if $(\ell,r) \in \Rules$ and $\omega$ is a
  type constructor substitution and $\gamma$ is a term substitution
  such that $\omega(\Gamma) \proves \gamma(x) : \omega(\Gamma(x))$,
  then $(\gamma(\omega(\ell)),\gamma(\omega(r))) \in \Rules$.
\end{itemize}
The reduction relation $\arr{\Rules}$ is the smallest monotonic
relation that contains $\Rules$.
\end{definition}

\subsubsection{An example system.}

For the system of urzy\_emb, we have the following type constructor
symbols:
\[
\begin{array}{c}
\TypeConstructors = \{\quad
  \bot : *,\quad
  \mathtt{or} : * \arrkind * \arrkind *,\quad
  \mathtt{and} : * \arrkind * \arrkind *,\quad
  \exists : (* \arrkind *) \arrkind *
  \}
\end{array}
\]

We have the following function symbols:
\[
\begin{array}{rcl}
@ & : & \forall \alpha \forall \beta . (\alpha \arrtype \beta) \arrtype \alpha \arrtype \beta \\
\mathtt{tapp} & : & \forall \alpha : * \arrkind * . \forall \beta .
  (\forall \beta [\alpha \beta]) \arrtype \alpha \beta \\
\epsilon & : & \forall \alpha . \bot \arrtype \alpha \\
\mathtt{pair} & : & \forall \alpha \forall \beta . \alpha \arrtype \beta \arrtype
  \mathtt{and}\, \alpha\, \beta \\
\pi^1 & : & \forall \alpha \forall \beta . \mathtt{and}\, \alpha\, \beta \arrtype \alpha \\
\pi^2 & : & \forall \alpha \forall \beta . \mathtt{and}\, \alpha\, \beta \arrtype \beta \\
\mathtt{in}^1 & : & \forall \alpha \forall \beta . \alpha \arrtype
  \mathtt{or}\, \alpha\, \beta \\
\mathtt{in}^2 & : & \forall \alpha \forall \beta . \beta \arrtype
  \mathtt{or}\, \alpha\, \beta \\
\mathtt{case} & : & \forall \alpha \forall \beta \forall \gamma . \mathtt{or}\, \alpha\, \beta \arrtype
  (\alpha \arrtype \gamma) \arrtype (\beta \arrtype \gamma) \arrtype \gamma \\
\mathtt{let} & : & \forall \alpha : * \arrkind * . \forall \beta .
  (\exists (\alpha)) \arrtype
  (\forall \gamma . \alpha \gamma \arrtype \beta) \arrtype \beta \\
\mathtt{ext} & : & \forall \alpha : * \arrkind * . \forall \beta . \alpha \beta \arrtype
  \exists (\alpha)
\end{array}
\]

\LC{I think it's clearer to do this for closed terms only,
  because then termination for open terms follows by closing them with
  lambda-abstractions.}

\LC{You had some mistakes in the rules below. I think these were only
  typos, but re-check if the interpretation still works. Though the
  rules in the last group were all wrong -- the types didn't match.}

\CK{With the ability to have type variables of a kind $* \arrkind *$
  these feel \emph{much} more natural.  This should work out. :)}

And finally the rules.
\[
\begin{array}{rcl}
@_{\sigma,\tau}(\abs{x}{s},t) & \red & s[x:=t] \\
\mathtt{tapp}_{\abs{\alpha}{\sigma},\tau}(\tabs{\alpha}{s}) & \red &
  s[\alpha:=\tau] \\
\pi^1_{\sigma,\tau}(\mathtt{pair}_{\sigma,\tau}(s,t)) & \red & s \\
\pi^2_{\sigma,\tau}(\mathtt{pair}_{\sigma,\tau}(s,t)) & \red & t \\
\mathtt{case}_{\sigma,\tau,\rho}(\mathtt{in}^1_{\sigma,\tau}(u),
  \abs{x}{s},\abs{y}{t}) & \red & s[x:=u] \\
\mathtt{case}_{\sigma,\tau,\rho}(\mathtt{in}^2_{\sigma,\tau}(u),
  \abs{x}{s},\abs{y}{t}) & \red & t[x:=u] \\
\mathtt{let}_{\varphi,\rho}(\mathtt{ext}_{\varphi,\tau}(s),\tabs{\alpha}{\abs{x:\varphi \alpha}{t}}) & \red & t[\alpha:=\tau][x:=s] \\
\end{array}
\]
\[
\begin{array}{rcl}
\epsilon_\tau(\epsilon_\bot(s)) & \red & \epsilon_\tau(s) \\
@_{\sigma,\tau}(\epsilon_{\sigma \arrtype \tau}(s),t) & \red &
  \epsilon_\tau(s) \\
\mathtt{tapp}_{\varphi,\tau}(
  \epsilon_{\quant{\alpha}{\varphi\alpha}}(s)) & \red &
  \epsilon_{\varphi\tau}(s) \\
\pi^1_{\sigma,\tau}(\epsilon_{\mathtt{and}\,\sigma\,\tau}(s)) & \red &
  \epsilon_\sigma(s) \\
\pi^2_{\sigma,\tau}(\epsilon_{\mathtt{and}\,\sigma\,\tau}(s)) & \red &
  \epsilon_\tau(s) \\
\mathtt{case}_{\sigma,\tau,\rho}(\epsilon_{\mathtt{or}\,\sigma\,\tau}(
  u),\abs{x:\sigma}{s},\abs{y:\tau}{t}) & \red & \epsilon_\rho(u) \\
\mathtt{let}_{\varphi,\rho}(\epsilon_{\exists(\varphi)}(s),\tabs{\alpha}{\abs{x:\varphi\alpha}{t}}) & \red &
  \epsilon_\rho(s) \\
\end{array}
\]
\begin{itemize}
%\[
%\begin{array}{rcl}
\item $
\epsilon_\rho(\mathtt{case}_{\sigma,\tau,\bot}(u,\abs{x:\sigma}{s},\abs{y:\tau}{t}))
  %& \red &
  \red
  \mathtt{case}_{\sigma,\tau,\rho}(u,\abs{x:\sigma}{\epsilon_\rho(s)},
  \abs{y:\tau}{\epsilon_\rho(t)}) $%\\
\item $
@_{\rho,\pi}(\mathtt{case}_{\sigma,\tau,\rho \arrtype \pi}(u,
  \abs{x:\sigma}{s},\abs{y:\tau}{t}),v) %& \red &
  \red
  \mathtt{case}_{\sigma,\tau,\pi}(u,
  \abs{x:\sigma}{@_{\rho,\pi}(s,v)},\abs{y:\tau}{@_{\rho,\pi}(t,v)}) $%\\
\item $
\mathtt{tapp}_{\varphi,\pi}(\mathtt{case}_{\sigma,\tau,
  \quant{\alpha}{\varphi\alpha}}(u,\abs{x:\sigma}{s},\abs{y:\tau}{t})) %& \red &
  \red
  \mathtt{case}_{\sigma,\tau,\varphi\pi}(u,
  \abs{x:\sigma}{\mathtt{tapp}_{\varphi,\pi}(s)},\\
  \abs{y:\tau}{\mathtt{tapp}_{\varphi,\pi}(t)}) $%\\
\item $
\pi^1_{\rho,\pi}(\mathtt{case}_{\sigma,\tau,\mathtt{and}\,\rho\,\pi}(u,
\abs{x:\sigma}{s},\abs{y:\tau}{t})) %& \red &
  \red
  \mathtt{case}_{\sigma,\tau,\rho}(u,\abs{x:\sigma}{\pi^1_{\rho,\pi}(s)},
  \abs{y:\tau}{\pi^1_{\rho,\pi}(t)}) $%\\
\item $
\pi^2_{\rho,\pi}(\mathtt{case}_{\sigma,\tau,\mathtt{and}\,\rho,\pi}(u,
  \abs{x:\sigma}{s},\abs{y:\tau}{t})) %& \red &
  \red
  \mathtt{case}_{\sigma,\tau,\pi}(u,\abs{x:\sigma}{\pi^2_{\rho,\pi}(s)},
  \abs{y:\tau}{\pi^2_{\rho,\pi}(t)}) $%\\
\item $
\mathtt{case}_{\rho,\pi,\xi}(\mathtt{case}_{\sigma,\tau,\mathtt{or}\,
  \rho\,\pi}(u,\abs{x:\sigma}{s},\abs{y:\tau}{t}),\abs{z:\rho}{v},\abs{a:\pi}{w}) %& \red &
  \red\\
  \mathtt{case}_{\sigma,\tau,\xi}(u,
    \abs{x:\sigma}{\mathtt{case}_{\rho,\pi,\xi}(s,\abs{z:\rho}{v},\abs{a:\pi}{w})},
    \abs{y:\tau}{\mathtt{case}_{\rho,\pi,\xi}(t,\abs{z:\rho}{v},\abs{a:\pi}{w})}) $%\\
\item $
    \mathtt{let}_{\varphi,\rho}(
  \mathtt{case}_{\sigma,\tau,\exists\varphi}(
  u,\abs{x:\sigma}{s},\abs{y:\tau}{t}),v) %& \red &
  \red\\
  \mathtt{case}_{\sigma,\tau,\rho}(u,
  \abs{x:\sigma}{\mathtt{let}_{\varphi,\rho}(s,v)},
  \abs{y:\tau}{\mathtt{let}_{\varphi,\rho}(t,v)})
  $%\\
%\end{array}
%\]
\end{itemize}
\LC{The following rules were wrong. The types didn't match -- you
  forgot the lambda-abstractions.}
\CK{They now seem to be okay, though!}
\begin{itemize}
\item
  $\epsilon_\tau(\mathtt{let}_{\varphi,\bot}(s,\tabs{\alpha}{\abs{x:\varphi\alpha}{t}}))
  \red
  \mathtt{let}_{\varphi,\tau}(s,\tabs{\alpha}{\abs{x:\varphi\alpha}{\epsilon_\tau(t)}})$
\item $@_{\tau,\rho}(\mathtt{let}_{\varphi, \tau \arrtype
  \rho}(s,\tabs{\alpha}{\abs{x:\varphi\alpha}{t}}),u) \red
  \mathtt{let}_{\varphi,\rho}(s,\tabs{\alpha}{\abs{x:\varphi\alpha}{@_{\tau,\rho}(t,
      u)}})$
\item
  $\mathtt{tapp}_{\psi,\rho}(\mathtt{let}_{\varphi,\forall\beta[\psi\beta]}(s,\tabs{\alpha}{\abs{x:\varphi\alpha}{t}}))
  \red
  \mathtt{let}_{\varphi,\psi\rho}(s,\tabs{\alpha}{\abs{x:\varphi\alpha}{\mathtt{tapp}_{\psi,\rho}(t)}})$
\item
  $\pi^1_{\tau,\rho}(\mathtt{let}_{\varphi,
  \mathtt{and}\,\tau,\rho}(s,\tabs{\alpha}{\abs{x:\varphi\alpha}{t}}))
  \red
  \mathtt{let}_{\varphi,\tau}(s,\tabs{\alpha}{\abs{x:\varphi\alpha}{\pi^1_{\tau,
        \rho}(t)}})$
\item
  $\pi^2_{\tau,\rho}(\mathtt{let}_{\varphi,
  \mathtt{and}\,\tau\,\rho}(s,\tabs{\alpha}{\abs{x:\varphi\alpha}{t}}))
  \red
  \mathtt{let}_{\varphi,\rho}(s,\tabs{\alpha}{\abs{x:\varphi\alpha}{\pi^2_{\tau,\rho}(t)}})$
\item $\mathtt{case}_{\tau,\rho,\pi}(
  \mathtt{let}_{\varphi,\mathtt{or}\,\tau\,\rho}(s,\tabs{\alpha}{\abs{x:\varphi\alpha}{t}}),\abs{x:\tau}{u},\abs{y:\rho}{v})
  \red
  \mathtt{let}_{\varphi,\pi}(s,\tabs{\alpha}{\abs{x:\varphi\alpha}{\mathtt{case}_{\tau,\rho,\pi}(t,\abs{x:\tau}{u},\abs{y:\rho}{v})}})$
\item
  $\mathtt{let}_{\psi,\rho}(\mathtt{let}_{\varphi,\exists\psi}(s,\tabs{\alpha}{\abs{x:\varphi\alpha}{t}}),u)
  \red
  \mathtt{let}_{\varphi,\rho}(s,\tabs{\alpha}{\abs{x:\varphi\alpha}{\mathtt{let}_{\psi,\rho}(t,u)}})$
\end{itemize}

\LC{To be completely precise we should define a translation $\Phi$
  from the system urzy\_emb to the above and show that if $s \red t$
  in urzy\_emb then $\Phi(s) \red \Phi(t)$. But this should be easy
  once the reductions are defined correctly.}

\subsection{Interpreting interesting terms}

All terms will be mapped to interpretation terms, which are compared
using $\succ$ to hopefully obtain a decrease that can be used with
rule removal.

\begin{definition}\normalfont
A \emph{type constructor mapping} is a function $\Typemap$ which maps
a type constructor symbol to an interpretation type constructor of the
same kind.

A fixed type constructor mapping $\Typemap$ is extended inductively to
a function from type constructors to interpretation type constructors
in the expected way. We denote the extended mapping
by~$\typeinterpret{\sigma}$. Thus, for example
$\typeinterpret{\quant{\alpha}{\sigma}} =
\quant{\alpha}{\typeinterpret{\sigma}}$ and $\typeinterpret{\sigma
  \arrtype \tau} = \typeinterpret{\sigma} \arrtype
\typeinterpret{\tau}$.
\end{definition}

Similarly, we employ a \emph{symbol mapping} as an aid to interpret
\emph{terms}.

\begin{definition}\normalfont
  A \emph{symbol mapping} is a function $\Termmap$ which assigns to
  each function symbol $\mathtt{f} : \rho$ a closed interpretation
  term $\Termmap(\mathtt{f})$ of type~$\typeinterpret{\rho}$. For a
  fixed symbol mapping $\Termmap$, we define $\interpret{s}$
  inductively:
  \[
    \begin{array}{rcl}
      \interpret{x} & = & x \\
      \interpret{\tabs{\alpha}{s}} & = & \tabs{\alpha}{\interpret{s}} \\
      \interpret{\abs{x:\sigma}{s}} & = & \abs{x:\typeinterpret{\sigma}}{
                                          \interpret{s}} \\
      \interpret{\app{t_1}{t_2}} &=& \app{\interpret{t_1}}{\interpret{t_2}} \\
      \interpret{\tapp{t}{\tau}} &=& \tapp{\interpret{t}}{\typeinterpret{\tau}} \\
      \interpret{\mathtt{f}} &=& \Termmap(\mathtt{f})
    \end{array}
  \]

  Symbol mapping is extended to contexts as follows:
  \[
    \itp{\Gamma} := \{ (x : \typeinterpret{\tau}) \mid (x : \tau) \in \Gamma \}
  \]
\end{definition}

Interpretation mapping preserves typing:

\begin{lemma}
If $\Gamma \vdash s : \sigma$ then $\itp{\Gamma} \vdash \interpret{s}
: \typeinterpret{\sigma}$.
\end{lemma}

\begin{proof} % Now this is straightforward with the new definitions
  By induction on the form of $s$.\qed
\end{proof}

\subsection{Monotonicity and rule removal}

\begin{definition}\normalfont
  A \emph{$\sigma$-context}~$C_\sigma$ is a term with a fresh function
  symbol $\Box_\sigma \notin \Sigma$ of type~$\sigma$ occurring
  exactly once. By~$C_\sigma[t]$ we denote a term obtained
  from~$C_\sigma$ by substituting~$t$ for~$\Box_\sigma$. We drop the
  $\sigma$ subscripts when clear or irrelevant.

  A relation~$R$ on terms of type~$\sigma$ is \emph{monotonic} if
  $R(s, t)$ implies $R(C[s], C[t])$ for every $\sigma$-context~$C$.
\end{definition}

We use \emph{rule removal}:

\begin{theorem}\label{thm:ruleremove}
Let $\Rules = \Rules_1 \cup \Rules_2$, and suppose that
$\arr{\Rules_1}\: \subseteq\:\succ$ and
$\arr{\Rules_2}\:\subseteq\:\succeq$ for a well-founded ordering
$\succ$ and a compatible quasi-ordering $\succeq$.  Then
$\arr{\Rules}$ is terminating if and only if $\arr{\Rules_2}$ is
(which is certainly the case if $\Rules_2 = \emptyset$).
\end{theorem}

\begin{proof}
By well-foundedness of $\succ$, every infinite decreasing $\arr{\Rules}$
sequence can only use finitely many steps using $\arr{\Rules_1}$.
\qed
\end{proof}

If $\succ$ and $\succeq$ are monotonic, this gives rise to the
following algorithm:
\begin{enumerate}
\item While $\Rules$ is non-empty:
  \begin{enumerate}
  \item Orient all rules in $\Rules$ using $\succeq$ or $\succ$; at least
    one of them must be oriented using $\succ$.
  \item Remove all rules ordered by $\succ$ from $\Rules$.
  \end{enumerate}
\end{enumerate}
If this algorithm succeeds, we have proven termination.

We propose using a pair $(\succinterpret,\succeqinterpret)$ defined as
follows: $s \succinterpret t$ if $\interpret{s} \succ \interpret{t}$ and
$s \succeqinterpret t$ if $\interpret{s} \succeq \interpret{t}$ (for a
fixed type constructor mapping $\Typemap$ and symbol mapping $\Termmap$).
To use this pair to prove termination of $\arr{\Rules}$ with rule removal,
two things must be proved:

\begin{itemize}
\item all rules in $\Rules$ can be oriented with $\succeqinterpret$ or
  $\succinterpret$ and at least one with $\succinterpret$;
\item $\succinterpret$ and $\succeqinterpret$ are both monotonic.
\end{itemize}

The former requirement has to be verified for every individual rule.
For the latter requirement, we can provide some sufficient criteria that
guarantee monotonicity of both $\succinterpret$ and $\succeqinterpret$.

\begin{definition}\normalfont
  An interpretation term~$t$ is \emph{safe for~$x$} if one of the
  following holds:
  \begin{itemize}
  \item $t = x u_1 \ldots u_m$,
  \item $t = \lift(t')$ and $t'$ is safe for~$x$,
  \item $t = \flatten(t')$ and $t'$ is safe for~$x$,
  \item $t = s_1 \oplus s_2$ and either $s_1$ is safe for~$x$ or $s_2$
    is safe for~$x$,
  \item $t = s_1 \otimes s_2$ and either:
    \begin{itemize}
    \item $s_1$ is safe for~$x$ and $s_2 \succeq \lift(1)$, or
    \item $s_2$ is safe for~$x$ and $s_1 \succeq \lift(1)$,
    \end{itemize}
  \item $t = \tabs{\alpha}{t'}$ and $t'$ is safe for~$x$,
  \item $t = \abs{y}{t'}$ and $t'$ is safe for~$x$.
  \end{itemize}
  A symbol mapping~$\Termmap$ is \emph{safe} if for all symbols $\afun
  : \forall (\alpha_1 : \kappa_1) \ldots \forall (\alpha_n : \kappa_n)
  . \sigma_1 \arrtype \ldots \arrtype \sigma_k \arrtype \tau$
  with~$\tau$ a type atom we have: $\Termmap(\afun) = \tabs{\alpha_1
    \dots \alpha_n}{\abs{x_1 \dots x_k}{t}}$ with $t$ safe for
  each~$x_i$.
\end{definition}

\begin{lemma}
  If~$t$ is safe for~$x$ and $s \succ s'$ (resp.~$s \succeq s'$) then
  $t[\subst{x}{s}] \succ t[\subst{x}{s'}]$ (resp.~$t[\subst{x}{s}]
  \succeq t[\subst{x}{s'}]$).
\end{lemma}

\begin{proof}
  Induction on the structure of~$t$. If $t = x u_1 \ldots u_m$ then
  TODO.
\end{proof}

\begin{lemma}
  If $t$ is safe for~$x$ and $y \ne x$, then $t[\subst{y}{s}]$ is
  still safe for~$x$.
\end{lemma}

\begin{proof}
\end{proof}

\begin{lemma}
  If~$\Termmap$ is safe then both $\succinterpret$ and
  $\succeqinterpret$ are monotonic.
\end{lemma}

\begin{proof}
  TODO
\end{proof}

\section{Some useful lemmas}

Some things I will need:

\begin{lemma}\label{lem:substitutioninterpret}
We have:
\begin{enumerate}
\item\label{lem:substitutioninterpret:types}
  $\typeinterpret{\sigma}[\alpha:=\typeinterpret{\tau}] =
  \typeinterpret{\sigma[\alpha:=\tau]}$
\item\label{lem:substitutioninterpret:mixed}
  $\interpret{s}[\alpha:=\typeinterpret{\tau}] =
  \interpret{s[\alpha:=\tau]}$
\item\label{lem:substitutioninterpret:terms}
  $\interpret{s}[x:=\interpret{t}] = \interpret{s[x:=t]}$
\end{enumerate}
\end{lemma}

\begin{proof}
TODO
\end{proof}

\subsection{Orienting $\beta$-reduction}

\subsection{Orienting type instantiation}

\subsection{Other}

\section{Some systems of interest -- urzy\_emb?}

\subsection{Interpretations}

We use the following type constructor mapping:
\[
\begin{array}{rcl}
\Typemap(\bot) & = & \nat \\
\Typemap(\mathtt{or}) & = & \lambda\alpha_1\lambda\alpha_2 . \alpha_1 \times \alpha_2 \\
\Typemap(\mathtt{and}) & = & \lambda\alpha_1\lambda\alpha_2 . \alpha_1 \times \alpha_2 \\
\Typemap(\mathtt{prop}_i) & = & \nat \\
\Typemap(\exists) & = & \lambda(\alpha : * \arrkind *) . \quant{\beta}{\quant{\gamma}{\alpha\gamma \arrtype \beta} \arrtype \beta}
\end{array}
\]
And the following function symbol mapping:
\[
\begin{array}{rcll}
\Termmap(\epsilon) & = & \Lambda \alpha:* . \lambda x:\nat. &
  \mathtt{lift}_\alpha(x) \\
\Termmap(@) & = & \Lambda\alpha\Lambda\beta\lambda x: \alpha \arrtype \beta . \lambda y :
  \alpha . \quad & x \cdot y \oplus \lift_\beta(\flatten_\alpha(
  y) \oplus 1) \\
\Termmap(\mathtt{tapp}) & = & \Lambda \alpha : * \arrkind * . \Lambda \beta . \lambda x : \quant{\gamma}{\alpha\gamma} . \quad & x * \beta \oplus \lift_{\alpha\beta}(1) \\
\Termmap(\mathtt{ext}) & = & \Lambda \alpha : * \arrkind * . \Lambda \beta : * . \lambda x:\alpha\beta . &
  \tabs{\xi}{\abs{y:\quant{\chi}{\alpha\chi
  \arrtype \xi}}{y * \beta \cdot x}} \\
\Termmap(\mathtt{in}^1) & = & \Lambda \alpha \Lambda \beta \lambda x : \alpha.\quad &
  (x, \mathtt{lift}_\beta(1)) \\
\Termmap(\mathtt{in}^2) & = & \Lambda \alpha \Lambda \beta \lambda x : \beta.\quad &
  (\mathtt{lift}_\alpha(1), x) \\
\Termmap(\pi^1) & = & \Lambda \alpha \Lambda \beta \lambda x : \alpha \times \beta.
  \quad & \pi^1_{\alpha,\beta}(x) \oplus \lift_{\alpha}(1) \\
\Termmap(\pi^2) & = & \Lambda \alpha \Lambda \beta \lambda x : \alpha \times \beta.
  \quad & \pi^2_{\alpha,\beta}(x) \oplus \lift_{\beta}(1) \\
\Termmap(\mathtt{pair}) & = & \Lambda \alpha \Lambda \beta \lambda x : \alpha, y :
  \beta.\quad & (x, y) \\
\end{array}
\]
\[
\begin{array}{rcl}
\Termmap(\mathtt{let}) & = & \Lambda \alpha : * \arrkind * . \Lambda \beta : * . \lambda x : \quant{\chi}{
  \quant{\xi}{\alpha\xi \arrtype \chi} \arrtype \chi},
  y : \quant{\xi}{\alpha\xi \arrtype \beta}. \\
  & & \hfill x * \beta \cdot y \oplus \lift_{\beta}(\flatten(y) \oplus
  1) \\
\Termmap(\mathtt{case}) & = & \Lambda \alpha,\beta,\xi . \lambda x : (\alpha
  \times \beta), y : (\alpha \arrtype \xi), z : (\beta \arrtype \xi). \\
  & & \quad
  \lift_\xi(37) \oplus (\ \lift_\xi(\flatten_{\alpha \times\beta}(
  x) \oplus 1) \otimes \\
  & & \phantom{\quad\lift_\xi(37) \oplus a}\
  ((y \cdot \proj^1_{\alpha,\beta}(x)) \oplus
   (z \cdot \proj^2_{\alpha,\beta}(x)) \oplus \lift_\xi(1))
  \ ) \\
\end{array}
\]

\subsection{Rule orientation}

\LC{The following should be adapted to the new notation and
  re-checked, because some rules were incorrect.}

\begin{itemize}
\item $@_{\sigma,\tau}(\abs{x}{s},t) \red s[x:=t]$ \\ We have
  $\interpret{@(\abs{x:\sigma}{s},t)} = (\abs{x:\typeinterpret{
    \sigma}}{\interpret{s}}) \cdot \interpret{t} \oplus
  \lift(\flatten( \interpret{t}) \oplus 1) \leadsto
  \interpret{s}[x:=\interpret{t}] \oplus \lift(\flatten(\interpret{t})
  \oplus 1)$.  Since, by Lemma \ref{lem:liftgreater} we have
  $\lift(\flatten(\interpret{t}) \oplus 1) \succeq \lift(1)$, by Lemma
  \ref{lem:plustimesmonotonic} this term $\succ
  \interpret{s}[x:=\interpret{t}]$, which equals $\interpret{s[x:=t]}$
  by Lemma \ref{lem:substitutioninterpret}.  Thus, we can remove this
  rule.
\item $\mathtt{tapp}_{\quant{\alpha}{\sigma},\tau}(\tabs{\alpha}{s})
  \red s[\alpha:=\tau]$ \\ We have
  $\interpret{\mathtt{tapp}_{\quant{\alpha}{\sigma},
      \tau}(\tabs{\alpha}{s})} = (\tabs{\alpha}{\interpret{s}}) *
  \typeinterpret{\tau} \oplus \lift(1) \leadsto \interpret{s}[\alpha:=
    \typeinterpret{\tau}] \oplus \lift(1) \succ
  \interpret{s}[\alpha:=\typeinterpret{\tau}] =
  \interpret{s[\alpha:=\tau]}$.  Thus, we can remove this rule.
\item $\mathtt{let}_{\qquant{\forall}{\alpha}{\sigma},\rho}(
  \mathtt{ext}_{\qquant{\forall}{\alpha}{\sigma},\tau}(s),\tabs{\alpha}{
    \abs{x:\sigma}{t}}) \red t[\alpha:=\tau][x:=s]$ \\
  Let $u := \mathtt{ext}_{\quant{\alpha}{\sigma},\tau}(s)$ and
  $w := \tabs{\alpha}{\abs{x}{t}}$.  Then we have:
  \begin{itemize}
  \item $\interpret{u} =
    \tabs{\xi}{\abs{y:\quant{\alpha}{\sigma \arrtype \xi}}{
    y * \typeinterpret{\tau} \cdot \interpret{s}}}$ (which has type
    $\quant{\xi}{\quant{\alpha}{\sigma \arrtype \xi} \arrtype \xi}$);
  \item $\interpret{w} = \tabs{\alpha}{\abs{x:\typeinterpret{\sigma}}{
    \interpret{t}}}$ (which has type $\quant{\alpha}{\sigma \arrtype
    \rho}$ with $\alpha \notin \FTV(\rho)$);
  \item $\interpret{\mathtt{let}_{\quant{\alpha}{\sigma},\rho}(u,w)} =
    \interpret{u} * \rho \cdot \interpret{w} \oplus
    \lift(\flatten(\interpret{w})\oplus 1) \succeq
    \interpret{u} * \rho \cdot \interpret{w} \oplus \lift(1)$ by
    Lemmas \ref{lem:liftgreater} and \ref{lem:plustimesmonotonic} as
    before; by Lemma \ref{lem:plustimesmonotonic} again this term
    $\succ \interpret{u} * \rho \cdot \interpret{w}
    \leadsto (\abs{y}{y * \typeinterpret{\tau} \cdot \interpret{s}})
    \cdot \interpret{w} \leadsto \interpret{w} * \typeinterpret{\tau}
    \cdot \interpret{s} \leadsto (\abs{x:\typeinterpret{\sigma}[\alpha:=
    \typeinterpret{\tau}]}{\interpret{t}[\alpha:=\typeinterpret{\tau}]})
    \cdot \interpret{s} \leadsto \interpret{t}[\alpha:=\typeinterpret{
    \tau}][x:=\interpret{s}]$.  By Lemma
    \ref{lem:substitutioninterpret} this is equal to
    $\interpret{t[\alpha:=\tau][x:=s]}$.
  \end{itemize}
\item $\pi^1_{\sigma,\tau}(\mathtt{pair}_{\sigma,\tau}(s,t)) \leadsto
  s$ \\
  We have $\interpret{\pi^1_{\sigma,\tau}(\mathtt{pair}_{\sigma,\tau}(
  s,t))} = \pi^1_{\typeinterpret{\sigma,\tau}}(\interpret{s},
  \interpret{t}) \oplus \lift(1) \leadsto \interpret{s} \oplus
  \lift(1) \succ \interpret{s}$.
\item $\pi^2_{\sigma,\tau}(\mathtt{pair}_{\sigma,\tau}(s,t)) \red t$ \\
  We have $\interpret{\pi^2_{\sigma,\tau}(\mathtt{pair}_{\sigma,\tau}(
 s,t))} = \pi^2_{\typeinterpret{\sigma,\tau}}(\interpret{s},
  \interpret{t}) \oplus \lift(1) \leadsto \cdot \succ \interpret{t}$.
\item $\mathtt{case}_{\sigma,\tau,\rho}(\mathtt{in}^1_{\sigma,\tau}(u),
  \abs{x}{s},\abs{y}{t}) \red s[x:=u]$ \\
  For brevity, let $uu := \interpret{\mathtt{in}^1_{\sigma,\tau}(u)} =
  (\interpret{u}, \lift_\tau(1))$.
  Also denote $\varphi := \lift_\rho(\flatten_{\sigma \times \tau}(
  uu) \oplus_{\nat} 1)$. \\
  We have $\interpret{\mathtt{case}_{\sigma,\tau,\rho}(\dots)} =
  \lift_\rho(37) \oplus (\varphi\,\otimes (\ (\abs{x:
  \typeinterpret{\sigma}}{\interpret{s}}) \cdot \proj^1_{\sigma,\tau}(
  uu) \oplus
  (\abs{y:\typeinterpret{\tau}}{\interpret{t}}) \cdot \proj^2_{\sigma,
  \tau}(uu)\ \oplus \lift(1)))$.
  Note that $\varphi \succeq \lift_\rho(1)$ by
  Lemma \ref{lem:liftgreater}.  Therefore, by monotonicity of $\oplus$
  and $\otimes$, the distribution property (Lemmas
  \ref{lem:plustimesmonotonic} and
  \ref{lem:approxproperties}(\ref{lem:approx:distribution})), this
  term $\succeq \lift(37) \oplus (\abs{x}{\interpret{s}}) \cdot
  \proj^1_{\sigma,\tau}(uu) \oplus (\abs{y}{\interpret{t}}) \cdot
  \proj^2_{\sigma,\tau}(uu) \oplus \lift(1) \leadsto^* \lift(37) \oplus
  \interpret{s}[x:=\interpret{u}] \oplus
  \interpret{t}[y:=\interpret{u}] \oplus \lift(1)$.  By Lemma
  \ref{lem:plusparts}\footnote{\CK{Since Lemma
  \ref{lem:plusparts} only gives that $s \oplus \lift(n) \succ s$ and
  not $\lift(n) \oplus s \succ s$, I use Lemma
  \ref{lem:approxproperties}(\ref{lem:approx:symmetry}) to obtain
  $\lift(n) \oplus s \succeq s \oplus \lift(n) \succ s$.  We will
  then also need an \emph{extended version} of Lemma
  \ref{lem:compatibility}, since as is, it does not state that
  $\succeq \cdot \succ$ is included in $\succ$.}}, this term
  $\succ \interpret{s}[x:=\interpret{u}] = \interpret{s[x:=u]}$ by
  Lemma \ref{lem:substitutioninterpret}.
\item $\mathtt{case}_{\sigma,\tau,\rho}(\mathtt{in}^2_{\sigma,\tau}(u),
  \abs{x}{s},\abs{y}{t}) \red t[x:=u]$ \\
  Symmetric to the case above.
\item $
\mathtt{case}_{\rho,\pi,\xi}(\mathtt{case}_{\sigma,\tau,\mathtt{or}(
  \rho,\pi)}(u,\abs{x}{s},\abs{y}{t}),\abs{z}{v},\abs{a}{w}) %& \red &
  \red\\
  \mathtt{case}_{\sigma,\tau,\xi}(u,
    \abs{x}{\mathtt{case}_{\rho,\pi,\xi}(s,\abs{z}{v},\abs{a}{w})},
    \abs{y}{\mathtt{case}_{\rho,\pi,\xi}(t,\abs{z}{v},\abs{a}{w})}) $\\
  We have:
  \begin{itemize}
  \item $aa := \interpret{\mathtt{case}_{\sigma,\tau,\mathtt{or}(\rho,
    \pi)}(u,\abs{x}{s},\abs{y}{t})} =$\\$
    \lift_{\typeinterpret{\rho} \times \typeinterpret{\pi}}(37) \oplus
    (\ \lift_{\typeinterpret{\rho} \times \typeinterpret{\pi}}(
      \flatten_{\typeinterpret{\sigma} \times \typeinterpret{\tau}}(
        \interpret{u}) \oplus 1) \otimes$ \\
    \phantom{x} \hfill
    $(\ ((\abs{x}{\interpret{s}}) \cdot \proj^1(\interpret{u})) \oplus
    ((\abs{y}{\interpret{t}}) \cdot \proj^2(\interpret{u})) \oplus
    \lift(1)\ )\ )$
  \end{itemize}
\end{itemize}

==========================

\[
\begin{array}{rcl}
\epsilon_\tau(\epsilon_\bot(s)) & \red & \epsilon_\tau(s) \\
@_{\sigma,\tau}(\epsilon_{\sigma \arrtype \tau}(s),t) & \red &
  \epsilon_\tau(s) \\
\mathtt{tapp}_{\quant{\alpha}{\sigma},\tau}(
  \epsilon_{\quant{\alpha}{\sigma}}(s)) & \red &
  \epsilon_{\sigma[\alpha:=\tau]}(s) \\
\pi^1_{\sigma,\tau}(\epsilon_{\mathtt{and}(\sigma,\tau)}(s)) & \red &
  \epsilon_\sigma(s) \\
\pi^2_{\sigma,\tau}(\epsilon_{\mathtt{and}(\sigma,\tau)}(s)) & \red &
  \epsilon_\tau(s) \\
\mathtt{case}_{\sigma,\tau,\rho}(\epsilon_{\mathtt{or}(\sigma,\tau)}(
  u),\abs{x}{s},\abs{y}{t}) & \red & \epsilon_\rho(s) \\
\mathtt{let}_{\qquant{\forall}{\alpha}{\sigma},\rho}(\epsilon_{\qquant{
  \forall}{\alpha}{\sigma}}(s),\tabs{\alpha}{\abs{x}{t}}) & \red &
  \epsilon_\rho(s) \\
\end{array}
\]

\begin{itemize}
%\[
%\begin{array}{rcl}
\item $
\epsilon_\rho(\mathtt{case}_{\sigma,\tau,\bot}(u,\abs{x}{s},\abs{y}{t}))
  %& \red &
  \red
  \mathtt{case}_{\sigma,\tau,\rho}(u,\abs{x}{\epsilon_\rho(s)},
  \abs{y}{\epsilon_\rho(t)}) $%\\
\item $
@_{\rho,\pi}(\mathtt{case}_{\sigma,\tau,\rho \arrtype \pi}(u,
  \abs{x}{s},\abs{y}{t}),v) %& \red &
  \red
  \mathtt{case}_{\sigma,\tau,\pi}(u,
  \abs{x}{@_{\rho,\pi}(s,v)},\abs{y}{@_{\rho,\pi}(t,v)}) $%\\
\item $
\mathtt{tapp}_{\quant{\alpha}{\rho},\pi}(\mathtt{case}_{\sigma,\tau,
  \quant{\alpha}{\rho}}(u,\abs{x}{s},\abs{y}{t})) %& \red &
  \red
  \mathtt{case}_{\sigma,\tau,\rho[\alpha:=\pi]}(u,
  \abs{x}{\mathtt{tapp}_{\quant{\alpha}{\rho},\pi}(s)},\\
  \abs{y}{\mathtt{tapp}_{\quant{\alpha}{\rho},\pi}(t)}) $%\\
\item $
\pi^1_{\rho,\pi}(\mathtt{case}_{\sigma,\tau,\mathtt{and}(\rho,\pi)}(u,
  \abs{x}{s},\abs{y}{t})) %& \red &
  \red
  \mathtt{case}_{\sigma,\tau,\rho}(u,\abs{x}{\pi^1_{\rho,\pi}(s)},
  \abs{y}{\pi^1_{\rho,\pi}(t)}) $%\\
\item $
\pi^2_{\rho,\pi}(\mathtt{case}_{\sigma,\tau,\mathtt{and}(\rho,\pi)}(u,
  \abs{x}{s},\abs{y}{t})) %& \red &
  \red
  \mathtt{case}_{\sigma,\tau,\pi}(u,\abs{x}{\pi^2_{\rho,\pi}(s)},
  \abs{y}{\pi^2_{\rho,\pi}(t)}) $%\\
\item $
\mathtt{let}_{\qquant{\forall}{\alpha}{\rho}}(
  \mathtt{case}_{\sigma,\tau,\qquant{\forall}{\alpha}{\rho}}(
  u,\abs{x}{s},\abs{y}{t}),v) %& \red &
  \red\\
  \mathtt{case}_{\sigma,\tau,\rho}(u,
  \abs{x}{\mathtt{let}_{\qquant{\forall}{\alpha}{\rho}}(s,v)},
  \abs{y}{\mathtt{let}_{\qquant{\forall}{\alpha}{\rho}}(t,v)})
  $%\\
%\end{array}
%\]
\end{itemize}
\begin{itemize}
\item $\epsilon_\tau(\mathtt{let}_{\qquant{\forall}{\alpha}{\sigma},
  \bot}(s,t)) \red
  \mathtt{let}_{\qquant{\forall}{\alpha}{\sigma},\tau}(s,\epsilon_\tau(t))$
\item $@_{\tau,\rho}(\mathtt{let}_{\qquant{\forall}{\alpha}{\sigma},
  \tau \arrtype \rho}(s,t),u) \red
  \mathtt{let}_{\qquant{\forall}{\alpha}{\sigma},\rho}(s,@_{\tau,\rho}(t,
  u))$
\item $\mathtt{tapp}_{\quant{\alpha}{\tau},\rho}(
\mathtt{let}_{\qquant{\forall}{\alpha}{\sigma},\quant{\alpha}{\tau}}(s,t))
  \red
  \mathtt{let}_{\qquant{\forall}{\alpha}{\sigma},\tau[\alpha:=\rho]}(s,
  \mathtt{tapp}_{\quant{\alpha}{\tau},\rho}(t))$
\item $\pi^1_{\tau,\rho}(\mathtt{let}_{\qquant{\forall}{\alpha}{\sigma},
  \mathtt{and}(\tau,\rho)}(s,t)) \red
  \mathtt{let}_{\qquant{\forall}{\alpha}{\sigma},\tau}(s,\pi^1_{\tau,
  \rho}(t))$
\item $\pi^2_{\tau,\rho}(\mathtt{let}_{\qquant{\forall}{\alpha}{\sigma},
  \mathtt{and}(\tau,\rho)}(s,t)) \red
  \mathtt{let}_{\qquant{\forall}{\alpha}{\sigma},\rho}(s,\pi^2_{\tau,
  \rho}(t))$
\item $\mathtt{case}_{\tau,\rho,\pi}(
  \mathtt{let}_{\qquant{\forall}{\alpha}{\sigma},\mathtt{or}(\tau,
  \rho)}(s,t),\abs{x}{u},\abs{y}{v}) \red
  \mathtt{let}_{\qquant{\forall}{\alpha}{\sigma},\pi}(s,\mathtt{case}_{
  \tau,\rho,\pi}(t,\abs{x}{u},\abs{y}{v}))$
\item $\mathtt{let}_{\qquant{\forall}{\beta}{\tau},\rho}(\mathtt{let}_{\qquant{\forall}{\alpha}{\sigma},\qquant{\forall}{\beta}{\tau}}(s,t),u) \red
  \mathtt{let}_{\qquant{\forall}{\alpha}{\sigma},\rho}(s,\mathtt{let}_{\qquant{\forall}{\beta}{\tau},\rho}(t,u))$
\end{itemize}
\end{document}
