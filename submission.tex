\documentclass[a4paper,UKenglish,cleveref,autoref,numberwithinsect]{lipics-v2019}

\usepackage{stmaryrd}
\usepackage{proof}
\usepackage[dvipsnames]{xcolor}

%\graphicspath{{./graphics/}}%helpful if your graphic files are in another directory

\bibliographystyle{plainurl}% the mandatory bibstyle

\theoremstyle{definition}
\newtheorem{defn}[theorem]{Definition}

\newcommand{\Fomega}{\mathtt{F}_\omega}

\newcommand{\Typevars}{\mathcal{A}}
\newcommand{\Vars}{\mathcal{V}}
\newcommand{\Rules}{\mathcal{R}}
\newcommand{\Iterms}{\mathcal{I}}
\newcommand{\ITypes}{\mathcal{Y}}

\newcommand{\arrkind}{\Rightarrow}
\newcommand{\arrtype}{\rightarrow}
\newcommand{\quant}[2]{\forall #1.#2}

\newcommand{\abstraction}[2]{\backslash #1.#2}
\newcommand{\app}[2]{#1 \cdot #2}
\newcommand{\tapp}[2]{#1 * #2}
\newcommand{\subst}[2]{#1:=#2}

\newcommand{\abs}[2]{\lambda #1.#2}
\newcommand{\tabs}[2]{\Lambda #1.#2}
\newcommand{\pair}[2]{\langle #1,#2 \rangle}
\newcommand{\expair}[2]{[#1,#2]}

\newcommand{\arrW}{\leadsto}
\newcommand{\arr}[1]{\longrightarrow_{#1}}
\newcommand{\red}{\longrightarrow}

\newcommand{\nat}{\mathtt{nat}}
\newcommand{\flatten}{\mathtt{flatten}}
\newcommand{\lift}{\mathtt{lift}}

\newcommand{\typeinterpret}[1]{\llbracket #1 \rrbracket}
\newcommand{\interpret}[1]{\llbracket #1 \rrbracket}
\newcommand{\itp}[1]{\llbracket #1 \rrbracket}

\newcommand{\refsec}[1]{Section~\ref{sec:#1}}

\newcommand{\FTV}{\mathrm{FTV}}
\newcommand{\FV}{\mathrm{FV}}
\newcommand{\Tc}{\mathcal{T}}
\newcommand{\Vc}{\mathcal{V}}
\newcommand{\Xc}{\CKchange{\mathcal{X}}}

\newcommand{\cl}{\mathcal{C}}
\newcommand{\dom}{\mathrm{dom}}
\newcommand{\nf}{\mathrm{nf}}

\newcommand{\da}{\mathord{\downarrow}}
\newcommand{\SN}{\mathrm{SN}}
\newcommand{\Cb}{\mathbb{C}}
\newcommand{\Nbb}{\mathbb{N}}
\newcommand{\val}[3]{\ensuremath{\llbracket#1\rrbracket_{#2}^{#3}}}
\newcommand{\gteq}[3]{\ensuremath{\ge_{#1}^{#2,#3}}}

\newcommand{\proves}{\vdash}

\newcommand{\Typemap}{\mathcal{T\!M}}
\newcommand{\Termmap}{\mathcal{J}}
\newcommand{\succinterpret}{\succ^{\Termmap}}
\newcommand{\succeqinterpret}{\succeq^{\Termmap}}

\newcommand{\List}{\mathtt{List}}
\newcommand{\Pair}{\mathtt{Pair}}
\newcommand{\nil}{\mathtt{nil}}
\newcommand{\cons}{\mathtt{cons}}
\newcommand{\fold}{\mathtt{fold}}
\newcommand{\xlet}[4]{\mathtt{let}_{#1}\,#2\,\mathtt{be}\,[#3]\,\mathtt{in}\,#4}

\newcommand{\CK}[1]{\textcolor{violet}{CK: #1}}
\newcommand{\CKchange}[1]{\textcolor{blue}{#1}}
\newcommand{\LC}[1]{\textcolor{red}{LC: #1}}
\newcommand{\LCchange}[1]{\textcolor{red}{#1}}

\title{Polymorphic Higher-order Termination}

%\titlerunning{Dummy short title}

\author{{\L}ukasz Czajka}{Faculty of Informatics, TU Dortmund, Germany \and \url{http://www.mimuw.edu.pl/~lukaszcz/} }{lukaszcz@mimuw.edu.pl}{https://orcid.org/0000-0001-8083-4280}{}

\author{Cynthia Kop}{Institute of Computer Science, Radboud University Nijmegen, Netherlands \and \url{https://www.cs.ru.nl/~cynthiakop/}}{c.kop@cs.ru.nl}{https://orcid.org/0000-0002-6337-2544}{}

\authorrunning{\L. Czajka and C. Kop}

\Copyright{{\L}ukasz Czajka and Cynthia Kop}

\ccsdesc[500]{Theory of computation~Rewrite systems}
\ccsdesc[500]{Theory of computation~Equational logic and rewriting}
\ccsdesc[300]{Theory of computation~Type theory}

\keywords{termination, polymorphism, higher-order rewriting, permutative conversions}

%\category{}%optional, e.g. invited paper

%\relatedversion{A full version of the paper is available at \url{...}.}
%\supplement{}%optional, e.g. related research data, source code, ... hosted on a repository like zenodo, figshare, GitHub, ...

%\acknowledgements{I want to thank \dots}%optional

%\nolinenumbers %uncomment to disable line numbering

%\hideLIPIcs  %uncomment to remove references to LIPIcs series (logo, DOI, ...), e.g. when preparing a pre-final version to be uploaded to arXiv or another public repository

%Editor-only macros:: begin (do not touch as author)%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\EventEditors{John Q. Open and Joan R. Access}
\EventNoEds{2}
\EventLongTitle{42nd Conference on Very Important Topics (CVIT 2016)}
\EventShortTitle{CVIT 2016}
\EventAcronym{CVIT}
\EventYear{2016}
\EventDate{December 24--27, 2016}
\EventLocation{Little Whinging, United Kingdom}
\EventLogo{}
\SeriesVolume{42}
\ArticleNo{23}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{document}

\maketitle

\begin{abstract}
  We generalise the termination method of higher-order polynomial
  interpretations to a setting with impredicative
  polymorphism. Instead of using weakly monotonic functionals, we
  interpret terms in a suitable extension of System~$\Fomega$. This
  enables a direct interpretation of rewrite rules which make
  essential use of impredicative polymorphism.  In addition, our
  generalisation eases the applicability of the method in the
  %CK "allowing for encoding of" sounds weird. Changing this, but
  %feel free to reformulate.
  %% LC: I think ``the'' is correct. According to grammarly.com,
  %% ``encoding'' is uncountable in normal usage, so ``an'' doesn't
  %% work. Though I guess that in this specialised context it could be
  %% considered countable. In any case, ``the'' seems like a safe
  %% choice.
  non-polymorphic setting by allowing for \CKchange{the} encoding of inductive data
  types. As an illustration of the potential of our method, we prove
  the termination of a substantial fragment of full intuitionistic
  second-order propositional logic with permutative conversions.
\end{abstract}

\section{Introduction}

Termination of higher-order term rewriting
systems~\cite[Chapter~11]{Terese2003} has been an active area of
research for several decades.
One powerful method, introduced by v.d. Pol \cite{Pol1993,pol:96},
interprets terms into \emph{weakly monotonic algebras}.  In later work
\cite{FuhsKop2012,Kop2012}, these algebra interpetations are specialised
into \emph{higher-order polynomial interpretations}, a generalisation of
the popular -- and highly automatable -- technique of polynomial
interpretations for first-order term rewriting.

In this paper, we further generalise higher-order polynomial
interpretations to a higher-order formalism with full impredicative
polymorphism. In the term rewriting literature, polymorphic
higher-order frameworks are usually restricted to shallow (rank-1,
weak) polymorphism, i.e., type quantifiers are effectively allowed
only at the top of a type. While shallow polymorphism often suffices
in functional programming practice, there do exist interesting
examples of rewrite systems which require higher-rank impredicative
polymorphism.

For instance, in recent extensions of Haskell one may define a type of
heterogenous lists.
\[
\begin{array}{ll}
  \List : * &
  \mathtt{foldl}_\sigma(f,a,\nil) \red a \\
  \mathtt{nil} : \List &
  \mathtt{foldl}_\sigma(f,a,\cons_\tau(x,l)) \red \mathtt{foldl}_\sigma(f,f \tau a x,l) \\
  \mathtt{cons} : \forall \alpha . \alpha \arrtype \List \arrtype \List \quad\quad \\
  \multicolumn{2}{l}{\mathtt{foldl} : \forall \beta . (\forall \alpha . \beta \arrtype \alpha \arrtype \beta) \arrtype \beta \arrtype \List \arrtype \CKchange{\beta}}
\end{array}
\]
The above states that $\List$ is a type ($*$), gives the types of its
two constructors $\nil$ and $\cons$, and defines the corresponding
fold-left function~$\mathtt{foldl}$. Each element of a heterogenous
list may have a different type. In practice, one would
  constrain the type variable~$\alpha$ above with a type class to
  guarantee the existence of some operations on list elements.  The
function argument of~$\mathtt{foldl}$ receives the element together
with its type. The $\forall$-quantifier binds type variables -- a term
of type $\forall \alpha . \tau$ takes a type~$\rho$ as an argument and
the result is a term of type~$\tau[\subst{\alpha}{\rho}]$.

Impredicativity of polymorphism means that the type itself may be
substituted for its own type variable, e.g., if $\mathtt{f} : \forall
\alpha . \tau$ then $f (\forall \alpha . \tau) :
\tau[\subst{\alpha}{\forall\alpha.\tau}]$. This prevents a translation
into an infinite set of simply typed rules by instantiating the type
variables. The above example is not directly reducible to shallow
polymorphism as used in the~ML programming language or the polymorphic
higher-order rewriting formalisms of~\cite{jou:oka:91,jou:rub:99}.

The technique we develop in this paper can be used to handle
systems like the one above.  Since termination of heterogeneous
fold can be shown in other ways (e.g., an encoding in
System~$\mathtt{F}$). Hence, we will also study a more complex example
in Section~\ref{sec:examples}: termination of a substantial fragment
of~IPC2, i.e., full intuitionistic second-order propositional logic
with permutative conversions. Permutative
conversions~\cite[Chapter~6]{TroelstraSchwichtenberg1996} are used in
proof theory to obtain ``good'' normal forms of natural deduction
proofs, which satisfy e.g.~the subformula property. Termination proofs
for systems with permutative conversions are notoriously tedious and
difficult, with some incorrect claims in the literature and no uniform
methodology. It is our goal to make such termination proofs
substantially easier in the future.

\section{Preliminaries}\label{sec_preliminaries}

In this section we introduce System~$\Fomega$ (see
e.g.~\cite[Section~11.7]{SorensenUrzyczyn2006}), which will form a
basis both of our interpretations and of a general syntactic framework
for the investigated systems. We assume familiarity with core notions
of lambda calculi such as substitution and $\alpha$-conversion.

\begin{defn}\label{def_types}
  \emph{Kinds} are defined inductively: $*$ is a kind, and if
  $\kappa_1,\kappa_2$ are kinds then so is $\kappa_1 \arrkind
  \kappa_2$. We assume an infinite set~$\Vc_\kappa$ of \emph{type
    constructor variables} of each kind~$\kappa$. Variables of
  kind~$*$ are \emph{type variables}. We assume a fixed
  set~$\Sigma^T_\kappa$ of \emph{type constructor symbols} paired with a
  kind~$\kappa$, denoted $c : \kappa$.
  %
  We define the set~$\Tc_\kappa$ of \emph{type constructors} of
  kind~$\kappa$ by the following grammar.
  Type constructors of kind~$*$ are \emph{types}.
  \[
  \begin{array}{rcl}
    \Tc_{*} &::=& \Vc_{*}
    \mid \Sigma^T_{*} \mid
    \Tc_{\kappa\arrkind *}\Tc_{\kappa} \mid \forall\Vc_\kappa\Tc_* \mid \Tc_*\arrtype\Tc_* \\
    \Tc_{\kappa_1\arrkind\kappa_2} &::=& \Vc_{\kappa_1\arrkind\kappa_2}
    \mid \Sigma^T_{\kappa_1\arrkind\kappa_2} \mid
    \Tc_{\kappa\arrkind(\kappa_1\arrkind\kappa_2)}\Tc_{\kappa} \mid \lambda \Vc_{\kappa_1} \Tc_{\kappa_2}
  \end{array}
  \]

  We use the standard notations $\forall \alpha . \tau$ and $\lambda
  \alpha . \tau$. When $\alpha$ is of kind $\kappa$ then we use the
  notation $\forall \alpha : \kappa . \tau$. If not indicated
  otherwise, we assume~$\alpha$ to be a type variable. We treat type
  constructors up to $\alpha$-conversion.

  \begin{example}
  If $\Sigma^T_{*} = \{ \List \}$ and $\Sigma^T_{* \arrkind * \arrkind
  *} = \{ \Pair \}$, types are for instance $\List$ and
  $\forall \alpha.\Pair\,\alpha\,\List$.  The expression
  $\Pair\,\List$ is a type constructor, but not a type.  If
  $\Sigma^T_{(* \arrkind *) \arrkind *} = \{ \exists \}$ and
  $\sigma \in \Tc_{* \arrkind *}$, then both
  $\exists(\sigma)$ and $\exists (\lambda \alpha.\sigma\alpha)$ are
  types.
  \end{example}

  The compatible closure of the rule $(\lambda\alpha.\varphi)\psi \to
  \varphi[\alpha := \psi]$ defines $\beta$-reduction on type
  constructors. As type constructors are (essentially) simply-typed
  lambda-terms, their $\beta$-reduction terminates
  and is confluent; hence every type constructor~$\tau$ has a unique
  $\beta$-normal form~$\nf_\beta(\tau)$. A \emph{type atom} is a type
  in $\beta$-normal form which is not an arrow $\tau_1\arrtype\tau_2$
  or quantification $\forall\alpha.\tau$.

  We define $\FTV(\varphi)$ -- the set of free type constructor
  variables of the type constructor~$\varphi$ -- in an obvious way by
  induction on~$\varphi$. A type constructor~$\varphi$ is
  \emph{closed} if $\FTV(\varphi) = \emptyset$.

  We assume a fixed type symbol~$\chi_* \in
  \Sigma^T_\kappa$. For $\kappa=\kappa_1\arrkind\kappa_2$ we define
  $\chi_\kappa = \lambda \alpha:\kappa_1 . \chi_{\kappa_2}$.
\end{defn}

\begin{defn}\label{def_preterms}
  We assume given an infinite set $\Vars$ of variables, and let
  $\Gamma$ refer to a variable context -- a set of pairs $x : \tau$ of
  a variable and a type, such that each variable occurs at most
  once. We assume given a fixed set $\Sigma$ of \emph{function
    symbols}, each paired with a closed type, denoted $\mathtt{f} :
  \tau$.  Every function symbol $\mathtt{f}$ occurs only with one type
  declaration. We denote $\Gamma,x:\tau$ for $\Gamma \cup \{x:\tau\}$. We
  set $\FTV(\Gamma) = \bigcup\{\FTV(\tau) \mid (x : \tau) \in
  \Gamma\}$.

  The set of preterms consists of all expressions~$s$ such that
  $\Gamma \vdash s : \sigma$ can be inferred for some type $\sigma$
  and context $\Gamma$ by the following clauses:
  \begin{itemize}
  \item $\Gamma \vdash x : \sigma$ for every $(x : \sigma) \in \Gamma$.
  \item $\Gamma \vdash \mathtt{f} : \sigma$ for all
    $(\mathtt{f} : \sigma) \in \Sigma$.
  \item $\Gamma \vdash \abs{x:\sigma}{s} : \sigma \arrtype \tau$ if $x
    \in \Vars$ and $\Gamma, x : \sigma \vdash s : \tau$.
  \item $\Gamma \vdash \tabs{\alpha:\kappa}{s} : \quant{\alpha:\kappa}{\sigma}$ if
    $\Gamma \vdash s : \sigma$ and $\alpha \notin \FTV(\Gamma)$.
  \item $\Gamma \vdash \app{s}{t} : \tau$ if $\Gamma \vdash s : \sigma
    \arrtype \tau$ and $\Gamma \vdash t : \sigma$
  \item $\Gamma \vdash \tapp{s}{\tau} : \sigma[\subst{\alpha}{\tau}]$
    if $\Gamma \vdash s : \quant{\alpha:\kappa}{\sigma}$ and~$\tau$ is
    a type constructor of kind~$\kappa$,
  \item $\Gamma \vdash s : \tau$ if $\Gamma \vdash s : \tau'$ and
    $\tau =_\beta \tau'$.
  \end{itemize}
  The set of free variables of a preterm~$t$, denoted $\FV(t)$, is
  defined in the expected way. Analogously, we define the
  set~$\FTV(t)$ of type constructor variables occurring free
  in~$t$.
  If $\alpha$ is a type constructor variable of
  kind~$\kappa$ then we use the notation $\tabs{\alpha:\kappa}{t}$.
  We define the equivalence relation~$\equiv$ by: $s \equiv t$ iff $s$
  and $t$ are identical modulo $\beta$-conversion in types.
\end{defn}

\begin{lemma}
  If $\Gamma \vdash s : \tau$ and $s \equiv t$ then $\Gamma \vdash t :
  \tau$.
\end{lemma}

\begin{proof}
  Induction on~$s$.
\end{proof}

\begin{defn}\label{def_terms}
  The set of \emph{terms} is the set of the equivalence classes
  of~$\equiv$.
\end{defn}

Because $\beta$-reduction on types is confluent and terminating, every
term has a canonical preterm representative -- the one with all types
occurring in it $\beta$-normalized.
We define $\FTV(t)$
as the value of~$\FTV$ on the canonical representative of~$t$.
We say that $t$ is \emph{closed} if both $\FTV(t) = \emptyset$
and $\FV(t) = \emptyset$.
%
Because typing and term formation operations (abstraction,
application, \ldots) are invariant under~$\equiv$, we may denote terms
by their (canonical) representatives and informally treat them
interchangeably.

We will often abuse notation to omit $\cdot$ and $*$. Thus, $s t$ can
refer to both $\app{s}{t}$ and $\tapp{s}{t}$. This is not ambiguous
due to typing. We will also use $\abstraction{a}{s}$ for either
$\abs{a}{s}$ or $\tabs{a}{s}$.

\begin{lemma}[Substitution lemma]\label{lem:substitution}
  \begin{enumerate}
  \item If $\Gamma, x : \sigma \proves s : \tau$ and $\Gamma \proves t
    : \sigma$ then $\Gamma \proves s[\subst{x}{t}] : \tau$.
  \item If $\Gamma \proves t : \sigma$ then
    $\Gamma[\subst{\alpha}{\tau}] \proves t[\subst{\alpha}{\tau}] :
    \sigma[\subst{\alpha}{\tau}]$.
  \end{enumerate}
\end{lemma}

\begin{proof}
  Induction on the typing derivation.
\end{proof}

\begin{lemma}[Generation lemma]\label{lem:generation}
  Assume $\Gamma \proves t : \sigma$ and let $\Xc = \FTV(t) \cup
  \FTV(\Gamma)$. Then there is a type~$\sigma'$ such that $\sigma'
  =_\beta \sigma$ and $\FTV(\sigma') \subseteq \Xc$ and one of the
  following holds.
  \begin{itemize}
  \item $t \equiv x$ is a variable and $(x : \sigma') \in \Gamma$.
  \item $t \equiv \mathtt{f}$ is a function symbol with $\mathtt{f} :
    \sigma'$ in $\Sigma$.
  \item $t \equiv \abs{x:\tau_1}{s}$ and
    $\sigma'=\tau_1\arrtype\tau_2$ and $\Gamma, x : \tau_1 \vdash s :
    \tau_2$.
  \item $t \equiv \tabs{\alpha:\kappa}{s}$ and $\sigma' =
    \quant{\alpha:\kappa}{\tau}$ and $\Gamma \vdash s : \tau$ and $\alpha
    \notin \FTV(\Gamma)$.
  \item $t \equiv \app{t_1}{t_2}$ and
    $\Gamma \vdash t_1 : \tau \arrtype \sigma'$ and
    $\Gamma \vdash t_2 : \tau$ and $\FTV(\tau) \subseteq \Xc$.
  \item $t \equiv \tapp{s}{\tau}$ and
    $\sigma' = \rho[\subst{\alpha}{\tau}]$ and
    $\Gamma \vdash s : \quant{(\alpha:\kappa)}{\rho}$ and~$\tau$ is a
    type constructor of kind~$\kappa$.
  \end{itemize}
\end{lemma}

\begin{proof}
  By analysing the derivation $\Gamma \proves t : \sigma$. To
  ensure $\FTV(\sigma') \subseteq \Xc$, note that if
  $\alpha \notin \Xc$
  is of kind~$\kappa$ and~$\Gamma \proves t : \sigma'$
  with~$\FTV(t) \cup \FTV(\Gamma) \subseteq \Xc$, then $\Gamma
  \proves t : \sigma'[\subst{\alpha}{\chi_\kappa}]$ by the
  substitution lemma (thus we can eliminate~$\alpha$).
\end{proof}

For convenience, we sometimes assume without loss of generality that
the terms are given in orthodox Church-style, i.e., instead of using
contexts we assume that each variable occurrence is annotated with a
type (where two occurrences of the same variable must be annotated
with the same type). Note that given a context~$\Gamma$ under which
all considered terms are typable, there is a natural isomorphism
between typed terms as defined above and terms given in orthodox
Church-style. We write $t : \tau$ if $t$ has type~$\tau$, in a fixed
implicit context~$\Gamma$, or equivalently with~$t$ considered as an
orthodox Church-style typed term.

\subsection{Encoding inductive types}\label{sec_encodings}

The polymorphic lambda-calculus has a much greater expressive power
than the simply-typed lambda-calculus. Arbitrary inductive data types
may be encoded, \CKchange{along} with their constructors and recursors with
appropriate derived reduction rules. This makes the polynomial
interpretation method easier to apply, even in the non-polymorphic
setting, thanks to more sophisticated ``programming'' in the
interpretations.
%
The reader is advised to consult e.g.~\cite[Chapter~11]{Girard1989}
for more background and explanations. Here, we state standard
abbreviations for \CKchange{two inductive types used in Section
\ref{sec:examples}.} Type subscripts are dropped when clear
or irrelevant.

\begin{defn}[Product types]
  \[
  \begin{array}{rclcrcl}
    \sigma \times \tau &=& \forall p . (\sigma \arrtype \tau \arrtype p) \arrtype p & \quad &
    \pi^1_{\sigma,\tau}(t) &=& t \sigma (\abs{x:\sigma}{\abs{y:\tau}{x}}) \\
    \pair{t_1}{t_2}_{\sigma,\tau} &=& \tabs{p}{\abs{x:\sigma\arrtype\tau\arrtype p}{x t_1 t_2}} & &
    \pi^2_{\sigma,\tau}(t) &=& t \tau (\abs{x:\sigma}{\abs{y:\tau}{y}}) \\
  \end{array}
  \]
\end{defn}

\begin{defn}[Existential types]
  \[
  \begin{array}{rclcrcl}
    \Sigma \alpha . \sigma &=& \forall p . (\forall \alpha . \sigma \arrtype p) \arrtype p & \quad &
    \expair{\tau}{t}_{\Sigma\alpha.\sigma} &=& \tabs{p}{\abs{x:\forall\alpha.\sigma\arrtype p}{x \tau t}} \\
    & & & &
    \xlet{\rho}{t}{\alpha,x:\sigma}{s} &=& t \rho (\tabs{\alpha}{\abs{x:\sigma}{s}}) \\
  \end{array}
  \]
\end{defn}

%\begin{defn}[Heterogenous lists]
%  \[
%  \begin{array}{rcl}
%    \List &=& \forall p . (\forall \alpha . \alpha \arrtype p \arrtype p) \arrtype p \arrtype p \\
%    \nil &=& \tabs{p}{\abs{f:\forall \alpha . \alpha \arrtype p \arrtype p}{\abs{a : p}{a}}} \\
%    \cons_\rho(h,t) &=& \tabs{p}{\abs{f:\forall\alpha . \alpha \arrtype p \arrtype p}{\abs{a : p}{f \rho h (l p f a)}}} \\
%    \fold_\rho(f,a,l) &=& l \rho f a
%  \end{array}
%  \]
%\end{defn}

From the definition we immediately see that all encodings have the expected types:

\begin{lemma}\label{lem:encodings_types}
  \begin{enumerate}
  \item If $\Gamma \proves t_1 : \sigma$ and $\Gamma \proves t_2 :
    \tau$ then $\Gamma \proves \pair{t_1}{t_2} : \sigma \times \tau$.
  \item If $\Gamma \proves t : \tau_1 \times \tau_2$ then $\Gamma
    \proves \pi^i(t) : \tau_i$.
  \item If $\Gamma \proves t : \sigma[\subst{\alpha}{\tau}]$ then
    $\Gamma \proves \expair{\tau}{t} : \Sigma \alpha . \sigma$.
  \item If $\Gamma \proves t : \Sigma \alpha . \sigma$ and
    $\Gamma,x:\sigma \proves s : \rho$ and $\alpha \notin
    \FTV(\Gamma,\rho)$ then $\xlet{}{t}{\alpha,x}{s} : \rho$.
%  \item $\Gamma \proves \nil : \List$.
%  \item If $\Gamma \proves h : \rho$ and $\Gamma \proves t : \List$
%    then $\Gamma \proves \cons_\rho(h,t) : \List$.
%  \item If $\Gamma \proves l : \List$ and $\Gamma \proves f : \forall
%    \alpha . \alpha \arrtype \rho \arrtype \rho$ and $a : \rho$ then
%    $\Gamma \proves \fold_\rho(f,a,l) : \rho$.
  \end{enumerate}
\end{lemma}

In addition, $\beta$-reduction on terms and types -- that is, the
relation $\leadsto_\beta$ generated by $(\abs{x}{s})t \leadsto_\beta
s[x:=t]$ and $(\tabs{\alpha}{s})\sigma \leadsto_\beta
s[\alpha:=\sigma]$ -- provides the desired derivation rules:

\begin{lemma}\label{lem:encodings_reduce}
  \begin{enumerate}
  \item $\pi^i(\pair{t_1}{t_2}) \leadsto_\beta^* t_i$.
  \item $\xlet{}{\expair{\tau}{t}}{\alpha,x}{s} \leadsto_\beta^*
    s[\subst{\alpha}{\tau}][\subst{x}{t}]$.
%  \item $\fold_\rho(f,a,\nil) \leadsto_\beta^* a$.
%  \item $\fold_\rho(f,a,\cons_\tau(h,t)) \leadsto_\beta^* f \tau h
%    (\fold_\rho(f,a,t))$.
  \end{enumerate}
\end{lemma}

\section{Polymorphic Functional Systems}\label{sec_systems}

In this section, we present a form of higher-order term rewriting
systems based on $\Fomega$: \emph{Polymorphic Functional Systems
  (PFSs)}. Systems of interest, such as logic systems like~ICP2 and
higher-order TRSs with shallow or full polymorphism can be encoded
into PFSs, and then proved terminating with the technique we will
develop in Sections \ref{sec:World}--\ref{sec_rule_removal}.

\begin{defn}\label{def_pafs_types_terms}
  \emph{Kinds}, \emph{type constructors} and \emph{types} are defined
  like in Definition~\ref{def_types}, parameterised by a fixed
  set~$\Sigma^T = \bigcup_{\kappa}\Sigma^T_\kappa$ of type constructor
  symbols.

  We assume given a fixed set~$\Sigma$ of function symbols, such
  that for $\mathtt{f} : \sigma \in \Sigma$ we can write:
    \[
    \sigma = \forall (\alpha_1 : \kappa_1) \ldots \forall (\alpha_n : \kappa_n)
    . \sigma_1 \arrtype \ldots \arrtype \sigma_k \arrtype \tau
    \]
  with $\tau$ a type atom. We define \emph{PFS
    terms} as in Definition~\ref{def_terms} (based on
  Definition~\ref{def_preterms}) with the restriction that
  for any subterm $\app{s}{u}$ of a term~$t$, we have $s =
    \mathtt{f} \rho_1 \ldots \rho_n u_1 \ldots u_m$ where
    \[
    \mathtt{f} : \forall (\alpha_1 : \kappa_1) \ldots
    \forall (\alpha_n : \kappa_n) . \sigma_1 \arrtype \ldots \arrtype
    \sigma_k \arrtype \tau
    \]
    with $\tau$ a type atom and $m < k$.
\end{defn}

This definition does not allow for a variable or
abstraction to occur at the head of an application, nor can we have
terms of the form $s \cdot t * \tau \cdot q$ (although terms of the
form $s \cdot t * \tau$, or $x * \tau$ with $x$ a variable,
\emph{are} allowed to occur).  To stress this restriction, we will
use the notation
$\mathtt{f}_{\rho_1,\ldots,\rho_n}(s_1,\ldots,s_m)$ as an alternative
way to denote
$\mathtt{f} \rho_1 \ldots \rho_n s_1 \ldots s_m$ when
$
  \mathtt{f} : \forall (\alpha_1 : \kappa_1) \ldots
  \forall (\alpha_n : \kappa_n) . \sigma_1 \arrtype \ldots \arrtype
  \sigma_k \arrtype \tau
$
is a function symbol in~$\Sigma$ with~$\tau$ a type atom and $m \leq k$.
This allows us to represent terms in a ``functional'' way, where
application does not explicitly occur (only implicitly in the
construction of $\mathtt{f}_{\rho_1,\ldots,\rho_n}(s_1,\ldots,s_m)$).

The following result follows easily by induction on term
structure:

\begin{lemma}
  If $t,s$ are PFS terms then so is $t[\subst{x}{s}]$.
\end{lemma}

PFS terms will be rewritten through a reduction relation
$\arr{\Rules}$ based on a (usually infinite) set of rewrite rules. To
define this relation, we need two additional notions.

\begin{defn}\label{def_replacement}
  For a variable context $\Gamma$,
  a \emph{$\Gamma$-replacement} is a function $\delta = \gamma \circ
  \omega$ satisfying:
  \begin{enumerate}
  \item $\omega$ is a type constructor substitution,
  \item $\gamma$ is a term substitution such that $\omega(\Gamma)
    \proves \gamma(x) : \omega(\tau)$ for every $(x : \tau) \in
    \Gamma$.
  \end{enumerate}

  For~$\tau$ a type constructor, we use $\delta(\tau)$ to denote
  $\omega(\tau)$. We use the notation $\delta[\subst{x}{t}] =
  \gamma[\subst{x}{t}] \circ \omega$. Note that if $\Gamma \proves t :
  \tau$ then $\delta(\Gamma) \proves \delta(t) : \delta(\tau)$.
\end{defn}

\begin{defn}\label{def:context}
  A \emph{$\sigma$-context}~$C_\sigma$ is a term with a fresh function
  symbol $\Box_\sigma \notin \Sigma$ of type~$\sigma$ occurring
  exactly once. By~$C_\sigma[t]$ we denote a term obtained
  from~$C_\sigma$ by substituting~$t$ for~$\Box_\sigma$. We drop the
  $\sigma$ subscripts when clear or irrelevant.
\end{defn}

Now, the rewrite rules are simply a set of term pairs, whose
monotonic closure generates the rewrite relation. We fix a variable
context~$\Gamma$.

\begin{defn}\label{def_rules}
  A set $\Rules$ of term pairs $(\ell,r)$ is a set of \emph{rewrite
    rules} if:
  \begin{itemize}
  \item $\FV(r) \subseteq \FV(\ell) \subseteq \mathit{keys}(\Gamma)$;
  \item $\ell$ and $r$ have the same type under $\Gamma$;
  \item if $(\ell,r) \in \Rules$ then $(\delta(\ell),\delta(r)) \in
    \Rules$ for any replacement~$\delta$.
  \end{itemize}
  The reduction relation $\arr{\Rules}$ is defined by: $t \arr{\Rules}
  s$ iff $t = C[\ell]$ and $s = C[r]$ for some $(\ell,r)\in\Rules$ and
  context~$C$.
\end{defn}

\begin{defn}\label{def_pafs}
  A \emph{Polymorphic Functional System (PFS)} is a triple
  $(\Sigma^T,\Sigma,\Rules)$ where~$\Sigma^T$ is a set of type
  constructor symbols, $\Sigma$ a set of function symbols (restricted
  as in Def.~\ref{def_pafs_types_terms}), and $\Rules$ is a set
  of rules as in Definition~\ref{def_rules}. A term of a
  PFS~$A$ is referred to as an $A$-term.
\end{defn}

While PFS-terms are a restriction from the general terms
of system $\Fomega$, the reduction relation allows us to actually encode
$\Fomega$ as a PFS: we can do so by including the symbol
${@} : \forall\alpha\forall\beta . (\alpha \arrtype \beta) \arrtype \alpha
\arrtype \beta$ in $\Sigma$ and adding all rules of the form
$@_{\sigma,\tau}(\abs{x}{s},t) \red s[x:=t]$.
Similarly, $\beta$-reduction of type abstraction can be modelled
by including a symbol
$\mathtt{A} : \forall \alpha : * \arrkind * . \forall \beta . (\forall
\gamma.\alpha \gamma) \arrtype \alpha \beta$ and rules
$\mathtt{A}_{\varphi,\sigma}(\abs{\alpha}{s}) \red s[\alpha:=\sigma]$.
It is also allowed to simply include rules
$(\tabs{\alpha}{s})*\tau \red s[\alpha:=\tau]$ without the extra
symbol, but to apply the method from
Sections \ref{sec:World}--\ref{sec_rule_removal}, it is often more
convenient to include the symbol, since it will allow us to assign an
arbitrary polynomial interpretation to type application.

\begin{example}[Fold on heterogenous lists]\label{ex_fold_pafs}
  The example from the introduction may be represented as a PFS with
  one type symbol $\mathtt{List} : *$, the following function symbols:
  \[
  \begin{array}{rcl}
    @ & : & \forall \alpha \forall \beta . (\alpha \arrtype \beta) \arrtype \alpha \arrtype \beta \\
    \mathtt{A} & : & \forall \alpha : * \arrkind * . \forall \beta .
    (\forall \gamma .\alpha \gamma) \arrtype \alpha \beta \\
    \mathtt{nil} & : & \List \\
    \mathtt{cons} & : & \forall \alpha . \alpha \arrtype \List \arrtype \List \\
    \mathtt{foldl} & : & \forall \beta . (\forall \alpha . \beta \arrtype \alpha \arrtype \beta) \arrtype \beta \arrtype \List \arrtype \CKchange{\beta}
  \end{array}
  \]
  and the following rules:
  \[
  \begin{array}{rcl}
    @_{\sigma,\tau}(\abs{x:\sigma}{s},t) & \red & s[x:=t] \\
    \mathtt{A}_{\abs{\alpha}{\sigma},\tau}(\tabs{\alpha}{s}) & \red &
    s[\alpha:=\tau] \\
    \mathtt{foldl}_\sigma(f,s,\nil) & \red & s \\
    \mathtt{foldl}_\sigma(f,s,\cons_\tau(h,t)) & \red & \mathtt{foldl}_\sigma(f,@_{\tau,\sigma}(@_{\sigma,\tau
    \arrtype\sigma}(\mathtt{A}_{
      \CKchange{\abs{\alpha}{\sigma\arrtype\alpha\arrtype\sigma}},\tau}(f),s),h),t)
  \end{array}
  \]
  Formally, the above represents an infinite set of rules, one rule for
  each choice of types $\sigma,\tau$ and PFS terms $s$, $t$, etc.
\end{example}

\section{A well-ordered set of interpretation terms}\label{sec:World}

In polynomial interpretations of first-order term
rewriting~\cite[Chapter 6.2]{Terese2003}, each term $s$ is mapped to a
natural number $\interpret{s}$, such that $\interpret{s} > \interpret{t}$
whenever $s \arr{\Rules} t$.  In higher-order rewriting, this is not
practical; instead, following \cite{pol:96}, terms are mapped to weakly
monotonic functionals according to their type (i.e., terms with a $0$-order
type are mapped to natural numbers, terms with a $1$-order type to weakly
monotonic functions over natural numbers, terms with a $2$-order type to
weakly monotonic functionals taking weakly monotonic functions as
arguments, and so on).  In this paper, to account for full polymorphism,
we will interpret PFS terms to a set $\Iterms$ of \emph{interpretation terms}
in a specific extension of System~$\Fomega$.  This set is defined in Section
\ref{subsec:I}; we provide a well-founded partial ordering $\succ$ on
$\Iterms$ in Section \ref{subsec:succ}.

\CKchange{Although our world of interpretation terms is quite different
from the weakly monotonic functionals of \cite{pol:96}, there are many
similarities.  Most pertinently, every interpretation term $\abs{x}{s}$
essentially defines a weakly monotonic function from $\Iterms$ to
$\Iterms$.  This, and the use of both addition and multiplication in
the definition of $\Iterms$, makes it possible to lift higher-order
polynomial interpretations \cite{FuhsKop2012} to our setting.  We %will
prove weak monotonicity in Section \ref{subsec:weakmono}.}

\subsection{Interpretation terms}\label{subsec:I}

\begin{defn}\label{def_iterms}
  The set~$\ITypes$ of \emph{interpretation types} is the set of types
  as in Definition~\ref{def_types} with $\Sigma^T = \{ \nat : * \}$,
  i.e., there is a single type constant~$\nat$. Then $\chi_* = \nat$.

  The set~$\Iterms$ of \emph{interpretation terms} is the set of terms
  from Definition~\ref{def_terms} (see also
  Definition~\ref{def_preterms}) where as types we take the
  interpretation types and for the set~$\Sigma$ of function symbols we
  take $\Sigma = \{ n : \nat \mid n \in \Nbb \} \cup \Sigma_f$, where:
  \[
      \Sigma_f = \{ \oplus : \forall \alpha . \alpha \arrtype
                 \alpha \arrtype \alpha, \otimes : \forall \alpha . \alpha \arrtype \alpha
                 \arrtype \alpha, \flatten : \forall \alpha . \alpha \arrtype
                 \nat, \lift : \forall \alpha . \nat \arrtype \alpha
                 \}
  \]
\end{defn}

For easier presentation, we write $\oplus_\tau$, $\otimes_\tau$, etc.,
instead of $\tapp{\oplus}{\tau}$, $\tapp{\otimes}{\tau}$, etc. We will
also use $\oplus$ and $\otimes$ in \emph{infix, left-associative}
notation, and omit the type denotation where it is clear from
context. Thus, $s \oplus t \oplus u$ should be read as
$\oplus_\sigma\,s\,(\oplus_\sigma\,t\,u)$ if $s$ has type $\sigma$.

\paragraph*{Normalising interpretation terms}

The set $\Iterms$ of interpretation terms can be reduced through
a relation $\arrW$, that we will define below.  This relation will
be a powerful aid in defining the parial ordering $\succ$ in Section
\ref{subsec:succ}.

\begin{defn}
  We define the relation $\arrW$ on interpretation terms as the
  smallest relation for which the following properties are satisfied:
  \begin{enumerate}
  \item\label{arrW:mono:abs}
    if $s \arrW t$ then both $\abs{x}{s} \arrW \abs{x}{t}$ and
    $\tabs{\alpha}{s} \arrW \tabs{\alpha}{t}$
  \item\label{arrW:mono:right}
    if $s \arrW t$ then $\app{u}{s} \arrW \app{u}{t}$
  \item\label{arrW:mono:left}
    if $s \arrW t$ then both $\app{s}{u} \arrW \app{t}{u}$ and
    $\tapp{s}{\sigma} \arrW \tapp{t}{\sigma}$
  \item\label{arrW:beta:abs} $\app{(\abs{x:\sigma}{s})}{t} \arrW
    s[\subst{x}{t}]$
  \item\label{arrW:beta:tabs} $\tapp{(\tabs{\alpha}{s})}{\sigma}
    \arrW s[\subst{\alpha}{\sigma}]$.
  \item\label{arrW:plus:base}
    $\app{\app{\oplus_{\nat}}{n}}{m} \arrW (n+m)$
  \item\label{arrW:times:base} $\app{\app{\otimes_{\nat}}{n}}{m}
    \arrW (n \cdot m)$
  \item\label{arrW:circ:arrow} $\app{\app{\circ_{\sigma \arrtype
        \tau}}{s}}{t} \arrW
    \abs{x:\sigma}{\app{\app{\circ_\tau}{(\app{s}{x})}}{(\app{t}{x})}}$
    for $\circ \in \{ \oplus, \otimes \}$
  \item\label{arrW:circ:forall}
    $\app{\app{\circ_{\quant{\alpha}{\sigma}}}{s}}{t} \arrW
    \tabs{\alpha}{\app{\app{\circ_\sigma}{(\tapp{s}{\alpha})}}{(
        \tapp{t}{\alpha})}}$ for $\circ \in \{ \oplus, \otimes \}$
  \item $\app{\flatten_\nat}{s} \arrW s$
  \item $\app{\flatten_{\sigma \arrtype \tau}}{s} \arrW
    \app{\flatten_\tau}{(\app{s}{(\app{\lift_\sigma}{0})})}$
  \item $\app{\flatten_{\quant{\alpha:\kappa}{\sigma}}}{s} \arrW
    \app{\flatten_{\sigma[\subst{\alpha}{\chi_\kappa}]}}{(\tapp{s}{\chi_\kappa})}$
  \item $\app{\lift_\nat}{s} \arrW s$
  \item $\app{\lift_{\sigma \arrtype \tau}}{s} \arrW
    \abs{x:\sigma}{\app{\lift_{\tau}}{s}}$
  \item $\app{\lift_{\quant{\alpha}{\sigma}}}{s} \arrW
    \tabs{\alpha}{\app{\lift_{\sigma}}{s}}$
  \end{enumerate}
  Note that the above rules are invariant under~$\equiv$ (by
  confluence of $\beta$-reduction on types), so they correctly define
  a relation on interpretation terms -- the equivalence classes
  of~$\equiv$. We say that $s$ is a \emph{redex} if $s$ reduces by one
  of the rules 4--15.

  A \emph{final interpretation term} is an interpretation term $s \in
  \Iterms$ such that (a) $s$ is closed, and (b) $s$ is in normal form
  with respect to $\arrW$.  We let $\Iterms^f$ be the set of all final
  interpretation terms. By~$\Iterms_\tau$ ($\Iterms^f_\tau$) we denote
  the set of all (final) interpretation terms of interpretation
  type~$\tau$ (in a fixed implicit context~$\Gamma$).
\end{defn}

An important difference with System~$\Fomega$ and related ones is that
the rules for $\oplus_\tau$, $\otimes_\tau$, $\flatten_\tau$ and
$\lift_\tau$ depend on the type~$\tau$. In particular, type
substitution in terms may create redexes. For instance, if $\alpha$ is
a type variable then $\oplus_\alpha t_1 t_2$ is not a redex, but
$\oplus_{\sigma\arrtype\tau} t_1 t_2$ is. This makes the question of
termination subtle. Indeed, System~$\Fomega$ is extremely sensitive to
modifications which are not of a logical nature. For instance, adding
a constant $\mathtt{J} : \forall \alpha \beta . \alpha \arrtype \beta$
with a reduction rule $\mathtt{J} \tau \tau \leadsto \lambda x : \tau
. x$ makes the system non-terminating~\cite{Girard1971}. Our rules do
not allow such a definition. Note that the natural number constants
are mutually indistinguishable inside our reduction system (e.g.~there
is no test for zero). For the purposes of termination, the type~$\nat$
may be considered a singleton.

Now we state some properties of~$\arrW$, including strong
normalisation. Because of space limitations, most proofs are
delegated to Appendix~\ref{app_proofs}.

\begin{lemma}[Subject reduction]
  If $\Gamma \proves t : \tau$ and $t \arrW t'$ then $\Gamma \proves
  t' : \tau$.
\end{lemma}

\begin{proof}
  By induction on the definition of $t \arrW t'$, using
  %CK: space
  %the generation and substitution lemmas.
  Lemmas \ref{lem:substitution} and \ref{lem:generation}.
\end{proof}

\begin{theorem}\label{thm_sn}
  If $\Gamma \proves t : \sigma$ then $t$ is terminating with respect
  to $\arrW$.
\end{theorem}

\begin{lemma}\label{lem_unique_final}
  Every term $s \in \Iterms$ has a unique normal form~$s\da$. If~$s$
  is closed then so is~$s\da$.
\end{lemma}

\begin{proof}
  One easily
  checks that~$\arrW$ is locally confluent. Since the
  relation is
  terminating by Theorem~\ref{thm_sn}, it is confluent by Newman's
  lemma.
\end{proof}

\begin{lemma}\label{lem_final_nat}
  The only final interpretation terms of type $\nat$ are the natural
  numbers.
\end{lemma}

\begin{example}\label{ex:arrWreduce}
\CKchange{Let $s \in \Iterms_{\nat \arrtype \nat}$ and $t \in
\Iterms_\nat$. Then we can reduce
$(s \oplus \lift_{\nat \arrtype \nat}(1)) \cdot t \arrW
(\abs{x}{s x \oplus \lift_{\nat \arrtype \nat}(1)x}) \cdot t \arrW
s t \oplus \lift_{\nat \arrtype \nat}(1)t \arrW
s t \oplus (\abs{y}{\lift_{\nat}(1)})t \arrW
s t \oplus \lift_\nat(1) \arrW
s t \oplus 1$.  If $s$ and $t$ are variables, this term is in normal
form.}
\end{example}

\subsection{The ordering pair $(\succeq,\succ)$}\label{subsec:succ}

With these ingredients, we are ready to define the well-founded
partial ordering $\succ$ on $\Iterms$.  In fact, we will do more: rather
than a single partial ordering, we will define an \emph{ordering pair}: a
pair of a quasi-ordering $\succeq$ and a compatible well-founded ordering
$\succ$. The quasi-ordering $\succeq$ often makes it easier to prove
%that
$s \succ t$, since it suffices to show that $s \succeq s' \succ t'
\succeq t$ for some interpretation terms $s',t'$.  Having $\succeq$ will
also allow us to use rule removal (Theorem \ref{thm:ruleremove}).
%instead of merely
%orienting all rules with $\succ$.

The ordering pair for \emph{closed} interpretation terms is
defined using co-induction. For the following definitions, we fix an
implict variable context~$\Gamma$.

\begin{defn}\label{def:succ}
  Let $R \in \{ \succ,\succeq \}$. For closed~$s,t\in\Iterms_\sigma$
  and closed~$\sigma$ in $\beta$-normal form, the relation
  $s\ R_{\sigma}\ t$ is defined coinductively by the following rules.
  \[
  \begin{array}{cc}
    \infer={s\ R_\nat\ t}{s\da\ R\ t\da \text{ in natural numbers}} \quad&\quad
    \infer={s\ R_{\sigma\arrtype\tau}\ t}{\app{s}{q}\ R_{\tau}\ \app{t}{q} \text{ for all } q \in \Iterms^f_\sigma} \\ \\
    \multicolumn{2}{c}{
    \infer={s\ R_{\forall(\alpha:\kappa)[\sigma]}\ t}{\tapp{s}{\tau}\ R_{\nf_\beta(\sigma[\subst{\alpha}{\tau}])}\ \tapp{t}{\tau} \text{ for all closed } \tau \in \Tc_{\kappa}}}
  \end{array}
  \]
  We define $s \approx_\sigma t$ if both $s \succeq_\sigma t$ and $t
  \succeq_\sigma s$.
\end{defn}

For \emph{open} interpretation terms, the definition is
  extended in a natural way:

\begin{defn}\label{def_closure}
  A \emph{closure}~$\cl = \gamma \circ \omega$ is a
  replacement such that $\omega(\alpha)$ is closed for each
  type constructor variable~$\alpha$, and $\gamma(x)$ is closed for
  each term variable~$x$.

  For arbitrary types~$\sigma$ and arbitrary terms $s,t \in \Iterms$
  we define $s \succ_\sigma t$ if for every closure~$\cl$ we can
  obtain $\cl(s) \succ_{\nf_\beta(\cl(\sigma))} \cl(t)$ coinductively
  with the above rules. The relations $\succeq_\sigma$ and
  $\approx_\sigma$ are extended analogously. We drop the type
  subscripts when clear or irrelevant.
\end{defn}

Note that in the case for~$\nat$ the terms~$s\da$, $t\da$ are natural
numbers by Lemma~\ref{lem_final_nat} ($s\da,t\da$ are closed and in
normal form, so they are final interpretation terms).

Intuitively, the above definition means that e.g. $s \succ t$ iff
there exists a possibly infinite derivation tree using the above
rules. In such a derivation tree all leaves must witness $s\da > t\da$
in natural numbers. However, this also allows for infinite branches,
which solves the problem of repeating types due to impredicative
polymorphism. If e.g.~$s \succ_{\forall \alpha . \alpha} t$ then
$\tapp{s}{\forall\alpha.\alpha} \succ_{\forall \alpha . \alpha}
\tapp{t}{\forall\alpha.\alpha}$, which forces an infinite branch in
the derivation tree. According to our definition, any infinite branch
may essentially be ignored.

The coinductive definition of~$\succ$ and~$\succeq$ can be
reformulated as follows.

\begin{lemma}\label{lem_succ_explicit}
  $t \succeq s$ if and only if for every closure~$\cl$ and every
  sequence $u_1,\ldots,u_n$ of closed terms and closed type
  constructors such that $\cl(t) u_1 \ldots u_n : \nat$ we have
  $(\cl(t) u_1 \ldots u_n)\da \ge (\cl(s) u_1 \ldots u_n)\da$ in
  natural numbers. An analogous result holds with $\succ$ or $\approx$
  instead of~$\succeq$.
\end{lemma}

\begin{proof}
  The direction from left to right follows by induction on~$n$; the
  other by coinduction.
\end{proof}

In what follows, all proofs by coinduction could be reformulated to
instead use the characterisation of $\succ$, $\succeq$ and~$\approx$
from the above lemma. However, this would arguably make the proofs
less perspicuous.

%\medskip Space?
Our next task is to show that $\succeq$ and $\succ$ have the
desired properties of an ordering pair; e.g., transitivity and
compatibility. We first state a simple lemma that will be used
implicitly.

\begin{lemma}
  If~$\tau$ is a closed interpretation type in $\beta$-normal form
  then $\tau = \nat$ or $\tau = \tau_1\arrtype\tau_2$ or $\tau =
  \forall\alpha\sigma$.
\end{lemma}

The most important property of~$\succ$ is that it is a well-founded
ordering.

\begin{lemma}\label{lem_well_founded}
  $\succ$ is well-founded.
\end{lemma}

\begin{proof}
  It suffices to show this for closed terms and closed types in
  $\beta$-normal form, because any infinite sequence $t_1 \succ_\tau
  t_2 \succ_\tau t_3 \succ_\tau \ldots$ induces an infinite sequence
  $\cl(t_1) \succ_{\nf_\beta(\cl(\tau))} \cl(t_2)
  \succ_{\nf_\beta(\cl(\tau))} \cl(t_3) \succ_{\nf_\beta(\cl(\tau))}
  \ldots$ for any closure~$\cl$. By induction on the size of a
  $\beta$-normal type~$\tau$ (with size measured as the number of
  occurrences of~$\forall$ and~$\arrtype$) one proves that there does
  not exist an infinite sequence $t_1 \succ_\tau t_2 \succ_\tau t_3
  \succ_\tau \ldots$ For instance, if $\alpha$ has kind~$\kappa$ and
  $t_1 \succ_{\forall\alpha\tau} t_2 \succ_{\forall\alpha\tau} t_3
  \succ_{\forall\alpha\tau} \ldots$ then $\tapp{t_1}{\chi_\kappa}
  \succ_{\tau'} \tapp{t_2}{\chi_\kappa} \succ_{\tau'}
  \tapp{t_3}{\chi_\kappa} \succ_{\tau'} \ldots$, where
  $\tau'=\nf_\beta(\tau[\subst{\alpha}{\chi_\kappa}])$. Because $\tau$
  is in $\beta$-normal form, all redexes in
  $\tau[\subst{\alpha}{\chi_\kappa}]$ are created by the substitution
  and must have the form $\chi_\kappa u$. Hence, by the definition
  of~$\chi_\kappa$ (see Definition~\ref{def_types}) the
  type~$\tau'$ is smaller than~$\tau$. This
  contradicts the inductive hypothesis.
\end{proof}

\begin{lemma}\label{lem_transitive}
  Both $\succ$ and $\succeq$ are transitive.
\end{lemma}

\begin{proof}
  We show this for~$\succ$, the proof for~$\succeq$ being
  analogous. Again, it suffices to prove this for closed terms and
  closed types in $\beta$-normal form. We proceed by coinduction.

  If $t_1 \succ_\nat t_2 \succ_\nat t_3$ then $t_1\da > t_2\da >
  t_3\da$, so $t_1\da > t_3\da$. Thus $t_1 \succ_\nat t_3$.

  If $t_1 \succ_{\sigma\arrtype\tau}t_2\succ_{\sigma\arrtype\tau}t_3$
  then $\app{t_1}{q}\succ_{\tau}\app{t_2}{q}\succ_\tau\app{t_3}{q}$
  for $q \in \Iterms^f_\sigma$. Hence
  $\app{t_1}{q}\succ_\tau\app{t_3}{q}$ for $q \in \Iterms^f_\sigma$ by
  the coinductive hypothesis. Thus $t_1\succ_{\sigma\arrtype\tau}
  t_3$.

  If $t_1
  \succ_{\forall(\alpha:\kappa)\sigma}t_2\succ_{\forall(\alpha:\kappa)\sigma}t_3$
  then
  $\tapp{t_1}{\tau}\succ_{\sigma'}\tapp{t_2}{\tau}\succ_{\sigma'}\tapp{t_3}{\tau}$
  for any closed type constructor~$\tau$ of kind~$\kappa$, where
  $\sigma' = \nf_\beta(\sigma[\subst{\alpha}{\tau}])$. Hence
  $\tapp{t_1}{\tau}\succ_{\sigma'}\tapp{t_3}{\tau}$ by the coinductive
  hypothesis. Thus $t_1\succ_{\forall\alpha\sigma} t_3$.
\end{proof}

\begin{lemma}\label{lem_reflexive}
  $\succeq$ is reflexive.
\end{lemma}

\begin{proof}
  By coinduction one shows that $\succeq_\sigma$ is reflexive on
  closed terms for closed $\beta$-normal~$\sigma$. The general case is
  then immediate from definitions.
\end{proof}

\begin{lemma}\label{lem:compatibility}
  The relations~$\succeq$ and~$\succ$ are compatible, i.e., $\succ
  \cdot \succeq\ \subseteq\ \succ$ and $\succeq \cdot
  \succ\ \subseteq\ \succ$.
\end{lemma}

\begin{proof}
  By coinduction, analogous to the transitivity proof.
\end{proof}

\begin{lemma}\label{lem_succ_to_succeq}
  If $t \succ s$ then $t \succeq s$.
\end{lemma}

\begin{proof}
  By coinduction.
\end{proof}

\begin{lemma}\label{lem_leadsto_to_approx}
  If $t \arrW s$ then $t \approx s$.
\end{lemma}

\begin{proof}
  Follows from Lemma~\ref{lem_succ_explicit}, noting that $t \arrW s$
  implies $\cl(t) \arrW \cl(s)$ for all closures~$\cl$.
\end{proof}

\begin{lemma}\label{lem_succ_red}
  Assume $t \succ s$ (resp.~$t \succeq s$).
  \begin{enumerate}
  \item If $t \leadsto t'$ or $t' \leadsto t$ then $t' \succ s$
    (resp.~$t' \succeq s$).
  \item If $s \leadsto s'$ or $s' \leadsto s$ then $t \succ s'$
    (resp.~$t \succeq s'$).
  \end{enumerate}
\end{lemma}

\begin{proof}
  Follows from Lemma~\ref{lem_leadsto_to_approx}, transitivity and
  compatibility.
\end{proof}

\begin{corollary}\label{cor_succ_da}
  For $R \in \{\succ,\succeq,\approx\}$: $s\ R\ t$ if and only if
  $s\downarrow\ R\ t\downarrow$.
\end{corollary}

\begin{example}\label{ex:plus1}
\CKchange{We can prove that $x \oplus \lift_{\nat \arrtype \nat}(1)
\succ x$: by
definition, this holds if $s \oplus \lift_{nat \arrtype \nat}(1) \succ
s$ for all closed $s$, so if $(s \oplus \lift_{nat \arrtype \nat})u
\succ s u$ for all closed $s,u$.
Following Example \ref{ex:arrWreduce} and Lemma \ref{lem_succ_red},
this holds if $s u \oplus 1 \succ u$.  By definition, this is the
case if $(s u \oplus 1)\downarrow > u\downarrow$ in the natural numbers,
which is clearly the case for any $s,u$.
}
\end{example}

\subsection{Weak monotonicity}\label{subsec:weakmono}

%We first return to our system of interpretation terms with an aim to
\CKchange{We will now}
show that $s \succeq s'$ implies $t[\subst{x}{s}] \succeq
t[\subst{x}{s'}]$ \CKchange{(weak monotonicity)}.
For this purpose, we prove a few lemmas, many of
which also apply to~$\succ$, stating the preservation of~$\succeq$
under term formation operations. We will need these results to obtain
a reduction pair.

\begin{lemma}\label{lem_app_succ}
  If $t \succeq s$ (resp.~$t \succ s$) then $t u \succeq s u$
  (resp.~$t u \succ s u$) with $u$ a term or type constructor.
\end{lemma}

\begin{proof}
  Follows from definitions.
\end{proof}

\begin{lemma}\label{lem:liftgreater}
  If $n \geq m$ (resp.~$n > m$) then $\lift_\sigma n \succeq
  \lift_\sigma m$ (resp.~$\lift_\sigma n \succ \lift_\sigma m$) for
  all types $\sigma$.
\end{lemma}

\begin{proof}
  Without loss of generality we may assume $\sigma$ closed and in
  $\beta$-normal form. By coinduction we show $\lift(n) u_1 \ldots u_k
  \succeq \lift(m) u_1 \ldots u_k$ for closed $u_1,\ldots,u_k$. First
  note that $(\lift\,t) u_1 \ldots u_k \leadsto^* \lift(t)$ (with a
  different type subscript in~$\lift$ on the right side, omitted here
  for conciseness). If $\sigma = \nat$ then $(\lift(n) u_1 \ldots
  u_k)\da = n \ge m = (\lift(m) u_1 \ldots u_k)\da$. If $\sigma =
  \tau_1\arrtype\tau_2$ then by the coinductive hypothesis $\lift(n)
  u_1 \ldots u_k q \succeq_{\tau_2} \lift(m) u_1 \ldots u_k q$ for any
  $q \in \Iterms^f_{\tau_1}$, so $\lift(n) u_1 \ldots u_k
  \succeq_{\sigma} \lift(m) u_1 \ldots u_k$ by definition. If $\sigma
  = \forall(\alpha:\kappa)\tau$ then by the coinductive hypothesis
  $\lift(n) u_1 \ldots u_k \xi \succeq_{\sigma'} \lift(m) u_1 \ldots
  u_k \xi$ for any closed $\xi \in \Tc_\kappa$, where $\sigma' =
  \tau[\subst{\alpha}{\xi}]$. Hence $\lift(n) u_1 \ldots u_k
  \succeq_{\sigma} \lift(m) u_1 \ldots u_k$ by definition
\end{proof}

\begin{lemma}\label{lem_flatten_succ}
  If $t \succeq_\sigma s$ then $\flatten_\sigma t \succeq_\nat
  \flatten_\sigma s$ for all types $\sigma$. The same holds
  with~$\succ$ instead of~$\succeq$.
\end{lemma}

\begin{proof}
  Without loss of generality we may assume~$\sigma$ is closed and in
  $\beta$-normal form. Using Lemma~\ref{lem_succ_red}, one shows by
  induction on~$\sigma$ that if $t \succeq_\sigma s$ then
  $\flatten_\sigma t \succeq_\nat \flatten_\sigma s$ (the proof
  for~$\succ$ is analogous).
\end{proof}

\begin{lemma}\label{lem_abs_succ}
  If $t \succeq s$ then $\abs{x}{t} \succeq \abs{x}{s}$ and
  $\tabs{\alpha}{t} \succeq \tabs{\alpha}{s}$. The same holds
  for~$\succ$.
\end{lemma}

\begin{proof}
  Assume $t \succeq_\tau s$ and $\Gamma \proves x : \sigma$. Let~$\cl$
  be a closure. We need to show $\cl(\abs{x}{t})
  \succeq_{\cl(\sigma\arrtype\tau)} \cl(\abs{x}{s})$. Let $u \in
  \Iterms^f_{\cl(\sigma)}$. Then $\cl' = \cl[\subst{x}{u}]$ is a
  closure and $\cl'(t) \succeq_{\cl(\tau)} \cl'(s)$. Hence
  $\cl(t)[\subst{x}{u}] \succeq_{\cl(\tau)} \cl(s)[\subst{x}{u}]$. By
  Lemma~\ref{lem_succ_red} this implies $\cl(\abs{x}{t}) u
  \succeq_{\cl(\tau)} \cl(\abs{x}{s}) u$. Therefore $\cl(\abs{x}{t})
  \succeq_{\cl(\sigma\arrtype\tau)} \cl(\abs{x}{s})$. The proof for
  the second part is analogous.
\end{proof}

\begin{lemma}\label{lem:plustimesmonotonic}
  Let $s,t,u$ be terms of type $\sigma$.
  \begin{enumerate}
  \item If $s \succeq t$ then $s \oplus_\sigma u \succeq t
    \oplus_\sigma u$, $u \oplus_\sigma s \succeq u \oplus_\sigma t$,
    $s \otimes_\sigma u \succeq t \otimes_\sigma u$, and $u
    \otimes_\sigma s \succeq u \otimes_\sigma t$.
  \item If $s \succ t$ then $s \oplus_\sigma u \succ t \oplus_\sigma
    u$ and $u \oplus_\sigma s \succ u \oplus_\sigma t$. Moreover, if
    additionally $u \succeq \lift_\sigma(1)$ then also $s
    \otimes_\sigma u \succ t \otimes_\sigma u$ and $u \otimes_\sigma s
    \succ u \otimes_\sigma t$.
  \end{enumerate}
\end{lemma}

\begin{proof}
  It suffices to prove this for closed $s,t,u$ and closed $\sigma$ in
  $\beta$-normal form. The proof is similar to the proof of
  Lemma~\ref{lem:liftgreater}. For instance, we show by coinduction
  that for closed $w_1,\ldots,w_n$ if $s w_1 \ldots w_n \succ t w_1
  \ldots w_n$ and $u w_1 \ldots w_n \succeq \lift(1) w_1 \ldots w_n$
  then $(s \otimes u) w_1 \ldots w_n \succ (t \otimes u) w_1 \ldots
  w_n$.
\end{proof}

The following lemma depends on the lemmas above. The full proof may be
found in Appendix~\ref{app_proofs}. The proof is actually quite
complex, and uses a method similar to Girard's method of candidates
for the termination proof. The difficulty comes from the fact that due
to the impredicativity of polymorphism direct induction on type
structure is not possible.

\begin{lemma}[Weak monotonicity]\label{lem_succeq_subst}
  If $s \succeq s'$ then $t[\subst{x}{s}] \succeq t[\subst{x}{s'}]$.
\end{lemma}

\begin{corollary}\label{cor_app_wm}
  If $s \succeq s'$ then $t s \succeq t s'$.
\end{corollary}


\section{\CKchange{A reduction pair for PFS terms}}\label{sec_reduction_pairs}

\CKchange{Recall that our goal is to prove termination of PFS terms.  To
do so, in this section we will define a systematic way to generate
\emph{reduction pairs}.}  We fix a~PFS~$A$\CKchange{, and define:}

\begin{defn}
  A binary relation~$R$ on $A$-terms is \emph{monotonic} if $R(s, t)$
  implies $R(C[s], C[t])$ for every context~$C$ (we assume $s,t$ have
  the same type~$\sigma$).

  A \emph{reduction pair} is a pair~$(\succeq^A,\succ^A)$ of a
  quasi-order~$\succeq^A$ on $A$-terms and a well-founded
  ordering~$\succ^A$ on $A$-terms such that:
  \begin{itemize}
  \item $\succeq^A$ and~$\succ^A$ are compatible, i.e., ${\succ^A}
    \cdot {\succeq^A} \subseteq {\succ^A}$
    %CK: this is how compatibiility was defined before!
    \CKchange{and ${\succeq^A} \cdot {\succ^A} \subseteq {\succ^A}$}
  \item $\succeq^A$ and~$\succ^A$ are both monotonic.
  \end{itemize}
\end{defn}


\CKchange{If we can generate such a pair with $\ell \succ^A r$ for each
rule $(\ell,r) \in \Rules$, then we easily see that the PFS $A$ is
terminating.  (If we merely have $\ell \succ^A r$ for \emph{some}
rules and $\ell \succeq^A r$ for the rest, we can still progress
with the termination proof, as we will discuss in Section
\ref{sec_rule_removal}.)
To generate this pair, we will define the notion of an
\emph{interpretation} from the set of $A$-terms to the set $\Iterms$ of
interpretation terms, and thus lift the ordering pair $(\succeq,\succ)$
to $A$.
In the next section, we will show how this reduction pair can be used
in practice to prove termination of PFSs.}

\medskip
\CKchange{One of the core ingredients of our interpretation function is a
mapping to translate types:}

\begin{defn}
  A \emph{type constructor mapping} is a function $\Typemap$ which
  maps a type constructor symbol to a closed interpretation type
  constructor of the same kind. A fixed type constructor mapping
  $\Typemap$ is extended inductively to a function from type
  constructors to closed interpretation type constructors in the
  expected way. We denote the extended \emph{interpretation (type)
    mapping} by~$\typeinterpret{\sigma}$. Thus,
  e.g.~$\typeinterpret{\quant{\alpha}{\sigma}} =
  \quant{\alpha}{\typeinterpret{\sigma}}$ and $\typeinterpret{\sigma
    \arrtype \tau} = \typeinterpret{\sigma} \arrtype
  \typeinterpret{\tau}$. \CKchange{An i}nterpretation type mapping is extended to
  contexts: \( \itp{\Gamma} := \{ (x : \typeinterpret{\tau}) \mid (x :
  \tau) \in \Gamma \}.  \)
\end{defn}

\begin{lemma}\label{lem:substitutioninterpret:types}
  $\typeinterpret{\sigma}[\alpha:=\typeinterpret{\tau}] =
  \typeinterpret{\sigma[\alpha:=\tau]}$
\end{lemma}

\begin{proof}
  Induction on~$\sigma$.
\end{proof}

Similarly, we employ a \emph{symbol mapping} as an aid to interpret
PFS terms.

\begin{defn}
  A \emph{symbol mapping} is a function $\Termmap$ which assigns to
  each function symbol $\mathtt{f} : \rho$ a closed interpretation
  term $\Termmap(\mathtt{f})$ of type~$\typeinterpret{\rho}$. For a
  fixed symbol mapping $\Termmap$, we define the \emph{interpretation
    mapping} $\interpret{s}$ inductively:
  \CKchange{\[
    \begin{array}{rclcrclcrcl}
      \interpret{x} & = & x &\quad&
      \interpret{\tabs{\alpha}{s}} & = & \tabs{\alpha}{\interpret{s}} &\quad&
      \interpret{\app{t_1}{t_2}} &=& \app{\interpret{t_1}}{\interpret{t_2}} \\
      \interpret{\mathtt{f}} &=& \Termmap(\mathtt{f}) & \quad &
      \interpret{\abs{x:\sigma}{s}} & = & \abs{x:\typeinterpret{\sigma}}{
                                          \interpret{s}} & \quad &
      \interpret{\tapp{t}{\tau}} &=& \tapp{\interpret{t}}{\typeinterpret{\tau}} \\
    \end{array}
  \]}
\end{defn}

\CKchange{Essentially, $\interpret{\cdot}$ substitutes
$\Typemap(\mathtt{c})$ for type constructor symbols $\mathtt{c}$, and
$\Termmap(\mathtt{f})$ for function symbols $\mathtt{f}$, thus mapping
$A$-terms to interpretation terms.  This translation preserves typing:}

\begin{lemma}
  If $\Gamma \vdash s : \sigma$ then $\itp{\Gamma} \vdash
  \interpret{s} : \typeinterpret{\sigma}$.
\end{lemma}

\begin{proof}
  By induction on the form of $s$, using
  Lemma~\ref{lem:substitutioninterpret:types}.
\end{proof}

\begin{defn}
  For a fixed type constructor mapping $\Typemap$ and symbol mapping
  $\Termmap$, the \emph{interpretation pair}
  $(\succeqinterpret,\succinterpret)$ is defined as follows: $s
  \succeqinterpret t$ if $\interpret{s} \succeq \interpret{t}$, and $s
  \succinterpret t$ if $\interpret{s} \succ \interpret{t}$.
\end{defn}

\begin{lemma}\label{lem:substitutioninterpret}
  \begin{enumerate}
  \item\label{lem:substitutioninterpret:mixed}
    $\interpret{s}[\alpha:=\typeinterpret{\tau}] =
    \interpret{s[\alpha:=\tau]}$.
  \item\label{lem:substitutioninterpret:terms}
    $\interpret{s}[x:=\interpret{t}] = \interpret{s[x:=t]}$.
  \end{enumerate}
\end{lemma}

\begin{proof}
  Induction on~$s$.
\end{proof}

\begin{example}\label{ex:notyetmono}
\CKchange{As observed in Section \ref{sec_encodings}, inductive data
types can be encoded in System $\Fomega$.  We can adapt such encodings
to interpretations in our framework.  Example \ref{ex_fold_pafs}
introduces an inductive type $\List$ and a $\mathtt{foldl}$ function.
Following \cite[Chapter~11]{Girard1989},
we set $\Typemap(\List) = \quant{\beta}{(\quant{\alpha}{\alpha \arrtype
\beta \arrtype \beta}) \arrtype \beta \arrtype \beta}$ and
$\Termmap(\nil) = \tabs{\beta}{\abs{f:\quant{\alpha}{\alpha \arrtype
\beta \arrtype \beta}}{\abs{x:\beta}{x}}}$.  If we additionally choose
$\Termmap(\mathtt{foldl}) = \tabs{\beta}{\abs{f}{\abs{x}{\abs{l}{l
\beta f x}}} \oplus \lift_\beta(1)}$, we have
$\interpret{\mathtt{foldl}_{\sigma}(f,s,\nil)} = (\tabs{\beta}{
  \abs{f}{\abs{x}{\abs{l}{l \beta f x}}} \oplus \lift_\beta(1)})
  \typeinterpret{\sigma} f s (\tabs{\beta}{\abs{f}{\abs{x}{x}}})
  \leadsto^* s \oplus \lift_{\interpret{\sigma}}(1)$ by
  $\beta$-reduction steps.
With an extension of the proof used in Example \ref{ex:plus1},
%we can see that
this term $\succ \interpret{s}$.
%Thus, we have oriented the third rule of Example \ref{ex_fold_pafs}.
}
\end{example}

\CKchange{It is easy to see that $\succeqinterpret$ and
$\succinterpret$ have desirable properties such as transitivty,
reflexivity (for $\succeqinterpret$) and well-foundedness (for
$\succinterpret$).  However, $\succinterpret$ is not necessarily
monotonic.  Using the interpretation from Example \ref{ex:notyetmono},
$\interpret{\mathtt{foldl}_{\sigma}(\abs{x}{s},t,\nil)} =
\interpret{\mathtt{fold}_{\sigma}(\abs{x}{w},t,\nil)}$ regardless of
$s$ and $w$, so a reduction in $s$ would not cause a decrease in
$\succinterpret$.  To obtain a reduction pair, we must impose certain
conditions on $\Termmap$; in particular, we will require that
$\Termmap$ is \emph{safe}.
}

\begin{defn}\label{def_safe}
  If $s_1 \succ s_2$ implies $t[\subst{x}{s_1}] \succ
  t[\subst{x}{s_2}]$, then the interpretation term~$t$ is \emph{safe
    for~$x$}. A symbol mapping~$\Termmap$ is \emph{safe} if for all
  symbols
  \[
  \mathtt{f} : \forall (\alpha_1 : \kappa_1) \ldots \forall (\alpha_n
  : \kappa_n) . \sigma_1 \arrtype \ldots \arrtype \sigma_k \arrtype
  \tau
  \]
  with~$\tau$ a type atom we have: $\Termmap(\mathtt{f}) =
  \tabs{\alpha_1 \dots \alpha_n}{\abs{x_1 \dots x_k}{t}}$ with $t$
  safe for each~$x_i$.
\end{defn}

\begin{lemma}\label{lem_safe}
  \begin{enumerate}
  \item $x u_1 \ldots u_m$ is safe for~$x$.
  \item If $t$ is safe for~$x$ then so is~$\lift(t)$
    and~$\flatten(t)$.
  \item If $s_1$ is safe for~$x$ or $s_2$ is safe for~$x$ then $s_1
    \oplus s_2$ is safe for~$x$.
  \item If either:
    \begin{itemize}
    \item $s_1$ is safe for~$x$ and $s_2 \succeq \lift(1)$, or
    \item $s_2$ is safe for~$x$ and $s_1 \succeq \lift(1)$,
    \end{itemize}
    then $s_1 \otimes s_2$ is safe for~$x$.
  \item If~$t$ is safe for~$x$ then so is~$\tabs{\alpha}{t}$
    and~$\abs{y}{t}$ ($y \ne x$).
  \item If $t$ is safe for~$x$ then so is~$\pi^1(t)$ and~$\pi^2(t)$.
  \item If $t$ is safe for~$x$ then so is~$\xlet{}{t}{\alpha,\CKchange{y}}{s}$.
%  \item If $t$ is safe for~$x$ then so is~$\fold_\rho(f,a,t)$.
  \end{enumerate}
\end{lemma}

\begin{proof}
  Each point follows from one of the lemmas proven before,
  Lemma~\ref{lem_succ_to_succeq}, Lemma~\ref{lem_succeq_subst},
  Lemma~\ref{lem:compatibility} and the transitivity of~$\succeq$. For
  instance, assume $s_1 \succ s_2$ and let
  $u_i^j=u_i[\subst{x}{s_j}]$. Then $(x u_1 \ldots
  u_m)[\subst{x}{s_1}] = s_1 u_1^1 \ldots u_m^1$. By
  Lemma~\ref{lem_app_succ} we have $s_1 u_1^1 \ldots u_m^1 \succ s_2
  u_1^1 \ldots u_m^1$. By Lemma~\ref{lem_succ_to_succeq} and
  Lemma~\ref{lem_succeq_subst} we have $u_i^1 \succeq u_i^2$. By
  Corollary~\ref{cor_app_wm} and the transitivity of~$\succeq$ we
  obtain $s_2 u_1^1 \ldots u_m^1 \succeq s_2 u_1^2 \ldots u_m^2$. By
  Lemma~\ref{lem:compatibility} finally $(x u_1 \ldots
  u_m)[\subst{x}{s_1}] = s_1 u_1^1 \ldots u_m^1 \succ s_2 u_1^2 \ldots
  u_m^2 = (x u_1 \ldots u_m)[\subst{x}{s_2}]$.
\end{proof}

\begin{lemma}\label{lem_succinterpret_monotonic}
  If~$\Termmap$ is safe then~$\succinterpret$ is monotonic.
\end{lemma}

\begin{proof}
  Assume $s_1 \succinterpret s_2$. By induction on the structure of a
  context~$C$ we show $C[s_1] \succinterpret C[s_2]$. If $C=\Box$ then
  this is obvious. If $C = \abs{x}{C'}$ or $C = \tabs{\alpha}{C'}$
  then $C'[s_1] \succinterpret C'[s_2]$ by the inductive hypothesis,
  and thus $C[s_1] \succinterpret C[s_2]$ follows from
  Lemma~\ref{lem_abs_succ} and definitions. If $C = C' t$ then
  $C'[s_1] \succinterpret C'[s_2]$ by the inductive hypothesis, and
  thus $C[s_1] \succinterpret C[s_2]$ follows from definitions.

  Finally, assume $C = \app{t}{C'}$. Then $t = \mathtt{f} \rho_1
  \ldots \rho_n t_1 \ldots t_m$ where
  \[
  \mathtt{f} : \forall (\alpha_1 : \kappa_1) \ldots \forall (\alpha_n
  : \kappa_n) . \sigma_1 \arrtype \ldots \arrtype \sigma_k \arrtype
  \tau
  \]
  with~$\tau$ a type atom, $m < k$, and $\Termmap(\mathtt{f}) =
  \tabs{\alpha_1 \dots \alpha_n}{\abs{x_1 \dots x_k}{u}}$ with $u$
  safe for each~$x_i$. Without loss of generality assume $m=k-1$. Then
  $\interpret{C[s_i]} \leadsto u'[\subst{x_k}{\interpret{C'[s_i]}}]$
  where
  $u'=u[\subst{\alpha_1}{\typeinterpret{\rho_1}}]\ldots[\subst{\alpha_n}{\typeinterpret{\rho_n}}][\subst{x_1}{\interpret{t_1}}]\ldots[\subst{x_{k-1}}{\interpret{t_{k-1}}}]$. By
  the inductive hypothesis $\interpret{C'[s_1]} \succ
  \interpret{C'[s_2]}$. Hence $u'[\subst{x_k}{\interpret{C'[s_1]}}]
  \succ u'[\subst{x_k}{\interpret{C'[s_2]}}]$, because~$u$ is safe
  for~$x_k$. Thus $\interpret{C[s_1]} \succ \interpret{C[s_2]}$ by
  Lemma~\ref{lem_succ_red}.
\end{proof}

\begin{theorem}\label{thm_reduction_pair}
  If~$\Termmap$ is safe then $(\succeqinterpret,\succinterpret)$ is a
  reduction pair.
\end{theorem}

\begin{proof}
  \CKchange{By Lemmas~\ref{lem_transitive} and~\ref{lem_reflexive},} 
  $\succeqinterpret$ is a
  quasi-order. \CKchange{Lemmas~\ref{lem_well_founded} 
  and~\ref{lem_transitive}} imply that~$\succinterpret$ is a
  well-founded ordering. Compatibility follows from
  Lemma~\ref{lem:compatibility}. Monotonicity of~$\succeqinterpret$
  follows from Lemma~\ref{lem_succeq_subst}. Monotonicity
  of~$\succinterpret$ follows from
  Lemma~\ref{lem_succinterpret_monotonic}.
\end{proof}

\begin{example}\label{ex_fold_interpretation}
  The following is a safe interpretation for the PFS \CKchange{from
  Example~\ref{ex_fold_pafs}:
  \[
  \begin{array}{rcll}
    \Typemap(\List) & = & \multicolumn{2}{l}{
      \quant{\beta}{(\quant{\alpha}{\alpha \arrtype
      \beta \arrtype \beta}) \arrtype \beta \arrtype \beta}}\\
  \Termmap(\mathtt{@}) & = & \Lambda \alpha.\Lambda\beta.
    \lambda f.\lambda x. &
    f \cdot x \oplus \lift_\beta(\flatten_\alpha(x)) \\
  \Termmap(\mathtt{A}) & = & \Lambda \alpha.\Lambda \beta.\lambda x. &
    x * \beta \\
  \Termmap(\mathtt{nil}) & = & \Lambda \beta.\lambda f. & \abs{x}{x} \\
  \Termmap(\mathtt{cons}) & = & \Lambda \alpha.\lambda h.\lambda t. &
    \Lambda \beta.\lambda f.\lambda x.
    t \beta f (f \alpha x h \oplus x \oplus
    \lift_\beta(\flatten_\alpha(h)))\ \oplus \\
    & & & \phantom{ABCDE\ }
    \lift_\beta(\flatten_\alpha(h) \oplus 1) \\
  \Termmap(\mathtt{foldl}) & = & \Lambda \beta.\lambda f. \lambda x.
    \lambda l. & l \beta f x \oplus \lift_\beta(\flatten_{\forall \alpha.
    \alpha \arrtype \beta \arrtype \beta}(f) \oplus
    \flatten_\beta(x) \oplus 1) \\
  \end{array}
  \]
Note that $\Termmap(\mathtt{cons})$ is \emph{not} required to be safe
for $x$, since $x$ is not an argument of $\mathtt{cons}$.}
\end{example}

\section{Proving termination with rule removal}\label{sec_rule_removal}

In this section we show how to use reduction pairs to prove
termination of a PFS. This is achieved by the method of rule removal.

\begin{theorem}\label{thm:ruleremove}
  Let $\Rules = \Rules_1 \cup \Rules_2$, and suppose that
  $\Rules_1\subseteq{\succ^\Rules}$ and
  $\Rules_2\subseteq{\succeq^\Rules}$ for a reduction pair
  $(\succeq^\Rules,\succ^\Rules)$. Then $\arr{\Rules}$ is terminating
  if and only if $\arr{\Rules_2}$ is. In particular, $\arr{\Rules}$ is
  terminating if $\Rules_2 = \emptyset$.
\end{theorem}

\begin{proof}
  Monotonicity of~$\succeq^\Rules$ and~$\succ^\Rules$ implies that
  ${\arr{\Rules_1}}\subseteq{\succ^\Rules}$ and
  ${\arr{\Rules_2}}\subseteq{\succeq^\Rules}$.

  By well-foundedness of $\succ^\Rules$, compatibility
  of~$\succeq^\Rules$ and~$\succ^\Rules$, and transitivity
  of~$\succeq^\Rules$, every infinite $\arr{\Rules}$ sequence can
  contain only finitely many $\arr{\Rules_1}$ steps.
\end{proof}

The above theorem gives rise to the following \emph{rule removal}
algorithm:
\begin{enumerate}
\item While $\Rules$ is non-empty:
  \begin{enumerate}
  \item Orient all rules in $\Rules$ using $\succeq^\Rules$ or
    $\succ^\Rules$; at least one of them must be oriented using
    $\succ^\Rules$.
  \item Remove all rules ordered by $\succ^\Rules$ from $\Rules$.
  \end{enumerate}
\end{enumerate}
If this algorithm succeeds, we have proven termination.

We propose using the pair $(\succeqinterpret,\succinterpret)$ from
Section~\ref{sec_reduction_pairs}. To use this pair to prove
termination of $\arr{\Rules}$ with rule removal, two things must be
ensured:
\begin{itemize}
\item $\Termmap$ is safe;
\item all rules in $\Rules$ can be oriented with $\succeqinterpret$ or
  $\succinterpret$, and at least one with $\succinterpret$.
\end{itemize}

The first requirement guarantees that
$(\succeqinterpret,\succinterpret)$ is a reduction pair (by
Theorem~\ref{thm_reduction_pair}). Lemma~\ref{lem_safe} provides some
sufficient safety criteria. The second requirement has to be verified
for every individual rule.

Now, we state a few lemmas which are helpful in showing rule
orientation with~$\succeqinterpret$ and~$\succinterpret$. The proofs
may be found in Appendix~\ref{app_proofs}.

\begin{lemma}\label{lem:plusparts}
For all types $\sigma$, terms $s,t$ of type $\sigma$ and natural
numbers $n > 0$:
\begin{enumerate}
\item $s \oplus_{\sigma} t \succeq s$ and $s \oplus_{\sigma} t \succeq
  t$;
\item $s \oplus_{\sigma} (\lift_{\sigma} n) \succ s$ and
  $(\lift_{\sigma} n) \oplus_{\sigma} t \succ t$.
\end{enumerate}
\end{lemma}

\begin{lemma}\label{lem:approxproperties}
For all types $\sigma$ and all terms $s,t,u$ of type $\sigma$, we
have:
\begin{enumerate}
\item\label{lem:approx:symmetry} $s \oplus_\sigma t \approx t
  \oplus_\sigma s$ and $s \otimes_\sigma t \approx t \otimes_\sigma
  s$;
\item\label{lem:approx:assoc} $s \oplus_\sigma (t \oplus_\sigma u)
  \approx (s \oplus_\sigma t) \oplus_\sigma u$ and $s \otimes_\sigma
  (t \otimes_\sigma u) \approx (s \otimes_\sigma t) \otimes_\sigma u$;
\item\label{lem:approx:distribution} $s \otimes_\sigma (t
  \oplus_\sigma u) \approx (s \otimes_\sigma t) \oplus_\sigma (s
  \otimes_\sigma u)$;
\item\label{lem:approx:neutral} $(\lift_\sigma 0) \oplus_\sigma s
  \approx s$ and $(\lift_\sigma 1) \otimes_\sigma s \approx s$.
\end{enumerate}
\end{lemma}

\begin{lemma}\label{lem_lift_approx}
  \begin{enumerate}
  \item $\lift_\sigma(n+m) \approx_\sigma (\lift_\sigma n)
    \oplus_\sigma (\lift_\sigma n)$.
  \item $\lift_\sigma(n m) \approx_\sigma (\lift_\sigma n)
    \otimes_\sigma (\lift_\sigma n)$.
  \end{enumerate}
\end{lemma}

\begin{example}\label{ex_fold_orientation}
  We continue with our example of fold on heterogenous lists. We prove
  termination by rule removal, using the symbol mapping from
  Example~\ref{ex_fold_interpretation}. \LC{Cynthia: TODO}
\end{example}

\section{Larger examples}\label{sec:examples}

Pol and Schwichtenberg used higher-order polynomial interpretations to
prove termination of a fragment of first-order logic with permutative
conversions~\cite{PolSchwichtenberg1995}, in the hope of providing a
more perspicuous proof of this well-known result. Notably, they did
not treat disjunction. The paper~\cite{SorensenUrzyczyn2010} depends
on termination of~IPC2, citing a proof from~\cite{Wojdyga2008}, which,
however, later turned out to be incorrect. To our knowledge,
termination of the full system~IPC2 remains an open problem.

\LC{Cynthia: TODO}

\section{Conclusions and future work}

\addcontentsline{toc}{section}{References}
\bibliography{references}

\clearpage
\appendix

\section{Complete proofs}\label{app_proofs}

In many proofs below we assume the terms to be given in orthodox
Church-style (see the discussion at the end of
Section~\ref{sec_preliminaries}). We denote an occurrence of a
variable~$x$ annotated with a type~$\tau$ by~$x^\tau$. So now
e.g.~$\lambda x : \tau\arrtype\sigma . x^{\tau\arrtype\sigma}y^\tau$
is an orthodox Church-style typed term. When clear or irrelevant, we
omit the type annotations for readability, denoting the above term
by~$\lambda x : \tau\arrtype\sigma . x y$ or even~$\lambda x . x
y$. Note that now type substitution also needs to change the type
annotations. Also, each term has a unique type modulo
$\beta$-conversion. The generation and subject reduction lemmas still
hold for orthodox Church-style typed terms.

\subsection{Strong Normalisation of~$\arrW$}

By~$\SN$ we denote the set of all interpretation terms terminating
w.r.t.~$\arrW$.

For $t \in \SN$ by~$\nu(t)$ we denote the length of the longest
reduction starting at~$t$. The following lemma is obvious, but worth
stating explicitly.

\begin{lemma}\label{lem_reduce_abs}
  If $\abstraction{a}{s} \arrW^* t$, then $t = \abstraction{a}{t'}$
  and $s \arrW^* t'$.  If $s \in \SN$ then both $\abs{x}{s}$ and
  $\tabs{\alpha}{s}$ are also in $\SN$.
\end{lemma}

\begin{proof}
  We observe that every reduct of $\abstraction{x}{s}$ has the form
  $\abstraction{x}{s'}$ with $s \arrW s'$, and analogously for
  $\tabs{\alpha}{s}$.  Thus, the first statement follows by induction
  on the length of the reduction $\abstraction{a}{s} \arrW^* t$,
  and the second statement by induction on $\nu(s)$.
\end{proof}

\begin{lemma}\label{lem_circ_sn_base}
  If $t_1,t_2 \in \SN$ then $\circ_\nat t_1 t_2 \in \SN$ for $\circ
  \in \{\oplus,\otimes\}$.
\end{lemma}

\begin{proof}
  By induction on $\nu(t_1) + \nu(t_2)$. Assume $t_1,t_2 \in \SN$. To
  prove $\circ_\nat t_1 t_2 \in \SN$ it suffices to show $s \in \SN$
  for all~$s$ such that $\circ_\nat t_1 t_2 \arrW s$. If $s =
  \circ_\nat t_1' t_2$ or $s = \circ_\nat t_1 t_2'$ with $t_i \arrW
  t_i'$ then we complete by the induction hypothesis. Otherwise $s \in
  \mathbb{N}$ is obviously in $\SN$.
\end{proof}

In the rest of this section we adapt Girard's method of candidates
(which itself is based on Tait's computability method) to prove
termination of~$\arrW$. The proof is an adaptation of chapters~6
and~14 from the book~\cite{Girard1989}, and chapters~10 and~11 from
the book~\cite{SorensenUrzyczyn2006}.

\begin{defn}\label{def_candidate}
  A term~$t$ is \emph{neutral} if there does not exist a sequence of
  terms and types~$u_1,\ldots,u_n$ with $n \ge 1$ such that $t u_1
  \ldots u_n$ is a redex (by~$\arrW$).

  By induction on the kind~$\kappa$ of a type constructor~$\tau$ we
  define the set~$\Cb_\tau$ of all candidates of type
  constructor~$\tau$.

  First assume $\kappa=*$, i.e., $\tau$ is a type. A set~$X$ of
  interpretation terms of type~$\tau$ is a \emph{candidate of
    type~$\tau$} when:
  \begin{enumerate}
  \item $X \subseteq \SN$;
  \item if $t \in X$ and $t \arrW t'$ then $t' \in X$;
  \item if $t$ is neutral and for every~$t'$ with $t \arrW t'$ we
    have $t' \in X$, then $t \in X$;
  \item if $t_1,t_2 \in X$ then $\circ_\tau t_1 t_2 \in X$ for
    $\circ \in \{\oplus,\otimes\}$;
  \item if $t \in \SN$ and $t : \nat$ then $\lift_\tau t \in X$;
  \item if $t \in X$ then $\flatten_\tau t \in \SN$.
  \end{enumerate}
  Note that item~3 above implies:
  \begin{itemize}
  \item if $t$ is neutral and in normal form then $t \in X$.
  \end{itemize}

  Now assume $\kappa = \kappa_1\arrkind\kappa_2$. A function $f :
  \Tc_{\kappa_1} \times \bigcup_{\xi\in\Tc_{\kappa_1}}\Cb_\xi \to
  \bigcup_{\xi\in\Tc_{\kappa_2}}\Cb_\xi$ is a \emph{candidate of type
    constructor~$\tau$} if for every closed type constructor~$\sigma$
  of kind~$\kappa_1$ and a candidate $X \in \Cb_\sigma$ we have
  $f(\sigma,X) \in \Cb_{\tau\sigma}$.
\end{defn}

Note that the elements of a candidate of type~$\tau$ are required to
have type~$\tau$.

\begin{lemma}\label{lem_beta_candidate}
  If $\sigma =_\beta \sigma'$ then $\Cb_\sigma = \Cb_{\sigma'}$.
\end{lemma}

\begin{proof}
  Induction on the kind of~$\sigma$.
\end{proof}

\begin{defn}\label{def_computability_valuation}
  Let $\omega$ be a mapping from type constructor variables to type
  constructors (respecting kinds). The mapping~$\omega$ extends in an
  obvious way to a mapping from type constructors to type
  constructors. A mapping~$\omega$ is \emph{closed for~$\sigma$} if
  $\omega(\alpha)$ is closed for $\alpha \in \FTV(\sigma)$ (then
  $\omega(\sigma)$ is closed).

  An \emph{$\omega$-valuation} is a mapping~$\xi$ from type
  constructor variables to candidates such that $\xi(\alpha) \in
  \Cb_{\omega(\alpha)}$.

  For each type constructor~$\sigma$, each mapping~$\omega$ closed
  for~$\sigma$, and each $\omega$-valuation~$\xi$, the set
  $\val{\sigma}{\xi}{\omega}$ is defined by induction on~$\sigma$:
  \begin{itemize}
  \item $\val{\alpha}{\xi}{\omega} = \xi(\alpha)$ for a type
    constructor variable~$\alpha$,
  \item $\val{\nat}{\xi}{\omega}$ is the set of all terms~$t \in \SN$
    such that $t : \nat$,
  \item $\val{\sigma \arrtype \tau}{\xi}{\omega}$ is the set of all
    terms~$t$ such that $t : \omega(\sigma\arrtype\tau)$ and for
    every~$s \in \val{\sigma}{\xi}{\omega}$ with $s : \omega(\sigma)$
    we have $\app{t}{s} \in \val{\tau}{\xi}{\omega}$,
  \item $\val{\forall(\alpha:\kappa)\sigma}{\xi}{\omega}$ is the set
    of all terms~$t$ such that $t : \omega(\forall\alpha\sigma)$ and
    for every closed type constructor~$\varphi$ of kind~$\kappa$ and
    every $X \in \Cb_\varphi$ we have $\tapp{t}{\varphi} \in
    \val{\sigma}{\xi[\subst{\alpha}{X}]}{\omega[\subst{\alpha}{\varphi}]}$,
  \item
    $\val{\varphi \psi}{\xi}{\omega} =
    \val{\varphi}{\xi}{\omega}(\omega(\psi),\val{\psi}{\xi}{\omega})$,
  \item
    $\val{\lambda(\alpha:\kappa)\varphi}{\xi}{\omega}(\psi,X) =
    \val{\varphi}{\xi[\subst{\alpha}{X}]}{\omega[\subst{\alpha}{\psi}]}$
    for closed $\psi \in \Tc_\kappa$ and $X \in \Cb_\psi$.
  \end{itemize}
  In the above, if e.g.~$\val{\psi}{\xi}{\omega} \notin
  \Cb_{\omega(\psi)}$ then $\val{\varphi \psi}{\xi}{\omega}$ is
  undefined.
\end{defn}

If~$\varphi$ is closed then $\omega,\xi$ do not affect the value
of~$\val{\varphi}{\xi}{\omega}$, so then we simply
write~$\val{\varphi}{}{}$.

\begin{lemma}\label{lem_nat_computable}
  $\val{\nat}{}{} \in \Cb_{\nat}$.
\end{lemma}

\begin{proof}
  We check the conditions in Definition~\ref{def_candidate}.
  \begin{enumerate}
  \item $\val{\nat}{}{} \subseteq \SN$ follows
    directly from Definition~\ref{def_computability_valuation}.
  \item Let $t \in \val{\nat}{}{}$ and $t \arrW t'$. Then $t :
    \nat$ and $t \in \SN$. Hence $t' \in \SN$, and $t' : \nat$ by the
    subject reduction lemma. Thus $t' \in \val{\nat}{}{}$.
  \item Let $t$ be neutral and $t : \nat$. Assume that for all~$t'$
    with $t \arrW t'$ we have $t' \in \val{\nat}{}{}$, so in
    particular $t' \in \SN$. But then $t \in \SN$. Hence $t \in
    \val{\nat}{}{}$.
  \item Let $t_1,t_2 \in \SN$ be such that $t_i : \nat$. Obviously,
    $\circ_\nat t_1 t_2 : \nat$. Also $\circ_\nat t_1 t_2 \in \SN$
    follows by Lemma~\ref{lem_circ_sn_base}. So $\circ_\nat t_1 t_2
    \in \val{\nat}{}{}$.
  \item Let $t \in \SN$ be such that $t : \nat$. Then $\lift_\nat t :
    \nat$. It remains to show $\lift_\nat t \in \SN$. Any infinite
    reduction from~$\lift_\nat t$ has the form $\lift_\nat t
    \arrW^* \lift_\nat t_0 \arrW t_1 \arrW t_2 \arrW
    \ldots$ or $\lift_\nat t \arrW \lift_\nat t_0 \arrW
    \lift_\nat t_1 \arrW \lift_\nat t_2 \arrW \ldots$, where $t
    \arrW^* t_0$ and $t_i \arrW t_{i+1}$. This contradicts $t
    \in \SN$.
  \item Let $t \in \SN$ be such that $t : \nat$. The proof of
    $\flatten_\nat t \in \SN$ is analogous to the proof of $\lift_\nat
    t \in \SN$ above.\qedhere
  \end{enumerate}
\end{proof}

\begin{lemma}\label{lem_chi_kappa_computable}
  $\val{\chi_\kappa}{}{} \in \Cb_{\chi_\kappa}$.
\end{lemma}

\begin{proof}
  Induction on~$\kappa$. If $\kappa = *$ then this follows from
  Lemma~\ref{lem_nat_computable}. If $\kappa=\kappa_1\arrkind\kappa_2$
  then $\chi_\kappa = \lambda \alpha : \kappa_1
  . \chi_{\kappa_2}$. Let~$\psi$ be a closed type constructor of
  kind~$\kappa_1$ and let $X \in \Cb_{\chi_{\kappa_1}}$. We have
  $\val{\chi_\kappa}{}{}(\psi,X) = \val{\chi_{\kappa_2}}{}{}$ because
  $\chi_{\kappa_2}$ is closed. By the inductive hypothesis
  $\val{\chi_\kappa}{}{}(\psi,X) = \val{\chi_{\kappa_2}}{}{} \in
  \Cb_{\chi_{\kappa_2}}$. This implies $\val{\chi_\kappa}{}{} \in
  \Cb_{\chi_\kappa}$.
\end{proof}

\begin{lemma}\label{lem_abstraction_computable}
  Let $\sigma,\tau$ be types. Suppose $\val{\tau}{\xi'}{\omega'} \in
  \Cb_{\omega'(\tau)}$ and $\val{\sigma}{\xi'}{\omega'} \in
  \Cb_{\omega'(\sigma)}$ for all suitable $\omega',\xi'$. Then
  \begin{itemize}
  \item
    $\abs{x}{s} \in \val{\tau \arrtype \sigma}{\xi}{\omega}$ if and
    only if $\abs{x}{s} : \omega(\tau \arrtype \sigma)$ and $s[x:=t]
    \in \val{\sigma}{\xi}{\omega}$ for all $t \in
    \val{\tau}{\xi}{\omega}$;
  \item
    $\tabs{\alpha}{s} \in
    \val{\quant{(\alpha:\kappa)}{\sigma}}{\xi}{\omega}$ if and only if
    $\tabs{\alpha}{s} : \omega(\quant{(\alpha:\kappa)}{\sigma})$ and
    for every closed type constructor~$\varphi$ of kind~$\kappa$ and
    all $X \in \Cb_\varphi$ we have $s[\alpha:=\varphi] \in
    \val{\sigma}{\xi[\subst{\alpha}{X}]}{\omega[\subst{\alpha}{\varphi}]}$.
  \end{itemize}
\end{lemma}

\begin{proof}
  First suppose
  $\abs{x:\omega(\tau)}{s} \in \val{\tau \arrtype
    \sigma}{\xi}{\omega}$. Then
  $\abs{x:\omega(\tau)}{s} : \omega(\tau\arrtype\sigma)$ and for all
  $t \in \val{\tau}{\xi}{\omega}$ we have
  $\app{(\abs{x:\omega(\tau)}{s})}{t} \in \val{\sigma}{\xi}{\omega}$.
  As this set is a candidate, it is closed under $\arrW$, so also
  $s[x:=t] \in \val{\sigma}{\xi}{\omega}$. Similarly, if
  $\tabs{\alpha}{s} \in \val{\quant{\alpha}{\sigma}}{\xi}{\omega}$,
  then $\tabs{\alpha}{s} : \quant{\alpha}{\sigma}$ and
  $\tapp{(\tabs{\alpha}{s})}{\varphi} \in
  \val{\sigma}{\xi[\subst{\alpha}{X}]}{\omega[\subst{\alpha}{\varphi}]}$,
  and we are done because
  $\tapp{(\tabs{\alpha}{s})}{\tau} \arrW s[\alpha:=\varphi]$ and
  $\val{\sigma}{\xi[\subst{\alpha}{X}]}{\omega[\subst{\alpha}{\varphi}]}$
  is a candidate, so it is closed under~$\arrW$.

  Now suppose $s[x:=t] \in \val{\sigma}{\xi}{\omega}$ for all
  $t \in \val{\tau}{\xi}{\omega}$. Let
  $t \in \val{\tau}{\xi}{\omega}$. Then $t \in \SN$ because
  $\val{\tau}{\xi}{\omega}$ is a candidate. Also $s \in \SN$ because
  every infinite reduction in $s$ induces an infinite reduction in
  $s[x:=t]$ ($\arrW$ is stable) and
  $\val{\sigma}{\xi}{\omega} \subseteq \SN$ is a candidate. For all
  $s',t'$ with $s \arrW^* s'$ and $t \arrW^* t'$, we show by
  induction on~$\nu(s') + \nu(t')$ that
  $\app{(\abs{x}{s'})} t' \in \val{\sigma}{\xi}{\omega}$. We have
  $\app{(\abs{x}{s'})} t' : \omega(\sigma)$ by definition and the
  subject reduction theorem (note that $t : \omega(\tau)$ because
  $\val{\tau}{\xi}{\omega} \in \Cb_{\omega(\tau)}$). The set
  $\val{\sigma}{\xi}{\omega}$ is a candidate, and
  $\app{(\abs{x}{s'})}{t'}$ is neutral, so in
  $\val{\sigma}{\xi}{\omega}$ if all its reducts are. Thus assume
  $\app{(\abs{x}{s'})}{t'} \arrW u$. If
  $u = \app{(\abs{x}{s'})}{t''}$ with $t' \arrW t''$ or
  $u = \app{(\abs{x}{s''})}{t'}$ with $s' \arrW s''$, then
  $u \in \val{\sigma}{\xi}{\omega}$ by the inductive hypothesis. So
  assume $u = s'[x:=t']$. We have $s[x:=t] \arrW^* s'[x:=t']$ by
  monotonicity and stability of $\arrW$. Therefore
  $u = s'[x:=t'] \in \val{\sigma}{\xi}{\omega}$, because
  $s[x:=t] \in \val{\sigma}{\xi}{\omega}$ and
  $\val{\sigma}{\xi}{\omega}$ is a candidate and hence closed under
  $\arrW$.

  A similar reasoning applies to $s[\alpha:=\varphi]$.
\end{proof}

\begin{lemma}\label{lem_val_computable}
  If $\sigma$ is a type constructor, $\omega$ is closed for~$\sigma$,
  and $\xi$ is an $\omega$-valuation, then $\val{\sigma}{\xi}{\omega}
  \in \Cb_{\omega(\sigma)}$.
\end{lemma}

\begin{proof}
  By induction on the structure of~$\sigma$ we show that
  $\val{\sigma}{\xi}{\omega} \in \Cb_{\omega(\sigma)}$ for all
  suitable $\omega,\xi$. First, if $\sigma = \alpha$ is a type
  constructor variable~$\alpha$ then $\val{\sigma}{\xi}{\omega} =
  \xi(\alpha) \in \Cb_{\omega(\sigma)}$ by definition. If $\sigma =
  \nat$ then $\val{\nat}{\xi}{\omega} \in \Cb_{\nat}$ by
  Lemma~\ref{lem_nat_computable}.

  Assume $\sigma = \tau_1 \arrtype \tau_2$. We check the conditions in
  Definition~\ref{def_candidate}.
  \begin{enumerate}
  \item Let $t \in \val{\tau_1\arrtype\tau_2}{\xi}{\omega}$ and assume
    there is an infinite reduction $t \arrW t_1 \arrW t_2
    \arrW t_3 \arrW \ldots$. By the inductive hypothesis
    $\val{\tau_1}{\xi}{\omega}$ and $\val{\tau_2}{\xi}{\omega}$ are
    candidates. Let~$x$ be a fresh variable. Then $x^{\omega(\tau_1)}
    : \omega(\tau_1)$ and $x^{\omega(\tau_1)} \in
    \val{\tau_1}{\xi}{\omega}$ because it is neutral and normal. Thus
    $t x \in \val{\tau_2}{\xi}{\omega} \subseteq \SN$. But $t x
    \arrW t_1 x \arrW t_2 x \arrW t_3 x \arrW
    \ldots$. Contradiction.
  \item Let $t \in \val{\tau_1\arrtype\tau_2}{\xi}{\omega}$ and $t
    \arrW t'$. Let $u \in \val{\tau_1}{\xi}{\omega}$ be such that
    $u : \omega(\tau_1)$. Then $t u \in \val{\tau_2}{\xi}{\omega}$. By
    the inductive hypothesis $\val{\tau_2}{\xi}{\omega}$ is a
    candidate, so $t' u \in \val{\tau_2}{\xi}{\omega}$. Also note that
    $t' : \omega(\tau_1 \arrtype \tau_2)$ by the subject reduction
    lemma. Hence $t' \in \val{\tau_1\arrtype\tau_2}{\xi}{\omega}$.
  \item Let $t$ be neutral such that $t : \omega(\tau_1 \arrtype
    \tau_2)$. Assume for every~$t'$ with $t \arrW t'$ we have $t'
    \in \val{\tau_1\arrtype\tau_2}{\xi}{\omega}$. Let $u \in
    \val{\tau_1}{\xi}{\omega}$ be such that $u : \omega(\tau_1)$. By
    the inductive hypothesis $\val{\tau_1}{\xi}{\omega}$ is a
    candidate, so $u \in \SN$. By induction on~$\nu(u)$ we show that
    $t u \in \val{\tau_2}{\xi}{\omega}$. Assume $t u \arrW t''$. We
    show $t'' \in \val{\tau_2}{\xi}{\omega}$. Because~$t$ is neutral,
    $t u$ cannot be a redex. So there are two cases.
    \begin{itemize}
    \item $t'' = t u'$ with $u \arrW u'$. Then $u' \in
      \val{\tau_1}{\xi}{\omega}$ because~$\val{\tau_1}{\xi}{\omega}$
      is a candidate, and~$u' : \omega(\tau_1)$ by the subject
      reduction lemma. So $t u' \in \val{\tau_2}{\xi}{\omega}$ by the
      inductive hypothesis for~$u$.
    \item $t'' = t' u$ with $t \arrW t'$. Then $t' \in
      \val{\tau_1\arrtype\tau_2}{\xi}{\omega}$ by point~2 above. So
      $t' u \in \val{\tau_2}{\xi}{\omega}$.
    \end{itemize}
    We have thus shown that if $t u \arrW t''$ then $t'' \in
    \val{\tau_2}{\xi}{\omega}$. By the (main) inductive hypothesis
    $\val{\tau_2}{\omega,\xi}{\Gamma}$ is a candidate. Because $t u$
    is neutral, the above implies $t u \in
    \val{\tau_2}{\xi}{\omega}$. Since $u \in
    \val{\tau_1}{\xi}{\omega}$ was arbitrary with $u :
    \omega(\tau_1)$, we have shown $t \in
    \val{\tau_1\arrtype\tau_2}{\xi}{\omega}$.
  \item Assume $t_1,t_2 \in \val{\tau_1\arrtype\tau_2}{\xi}{\omega}$.
    We have already shown that this implies $t_1,t_2 \in \SN$. Let $s
    = \circ_{\omega(\tau_1\arrtype\tau_2)} t_1 t_2$. We show $s \in
    \val{\tau_1\arrtype\tau_2}{\xi}{\omega}$ by induction on $\nu(t_1)
    + \nu(t_2)$. Note that $s : \omega(\tau_1\arrtype\tau_2)$ because
    $t_i : \omega(\tau_1\arrtype\tau_2)$. Since $s$ is neutral, we
    have already seen in point~3 above that to prove $s \in
    \val{\tau_1\arrtype\tau_2}{\xi}{\omega}$ it suffices to show that
    $s' \in \val{\tau_1\arrtype\tau_2}{\xi}{\omega}$ whenever $s
    \arrW s'$. If $s' = \circ_{\omega(\tau_1\arrtype\tau_2)} t_1'
    t_2$ with $t_1 \arrW t_1'$, then note that $t_1' \in
    \val{\tau_1\arrtype\tau_2}{\xi}{\omega}$ because we have already
    shown that $\val{\tau_1\arrtype\tau_2}{\xi}{\omega}$ is closed
    under $\arrW$; thus, we can complete by the induction
    hypothesis. If $s' = \circ_{\omega(\tau_1\arrtype\tau_2)} t_1
    t_2'$, we complete in the same way.  The only alternative is that
    $s' = \abs{x:\omega(\tau_1)}{\circ_{\omega(\tau_2)}(t_1x)(t_2x)}$.
    Let $u \in \val{\tau_1}{\xi}{\omega}$. Then $u : \omega(\tau_1)$
    because $\val{\tau_1}{\xi}{\omega} \in \Cb_{\omega(\tau_1)}$ by
    the inductive hypothesis. Since $t_1,t_2 \in
    \val{\tau_1\arrtype\tau_2}{\xi}{\omega}$, we have that $t_1 u$ and
    $t_2 u$ are in $\val{\tau_2}{\xi}{\omega}$ by definition. Since
    $\val{\tau_2}{\xi}{\omega}$ is a candidate, this means that
    $\circ_{\omega(\tau_2)} (t_1 u) (t_2 u) = (\circ_{\omega(\tau_2)}
    (t_1 x) (t_2 x))[x:=u]$ is in $\val{\tau_2}{\xi}{\omega}$ as well.
    By Lemma~\ref{lem_abstraction_computable}, we conclude that $s'
    \in \val{\tau_1\arrtype\tau_2}{\xi}{\omega}$.
  \item Let $t \in \SN$ satisfy $t : \nat$, and let $s =
    \lift_{\omega(\tau_1\arrtype\tau_2)}(t)$. We show $s \in
    \val{\tau_1\arrtype\tau_2}{\xi}{\omega}$ by induction
    on~$\nu(t)$. We have $s : \omega(\tau_1\arrtype\tau_2)$ because $t
    : \nat$. Since~$s$ is neutral, we have already proved above in
    point~3 that it suffices to show that $s' \in
    \val{\tau_1\arrtype\tau_2}{\xi}{\omega}$ whenever $s \arrW
    s'$. If $s' = \lift_{\omega(\tau_1\arrtype\tau_2)}(t')$ with $t
    \arrW t'$ then still $t' \in \SN$ and $t' : \nat$, so $s' \in
    \val{\tau_1\arrtype\tau_2}{\xi}{\omega}$ by the inductive
    hypothesis. The only alternative is that $s' = \lambda x :
    \omega(\tau_1) . \lift_{\omega(\tau_2)}(t)$. Let $u \in
    \val{\tau_1}{\xi}{\omega}$ be such that $u :
    \omega(\tau_1)$. Because $\val{\tau_2}{\xi}{\omega} \in
    \Cb_{\omega(\tau_2)}$ by the (main) inductive hypothesis
    for~$\sigma$, we have $\lift_{\omega(\tau_2)}(t) \in
    \val{\tau_2}{\xi}{\omega}$. Since $\lift_{\omega(\tau_2)}(t) =
    (\lift_{\omega(\tau_2)}x)[\subst{x}{t}]$ we obtain $s' \in
    \val{\tau_1\arrtype\tau_2}{\xi}{\omega}$ by
    Lemma~\ref{lem_abstraction_computable}.
  \item Let $t \in \val{\tau_1\arrtype\tau_2}{\xi}{\omega}$.  We show
    $s := \flatten_{\omega(\tau_1\arrtype\tau_2)}t \in \SN$. We have
    already shown $t \in \SN$ in point~1 above. Thus any infinite
    reduction starting from~$s$ must have the form $s \arrW^*
    \flatten_{\omega(\tau_1\arrtype\tau_2)}t' \arrW
    \flatten_{\omega(\tau_2)}(t' (\lift_{\omega(\tau_1)}0)) \arrW
    \ldots$ with $t \arrW^* t'$. We have already shown in point~2
    above that $\val{\tau_1\arrtype\tau_2}{\xi}{\omega}$ is closed
    under~$\arrW$, so $t' \in
    \val{\tau_1\arrtype\tau_2}{\xi}{\omega}$. By the inductive
    hypothesis $\val{\tau_1}{\xi}{\omega} \in\Cb_{\omega(\tau_1)}$, so
    $\lift_{\omega(\tau_1)}0 \in \val{\tau_1}{\xi}{\omega}$ by
    property~5 of candidates. Hence $t' (\lift_{\omega(\tau_1)}0) \in
    \val{\tau_2}{\xi}{\omega}$ by definition. But by the inductive
    hypothesis~$\val{\tau_2}{\xi}{\omega}$ is a candidate, so
    $\flatten_{\omega(\tau_2)}(t'(\lift_{\omega(\tau_1)}0))\in\SN$. Contradiction.
  \end{enumerate}

  Assume $\sigma = \forall(\alpha:\kappa)\tau$. We check the
  conditions in Definition~\ref{def_candidate}.
  \begin{enumerate}
  \item Let $t \in \val{\forall(\alpha:\kappa)\tau}{\xi}{\omega}$
    and assume there is an infinite reduction $t \arrW t_1 \arrW
    t_2 \arrW t_3 \arrW \ldots$. Recall that~$\chi_\kappa$ from
    Definition~\ref{def_types} is a closed type constructor of
    kind~$\kappa$. By Lemma~\ref{lem_chi_kappa_computable} we have
    $\val{\chi_{\kappa}}{}{} \in \Cb_{\chi_\kappa}$. Then $t
    \chi_\kappa \in
    \val{\tau}{\xi[\subst{\alpha}{\val{\chi_\kappa}{}{}}]}{\omega[\subst{\alpha}{\chi_\kappa}]}$. By
    the inductive hypothesis
    $\val{\tau}{\xi[\subst{\alpha}{\val{\chi_\kappa}{}{}}]}{\omega[\subst{\alpha}{\chi_\kappa}]}$
    is a candidate, so $t \chi_\kappa \in \SN$. But $t \chi_\kappa
    \arrW t_1 \chi_\kappa \arrW t_2 \chi_\kappa \arrW t_3
    \chi_\kappa \arrW \ldots$. Contradiction.
  \item Let $t \in \val{\forall\alpha\tau}{\xi}{\omega}$ and $t
    \arrW t'$. By the subject reduction lemma $t' :
    \omega(\forall\alpha\tau)$. Let~$\varphi$ be a closed type
    constructor of kind~$\kappa$ and~$X \in \Cb_{\varphi}$. Then $t
    \varphi \in
    \val{\tau}{\xi[\subst{\alpha}{X}]}{\omega[\subst{\alpha}{\varphi}]}$. By
    the inductive hypothesis
    $\val{\tau}{\xi[\subst{\alpha}{X}]}{\omega[\subst{\alpha}{\varphi}]}$
    is a candidate, so $t' \varphi \in
    \val{\tau}{\xi[\subst{\alpha}{X}]}{\omega[\subst{\alpha}{\varphi}]}$. Therefore
    $t' \in \val{\forall\alpha\tau}{\xi}{\omega}$.
  \item Let $t$ be neutral such that $t :
    \omega(\forall\alpha\tau)$, and assume that for every~$t'$ with
    $t \arrW t'$ we have $t' \in
    \val{\forall\alpha\tau}{\xi}{\omega}$. Let~$\varphi$ be a closed
    type constructor of kind~$\kappa$ and~$X \in
    \Cb_{\varphi}$. Assume $t \varphi \arrW t''$. Then $t'' = t'
    \varphi$ with $t \arrW t'$, because~$t$ is neutral. Hence $t
    \varphi \arrW t' \varphi \in
    \val{\tau}{\xi[\subst{\alpha}{X}]}{\omega[\subst{\alpha}{\varphi}]}$. By
    the inductive
    hypothesis~$\val{\tau}{\xi[\subst{\alpha}{X}]}{\omega[\subst{\alpha}{\varphi}]}$
    is a candidate. Also $t \varphi$ is neutral, so $t \varphi \in
    \val{\tau}{\xi[\subst{\alpha}{X}]}{\omega[\subst{\alpha}{\varphi}]}$
    because~$t''$ was arbitrary with $t \varphi \arrW t''$. This
    implies that $t \in \val{\forall\alpha\tau}{\xi}{\omega}$.
  \item Assume $t_1,t_2 \in
    \val{\forall\alpha\tau}{\xi}{\omega}$. We have already shown
    that this implies $t_1,t_2 \in \SN$. We prove
    $\circ_{\omega(\forall\alpha\tau)} t_1 t_2 \in
    \val{\forall\alpha\tau}{\xi}{\omega}$ by induction on $\nu(t_1)
    + \nu(t_2)$. Since $s := \circ_{\omega(\forall\alpha\tau)} t_1
    t_2$ is neutral, we have already proven that it suffices to show
    that $s' \in \val{\forall\alpha\tau}{\xi}{\omega}$ whenever $s
    \arrW s'$. The cases when $t_1$ or $t_2$ are reduced are
    immediate with the induction hypotheses. The only remaining case
    is when $s'=\tabs{\alpha}{\circ_{\omega(\tau)} (t_1 \alpha) (t_2
      \alpha)}$.  For all closed type constructors $\varphi$ of
    kind~$\kappa$ and all $X \in \Cb_{\varphi}^\Gamma$ we have both
    $t_1 \varphi$ and $t_2 \varphi$ in
    $\val{\tau}{\xi[\subst{\alpha}{X}]}{\omega[\subst{\alpha}{\varphi}]}$
    (by definition of $t_1,t_2 \in
    \val{\forall\alpha\tau}{\xi}{\omega}$). Let $\omega' =
    \omega[\subst{\alpha}{\varphi}]$. By bound variable renaming, we
    may assume $\omega(\alpha) = \alpha$ and $\alpha$ does not occur
    in~$t_1,t_2$. Because
    $\val{\tau}{\xi[\subst{\alpha}{X}]}{\omega[\subst{\alpha}{\varphi}]}$
    is a candidate by the inductive hypothesis for~$\sigma$, we have
    \[
    \circ_{\omega'(\tau)} (t_1 \varphi)
    (t_2\varphi) = (\circ_{\omega(\tau)} (t_1 \alpha) (t_2
    \alpha))[\subst{\alpha}{\varphi}] \in
    \val{\tau}{\xi[\subst{\alpha}{X}]}{\omega[\subst{\alpha}{\varphi}]}.
    \]
    Hence $s' \in \val{\forall\alpha\tau}{\xi}{\omega}$ by
    Lemma~\ref{lem_abstraction_computable}.
  \item Let $t \in \SN$ be such that $t : \nat$. By induction
    on~$\nu(t)$ we show $s := \lift_{\omega(\forall\alpha\tau)}(t)
    \in \val{\forall\alpha\tau}{\xi}{\omega}$. First note that $s :
    \omega(\forall\alpha\tau)$. Since~$s$ is neutral, by the already
    proven point~3 above, it suffices to show that $s' \in
    \val{\forall\alpha\tau}{\xi}{\omega}$ whenever $s \arrW
    s'$. The case when~$t$ is reduced is immediate by the inductive
    hypothesis. The only remaining case is when $s' =
    \tabs{\alpha}{\lift_{\omega(\tau)}(t)}$ (without loss of
    generality assuming $\omega(\alpha) = \alpha$). Let $\varphi$ be a
    closed type constructor of kind~$\kappa$ and let $X \in
    \Cb_\varphi$. Because
    $\val{\tau}{\xi[\subst{\alpha}{X}]}{\omega[\subst{\alpha}{\varphi}]}$
    is a candidate, we have
    \[
    \lift_{\omega[\subst{\alpha}{\varphi}](\tau)}(t) =
    (\lift_{\omega(\tau)}(t))[\subst{\alpha}{\varphi}] \in
    \val{\tau}{\xi[\subst{\alpha}{X}]}{\omega[\subst{\alpha}{\varphi}]}.
    \]
    This implies $s' \in \val{\forall\alpha\tau}{\xi}{\omega}$.
  \item Let $t \in \val{\forall\alpha\tau}{\xi}{\omega}$. We show $s
    := \flatten_{\omega(\forall\alpha\tau)}t \in \SN$. We have
    already shown $t \in \SN$ in point~1 above. Thus any infinite
    reduction starting from~$s$ must have the form $s \arrW^*
    \flatten_{\omega(\forall\alpha\tau)}t' \arrW
    \flatten_{\omega(\tau)[\subst{\alpha}{\chi_\kappa}]}(t'
    \chi_\kappa) \arrW \ldots$ with $t \arrW^* t'$ (assuming
    $\omega(\alpha) = \alpha$ without loss of generality). We have
    already shown in point~2 above that
    $\val{\forall\alpha\tau}{\xi}{\omega}$ is closed
    under~$\arrW$, so $t' \in
    \val{\forall\alpha\tau}{\xi}{\omega}$. We have
    $\val{\chi_\kappa}{}{} \in \Cb_{\chi_\kappa}$ by
    Lemma~\ref{lem_chi_kappa_computable}. Since~$\chi_\kappa$ is also
    closed, we have $t' \chi_\kappa \in
    \val{\tau}{\xi[\subst{\alpha}{\val{\chi_\kappa}{}{}}]}{\omega[\subst{\alpha}{\chi_\kappa}]}$
    by definition of $\val{\forall\alpha\tau}{\xi}{\omega}$. By the
    inductive hypothesis
    $\val{\tau}{\xi[\subst{\alpha}{\val{\chi_\kappa}{}{}}]}{\omega[\subst{\alpha}{\chi_\kappa}]}
    \in \Cb_{\omega[\subst{\alpha}{\chi_\kappa}](\tau)}$. Hence
    $\flatten_{\omega[\subst{\alpha}{\chi_\kappa}](\tau)}(t'\chi_\kappa)\in\SN$. But
    $\omega[\subst{\alpha}{\chi_\kappa}](\tau) =
    \omega(\tau)[\subst{\alpha}{\chi_\kappa}]$ because~$\chi_\kappa$
    is closed and $\omega(\alpha) = \alpha$. Contradiction.
  \end{enumerate}

  Assume $\sigma = \varphi\psi$, with $\psi$ of kind~$\kappa_1$ and
  $\varphi$ of kind~$\kappa_1\arrkind\kappa_2$. By the inductive
  hypothesis $\val{\psi}{\xi}{\omega} \in \Cb_{\omega(\psi)}$ and
  $\val{\varphi}{\xi}{\omega} \in \Cb_{\omega(\varphi)}$. Because
  applying~$\omega$ does not change kinds, we have
  $\val{\varphi\psi}{\xi}{\omega} =
  \val{\varphi}{\xi}{\omega}(\omega(\psi), \val{\psi}{\xi}{\omega})
  \in \Cb_{\omega(\varphi\psi)}$, by the definition of candidates of a
  type constructor with kind~$\kappa_1\arrkind\kappa_2$ (note that
  $\omega(\psi)$ is closed, because $\omega$ is closed for~$\sigma$).

  Finally, assume $\sigma = \lambda(\alpha:\kappa)\varphi$. Let $\psi$
  be a closed type constructor of kind~$\kappa$ and $X \in
  \Cb_{\psi}$. By the inductive hypothesis
  $\val{\lambda(\alpha:\kappa)\varphi}{\xi}{\omega}(\psi,X) =
  \val{\varphi}{\xi[\subst{\alpha}{X}]}{\omega[\subst{\alpha}{\psi}]}
  \in \Cb_{\omega[\subst{\alpha}{\psi}](\varphi)}$. Because $\psi$ is
  closed we have $\omega[\subst{\alpha}{\psi}](\varphi) =
  \omega(\varphi[\subst{\alpha}{\psi}]) =_\beta
  \omega((\lambda\alpha.\varphi)\psi) = \omega(\sigma\psi) =
  \omega(\sigma)\psi$. By Lemma~\ref{lem_beta_candidate} this implies
  that $\val{\sigma}{\xi}{\omega} \in \Cb_{\omega(\sigma)}$.
\end{proof}

\begin{lemma}\label{lem_circ}
  $\circ \in \val{\forall\alpha . \alpha \arrtype \alpha \arrtype
    \alpha}{}{}$ for $\circ \in \{ \oplus, \otimes \}$.
\end{lemma}

\begin{proof}
  Follows from definitions and property~4 of candidates.
\end{proof}

\begin{lemma}\label{lem_lift}
  $\lift \in \val{\forall\alpha.\nat\arrtype\alpha}{}{}$.
\end{lemma}

\begin{proof}
  Follows from definitions and property~5 of candidates.
\end{proof}

\begin{lemma}\label{lem_flatten}
  $\flatten \in \val{\forall\alpha.\alpha\arrtype\nat}{}{}$.
\end{lemma}

\begin{proof}
  Follows from definitions and property~6 of candidates.
\end{proof}

\begin{lemma}\label{lem_val_subst}
  For any type constructors~$\sigma,\tau$ with $\alpha \notin
  \FTV(\tau)$, a mapping~$\omega$ closed for~$\sigma$ and for~$\tau$,
  and an $\omega$-valuation~$\xi$, we have:
  \[
  \val{\sigma[\subst{\alpha}{\tau}]}{\xi}{\omega} =
  \val{\sigma}{\xi[\subst{\alpha}{\val{\tau}{\xi}{\omega}}]}{\omega[\subst{\alpha}{\omega(\tau)}]}.
  \]
\end{lemma}

\begin{proof}
  Let~$\omega' = \omega[\subst{\alpha}{\omega(\tau)}]$ and $\xi' =
  \xi[\subst{\alpha}{\val{\tau}{\xi}{\omega}}]$. First note
  that~$\omega$ is closed for~$\sigma[\subst{\alpha}{\tau}]$
  and~$\omega'$ is closed for~$\sigma$. We proceed by induction
  on~$\sigma$. If $\alpha \notin \FTV(\sigma)$ then the claim is
  obvious. If $\sigma = \alpha$ then
  $\val{\sigma[\subst{\alpha}{\tau}]}{\xi}{\omega} =
  \val{\tau}{\xi}{\omega} = \val{\sigma}{\xi'}{\omega'}$.

  Assume $\sigma = \sigma_1\arrtype\sigma_2$. We show
  $\val{\sigma[\subst{\alpha}{\tau}]}{\xi}{\omega} \subseteq
  \val{\sigma}{\xi'}{\omega'}$. Let $t \in
  \val{\sigma[\subst{\alpha}{\tau}]}{\xi}{\omega}$. We have $t :
  \omega(\sigma[\subst{\alpha}{\tau}])$, so $t : \omega'(\sigma)$. Let
  $u \in \val{\sigma_1}{\xi'}{\omega'}$. By the inductive hypothesis
  $u \in \val{\sigma_1[\subst{\alpha}{\tau}]}{\xi}{\omega}$. Hence $t
  u \in \val{\sigma_2[\subst{\alpha}{\tau}]}{\xi}{\omega} =
  \val{\sigma_2}{\xi'}{\omega'}$, where the last equality follows from
  the inductive hypothesis. Thus $t \in
  \val{\sigma}{\xi'}{\omega'}$. The other direction is analogous. The
  case $\sigma = \forall\alpha\sigma'$ is also analogous.

  Assume $\sigma = \varphi\psi$. We have
  $\val{\sigma[\subst{\alpha}{\tau}]}{\xi}{\omega} =
  \val{\varphi[\subst{\alpha}{\tau}]}{\xi}{\omega}(\omega(\psi[\subst{\alpha}{\tau}]),
  \val{\psi[\subst{\alpha}{\tau}]}{\xi}{\omega}) =
  \val{\varphi[\subst{\alpha}{\tau}]}{\xi}{\omega}(\omega'(\psi),
  \val{\psi[\subst{\alpha}{\tau}]}{\xi}{\omega}) =
  \val{\varphi}{\xi'}{\omega'}(\omega'(\psi),
  \val{\psi}{\xi'}{\omega'})$ where the last equality follows from the
  inductive hypothesis.

  Finally, assume $\sigma = \lambda(\beta:\kappa)\varphi$. Let $\psi
  \in \Tc_\kappa$ be closed and let $X \in \Cb_\psi$. We have
  $\val{\sigma[\subst{\alpha}{\tau}]}{\xi}{\omega}(\psi,X) =
  \val{\varphi[\subst{\alpha}{\tau}]}{\xi[\subst{\beta}{X}]}{\omega[\subst{\beta}{\tau}]}
  =
  \val{\varphi}{\xi'[\subst{\beta}{X}]}{\omega'[\subst{\beta}{\tau}]}
  = \val{\sigma}{\xi'}{\omega'}(\psi,X)$ where we use the inductive
  hypothesis in the penultimate equality.
\end{proof}

\begin{lemma}\label{lem_forall}
  Let $\tau$ be a type constructor of kind~$\kappa$. Assume $\omega$
  is closed for $\forall\alpha\sigma$ and for~$\tau$. If $t \in
  \val{\forall(\alpha:\kappa)\sigma}{\xi}{\omega}$ then $t
  (\omega(\tau)) \in \val{\sigma[\subst{\alpha}{\tau}]}{\xi}{\omega}$.
\end{lemma}

\begin{proof}
  By Lemma~\ref{lem_val_computable} we have~$\val{\tau}{\xi}{\omega}
  \in \Cb_{\omega(\tau)}$. So $t (\omega(\tau)) \in
  \val{\sigma}{\xi[\subst{\alpha}{\val{\tau}{\xi}{\omega}}]}{\omega[\subst{\alpha}{\omega(\tau)}]}$
  by $t \in \val{\forall(\alpha:\kappa)\sigma}{\xi}{\omega}$. Hence
  $t (\omega(\tau)) \in
  \val{\sigma[\subst{\alpha}{\tau}]}{\xi}{\omega}$ by
  Lemma~\ref{lem_val_subst}.
\end{proof}

\begin{lemma}\label{lem_beta_val}
  If $\omega$ is closed for~$\sigma,\sigma'$ and $\sigma =_\beta
  \sigma'$ then $\val{\sigma}{\xi}{\omega} =
  \val{\sigma'}{\xi}{\omega}$.
\end{lemma}

\begin{proof}
  It suffices to show the lemma for the case when~$\sigma$ is a
  $\beta$-redex. Then the general case follows by induction
  on~$\sigma$ and the length of reduction to a common reduct.

  So assume $(\lambda\alpha\tau)\sigma \to_\beta
  \tau[\subst{\alpha}{\sigma}]$. We have
  $\val{(\lambda\alpha\tau)\sigma}{\xi}{\omega} =
  \val{\lambda\alpha\tau}{\xi}{\omega}(\omega(\sigma),
  \val{\sigma}{\xi}{\omega}) =
  \val{\tau}{\xi[\subst{\alpha}{\val{\sigma}{\xi}{\omega}}]}{\omega[\subst{\alpha}{\omega(\sigma)}]}
  = \val{\tau[\subst{\alpha}{\sigma}]}{\xi}{\omega}$ where the last
  equality follows from Lemma~\ref{lem_val_subst}.
\end{proof}

A mapping~$\omega$ on type constructors is extended in the obvious way
to a mapping on terms. Note that $\omega$ also acts on the type
annotations of variable occurrences, e.g.~$\omega(\lambda x : \alpha
. x^\alpha) = \lambda x : \omega(\alpha) . x^{\omega(\alpha)}$.

\begin{lemma}\label{lem_typable_computable}
  If $t : \sigma$ and $\omega$ is closed for~$\sigma$ and
  $\FTV(\omega(t)) = \emptyset$ then $\omega(t) \in
  \val{\sigma}{\xi}{\omega}$.
\end{lemma}

\begin{proof}
  We prove by induction on the structure of~$t$ that if $t : \sigma$
  and $\omega$ is closed for~$\sigma$ and $\FTV(\omega(t)) =
  \emptyset$ and $x_1^{\tau_1},\ldots,x_n^{\tau_n}$ are all free
  variable occurrences in the canonical representative of~$t$ (so
  each~$\tau_i$ is $\beta$-normal), then for all
  $u_1\in\val{\tau_1}{\xi}{\omega},\ldots,u_n\in\val{\tau_n}{\xi}{\omega}$
  we have $\omega(t)[\subst{x_1}{u_1},\ldots,\subst{x_n}{u_n}] \in
  \val{\sigma}{\xi}{\omega}$. This suffices because
  $\omega(x_i^{\tau_i}) \in \val{\tau_i}{\xi}{\omega}$. Note that
  $\omega$ is closed for each~$\tau_i$ because $\FTV(\omega(t)) =
  \emptyset$ and~$t$ is typed, so no type constructor variable
  occurring free in~$\tau_i$ can be bound in~$t$ by a~$\Lambda$;
  e.g.~$\Lambda \alpha . x^\alpha$ is not a valid typed term (we
  assume~$\tau_i$ to be in $\beta$-normal form). For brevity, we use
  the notation $\omega^*(t) =
  \omega(t)[\subst{x_1}{u_1},\ldots,\subst{x_n}{u_n}]$. Note that
  $\omega^*(t) : \omega(\sigma)$.

  By the generation lemma for $t : \sigma$ there is a type~$\sigma'$
  such that $\sigma' =_\beta \sigma$ and $\FTV(\sigma') \subseteq
  \FTV(t)$ and one of the cases below holds. Note that~$\omega$ is
  closed for~$\sigma'$ because it is closed for~$\sigma$ and
  $\FTV(\omega(t)) = \emptyset$. By Lemma~\ref{lem_beta_val} it
  suffices to show $\omega^*(t) \in \val{\sigma'}{\xi}{\omega}$.
  \begin{itemize}
  \item If $t = x_1^{\sigma'}$ then $\omega(t)[\subst{x_1}{u_1}] =
    (x_1^{\omega(\sigma')})[\subst{x_1}{u_1}] = u_1 \in
    \val{\sigma'}{\xi}{\omega}$ by assumption.
  \item If $t = n$ is a natural number and $\sigma' = \nat$ then $t
    \in \val{\nat}{}{}$ by definition.
  \item If $t$ is a function symbol then the claim follows from
    Lemma~\ref{lem_circ}, Lemma~\ref{lem_lift} or
    Lemma~\ref{lem_flatten}.
  \item If $t = \abs{x:\sigma_1}{s}$ then
    $\sigma' = \sigma_1\arrtype\sigma_2$ and $s : \sigma_2$. Hence
    $\omega$ is closed for~$\sigma_2$. Let
    $u \in \val{\sigma_1}{\xi}{\omega}$. By the inductive hypothesis
    $\omega^*(s)[\subst{x}{u}] \in \val{\sigma_2}{\xi}{\omega}$. Hence
    $\omega^*(t) \in \val{\sigma'}{\xi}{\omega}$ by
    Lemma~\ref{lem_abstraction_computable}.
  \item If $t = \tabs{\alpha:\kappa}{s}$ then $\sigma' =
    \forall\alpha\tau$ and $s : \tau$. Let $\psi$ be a closed type
    constructor of kind~$\kappa$ and let $X \in \Cb_\psi$. Let
    $\omega_1 = \omega[\subst{\alpha}{\psi}]$ and
    $\xi_1=\xi[\subst{\alpha}{X}]$. Then $\omega_1$ is closed
    for~$\tau$ and $\FTV(\omega_1(s)) = \emptyset$. By the inductive
    hypothesis $\omega_1^*(s) \in \val{\tau}{\xi_1}{\omega_1}$. We
    have $\omega_1^*(s) = \omega^*(s)[\subst{\alpha}{\psi}]$ (assuming
    $\alpha$ chosen fresh such that $\omega(\alpha) = \alpha$). Hence
    $\omega^*(t) \in \val{\tau}{\xi}{\omega}$ by
    Lemma~\ref{lem_abstraction_computable}.
  \item If $t = t_1 t_2$ then $t_1 : \tau\arrtype\sigma'$ and $t_2 :
    \tau$ and $\FTV(\tau) \subseteq \FTV(t)$. Hence~$\omega$ is closed
    for~$\tau$ and for~$\tau\arrtype\sigma'$. By the inductive
    hypothesis $\omega^*(t_1) \in
    \val{\tau\arrtype\sigma'}{\xi}{\omega}$ and $\omega^*(t_2) \in
    \val{\tau}{\xi}{\omega}$. We have $\omega^*(t_2) :
    \omega(\tau)$. Then by definition $\omega^*(t) =
    (\omega^*(t_1))(\omega^*(t_2)) \in \val{\sigma'}{\xi}{\omega}$.
  \item If $t = s \psi$ then $s : \forall\alpha\tau$ and $\sigma' =
    \tau[\subst{\alpha}{\psi}]$. By the inductive hypothesis
    $\omega^*(s) \in \val{\forall\alpha\tau}{\xi}{\omega}$. Because
    $\FTV(\omega(t)) = \emptyset$, the mapping $\omega$ is closed
    for~$\psi$. So by Lemma~\ref{lem_forall} we have $\omega^*(t) =
    \omega^*(s) \omega(\psi) \in
    \val{\tau[\subst{\alpha}{\psi}]}{\xi}{\omega}$.\qedhere
  \end{itemize}
\end{proof}

{ \renewcommand{\thetheorem}{\ref{thm_sn}}
\begin{theorem}
  If $\Gamma \proves t : \sigma$ then $t \in \SN$.
\end{theorem}
\addtocounter{theorem}{-1}}

\begin{proof}
  For closed terms~$t$ and closed types~$\sigma$ this follows from
  Lemma~\ref{lem_typable_computable}, Lemma~\ref{lem_val_computable}
  and property~1 of candidates (Definition~\ref{def_candidate}). For
  arbitrary terms and types, this follows by closing the terms with an
  appropriate number of abstractions, and the types with corresponding
  $\forall$-quantifiers.
\end{proof}

{ \renewcommand{\thelemma}{\ref{lem_final_nat}}
\begin{lemma}
  The only final interpretation terms of type $\nat$ are the natural
  numbers.
\end{lemma}
\addtocounter{theorem}{-1}}

\begin{proof}
  We show by induction on~$t$ that if $t$ is a final interpretation
  term of type~$\nat$ then $t$ is a natural number. Because~$t$ is
  closed and in normal form, if it is not a natural number then it
  must have the form $\mathtt{f}_\sigma t_1 \ldots t_n$ for a function
  symbol $\mathtt{f}$. For concreteness assume $\mathtt{f} =
  \oplus$. Then $n \ge 2$. Because~$t$ is closed, $\sigma$ cannot be a
  type variable. It also cannot be an arrow or a $\forall$-type,
  because then $t$ would contain a redex. So $\sigma=\nat$. Then
  $t_1,t_2$ are final interpretation terms of type~$\nat$, hence
  natural numbers by the inductive hypothesis. But then $t$ contains a
  redex. Contradiction.
  The case for $\mathtt{f} = \otimes$ is parallel.  If
  $\mathtt{f} \in \{\flatten,\lift\}$ and $\sigma$ is closed, then
  $n \ge 1$ and in all cases $t$ is not in normal form.
\end{proof}

\subsection{Weak monotonicity proof}\label{sec_weakly_monotone_proof}

We want to show that if $s \succeq s'$ then $t[\subst{x}{s}] \succeq
t[\subst{x}{s'}]$. A straightforward proof attempt runs into a problem
that, because of impredicativity of polymorphism, direct induction on
type structure is not possible. We adopt a method similar to Girard's
method of candidates from the termination proof.

\begin{defn}\label{def_wm_candidate}
  By induction on the kind~$\kappa$ of a type constructor~$\tau$ we
  define the set~$\Cb_\tau$ of all candidates of type
  constructor~$\tau$.

  First assume $\kappa=*$, i.e., $\tau$ is a type. A set~$X$ of terms
  of type~$\tau$ equipped with a binary relation~$\ge^X$ is a
  \emph{candidate of type~$\tau$} if it satisfies the following
  properties:
  \begin{enumerate}
  \item if $t \in X$ and $t' : \tau$ and $t' \leadsto t$ then $t' \in
    X$,
  \item if $t_1,t_2 \in X$ then $\circ_\tau t_1 t_2 \in X$ for $\circ
    \in \{\oplus,\otimes\}$,
  \item if $t : \nat$ then $\lift_\tau t \in X$.
  \end{enumerate}
  and the relation~$\ge^X$ satifies the following properties:
  \begin{enumerate}
  \item ${\succeq} \cap X \times X \subseteq {\ge^X}$,
  \item if $t_1 \ge^X t_2$ and $t_1' \leadsto t_1$ (resp.~$t_2'
    \leadsto t_2$) then $t_1' \ge^X t_2$ (resp.~$t_1 \ge^X t_2'$),
  \item if $t_1 \ge^X t_1'$ and $t_2 \ge^X t_2'$ then $\circ_\tau t_1
    t_2 \ge^X \circ_\tau t_1' t_2'$ for $\circ \in
    \{\oplus,\otimes\}$,
  \item if $t_1 \succeq_\nat t_2$ then $\lift_\tau(t_1) \ge^X
    \lift_\tau(t_2)$,
  \item if $t_1 \ge^X t_2$ then $\flatten_\tau(t_1) \succeq_\nat
    \flatten_\tau(t_2)$,
  \item $\ge^X$ is reflexive and transitive on~$X$.
  \end{enumerate}
  The relation~$\ge^X$ is a \emph{comparison candidate for~$X$},
  and~$X$ is a \emph{candidate set}.

  Now assume $\kappa = \kappa_1\arrkind\kappa_2$. A function $f :
  \Tc_{\kappa_1} \times \bigcup_{\xi\in\Tc_{\kappa_1}}\Cb_\xi \to
  \bigcup_{\xi\in\Tc_{\kappa_2}}\Cb_\xi$ is a \emph{candidate of type
    constructor~$\tau$} if for every closed type constructor~$\sigma$
  of kind~$\kappa_1$ and a candidate $X \in \Cb_\sigma$ we have
  $f(\sigma,X) \in \Cb_{\tau\sigma}$.
\end{defn}

\begin{lemma}\label{lem_beta_wm_candidate}
  If $\sigma =_\beta \sigma'$ then $\Cb_\sigma = \Cb_{\sigma'}$.
\end{lemma}

\begin{proof}
  Induction on the kind of~$\sigma$.
\end{proof}

\begin{defn}\label{def_wm_valuation}
  Let $\omega$ be a mapping from type constructor variables to type
  constructors (respecting kinds). The mapping~$\omega$ extends in an
  obvious way to a mapping from type constructors to type
  constructors. A mapping~$\omega$ is \emph{closed for~$\sigma$} if
  $\omega(\alpha)$ is closed for $\alpha \in \FTV(\sigma)$ (then
  $\omega(\sigma)$ is closed).

  An \emph{$\omega$-valuation} is a mapping~$\xi$ on type constructor
  variables such that $\xi(\alpha) \in \Cb_{\omega(\alpha)}$.

  For each type constructor~$\sigma$, each mapping~$\omega$ closed
  for~$\sigma$, and each $\omega$-valuation~$\xi$, we define
  $\val{\sigma}{\xi}{\omega}$ by induction on~$\sigma$:
  \begin{itemize}
  \item $\val{\alpha}{\xi}{\omega} = \xi(\alpha)$ for a type
    constructor variable~$\alpha$,
  \item $\val{\nat}{\xi}{\omega}$ is the set of all terms~$t \in
    \Iterms$ such that $t : \nat$; equipped with the relation
    $\gteq{\nat}{\xi}{\omega} = \succeq_\nat$,
  \item $\val{\sigma \arrtype \tau}{\xi}{\omega}$ is the set of all
    terms~$t$ such that $t : \omega(\sigma\arrtype\tau)$ and:
    \begin{itemize}
    \item for all $s \in \val{\sigma}{\xi}{\omega}$ we have
      $\app{t}{s} \in \val{\tau}{\xi}{\omega}$, and
    \item if $s_1 \gteq{\sigma}{\xi}{\omega} s_2$ then $\app{t}{s_1}
      \gteq{\tau}{\xi}{\omega} \app{t}{s_2}$;
    \end{itemize}
    equipped with the
    relation~$\gteq{\sigma\arrtype\tau}{\xi}{\omega}$ defined by:
    \begin{itemize}
    \item $t_1 \gteq{\sigma\arrtype\tau}{\xi}{\omega} t_2$ iff
      $t_1,t_2 \in \val{\sigma\arrtype\tau}{\xi}{\omega}$ and for
      every $s \in \val{\sigma}{\xi}{\omega}$ we have $t_1 s
      \gteq{\tau}{\xi}{\omega} t_2 s$,
    \end{itemize}
  \item $\val{\forall(\alpha:\kappa)[\sigma]}{\xi}{\omega}$ is the set
    of all terms~$t$ such that $t : \omega(\forall\alpha[\sigma])$ and:
    \begin{itemize}
    \item for every closed type constructor~$\varphi$ of kind~$\kappa$
      and every $X \in \Cb_\varphi$ we have $\tapp{t}{\varphi} \in
      \val{\sigma}{\xi[\subst{\alpha}{X}]}{\omega[\subst{\alpha}{\varphi}]}$;
    \end{itemize}
    equipped with the
    relation~$\gteq{\forall\alpha[\sigma]}{\xi}{\omega}$ defined by:
    \begin{itemize}
    \item $t_1 \gteq{\forall(\alpha:\kappa)[\sigma]}{\xi}{\omega} t_2$
      iff $t_1,t_2 \in
      \val{\forall(\alpha:\kappa)[\sigma]}{\xi}{\omega}$ and for every
      closed type constructor~$\varphi$ of kind~$\kappa$ and every $X
      \in \Cb_\varphi$ we have $t_1 \varphi
      \gteq{\sigma}{\xi[\subst{\alpha}{X}]}{\omega[\subst{\alpha}{\varphi}]}
      t_2 \varphi$,
    \end{itemize}
  \item
    $\val{\varphi \psi}{\xi}{\omega} =
    \val{\varphi}{\xi}{\omega}(\omega(\psi),\val{\psi}{\xi}{\omega})$,
  \item
    $\val{\lambda(\alpha:\kappa)\varphi}{\xi}{\omega}(\psi,X) =
    \val{\varphi}{\xi[\subst{\alpha}{X}]}{\omega[\subst{\alpha}{\psi}]}$
    for closed $\psi \in \Tc_\kappa$ and $X \in \Cb_\psi$.
  \end{itemize}
  In the above, if e.g.~$\val{\psi}{\xi}{\omega} \notin
  \Cb_{\omega(\psi)}$ then $\val{\varphi \psi}{\xi}{\omega}$ is
  undefined.
\end{defn}

Note that if $t \in \val{\sigma}{\xi}{\omega}$ then $t :
\omega(\sigma)$, and if $t_1 \gteq{\sigma}{\xi}{\omega} t_2$ then
$t_1,t_2\in\val{\sigma}{\xi}{\omega}$. For brevity we
use~$\val{\sigma}{\xi}{\omega}$ to denote both the pair
$(\val{\sigma}{\xi}{\omega},{\gteq{\sigma}{\xi}{\omega}})$ and its
first element, depending on the context. For a type~$\tau$,
by~$\gteq{\tau}{\xi}{\omega}$ we always denote the second element of
the pair~$\val{\tau}{\xi}{\omega}$. If $\tau$ is closed then~$\xi$
and~$\omega$ do not matter and we simply write~$\geq_\tau$
and~$\val{\tau}{}{}$.

\begin{lemma}\label{lem_val_wm_computable}
  If $\sigma$ is a type constructor, $\omega$ is closed for~$\sigma$,
  and $\xi$ is an $\omega$-valuation, then $\val{\sigma}{\xi}{\omega}
  \in \Cb_{\omega(\sigma)}$.
\end{lemma}

\begin{proof}
  Induction on~$\sigma$. If $\sigma=\alpha$ then $\xi(\alpha) \in
  \Cb_{\omega(\alpha)}$ by definition. If $\sigma=\nat$ then this
  follows from definitions.

  Assume $\sigma=\sigma_1\arrtype\sigma_2$. We check the properties of
  a candidate set.
  \begin{enumerate}
  \item The first property follows from the inductive hypothesis and
    property~2 of comparison candidates.
  \item Let $t_1,t_2 \in \val{\sigma}{\xi}{\omega}$. We need to show
    $\circ_\omega(\sigma) t_1 t_2 \in
    \val{\sigma_1\arrtype\sigma_2}{\xi}{\omega}$.

    Let $s \in \val{\sigma_1}{\xi}{\omega}$. Then
    $\circ_{\omega(\sigma)} t_1 t_2 s \leadsto
    \circ_{\omega(\sigma_2)} (t_1 s) (t_2 s)$. Because $t_i \in
    \val{\sigma_1\arrtype\sigma_2}{\xi}{\omega}$, we have $t_i s \in
    \val{\sigma_2}{\xi}{\omega}$. By the inductive
    hypothesis~$\val{\sigma_2}{\xi}{\omega} \in
    \Cb_{\omega(\sigma_2)}$, so $\circ_{\omega(\sigma_2)} (t_1 s) (t_2
    s) \in \val{\sigma_2}{\xi}{\omega}$. Hence
    $\circ_{\omega(\sigma_2)} t_1 t_2 s \in
    \val{\sigma_2}{\xi}{\omega}$ by property~1 of candidate sets.

    Let $s_1 \gteq{\sigma_1}{\xi}{\omega} s_2$. Then $s_i \in
    \val{\sigma_1}{\xi}{\omega}$. Because $t_j \in
    \val{\sigma_1\arrtype\sigma_2}{\xi}{\omega}$, we have $t_j s_i \in
    \val{\sigma_2}{\xi}{\omega}$ and $t_j s_1
    \gteq{\sigma_2}{\xi}{\omega} t_j s_2$. By the inductive
    hypothesis~$\gteq{\sigma_2}{\xi}{\omega}$ is a comparison
    candidate for~$\val{\sigma_2}{\xi}{\omega}$. Thus
    $\circ_{\omega(\sigma_2)} (t_1 s_1) (t_2 s_1)
    \gteq{\sigma_2}{\xi}{\omega} \circ_{\omega(\sigma_2)} (t_1 s_2)
    (t_2 s_2)$ by property~3 of comparison candidates. This suffices
    by property~2 of comparison candidates.
  \item Let $t : \nat$. Then $\lift_{\omega(\sigma)} t :
    \omega(\sigma)$.

    Let $s \in \val{\sigma_1}{\xi}{\omega}$. Then
    $\lift_{\omega(\sigma)}t s \leadsto \lift_{\omega(\sigma_2)}
    t$. By the inductive hypothesis $\lift_{\omega(\sigma_2)} t \in
    \val{\sigma_2}{\xi}{\omega}$. Hence $\lift_{\omega(\sigma)}t s \in
    \val{\sigma_2}{\xi}{\omega}$ by property~1 of candidate sets.

    Let $s_1,s_2 \in \val{\sigma_1}{\xi}{\omega}$. By the inductive
    hypothesis~$\gteq{\sigma_2}{\xi}{\omega}$ is a comparison
    candidate for~$\val{\sigma_2}{\xi}{\omega}$. We have
    $\lift_{\omega(\sigma_2)} t \gteq{\sigma_2}{\xi}{\omega}
    \lift_{\omega(\sigma_2)} t$ by the reflexivity
    of~$\gteq{\sigma_2}{\xi}{\omega}$ (property~6 of comparison
    candidates). This suffices by property~2 of comparison candidates,
    because $\lift_{\omega(\sigma)}t s_i \leadsto
    \lift_{\omega(\sigma_2)} t$.
  \end{enumerate}
  Now we check the properties of a comparison candidate
  for~$\val{\sigma_1\arrtype\sigma_2}{\xi}{\omega}$.
  \begin{enumerate}
  \item Suppose $t_1 \succeq t_2$ with $t_1,t_2 \in
    \val{\sigma}{\xi}{\omega}$. Let $s \in
    \val{\sigma_1}{\xi}{\omega}$. Then $t_1 s \succeq t_2 s$ by the
    definition of~$\succeq$. Hence $t_1 s \gteq{\sigma_2}{\xi}{\omega}
    t_2 s$ by the inductive hypothesis.
  \item Follows from the inductive hypothesis and the already shown
    property~1 of candidate sets
    for~$\val{\sigma_1\arrtype\sigma_2}{\xi}{\omega}$.
  \item Assume $t_i \gteq{\sigma}{\xi}{\omega} t_i'$. Let $s \in
    \val{\sigma_1}{\xi}{\omega}$. We have $\circ_{\omega(\sigma)} t_1
    t_2 s \leadsto \circ_{\omega(\sigma_2)} (t_1 s) (t_2 s)$ and
    $\circ_{\omega(\sigma)} t_1' t_2' s \leadsto
    \circ_{\omega(\sigma_2)} (t_1' s) (t_2' s)$. Since
    $t_i,t_i'\in\val{\sigma}{\xi}{\omega}$, we have $t_i s
    \gteq{\sigma_2}{\xi}{\omega} t_i' s$ and $t_i s, t_i' s \in
    \val{\sigma_2}{\xi}{\omega}$. By the inductive hypothesis $\circ
    (t_1 s) (t_2 s) \gteq{\sigma_2}{\xi}{\omega} \circ (t_1' s) (t_2'
    s)$, so $\circ t_1 t_2 s \gteq{\sigma_2}{\xi}{\omega} \circ t_1'
    t_2' s$ by property~2 of comparison candidates. This implies
    $\circ t_1 t_2 \gteq{\sigma}{\xi}{\omega} \circ t_1' t_2'$.
  \item Follows from Lemma~\ref{lem:liftgreater} and property~1 of
    comparison candidates.
  \item Assume $t_1 \gteq{\sigma}{\xi}{\omega} t_2$. Then
    $\flatten_{\omega(\sigma)} t_i \leadsto
    \flatten_{\omega(\sigma_2)} (t_i (\lift_{\omega(\sigma_1)}0))$. By
    the inductive hypothesis and property~3 of candidate sets
    $\lift_{\omega(\sigma_1)}0 \in \val{\sigma_1}{\xi}{\omega}$. Hence
    $t_i (\lift_{\omega(\sigma_1)}0) \in \val{\sigma_2}{\xi}{\omega}$
    and $t_1 (\lift_{\omega(\sigma_1)}0) \gteq{\sigma_2}{\xi}{\omega}
    t_2 (\lift_{\omega(\sigma_1)}0)$. Thus by the inductive hypothesis
    $\flatten_{\omega(\sigma_2)} (t_1 (\lift_{\omega(\sigma_1)}0))
    \succeq_\nat \flatten_{\omega(\sigma_2)} (t_2
    (\lift_{\omega(\sigma_1)}0))$. This implies
    $\flatten_{\omega(\sigma)} t_1 \succeq_\nat
    \flatten_{\omega(\sigma)} t_2$.
  \item Follows directly from the inductive hypothesis.
  \end{enumerate}

  If $\sigma=\forall\alpha\tau$ then the proof is analogous to the
  case $\sigma=\sigma_1\arrtype\sigma_2$. If $\sigma=\varphi\psi$ or
  $\sigma=\lambda(\alpha:\kappa)\varphi$ then the claim follows from
  the inductive hypothesis and Lemma~\ref{lem_beta_wm_candidate}, like
  in the proof of Lemma~\ref{lem_val_computable}.
\end{proof}

\begin{lemma}\label{lem_wm_circ}
  $\circ \in \val{\forall \alpha . \alpha \arrtype \alpha \arrtype
    \alpha}{}{}$ for $\circ \in \{ \oplus, \otimes \}$.
\end{lemma}

\begin{proof}
  Let~$\tau$ be a closed type and let $X \in \Cb_{\tau}$. Let
  $\omega(\alpha) = \tau$ and $\xi(\alpha) = X$.

  Let $t_1,t_2 \in \val{\alpha}{\xi}{\omega} = X$. Then $\circ_{\tau}
  t_1 t_2 \in \val{\alpha}{\xi}{\omega}$ by property~2 of candidate
  sets.

  Let $t_2' \in \val{\alpha}{\xi}{\omega}$ be such that $t_2
  \gteq{\alpha}{\xi}{\omega} t_2'$, i.e., $t_2 \ge^X t_2'$. By
  properties~6 and~3 of comparison candidates we have we have
  $\circ_{\tau} t_1 t_2 \gteq{\alpha}{\xi}{\omega} \circ_{\tau} t_1
  t_2'$. This shows $\circ_{\tau} t_1 \in
  \val{\alpha\arrtype\alpha}{\xi}{\omega}$.

  Let $t_1' \in \val{\alpha}{\xi}{\omega}$ be such that $t_1
  \gteq{\alpha}{\xi}{\omega} t_1'$. Let $u \in
  \val{\alpha}{\xi}{\omega}$. By properties~6 and~3 of comparison
  candidates we have $\circ_{\tau} t_1 u \gteq{\alpha}{\xi}{\omega}
  \circ_{\tau} t_1' u$. Hence $\circ_{\tau} t_1
  \gteq{\alpha\arrtype\alpha}{\xi}{\omega} \circ_{\tau} t_1'$. This
  shows $\circ_{\tau} \in
  \val{\alpha\arrtype\alpha\arrtype\alpha}{\xi}{\omega}$.
\end{proof}

\begin{lemma}\label{lem_wm_lift}
  $\lift \in \val{\forall\alpha.\nat\arrtype\alpha}{}{}$.
\end{lemma}

\begin{proof}
  Let~$\tau$ be a closed type and let $X \in \Cb_{\tau}$. Let
  $\omega(\alpha) = \tau$ and $\xi(\alpha) = X$. By property~4 of
  comparison candidates we have $\lift_{\tau}s_1
  \gteq{\alpha}{\xi}{\omega} \lift_{\tau}s_2$ for all $s_i : \nat$
  with $s_1 \succeq_\nat s_2$. It remains to show that $\lift_{\tau}s
  \in \val{\alpha}{\xi}{\omega} = X$ for all $s : \nat$. This follows
  from property~3 of candidate sets.
\end{proof}

\begin{lemma}\label{lem_wm_flatten}
  $\flatten \in \val{\forall\alpha.\alpha\arrtype\nat}{}{}$.
\end{lemma}

\begin{proof}
  Follows from definitions and property~5 of comparison candidates.
\end{proof}

\begin{lemma}\label{lem_val_subst_wm}
  For any type constructors~$\sigma,\tau$ with $\alpha \notin
  \FTV(\tau)$, a mapping~$\omega$ closed for~$\sigma$ and for~$\tau$,
  and an $\omega$-valuation~$\xi$, we have:
  \[
  \val{\sigma[\subst{\alpha}{\tau}]}{\xi}{\omega} =
  \val{\sigma}{\xi[\subst{\alpha}{\val{\tau}{\xi}{\omega}}]}{\omega[\subst{\alpha}{\omega(\tau)}]}.
  \]
\end{lemma}

\begin{proof}
  Let~$\omega' = \omega[\subst{\alpha}{\omega(\tau)}]$ and $\xi' =
  \xi[\subst{\alpha}{\val{\tau}{\xi}{\omega}}]$. The proof by
  induction on~$\sigma$ is analogous to the proof of
  Lemma~\ref{lem_val_subst}. The main difference is that in the case
  $\sigma = \sigma_1\arrtype\sigma_2$ we need to show that if e.g.~$t
  \in \val{\sigma[\subst{\alpha}{\tau}]}{\xi}{\omega}$ and $s_1
  \gteq{\sigma_1}{\xi'}{\omega'} s_2$ then $t s_1
  \gteq{\sigma_2}{\xi'}{\omega'} t s_2$. But then $s_1
  \gteq{\sigma_1[\subst{\alpha}{\tau}]}{\xi}{\omega} s_2$ by the
  inductive hypothesis, so $t s_1
  \gteq{\sigma_2[\subst{\alpha}{\tau}]}{\xi}{\omega} t s_2$ by
  definition. Hence $t s_1 \gteq{\sigma_2}{\xi'}{\omega'} t s_2$ by
  the inductive hypothesis.
\end{proof}

\begin{lemma}\label{lem_wm_forall}
  Let $\tau$ be a type constructor of kind~$\kappa$. Assume $\omega$
  is closed for $\forall\alpha[\sigma]$ and for~$\tau$.
  \begin{enumerate}
  \item If $t \in \val{\forall(\alpha:\kappa)[\sigma]}{\xi}{\omega}$
    then $t (\omega(\tau)) \in
    \val{\sigma[\subst{\alpha}{\tau}]}{\xi}{\omega}$.
  \item If $t_1 \gteq{\forall(\alpha:\kappa)[\sigma]}{\xi}{\omega}
    t_2$ then $t_1 (\omega(\tau))
    \gteq{\sigma[\subst{\alpha}{\tau}]}{\xi}{\omega} t_2
    (\omega(\tau))$.
  \end{enumerate}
\end{lemma}

\begin{proof}
  Analogous to the proof of Lemma~\ref{lem_forall}, using
  Lemma~\ref{lem_val_wm_computable} and Lemma~\ref{lem_val_subst_wm}.
\end{proof}

\begin{lemma}\label{lem_beta_val_wm}
  If $\omega$ is closed for~$\sigma,\sigma'$ and $\sigma =_\beta
  \sigma'$ then $\val{\sigma}{\xi}{\omega} =
  \val{\sigma'}{\xi}{\omega}$ and ${\gteq{\sigma}{\xi}{\omega}} =
      {\gteq{\sigma'}{\xi}{\omega}}$.
\end{lemma}

\begin{proof}
  Analogous to the proof of Lemma~\ref{lem_beta_val}, using
  Lemma~\ref{lem_val_subst_wm}.
\end{proof}

For two replacements $\delta_1 = \gamma_1 \circ \omega$ and $\delta_2
= \gamma_2 \circ \omega$ (see Definition~\ref{def_closure}) and an
$\omega$-valuation~$\xi$ we write $\delta_1 \gteq{\tau}{\xi}{\omega}
\delta_2$ iff $\delta_1(x) \gteq{\tau}{\xi}{\omega} \delta_2(x)$ for
each~$x : \tau$.

\begin{lemma}\label{lem_typable_wm_computable}
  Assume $t : \sigma$ and $\delta_1=\gamma_1\circ\omega$,
  $\delta_2=\gamma_2\circ\omega$ are replacements and~$\xi$ an
  $\omega$-valuation such that $\delta_1 \gteq{}{\xi}{\omega}
  \delta_2$ and $\omega$ is closed for~$\sigma$ and $\FTV(\omega(t)) =
  \emptyset$ and for all $x^\tau \in \FTV(t)$ we have $\delta_i(x) \in
  \val{\tau}{\xi}{\omega}$. Then $\delta_i(t) \in
  \val{\sigma}{\xi}{\omega}$ and $\delta_1(t)
  \gteq{\sigma}{\xi}{\omega} \delta_2(t)$.
\end{lemma}

\begin{proof}
  Induction on the structure of~$t$. By the generation lemma for $t :
  \sigma$ there is a type~$\sigma'$ such that $\sigma' =_\beta \sigma$
  and $\FTV(\sigma') \subseteq \FTV(t)$ and one of the cases below
  holds. Note that $\omega$ is closed for~$\sigma'$, because it is
  closed for~$\sigma$ and $\FTV(\omega(t)) = \emptyset$. Hence by
  Lemma~\ref{lem_beta_val_wm} it suffices to show $\delta_i(t) \in
  \val{\sigma'}{\xi}{\omega}$ and $\delta_1(t)
  \gteq{\sigma'}{\xi}{\omega} \delta_2(t)$.
  \begin{itemize}
  \item If $t = x^{\sigma'}$ then $\delta_i(t) \in
    \val{\sigma'}{\xi}{\omega}$ by assumption. Also $\delta_1(t)
    \gteq{\sigma'}{\xi}{\omega} \delta_2(t)$ by assumption.
  \item If $t = n$ is a natural number and $\sigma' = \nat$ then
    $\delta_i(t) = t$ and thus $t \in \val{\nat}{}{}$ and $\delta_1(t)
    \gteq{\nat}{\xi}{\omega} \delta_2(t)$ by definition and the
    reflexivity of~$\gteq{\nat}{\xi}{\omega}$.
  \item If $t$ is a function symbol then the claim follows from
    Lemma~\ref{lem_wm_circ}, Lemma~\ref{lem_wm_lift} or
    Lemma~\ref{lem_wm_flatten}, and the reflexivity
    of~$\gteq{}{\xi}{\omega}$.
  \item If $t = \abs{x:\sigma_1}{u}$ then $\sigma' =
    \sigma_1\arrtype\sigma_2$ and $u : \sigma_2$. Let $s \in
    \val{\sigma_1}{\xi}{\omega}$ and
    $\delta_i'=\delta_i[\subst{x}{s}]$. This is well-defined because
    $s : \omega(\sigma_1)$ and~$\omega(x)$ has
    type~$\omega(\sigma_1)$. We have $\delta_1' \gteq{}{\xi}{\omega}
    \delta_2'$ by the reflexivity of~$\gteq{\sigma_1}{\xi}{\omega}$
    (Lemma~\ref{lem_val_wm_computable} and property~6 of comparison
    candidates). Hence by the inductive hypothesis $\delta_i'(u) \in
    \val{\sigma_2}{\xi}{\omega}$. We have $\delta_i(\abs{x}{u}) s
    \leadsto \delta_i'(u)$, so $\delta_i(\abs{x}{u}) s \in
    \val{\sigma_2}{\xi}{\omega}$ by Lemma~\ref{lem_val_wm_computable}
    and property~1 of candidate sets.

    Let $s_1,s_2 \in \val{\sigma_1}{\xi}{\omega}$ be such that $s_1
    \gteq{\sigma_1}{\xi}{\omega} s_2$. Let
    $\delta_i'=\delta_i[\subst{x}{s_i}]$. We have $\delta_1
    \gteq{}{\xi}{\omega} \delta_2$. Hence by the inductive hypothesis
    $\delta_1'(u)\gteq{\sigma_2}{\xi}{\omega}\delta_2'(u)$. We have
    $\delta_i(\abs{x}{u}) s_i \leadsto \delta_i'(u)$. Thus
    $\delta_1(t) s_1 \gteq{\sigma_2}{\xi}{\omega} \delta_2(t) s_2$ by
    Lemma~\ref{lem_val_wm_computable} and property~2 of comparison
    candidates.

    Finally, we show $\delta_1(t)
    \gteq{\sigma_1\arrtype\sigma_2}{\xi}{\omega} \delta_2(t)$. Let $s
    \in \val{\sigma_1}{\xi}{\omega}$ and
    $\delta_i'=\delta_i[\subst{x}{s}]$. We have $\delta_1'
    \gteq{}{\xi}{\omega} \delta_2'$. By the inductive hypothesis
    $\delta_1'(u) \gteq{\sigma_2}{\xi}{\omega} \delta_2'(u)$. We have
    $\delta_i(\abs{x}{u}) s \leadsto \delta_i'(u)$. Thus $\delta_1(t)
    s \gteq{\sigma_2}{\xi}{\omega} \delta_2(t) s$ by
    Lemma~\ref{lem_val_wm_computable} and property~2 of comparison
    candidates.
  \item If $t = \tabs{\alpha:\kappa}{u}$ then $\sigma' =
    \forall\alpha[\tau]$ and $u : \tau$. Let $\psi$ be a closed type
    constructor of kind~$\kappa$ and let $X \in \Cb_\psi$. Let
    $\omega' = \omega[\subst{\alpha}{\psi}]$ and
    $\xi'=\xi[\subst{\alpha}{X}]$. Then $\omega'$ is closed for~$\tau$
    and $\FTV(\omega'(u)) = \emptyset$. Let
    $\delta_i'=\gamma_i\circ\omega'$. By the inductive hypothesis
    $\delta_i'(u) \in \val{\tau}{\xi'}{\omega'}$ and $\delta_1'(u)
    \gteq{\tau}{\xi'}{\omega'} \delta_2'(u)$. We have
    $\delta_i(\tabs{\alpha}{u}) \psi \leadsto \delta_i'(u)$. Hence
    $\delta_i(\tabs{\alpha}{u}) \psi \in \val{\tau}{\xi'}{\omega'}$ by
    Lemma~\ref{lem_val_wm_computable} and property~1 of candidate
    sets. Thus $\delta_i(\tabs{\alpha}{u}) \in
    \val{\forall\alpha[\tau]}{\xi}{\omega}$. Also
    $\delta_1(\tabs{\alpha}{u}) \psi \gteq{\tau}{\xi'}{\omega'}
    \delta_2(\tabs{\alpha}{u}) \psi$ by
    Lemma~\ref{lem_val_wm_computable} and property~2 of comparison
    candidates. Thus $\delta_1(\tabs{\alpha}{u})
    \gteq{\forall\alpha[\tau]}{\xi'}{\omega'}
    \delta_2(\tabs{\alpha}{u})$.
  \item If $t = t_1 t_2$ then $t_1 : \tau\arrtype\sigma'$ and $t_2 :
    \tau$ and $\FTV(\tau) \subseteq \FTV(t)$. Hence~$\omega$ is closed
    for~$\tau$ and for~$\tau\arrtype\sigma'$. By the inductive
    hypothesis $\delta_i(t_1) \in
    \val{\tau\arrtype\sigma'}{\xi}{\omega}$ and $\delta_i(t_2) \in
    \val{\tau}{\xi}{\omega}$ and $\delta_1(t_1)
    \gteq{\tau\arrtype\sigma'}{\xi}{\omega} \delta_2(t_1)$ and
    $\delta_1(t_2) \gteq{\tau}{\xi}{\omega} \delta_2(t_2)$. By the
    definition of $\val{\tau\arrtype\sigma'}{\xi}{\omega}$ we have
    $\delta_i(t) = \delta_i(t_1)\delta_i(t_2) \in
    \val{\sigma'}{\xi}{\omega}$, and $\delta_1(t_1)\delta_1(t_2)
    \gteq{\sigma'}{\xi}{\omega} \delta_1(t_1)\delta_2(t_2)$. By the
    definition of~$\gteq{\tau\arrtype\sigma'}{\xi}{\omega}$ we have
    $\delta_1(t_1)\delta_2(t_2)\gteq{\sigma'}{\xi}{\omega}\delta_2(t_1)\delta_2(t_2)$. Hence
    $\delta_1(t)\gteq{\sigma'}{\xi}{\omega}\delta_2(t)$ by the
    transitivity of~$\gteq{\sigma'}{\xi}{\omega}$.
  \item If $t = s \psi$ then $s : \forall\alpha[\tau]$ and $\sigma' =
    \tau[\subst{\alpha}{\psi}]$. By the inductive hypothesis
    $\delta_i(s) \in \val{\forall\alpha[\tau]}{\xi}{\omega}$ and
    $\delta_1(s) \gteq{\forall\alpha[\tau]}{\xi}{\omega}
    \delta_2(s)$. Because $\FTV(\omega(t)) = \emptyset$, the mapping
    $\omega$ is closed for~$\psi$. So by Lemma~\ref{lem_wm_forall} we
    have $\delta_i(t) = \delta_i(s) \omega(\psi) \in
    \val{\tau[\subst{\alpha}{\psi}]}{\xi}{\omega}$ and $\delta_1(t)
    \gteq{\tau[\subst{\alpha}{\psi}]}{\xi}{\omega} \delta_2(t)$.\qedhere
  \end{itemize}
\end{proof}

\begin{corollary}\label{cor_typable_wm_computable}
  If $t$ is closed and $t : \sigma$ then $t \in \val{\sigma}{}{}$.
\end{corollary}

\begin{lemma}\label{lem_gteq_to_succeq}
  If $\sigma$ is a closed type and $t_1 \geq_\sigma t_2$ then
  $t_1 \succeq_{\sigma} t_2$.
\end{lemma}

\begin{proof}
  By coinduction. By Lemma~\ref{lem_beta_val_wm} we may assume
  that~$\sigma$ is in $\beta$-normal form. The case $\sigma=\alpha$ is
  impossible because~$\sigma$ is closed. If $\sigma = \nat$ then
  ${\geq_\nat} = {\succeq_\nat}$.

  Assume $\sigma=\sigma_1\arrtype\sigma_2$. Let $u : \sigma_1$ be
  closed. By Corollary~\ref{cor_typable_wm_computable} we have $u \in
  \val{\sigma_1}{}{}$. Hence $t_1 u \geq_{\sigma_2} t_2 u$. By the
  coinductive hypothesis $t_1 u \succeq_{\sigma_2} t_2 u$. This
  implies $t_1 \succeq_{\sigma} t_2$.

  Assume $\sigma=\forall(\alpha:\kappa)\tau$. Let $\varphi$ be a
  closed type constructor of kind~$\kappa$. By
  Lemma~\ref{lem_val_wm_computable} we have $\val{\varphi}{}{} \in
  \Cb_\varphi$. By the definition of~$\geq_{\forall\alpha\tau}$ and
  Lemma~\ref{lem_val_subst_wm} we have $t_1 \varphi
  \geq_{\tau[\subst{\alpha}{\varphi}]} t_2 \varphi$. Note that
  $\tau[\subst{\alpha}{\varphi}]$ is still closed. Hence by the
  coinductive hypothesis $t_1 \varphi
  \succeq_{\tau[\subst{\alpha}{\varphi}]} t_2 \varphi$. This implies
  $t_1 \succeq_{\sigma} t_2$.
\end{proof}

\begin{corollary}\label{cor_gteq_succeq}
  If~$\sigma$ is a closed type then ${\geq_{\sigma}} =
  {\succeq_\sigma}$.
\end{corollary}

\begin{proof}
  Follows from Lemma~\ref{lem_gteq_to_succeq},
  Lemma~\ref{lem_val_wm_computable} and property~1 of comparison
  candidates.
\end{proof}

{ \renewcommand{\thelemma}{\ref{lem_succeq_subst}}
\begin{lemma}[Weak monotonicity]
  If $s \succeq_\sigma s'$ then $t[\subst{x}{s}] \succeq_\tau t[\subst{x}{s'}]$.
\end{lemma}
\addtocounter{theorem}{-1}}

\begin{proof}
  It suffices to show this when
  $s,s',t[\subst{x}{s}],t[\subst{x}{s'}]$ and $\sigma,\tau$ are all
  closed. Assume $s \succeq_\sigma s'$. Then $s \geq_{\sigma} s'$ by
  Corollary~\ref{cor_gteq_succeq}. Thus $t[\subst{x}{s}] \geq_{\tau}
  t[\subst{x}{s'}]$ follows from
  Lemma~\ref{lem_typable_wm_computable}. Hence $t[\subst{x}{s}]
  \succeq_\tau t[\subst{x}{s'}]$ by Corollary~\ref{cor_gteq_succeq}.
\end{proof}

\subsection{Proofs for Section~\ref{sec_rule_removal}}

{ \renewcommand{\thelemma}{\ref{lem:plusparts}}
\begin{lemma}
For all types $\sigma$, terms $s,t$ of type $\sigma$ and natural
numbers $n > 0$:
\begin{enumerate}
\item $s \oplus_{\sigma} t \succeq s$ and $s \oplus_{\sigma} t \succeq
  t$;
\item $s \oplus_{\sigma} (\lift_{\sigma} n) \succ s$ and
  $(\lift_{\sigma} n) \oplus_{\sigma} t \succ t$.
\end{enumerate}
\end{lemma}
\addtocounter{theorem}{-1}}

\begin{proof}
  It suffices to prove this for closed $s,t$ and closed $\sigma$ in
  $\beta$-normal form.
  \begin{enumerate}
  \item By coinduction we show $(s \oplus t) u_1 \ldots u_m
    \succeq_\sigma s u_1 \ldots u_m$ for closed $u_1,\ldots,u_m$. The
    second case is similar.

    First note that $(s \oplus t) u_1 \ldots u_m \leadsto^* s u_1
    \ldots u_m \oplus t u_1 \ldots u_m$.

    If $\sigma = \nat$ then $((s \oplus t) u_1 \ldots u_m)\da = (s u_1
    \ldots u_m)\da + (t u_1 \ldots u_m)\da \ge (s u_1 \ldots
    u_m)\da$. Hence $(s \oplus t) u_1 \ldots u_m) \succeq_\nat s u_1
    \ldots u_m$.

    If $\sigma = \tau_1\arrtype\tau_2$ then by the coinductive
    hypothesis $(s \oplus t) u_1 \ldots u_m q \succeq_{\tau_2} s u_1
    \ldots u_m q$ for any $q \in \Iterms_{\tau_1}^f$. Hence $(s \oplus
    t) u_1 \ldots u_m \succeq_\sigma s u_1 \ldots u_m$.

    \CK{TODO: check: I changed $\mathcal{W}$ to $\Iterms$ here.}
    \LC{It should be $\Iterms^f$ -- I forgot to change this when I
      changed the notation from $\mathcal{W}$ to $\Iterms^f$ (my rationale
      for changing the notation was that we really interpret by terms
      in $\Iterms$, not by final interpretation terms $\Iterms^f$,
      which are just a special case of $\Iterms$ used in the
      proofs). In the coinductive definition you have $\Iterms^f$, not
      $\Iterms$. This is why I say at the beginning that we consider
      closed terms and types (which we can do because if $\succ$ holds
      for closed terms and types, then it holds for all terms and
      types, by how $\succ$ is defined on open terms)}

    If $\sigma = \forall(\alpha:\kappa)[\tau]$ then by the coinductive
    hypothesis $(s \oplus t) u_1 \ldots u_m \xi \succeq_{\sigma'} s
    u_1 \ldots u_m \xi$ for any closed $\xi \in \Tc_\kappa$, where
    $\sigma' = \tau[\subst{\alpha}{\xi}]$. Hence $(s \oplus t) u_1
    \ldots u_m \succeq_\sigma s u_1 \ldots u_m$.
  \item By coinduction we show $(s \oplus (\lift n)) u_1 \ldots u_m
    \succeq_\sigma s u_1 \ldots u_m$ for closed $u_1,\ldots,u_m$. The
    second case is similar.

    Note that $(s \oplus (\lift n)) u_1 \ldots u_m \leadsto^* s u_1
    \ldots u_m \oplus n$. From this the case $\sigma=\nat$
    follows. The other cases follow from the coinductive hypothesis,
    like in the first point above.\qedhere
  \end{enumerate}
\end{proof}

{ \renewcommand{\thelemma}{\ref{lem:approxproperties}}
\begin{lemma}
For all types $\sigma$ and all terms $s,t,u$ of type $\sigma$, we
have:
\begin{enumerate}
\item $s \oplus_\sigma t \approx t \oplus_\sigma s$ and $s
  \otimes_\sigma t \approx t \otimes_\sigma s$;
\item $s \oplus_\sigma (t \oplus_\sigma u) \approx (s \oplus_\sigma t)
  \oplus_\sigma u$ and $s \otimes_\sigma (t \otimes_\sigma u) \approx
  (s \otimes_\sigma t) \otimes_\sigma u$;
\item $s \otimes_\sigma (t \oplus_\sigma u) \approx (s \otimes_\sigma
  t) \oplus_\sigma (s \otimes_\sigma u)$;
\item $(\lift_\sigma 0) \oplus_\sigma s \approx s$ and $(\lift_\sigma
  1) \otimes_\sigma s \approx s$.
\end{enumerate}
\end{lemma}
\addtocounter{theorem}{-1}}

\begin{proof}
  The proof is again analogous to the proof of
  Lemma~\ref{lem:plusparts}. For instance, for closed $s,t$ and closed
  $\sigma$ in $\beta$-normal form, we show by coinduction that $(s
  \oplus t) w_1 \ldots w_n \succeq (t \oplus s) w_1 \ldots w_n$ for
  closed $w_1,\ldots,w_n$ (and then the same with $\preceq$).
\end{proof}

{ \renewcommand{\thelemma}{\ref{lem_lift_approx}}
\begin{lemma}
  \begin{enumerate}
  \item $\lift_\sigma(n+m) \approx_\sigma (\lift_\sigma n)
    \oplus_\sigma (\lift_\sigma n)$.
  \item $\lift_\sigma(n m) \approx_\sigma (\lift_\sigma n)
    \otimes_\sigma (\lift_\sigma n)$.
  \end{enumerate}
\end{lemma}
\addtocounter{theorem}{-1}}

\begin{proof}
  It suffices to show this for closed~$\sigma$ in $\beta$-normal
  form. Then one proves by induction on~$\sigma$ that
  $(\lift_\sigma(n+m))\da = (\lift_\sigma n \oplus_\sigma \lift_\sigma
  n)\da$ (analogously for multiplication). This suffices by
  Corollary~\ref{cor_succ_da} and the reflexivity of~$\approx$.
\end{proof}

\section{Proving the inequalities in \refsec{examples}}\label{app_ineqs}

\end{document}
